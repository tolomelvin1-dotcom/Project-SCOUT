<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>S.C.O.U.T. Rover Full-Spectrum Data Fusion & Control Console (V14.2 - Analysis Fix)</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://unpkg.com/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
<script async src="https://docs.opencv.org/4.x/opencv.js" onload="onOpenCvReady();"></script>
<style>
/* =================================================================
   SECTION 0.1: CRITICAL SYSTEM-WIDE CSS STYLES (Highly Detailed Dark Theme)
   ================================================================= */
body { 
    font-family: 'Consolas', 'Segoe UI', monospace; 
    margin: 0; 
    padding: 25px; 
    background-color: #0c1015; /* Deeper background for the ultimate dark mode */
    color: #c9d1d9; 
    transition: background-color 0.5s;
    line-height: 1.5; 
}
.container {
    max-width: 1920px; /* Maximizing width for high-resolution displays */
    margin: auto;
    background: #161b22; 
    padding: 40px;
    border-radius: 18px;
    box-shadow: 0 15px 40px rgba(0,0,0,1.0); /* Increased shadow depth */
    display: flex;
    flex-wrap: wrap; 
    border: 3px solid #30363d; /* Thicker border for structural definition */
}

/* LAYOUT AND PANEL DEFINITION (Ensuring Robust Flex Behavior) */
.controls-panel { flex: 1; min-width: 400px; padding-right: 35px; border-right: 1px dashed #30363d; }
.map-panel { flex: 1; min-width: 480px; padding: 0 35px; }
.photo-panel { flex: 1; min-width: 480px; padding-left: 35px; border-left: 1px dashed #30363d; }
.map-3d-panel { flex-basis: 100%; min-width: 100%; margin-top: 40px; padding-top: 20px; border-top: 3px solid #30363d; }
.plant-analysis-panel {
    flex-basis: 100%; 
    margin-top: 50px;
    padding-top: 30px;
    border-top: 3px solid #30363d;
}

/* Typography and Status Indicators (Enhanced Visual Feedback) */
h1 { color: #58a6ff; border-bottom: 5px double #30363d; padding-bottom: 15px; margin-bottom: 30px; font-size: 2.6em; font-weight: 800; }
h2 { color: #79c0ff; margin-top: 35px; margin-bottom: 15px; font-size: 1.9em; border-bottom: 1px solid #30363d; padding-bottom: 5px; }
h3 { color: #4ac9b0; margin-top: 20px; font-size: 1.4em; }
#status { font-weight: 900; color: #f08047; font-size: 1.25em; display: block; margin-top: 10px; }
.data-display { 
    margin-top: 30px; 
    padding: 25px; 
    border: 2px solid #30363d; 
    border-radius: 12px; 
    background-color: #0f131a; 
    transition: box-shadow 0.3s;
}
.data-display:hover { box-shadow: 0 0 18px rgba(88, 166, 255, 0.3); }

/* Data Rows (Alignment Control) */
.data-row { margin: 12px 0; }
.data-row strong { 
    display: inline-block; 
    width: 220px; /* Increased for clean alignment */
    color: #4ac9b0; 
}

/* Control Buttons (Explicit Color Coding & Code Clean-up) */
button { 
    padding: 16px 24px; 
    margin: 8px 6px; 
    cursor: pointer; 
    border: none; 
    border-radius: 10px; 
    font-weight: bold; 
    transition: background-color 0.3s ease, transform 0.1s, box-shadow 0.3s; 
    letter-spacing: 1.2px;
    font-size: 1.08em;
    text-transform: uppercase;
    box-shadow: 0 5px 8px rgba(0,0,0,0.5);
    white-space: nowrap;
}
button:hover { transform: translateY(-3px); box-shadow: 0 8px 12px rgba(0,0,0,0.8); }
.move-controls button { background-color: #58a6ff; color: #0d1117; } 
.arm-controls button { background-color: #3fb950; color: #0d1117; } 
.history-controls button { background-color: #e3b341; color: #0d1117; } 
.photo-controls button { background-color: #f08047; color: #0d1117; }

/* MAP STYLES */
#roverMap {
    border: 4px solid #58a6ff;
    border-radius: 5px;
    background-color: #0f131a;
}

/* GRID STYLES (4x4 Zones) */
#photoGrid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    grid-template-rows: repeat(4, 1fr);
    gap: 8px;
    border: 3px solid #58a6ff;
    max-width: 480px; 
    margin: 25px auto;
    aspect-ratio: 1 / 1;
    background-color: #0f131a;
    position: relative; 
}
.grid-cell {
    background-color: #21262d;
    border: 1px solid #3fb950;
    position: relative;
    cursor: pointer;
    overflow: hidden;
    aspect-ratio: 1/1;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 0.9em;
    font-weight: bold;
    color: #4ac9b0;
    transition: border 0.2s, background-color 0.2s;
}
.grid-cell:hover { border: 3px solid #79c0ff; background-color: #2a3038; }

/* Styles for delete button for embedded file input to work */
.delete-photo-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    padding: 2px 5px;
    font-size: 0.8em;
    z-index: 10; /* Ensure button is on top of the transparent input */
    background-color: #f85149;
    color: #0d1117;
    border-radius: 50%;
}

/* ANALYSIS CARD STYLING */
#plantAnalysisGrid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(550px, 1fr)); 
    gap: 40px;
    margin-top: 30px;
}
.analysis-card {
    padding: 35px;
    border-radius: 20px;
    background-color: #21262d;
    box-shadow: 0 10px 25px rgba(0,0,0,0.8);
}
.plant-id-label {
    font-size: 2.2em;
    font-weight: 900;
    color: #ffd700;
    border-bottom: 5px double #30363d;
    padding-bottom: 15px;
    margin-bottom: 25px;
}
.assessment-section { margin-bottom: 30px; padding: 25px; border-radius: 12px; }

/* Recommendation Coloring */
.rec-optimal, .rec-action, .rec-critical, .rec-no-data {
    padding: 15px;
    border-radius: 10px;
    display: block;
    font-weight: bold;
    margin-top: 18px;
    font-size: 1.15em;
    line-height: 1.4;
}
.rec-optimal { background-color: #3fb950; color: #0d1117; }
.rec-action { background-color: #e3b341; color: #0d1117; }
.rec-critical { background-color: #f85149; color: #0d1117; }
.rec-no-data { background-color: #58a6ff; color: #0d1117; } 

/* MODAL AND HISTORY LIST STYLES */
.modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.98); }
.modal-content { background-color: #161b22; margin: 3% auto; padding: 50px; border: 3px solid #30363d; width: 95%; max-width: 1600px; border-radius: 20px; }
.close-btn { color: #aaa; float: right; font-size: 50px; font-weight: bold; }
.trial-item { 
    padding: 20px; 
    margin-bottom: 12px; 
    background-color: #0f131a; 
    border-left: 6px solid #e3b341;
    border-radius: 12px; 
    cursor: pointer; 
    transition: background-color 0.3s;
}
.trial-item:hover { background-color: #21262d; border-left: 6px solid #79c0ff; }
#stockImageGrid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); 
    gap: 18px;
    max-width: 100%;
    margin-top: 25px;
    border: 1px solid #30363d;
    padding: 20px;
    border-radius: 10px;
}
</style>
</head>
<body>
<div class="container">
<div class="controls-panel">
    <h1>S.C.O.U.T. Rover Control & Telemetry Bridge (V14.2)</h1>
    <p>System Diagnostic Status: <span id="status">AWAITING SYSTEM BOOT SEQUENCE COMPLETION...</span></p>

    <div class="data-display history-controls">
        <h2>Trial Preservation Console (MAX 50 Presets) üíæ  </h2>
        <div class="data-row"><strong>Current System Trial ID:</strong> <span id="currentTrialNumber">1</span></div>
        <p>
            <button onclick="executeTrialSaveOperation()"> üíæ  EXECUTE TRIAL SAVE OPERATION</button>
            <button onclick="openHistoryRetrievalModal()"> üìÖ  RETRIEVE HISTORY (MAX 50)</button>
        </p>
        <p><small>Storage Capacity: **50 Historical Presets**. Oldest trial is automatically purged (FIFO) upon capacity breach.</small></p>
    </div>

    <div class="data-display move-controls">
        <h2>Rover Translational Control (X/Y Axis)</h2>
        <p>Command Structure: X-Axis (Left/Right), Y-Axis (Forward/Backward). **No code leakage in button labels.**</p>
        <button onclick="dispatchRoverMovementCommand('forward')">FORWARD (Y+)</button>
        <button onclick="dispatchRoverMovementCommand('stop')"> üõë EMERGENCY STOP</button>
        <button onclick="dispatchRoverMovementCommand('backward')">BACKWARD (Y-)</button><br>
        <button onclick="dispatchRoverMovementCommand('left')">LEFT (X-)</button>
        <button onclick="dispatchRoverMovementCommand('right')">RIGHT (X+)</button>
    </div>

    <div class="data-display arm-controls">
        <h2>Data Acquisition (Arduino R3 Sensor Payload)</h2>
        <p>The **ESP32** serves as the critical Wi-Fi bridge for cloud telemetry push.</p>
        <button onclick="dispatchRoverMovementCommand('probe')"> üî¨ EXTEND PROBE (SOIL READ)</button>
        <button onclick="dispatchRoverMovementCommand('read_sensors')"> üíß READ ENVIRONMENTAL DATA</button>
        <button onclick="dispatchRoverMovementCommand('read_nav')"> üß≠ ACQUIRE GPS/IMU DATA</button>
    </div>

    <div class="data-display">
        <h2>Real-time Sensor Telemetry (Raw Feed)</h2>
        <h3>Navigation Subsystem</h3>
        <div class="data-row"><strong>Latitude (GPS):</strong> <span id="latitudeData">N/A</span></div>
        <div class="data-row"><strong>Longitude (GPS):</strong> <span id="longitudeData">N/A</span></div>
        <div class="data-row"><strong>GPS Fix Status:</strong> <span id="gpsFix">N/A</span></div>
        <div class="data-row"><strong>Heading (IMU):</strong> <span id="headingData">N/A</span></div>
        <h3>Soil/Environment Subsystem</h3>
        <div class="data-row"><strong>Soil Moisture (%):</strong> <span id="moistureData">N/A</span></div>
        <div class="data-row"><strong>NPK (N, P, K ppm):</strong> <span id="npkData">N/A</span></div>
        <div class="data-row"><strong>ThingSpeak Status:</strong> <span id="thingspeakStatus">Awaiting Connection</span></div>
    </div>
</div>

<div class="map-panel">
    <h2>2D Field Map (4m x 4m Grid - Cleaned Visualization)</h2>
    <p>Grid Key: **Thin Lines** = 1m x 1m. **Green Circles** = Plant Zones. **Blue Triangle** = Rover Position. **Zone numbers removed for clarity.**</p>
    <canvas id="roverMap" width="480" height="480"></canvas>
    <p style="margin-top: 15px;">
        <button onclick="resetSensorAndMapData()"> üóëÔ∏è CLEAR ALL TRANSIENT MAP DATA</button>
    </p>
</div>

<div class="photo-panel">
    <div class="camera-control data-display">
        <h2>Image Capture & Stock Library</h2>
        <p>TO UPLOAD: **Click any Zone (1-16)** to select it, then click to upload or use the stock library.</p>
        <button onclick="dispatchRoverMovementCommand('capture')" class="photo-controls"> üì∏ TRIGGER CAMERA CAPTURE</button>
        <button onclick="openStockImageGalleryModal()" class="photo-controls"> üñºÔ∏è VIEW STOCK PHOTOS (50 Presets)</button>
        <p>Current Target Zone: **Zone <span id="currentZoneSelection">N/A</span>**</p>
    </div>
    <hr style="border-top: 2px solid #30363d; margin: 30px 0;">
    <h2>Plant Zone Photo Assignments (16 Zones)</h2>
    <div id="photoGrid">
        </div>
</div>

<div class="map-3d-panel">
    <h2>3D Soil Metric Visualization üìä (Height=Moisture, Color=Health)</h2>
    <div id="threeDContainer" style="height: 550px; width: 100%;"></div>
</div>

<div class="plant-analysis-panel">
    <h2>DATA FUSION ENGINE: Plant-Specific Final Diagnosis (16 Zones) üî¨ </h2>
    <p>This panel displays the **FUSED** assessment: **Leaf Visual Pre-Assessment (CV) (LOWER WEIGHT)** + **Local Soil Sensor Data (HIGHER WEIGHT)**.</p>
    <div id="plantAnalysisGrid">
        </div>
</div>
</div>

<div id="historyModal" class="modal" onclick="if(event.target.id === 'historyModal') closeHistoryModal()">
    <div class="modal-content">
        <span class="close-btn" onclick="closeHistoryModal()">&times;</span>
        <h2>Saved Trial History Retrieval Console (Maximum Capacity: 50 Presets ENFORCED)</h2>
        <p>Click a trial to restore its exact state (map, photos, and final analysis).</p>
        <div id="trialHistoryList">
        </div>
        <hr style="border-top: 2px solid #30363d; margin-top: 20px;">
        <button onclick="executeAllHistoryClearance()" style="background-color: #f85149;"> üö® EXECUTE ALL SAVED TRIALS CLEARANCE</button>
    </div>
</div>

<div id="stockImageModal" class="modal" onclick="if(event.target.id === 'stockImageModal') closeStockImageGalleryModal()">
    <div class="modal-content">
        <span class="close-btn" onclick="closeStockImageGalleryModal()">&times;</span>
        <h2>Stock Photo Gallery (50 Pre-Diagnosed Leaf Presets - Click to Assign)</h2>
        <p>Target Zone: **Zone <span id="modalCurrentZoneSelection">N/A</span>** (Click a cell to select a photo)</p>
        <div id="stockImageGrid">
            </div>
    </div>
</div>

<script>
// ==================================================================================
// SECTION 0.2: CORE SYSTEM CONSTANTS AND GLOBAL CONFIGURATION (MAXIMAL VERBOSITY)
// ----------------------------------------------------------------------------------
/**
 * @fileoverview S.C.O.U.T. Rover Control System JavaScript Core.
 * Version 14.2: Enhanced Photo Analysis Consistency with UX fix.
 */

// --- 0.2.1 HARDWARE AND NETWORK CONFIGURATION (CRITICAL SYSTEM IDENTIFIERS) ---
// üõë CRITICAL: Update this IP to the actual local IP printed by your ESP32 Serial Monitor üõë
const HARDWARE_ESP32_IP_ADDRESS = '192.168.1.50'; // e.g., '192.168.1.100'

// THINGSPEAK TELEMETRY CONFIGURATION
const THINGSPEAK_CHANNEL_ID = '3093113';       // <--- INSERT CHANNEL ID HERE
const THINGSPEAK_READ_API_KEY = 'IWLHAT1BGO6CXA5O';   // <--- INSERT READ KEY HERE

// ThingSpeak API URL to get the last entry (Derived from the constants above)
const THINGSPEAK_FETCH_URL = `https://api.thingspeak.com/channels/${THINGSPEAK_CHANNEL_ID}/feeds/last.json?api_key=${THINGSPEAK_READ_API_KEY}`;

// Retaining the original constant for the Rover's internal mock-transmit logic (write key)
const THINGSPEAK_WRITE_API_KEY = '6OXH3SUQ4VNSOJX1'; 
const MAX_HISTORY_TRIALS = 50;

// --- 0.2.2 PHYSICAL SYSTEM AND UI CONSTANTS (STRICT ADHERENCE TO SPECIFICATIONS) ---
const FIELD_GRID_SIZE_M = 4; 
const MAP_CANVAS_PIXELS = 480; 
const MAX_STOCK_PHOTOS = 50; 
const PLANT_CIRCLE_RADIUS = 5; 
const SCORE_CAP_ON_PARTIAL_DATA = 50; // New constraint applied here

// --- 0.2.3 DOM ELEMENT REFERENCES (MAPPING CORE UI COMPONENTS) ---
const STATUS_ELEMENT = document.getElementById('status');
const MOISTURE_DISPLAY_ELEMENT = document.getElementById('moistureData');
const NPK_DISPLAY_ELEMENT = document.getElementById('npkData');
const HISTORY_TRIAL_COUNTER = document.getElementById('currentTrialNumber');
const MAP_CONTEXT = document.getElementById('roverMap').getContext('2d');
const HISTORY_MODAL = document.getElementById('historyModal');
const STOCK_MODAL = document.getElementById('stockImageModal');
const CURRENT_ZONE_SELECTION_DISPLAY = document.getElementById('currentZoneSelection');

// --- 0.2.4 GLOBAL STATE VARIABLES (Clean Initial State Definition) ---
let openCvLibraryIsReady = false;
let systemLoggedSensorDataArray = []; 
let currentPhotoAssignmentData = {}; 
let stockPhotoLibraryData = {}; 
let currentlySelectedPlantZone = 0; // CRITICAL: Used by photo handlers
let historyIsBeingViewed = false;

let currentRoverKinematicState = {
    latitude: 'N/A',
    longitude: 'N/A',
    heading: 0.0,
    x_position_m: 2.0, // Starting center (2, 2)
    y_position_m: 2.0
};

// Persistent Storage Management (Ensure 50 preset capacity logic is used)
let trialHistoryRecords = JSON.parse(localStorage.getItem('trialHistory') || '[]');
let currentIncrementalTrialID = trialHistoryRecords.length + 1;
HISTORY_TRIAL_COUNTER.innerText = currentIncrementalTrialID;

// Pre-calculated Plant Locations (16 zones)
const FIELD_PLANT_LOCATIONS_M = [];
for(let r=0; r<FIELD_GRID_SIZE_M; r++) {
    for(let c=0; c<FIELD_GRID_SIZE_M; c++) {
        FIELD_PLANT_LOCATIONS_M.push({x: c + 0.5, y: r + 0.5, id: (r * FIELD_GRID_SIZE_M) + c + 1});
    }
}


// ==================================================================================
// SECTION 1.0: HARDWARE COMMUNICATIONS & SENSOR DATA LOGGING (Standard Logic)
// ----------------------------------------------------------------------------------
   // ----------------------------------------------------------------------------------
// NEW: ESP32 LOCAL COMMAND BRIDGE (Option B)
// ----------------------------------------------------------------------------------
/**
 * Sets the status message for the Command Bridge.
 * @param {string} message - The status message.
 * @param {boolean} isError - True if the message indicates an error.
 */
function setCommandStatus(message, isError = false) {
    const statusEl = document.getElementById('commandStatus');
    if (statusEl) {
        statusEl.innerText = message;
        // Use existing color variables for consistency
        statusEl.style.color = isError ? '#f85149' : '#3fb950'; 
    }
}

/**
 * Sends a command directly to the ESP32's local web server on port 80.
 * @param {string} command - The raw command string (e.g., 'MOVE,200,200', 'STOP', 'SERVO,90').
 */
function sendCommand(command) {
    setCommandStatus(`DISPATCH: Sending local command '${command}'...`);

    if (HARDWARE_ESP32_IP_ADDRESS === 'YOUR_ESP32_LOCAL_IP') {
        setCommandStatus('ERROR: Update HARDWARE_ESP32_IP_ADDRESS in the code!', true);
        return;
    }

    // The ESP32 is listening on http://[IP]/command?cmd=[command]
    const url = `http://${192.168.1.50/command?cmd=${command}`;
    
    fetch(url)
        .then(response => {
            if (response.ok) {
                return response.text();
            } else {
                // HTTP status code other than 2xx
                throw new Error(`HTTP Error: ${response.status} ${response.statusText}`);
            }
        })
        .then(data => {
            setCommandStatus(`RESPONSE: ESP32 acknowledged command: ${command}.`);
            console.log("Local Command Response:", data);
        })
        .catch(error => {
            setCommandStatus(`FAILURE: Command failed! Check ESP32 IP/Network.`, true);
            console.error("Error sending local command:", error);
        });
} <div class="rover-controls">
    <h2>Rover Control & Command Bridge</h2>
    <p style="margin-top: 15px;">
        <strong>Command Status:</strong> <span id="commandStatus" style="color:#3fb950;">Ready.</span>
    </p>
                    
    <div class="move-controls" style="text-align: center;">
        <button onclick="sendCommand('MOVE,200,200')">FORWARD (Y+)</button>
        <button onclick="sendCommand('STOP')">  üõë  EMERGENCY STOP</button>
        <button onclick="sendCommand('MOVE,-200,-200')">BACKWARD (Y-)</button><br>
        <button onclick="sendCommand('MOVE,0,200')">TURN LEFT (Pvt)</button>
        <button onclick="sendCommand('MOVE,200,0')">TURN RIGHT (Pvt)</button>
        <p style="font-size:0.8em; color:#8b949e;">Controls send commands directly to ESP32 local server.</p>
    </div>

    <hr style="border-color:#30363d;">
                    
    <div class="servo-controls" style="text-align: center;">
        <h3>Soil Probe & Tool Control</h3>
        <label for="servoAngle">Probe Angle (0-180¬∞):</label>
        <input type="number" id="servoAngle" value="90" min="0" max="180" style="width: 80px;">
        <button onclick="sendCommand('SERVO,' + document.getElementById('servoAngle').value)">Set Angle</button>
    </div>
</div>
// ----------------------------------------------------------------------------------
function transmitSensorDataViaESP32ToThingSpeak(dataPacket) {
    const apiEndpointUrl = "https://api.thingspeak.com/update";
    document.getElementById('thingspeakStatus').innerText = 'TRANSMITTING...';
    // The data structure here simulates the fields being sent to ThingSpeak (field1-7)
    const urlPayload = `${apiEndpointUrl}?api_key=${THINGSPEAK_API_KEY}` +
                `&field1=${dataPacket.moisture}&field2=${dataPacket.N}&field3=${dataPacket.P}&field4=${dataPacket.K}` +
                `&field5=${dataPacket.latitude}&field6=${dataPacket.longitude}&field7=${dataPacket.heading}`; 
    
    fetch(urlPayload, { method: 'GET', mode: 'no-cors' })
        .then(() => {
            document.getElementById('thingspeakStatus').innerText = `SUCCESS: Data pushed.`;
        })
        .catch(error => {
            document.getElementById('thingspeakStatus').innerText = `ERROR: ThingSpeak Transmission Failed.`;
            console.error("ThingSpeak Transmission Error:", error);
        });
}

function dispatchRoverMovementCommand(commandIdentifier) {
    STATUS_ELEMENT.innerText = `DISPATCH: Sending command '${commandIdentifier}'...`;
    
    setTimeout(() => {
        STATUS_ELEMENT.innerText = `RESPONSE: Command '${commandIdentifier}' Acknowledged.`;

        if (commandIdentifier.startsWith('read_') || commandIdentifier === 'probe') {
            executeDataAcquisition(commandIdentifier); 
        } else if (commandIdentifier === 'capture') {
            // Mock capture logic
            const zoneID = findNearestPlantZone(currentRoverKinematicState.x_position_m, currentRoverKinematicState.y_position_m)?.id || 1;
            // Mocking a diagnosis based on the zone for testing purposes
            const mockDiagnosis = (zoneID % 3 === 0) ? 'Dark Spots & Lesions/Blackening of Leaf (Fungal/Bacterial)' : 'Healthy, Deep Green Foliage';
            currentPhotoAssignmentData[zoneID] = `data:image/jpeg;base64,mocked_rover_capture_zone_${zoneID}_diag:${mockDiagnosis.replace(/\s/g, '_').replace(/[()]/g, '')}`;
            renderPhotoInPhotoGridCell(zoneID, currentPhotoAssignmentData[zoneID]);
            
            // Set the zone selection explicitly after capture
            currentlySelectedPlantZone = zoneID;
            CURRENT_ZONE_SELECTION_DISPLAY.innerText = zoneID;
            
            STATUS_ELEMENT.innerText = `Photo captured and assigned to nearest Zone ${zoneID}. Triggering Analysis.`;
            triggerComprehensiveAnalysisCycle();
        } else {
             // Simulate Rover Kinematics Update (0.1m step)
             const step = 0.1;
             let newX = parseFloat(currentRoverKinematicState.x_position_m);
             let newY = parseFloat(currentRoverKinematicState.y_position_m);
             
             if (commandIdentifier === 'forward') newY = Math.min(FIELD_GRID_SIZE_M, newY + step).toFixed(2);
             if (commandIdentifier === 'backward') newY = Math.max(0, newY - step).toFixed(2);
             if (commandIdentifier === 'left') newX = Math.max(0, newX - step).toFixed(2);
             if (commandIdentifier === 'right') newX = Math.min(FIELD_GRID_SIZE_M, newX + step).toFixed(2);

             currentRoverKinematicState.x_position_m = newX;
             currentRoverKinematicState.y_position_m = newY;
             currentRoverKinematicState.heading = (currentRoverKinematicState.heading + (Math.random() * 5 - 2.5)).toFixed(1); 
             
             updateMapVisualization();
             updateRover3DPosition();
        }
    }, 750);
}

function executeDataAcquisition(acquisitionType) {
    STATUS_ELEMENT.innerText = "SENSOR READ: Acquiring raw data...";
    
    // Simulate sensor data
    const nearestPlant = findNearestPlantZone(currentRoverKinematicState.x_position_m, currentRoverKinematicState.y_position_m);
    const plantID = nearestPlant ? nearestPlant.id : 1;
    
    let moistureVal = (Math.random() * 70 + 20).toFixed(1); 
    let npk_n = Math.floor(Math.random() * 150 + 50);
    let npk_p = Math.floor(Math.random() * 100 + 40);
    let npk_k = Math.floor(Math.random() * 180 + 60);

    // Simulate bad sensor data for zones that have a mocked disease
    if (plantID % 3 === 0) {
        moistureVal = (Math.random() * 15 + 5).toFixed(1); // Very low moisture
        npk_n = Math.floor(Math.random() * 30 + 10); // Very low N
    }

    // Navigation Data
    const heading = (Math.random() * 360).toFixed(1);
    const latitude = `40.7128${(Math.random()*100).toFixed(0)}`;
    const longitude = `-74.0060${(Math.random()*100).toFixed(0)}`;


    // Update Live Display Elements 
    document.getElementById('moistureData').innerText = `${moistureVal}%`;
    document.getElementById('npkData').innerText = `N:${npk_n}, P:${npk_p}, K:${npk_k}`;
    document.getElementById('headingData').innerText = heading + ' deg';
    document.getElementById('latitudeData').innerText = latitude;
    document.getElementById('longitudeData').innerText = longitude;
    document.getElementById('gpsFix').innerText = '3D Fix Acquired';

    // Transmit data to ThingSpeak
    transmitSensorDataViaESP32ToThingSpeak({ 
        moisture: parseFloat(moistureVal), N: npk_n, P: npk_p, K: npk_k,
        latitude: latitude, longitude: longitude, heading: heading // Sending full data packet
    });

    if (acquisitionType === 'probe' || acquisitionType === 'read_sensors') {
        systemLoggedSensorDataArray.push({
            x_m: parseFloat(currentRoverKinematicState.x_position_m),
            y_m: parseFloat(currentRoverKinematicState.y_position_m),
            moisture: parseFloat(moistureVal),
            npk_n: npk_n, npk_p: npk_p, npk_k: npk_k,
            timestamp: Date.now() 
        });
        
        STATUS_ELEMENT.innerText = `SENSOR READ: Data logged (${systemLoggedSensorDataArray.length} total logs). Triggering Analysis...`;
        triggerComprehensiveAnalysisCycle();
    }
    updateMapVisualization();
    draw3DMap(); 
}


// ==================================================================================
// SECTION 2.0: DIAGNOSTIC KNOWLEDGE BASE & FUSED ANALYSIS CORE (V14.2)
// ----------------------------------------------------------------------------------

const TOMATO_DIAGNOSTIC_KB = {
    DISEASE_TIERS: [
        { name: "Mottling/Mosaic Pattern (Viral-TMV)", severity_score: 95, class: 'rec-critical', recommendation: "CRITICAL ISOLATION REQUIRED: Strong indicator of Tobacco Mosaic Virus (TMV). **IMMEDIATELY REMOVE AND DESTROY** the plant to prevent field-wide contamination. No chemical cure exists." },
        { name: "Dark Spots & Lesions/Blackening of Leaf (Fungal/Bacterial)", severity_score: 90, class: 'rec-critical', recommendation: "FUNGICIDE/BACTERICIDE APPLICATION: Likely Early Blight, Bacterial Spot, or Black Mold. Apply broad-spectrum copper-based fungicide and focus on improving air circulation and reducing leaf wetness." },
        { name: "General Severe Yellowing (Chlorosis-N)", severity_score: 50, class: 'rec-action', recommendation: "NPK DEFICIENCY LIKELY: Severe yellowing often indicates primary Nitrogen (N) deficiency. Review current sensor data and adjust fertilizer immediately." },
        { name: "Edging Burn/Tip Necrosis (K/Salt)", severity_score: 65, class: 'rec-action', recommendation: "POTASSIUM/SALINITY ALERT: Symptoms point to Potassium (K) deficiency or high salt buildup. Test K levels and consider a soil flush with plain water." },
        { name: "Healthy, Deep Green Foliage", severity_score: 0, class: 'rec-optimal', recommendation: "OPTIMAL: No visual symptoms detected. Continue regular monitoring. The overall visual health looks excellent." }
    ],
    NPK_GUIDELINES: {
        moisture: { ideal_min: 40, ideal_max: 60, low_crit: 25, high_crit: 75, penalty_minor: 10, penalty_major: 30, low_rec: "deep supplemental irrigation", high_rec: "review soil drainage/stop all irrigation" },
        N: { ideal_min: 60, ideal_max: 100, low_crit: 30, high_crit: 150, penalty_minor: 15, penalty_major: 40, low_rec: "high-Nitrogen (N) liquid feed", high_crit: "stop all N-fertilizer, flush soil" },
        P: { ideal_min: 50, ideal_max: 80, low_crit: 20, high_crit: 120, penalty_minor: 10, penalty_major: 25, low_rec: "Phosphorus (P) booster for root development", high_rec: "check fertilizer blend for P excess" },
        K: { ideal_min: 70, ideal_max: 120, low_crit: 40, high_crit: 180, penalty_minor: 10, penalty_major: 25, low_rec: "Potassium (K) to boost resistance/fruit set", high_rec: "check for K salt toxicity" },
    }
};

function getVisualPreAssessment(visualScore, diagnosedDiseaseName) {
    const diseaseBaseName = diagnosedDiseaseName.split('(')[0].trim();
    if (visualScore >= 90) return `Leaf condition: **Greenish/Excellent**. CV Score: ${visualScore}%.`;
    if (visualScore >= 80) return `Leaf is **Healthy**, showing only minor localized discoloration. CV Score: ${visualScore}%.`;
    if (visualScore >= 60) return `Leaf shows **Notable Discoloration**. Diagnosis: ${diseaseBaseName} is likely. CV Score: ${visualScore}%.`;
    return `**Critical Visual Alert**. Diagnosis: Analysis suggests ${diseaseBaseName} is imminent. CV Score: ${visualScore}%.`;
}

function findNearestSensorDataPoint(plantX, plantY) {
    let nearestDataPoint = null;
    let minimumDistanceSquared = Infinity;
    const MAX_SEARCH_RADIUS_SQ = 0.5 * 0.5; 

    systemLoggedSensorDataArray.forEach(dataPoint => {
        let dx = dataPoint.x_m - plantX;
        let dy = dataPoint.y_m - plantY;
        let dist_sq = dx * dx + dy * dy;

        if (dist_sq <= MAX_SEARCH_RADIUS_SQ && dist_sq < minimumDistanceSquared) {
            minimumDistanceSquared = dist_sq;
            nearestDataPoint = dataPoint;
        }
    });
    return nearestDataPoint;
}

function performFinalDataFusionAndDiagnosis(plant, sensorData, visualResult) {
    const hasSensorData = !!sensorData;
    const hasPhotoData = !!visualResult;
    
    let fusedHealthScore = 100;
    let soilHealthPenalties = [];
    let sensorDataSummary = "Soil Data: Sensor Data Missing (N/A) - **HIGH PRIORITY GAP**";
    let visualPreAssessment = "Leaf Pre-Assessment: No Photo Taken.";
    let partialRecommendationVisual = "N/A (Awaiting Photo)";

    // 1. Process Sensor Data and Calculate Soil Penalties
    if (hasSensorData) {
        const { moisture, npk_n, npk_p, npk_k } = sensorData;
        const sensorReadings = { moisture, N: npk_n, P: npk_p, K: npk_k };
        sensorDataSummary = `Soil Readings: M=${moisture}%, NPK=${npk_n}/${npk_p}/${npk_k} (Logged at ${sensorData.x_m}m, ${sensorData.y_m}m)`;

        Object.keys(TOMATO_DIAGNOSTIC_KB.NPK_GUIDELINES).forEach(key => {
            const guideline = TOMATO_DIAGNOSTIC_KB.NPK_GUIDELINES[key];
            const value = sensorReadings[key];
            let penaltyMagnitude = 0;
            let problemClassification = '';

            if (value < guideline.low_crit || value > guideline.high_crit) {
                penaltyMagnitude = guideline.penalty_major;
                problemClassification = `CRITICAL DEVIATION (${key})`;
            } else if (value < guideline.ideal_min || value > guideline.ideal_max) {
                penaltyMagnitude = guideline.penalty_minor;
                problemClassification = `MILD IMBALANCE (${key})`;
            }

            if (problemClassification) {
                fusedHealthScore = Math.max(0, fusedHealthScore - penaltyMagnitude);
                const specificRec = (value < guideline.ideal_min ? guideline.low_rec : guideline.high_rec);
                soilHealthPenalties.push({ key, value, problemClassification, specificRec });
            }
        });
    }

    // 2. Process Visual Data and Calculate Visual Penalties
    let visualPredictionTier = TOMATO_DIAGNOSTIC_KB.DISEASE_TIERS.find(d => d.name.includes("Healthy"));
    if (hasPhotoData) {
        visualPredictionTier = visualResult.prediction;
        const visualScore = visualResult.score;
        visualPreAssessment = getVisualPreAssessment(visualScore, visualResult.diagnosis);
        partialRecommendationVisual = visualPredictionTier.recommendation;
        
        // Apply visual penalty (20% weight) to the score
        const visualDeficit = 100 - visualScore;
        fusedHealthScore = Math.max(0, fusedHealthScore - (visualDeficit * 0.20)); 
    }

    // --- CASE 1: NO DATA ---
    if (!hasSensorData && !hasPhotoData) {
         return {
            id: plant.id,
            fusedScore: 'N/A',
            preAssessmentVisual: visualPreAssessment,
            preAssessmentSensor: sensorDataSummary,
            partialRecommendation: "N/A (Awaiting Photo)",
            finalRecommendation: "Awaiting photo assignment or sensor log in this zone. Please collect data to generate a diagnosis.",
            healthClassification: 'rec-no-data'
        };
    }
    
    // --- CASE 2: PHOTO ONLY (Partial Data Constraint) ---
    if (hasPhotoData && !hasSensorData) {
        // Apply score cap at 50 as per requirement
        fusedHealthScore = Math.min(Math.round(fusedHealthScore), SCORE_CAP_ON_PARTIAL_DATA); 
        
        return {
            id: plant.id,
            fusedScore: fusedHealthScore.toFixed(0),
            preAssessmentVisual: visualPreAssessment,
            preAssessmentSensor: sensorDataSummary,
            partialRecommendation: partialRecommendationVisual,
            finalRecommendation: `PARTIAL DIAGNOSIS: Health is capped at ${SCORE_CAP_ON_PARTIAL_DATA}%. Sensor data is required for confirmation and final action plan. Current Visual Rec: ${visualPredictionTier.recommendation}`,
            healthClassification: (fusedHealthScore <= 30) ? 'rec-action' : (fusedHealthScore <= 50 ? 'rec-optimal' : 'rec-no-data') 
        };
    }
    
    // --- CASE 3: FUSED DATA (Photo + Sensor) or SENSOR ONLY ---
    
    let finalActionRecommendation = 'Optimal health confirmed. Continue regular monitoring and data logging.';
    let finalHealthClassification = 'rec-optimal';
    
    // Check for critical flags
    const isMajorViral = hasPhotoData && visualPredictionTier.name.includes('Mottling');
    const hasCriticalSoilIssue = soilHealthPenalties.some(p => p.problemClassification.includes('CRITICAL'));
    
    if (isMajorViral) {
        finalActionRecommendation = visualPredictionTier.recommendation;
        finalHealthClassification = visualPredictionTier.class;
        fusedHealthScore = Math.min(10, fusedHealthScore); // Drastically reduce score for TMV
    } else if (hasCriticalSoilIssue) {
        const criticalProblems = soilHealthPenalties.filter(p => p.problemClassification.includes('CRITICAL'));
        const recString = criticalProblems.map(p => `[${p.key}]: ${p.specificRec}`).join('; ');
        finalActionRecommendation = `CRITICAL SOIL ALERT: Urgent Action Required. Deviations Detected: ${recString}`;
        finalHealthClassification = 'rec-critical';
    } else if (soilHealthPenalties.length > 0) {
        const recString = soilHealthPenalties.map(p => p.specificRec).join('; ');
        finalActionRecommendation = `CAUTION: Moderate Soil Imbalance. Recommended adjustments: ${recString}`;
        finalHealthClassification = fusedHealthScore <= 70 ? 'rec-action' : 'rec-optimal';
    } else if (hasPhotoData) {
        // If soil is fine, defer to visual diagnosis
        finalActionRecommendation = visualPredictionTier.recommendation;
        finalHealthClassification = visualPredictionTier.class;
    } else {
        // Sensor only data, no visual issue found, and soil is healthy/optimal.
        finalActionRecommendation = "Soil metrics are optimal/healthy. No visual data available. Recommend obtaining a photo for full spectrum analysis.";
        finalHealthClassification = 'rec-optimal';
        partialRecommendationVisual = "N/A (Awaiting Photo)";
    }

    return {
        id: plant.id,
        fusedScore: Math.round(fusedHealthScore).toFixed(0),
        preAssessmentVisual: visualPreAssessment,
        preAssessmentSensor: sensorDataSummary,
        partialRecommendation: partialRecommendationVisual,
        finalRecommendation: finalActionRecommendation.trim(),
        healthClassification: finalHealthClassification
    };
}

/**
 * CRITICAL V14.2 FIX: Enhanced analysis logic for uploaded photos.
 */
function executeCoreCVAnalysis(base64Image) {
    if (!openCvLibraryIsReady) {
        const fallbackPrediction = TOMATO_DIAGNOSTIC_KB.DISEASE_TIERS.find(d => d.name.includes("Yellowing"));
        return Promise.resolve({ score: 50, diagnosis: "CV Library Not Ready (Delayed Init)", prediction: fallbackPrediction });
    }
    
    return new Promise((resolve) => {
        const imageElement = document.createElement('img');
        imageElement.onload = function() {
            // --- NEW Logic for diverse and consistent mock diagnosis ---
            
            // 1. Filter out the "No Data" tier and pick a random tier.
            const tiers = TOMATO_DIAGNOSTIC_KB.DISEASE_TIERS.filter(t => !t.name.includes("No Data"));
            const randomIndex = Math.floor(Math.random() * tiers.length);
            const predictionTier = tiers[randomIndex];

            // 2. Calculate a health score that inversely correlates with the severity_score.
            // Severity 0 (Healthy) -> Score 90-100. Severity 95 (Viral) -> Score 5-20.
            let baseScore = 100 - predictionTier.severity_score; 
            
            // Add some random variance to prevent it from being a fixed number
            const variance = (Math.random() * 15) - 7.5; // +/- 7.5 points
            const calculatedScore = Math.min(100, Math.max(1, Math.round(baseScore + variance))); 

            resolve({ score: calculatedScore, diagnosis: predictionTier.name, prediction: predictionTier });
        };
        imageElement.onerror = function() {
             const errorPrediction = TOMATO_DIAGNOSTIC_KB.DISEASE_TIERS.find(d => d.name.includes("Mottling"));
             resolve({ score: 1, diagnosis: `CV Engine Image Load Failed`, prediction: errorPrediction });
        }
        imageElement.src = base64Image;
    });
}

function executePhotoPrediction(base64Image) {
    if (base64Image.includes('mocked_stock_photo_hash') || base64Image.includes('mocked_rover_capture_zone')) {
        const mockMatch = base64Image.match(/diag:([a-zA-Z_()\-]+)/);
        const mockDiseaseName = mockMatch ? mockMatch[1].replace(/_/g, ' ') : "Healthy, Deep Green Foliage";

        let prediction = TOMATO_DIAGNOSTIC_KB.DISEASE_TIERS.find(d => d.name.includes(mockDiseaseName.split('(')[0].trim())) || TOMATO_DIAGNOSTIC_KB.DISEASE_TIERS[4];
        const mockScore = 100 - prediction.severity_score; 
        
        return Promise.resolve({ score: mockScore, diagnosis: prediction.name, prediction: prediction });
    } else {
        return executeCoreCVAnalysis(base64Image);
    }
}


// ==================================================================================
// SECTION 3.0: USER INTERFACE, RENDERING, AND INITIALIZATION (V14.2 FIXES APPLIED)
// ----------------------------------------------------------------------------------

/**
 * 3.1 Master function to trigger the full asynchronous analysis and UI update cycle.
 */
async function triggerComprehensiveAnalysisCycle() {
    const analysisGridContainer = document.getElementById('plantAnalysisGrid');
    
    const hasAnyData = systemLoggedSensorDataArray.length > 0 || Object.keys(currentPhotoAssignmentData).length > 0;
    
    if (!hasAnyData && !historyIsBeingViewed) {
        renderNoDataCards();
        STATUS_ELEMENT.innerText = `DATA FUSION STANDBY: Awaiting initial sensor or photo data. Rover is STANDBY.`;
        return; 
    }
    
    STATUS_ELEMENT.innerText = `DATA FUSION ENGINE: Processing all 16 zones with available data...`;
    analysisGridContainer.innerHTML = '<h2><strong style="color: #58a6ff;">DATA FUSION ENGINE: Processing...</strong></h2>';

    const fusionPromises = FIELD_PLANT_LOCATIONS_M.map(async plant => {
        const sensorData = findNearestSensorDataPoint(plant.x, plant.y);
        const photoBase64 = currentPhotoAssignmentData[plant.id];
        
        let visualResult = null;
        if (photoBase64) {
            visualResult = await executePhotoPrediction(photoBase64); 
        }
        
        return performFinalDataFusionAndDiagnosis(plant, sensorData, visualResult); 
    });

    const finalAnalysesResults = await Promise.all(fusionPromises); 
    analysisGridContainer.innerHTML = ''; 

    finalAnalysesResults.forEach(renderAnalysisCard);

    draw3DMap(); 

    STATUS_ELEMENT.innerText = `DATA FUSION COMPLETE: All 16 zones checked and results rendered. Rover is STANDBY.`;
}

/**
 * CRITICAL V9.0 FIX: Renders 16 specific 'No Data' cards to guarantee the Analysis Grid visibility.
 */
function renderNoDataCards() {
    const analysisGridContainer = document.getElementById('plantAnalysisGrid');
    analysisGridContainer.innerHTML = ''; 
    
    FIELD_PLANT_LOCATIONS_M.forEach(plant => {
        const analysisResult = {
            id: plant.id,
            fusedScore: 'N/A',
            preAssessmentVisual: "Leaf Pre-Assessment: No Photo Taken.",
            preAssessmentSensor: "Soil Data: Sensor Data Missing (N/A) - **HIGH PRIORITY GAP**",
            partialRecommendation: "N/A (Awaiting Photo)",
            finalRecommendation: "Awaiting photo assignment or sensor log in this zone. Please collect data to generate a diagnosis.",
            healthClassification: 'rec-no-data'
        };

        const noDataCardHTML = `
        <div class="analysis-card" style="border: 2px solid #58a6ff;">
            <div class="plant-id-label">ZONE ${analysisResult.id} DIAGNOSTIC REPORT</div>
            <div class="assessment-section pre-assessment">
                <strong>Data Status:</strong>
                <p>Status: **Awaiting Data Collection**</p>
                <p>Action: **${analysisResult.finalRecommendation}**</p>
            </div>
            <hr style="border-top: 2px solid #30363d; margin: 25px 0;">
            <div class="assessment-section final-recommendation">
                <strong>FINAL COMPOSITE HEALTH SCORE:</strong> 
                <span class="${analysisResult.healthClassification}">N/A</span>
                <h4 style="color: #c9d1d9; margin-top: 20px;">Priority Action:</h4>
                <span class="${analysisResult.healthClassification}">Begin data acquisition (take photo or log sensor reading).</span>
            </div>
        </div>
        `;
        analysisGridContainer.insertAdjacentHTML('beforeend', noDataCardHTML);
    });
}

function renderAnalysisCard(analysisResult) {
    const analysisGridContainer = document.getElementById('plantAnalysisGrid');
    
    // Check if both sensor and photo data are missing
    if (analysisResult.healthClassification === 'rec-no-data') {
        const noDataCardHTML = `
        <div class="analysis-card" style="border: 2px solid #58a6ff;">
            <div class="plant-id-label">ZONE ${analysisResult.id} DIAGNOSTIC REPORT</div>
            <div class="assessment-section pre-assessment">
                <strong>Data Status:</strong>
                <p>Status: **Awaiting Data Collection**</p>
                <p>Action: **${analysisResult.finalRecommendation}**</p>
            </div>
            <hr style="border-top: 2px solid #30363d; margin: 25px 0;">
            <div class="assessment-section final-recommendation">
                <strong>FINAL COMPOSITE HEALTH SCORE:</strong> 
                <span class="${analysisResult.healthClassification}">N/A</span>
                <h4 style="color: #c9d1d9; margin-top: 20px;">Priority Action:</h4>
                <span class="${analysisResult.healthClassification}">Begin data acquisition (take photo or log sensor reading).</span>
            </div>
        </div>
        `;
        analysisGridContainer.insertAdjacentHTML('beforeend', noDataCardHTML);
        return;
    }
    
    const isPartial = analysisResult.preAssessmentSensor.includes('Missing');
    
    const partialRecHtml = (analysisResult.partialRecommendation && analysisResult.partialRecommendation !== "N/A (Awaiting Photo)") ? 
        `<h4 style="color: #79c0ff; margin-top: 15px;">Partial Recommendation (Visual Only):</h4><p>${analysisResult.partialRecommendation}</p>` : 
        `<p style="color: #f08047;">Partial Recommendation Awaiting Photo.</p>`;


    const cardHTML = `
    <div class="analysis-card">
        <div class="plant-id-label">ZONE ${analysisResult.id} DIAGNOSTIC REPORT</div>
        <div class="assessment-section pre-assessment">
            <strong>1. Leaf Pre-Assessment (CV Engine - Visual Health)</strong>
            <p>${analysisResult.preAssessmentVisual}</p>
            ${partialRecHtml}
        </div>
        <div class="assessment-section pre-assessment">
            <strong>2. Soil Sensor Pre-Assessment (Arduino R3 Data Log)</strong>
            <p>${analysisResult.preAssessmentSensor}</p>
        </div>
        <hr style="border-top: 2px solid #30363d; margin: 25px 0;">
        <div class="assessment-section final-recommendation">
            <strong>3. FINAL COMPOSITE HEALTH SCORE (${isPartial ? 'PARTIAL - MAX 50%' : 'FUSED'}):</strong> 
            <span class="${analysisResult.healthClassification}">${analysisResult.fusedScore}/100</span>
            <h4 style="color: #c9d1d9; margin-top: 20px;">Final Action Recommendation (Priority Action):</h4>
            <span class="${analysisResult.healthClassification}">${analysisResult.finalRecommendation}</span>
        </div>
    </div>
    `;
    analysisGridContainer.insertAdjacentHTML('beforeend', cardHTML);
}

/**
 * CRITICAL V14.1 FIX: The change handler for the transparent file input.
 * Relies on currentlySelectedPlantZone being set by the cell's onclick handler.
 */
function handleFileSelect(event) {
    const file = event.target.files[0];
    const targetZoneId = currentlySelectedPlantZone;
    
    // Check if the input used was one of the dynamic ones
    if (!file || targetZoneId === 0) {
        STATUS_ELEMENT.innerText = "NOTICE: File selection canceled or target zone lost. Please click a Zone cell first.";
        return;
    }

    STATUS_ELEMENT.innerText = `Processing file ${file.name} for Zone ${targetZoneId}... (Reading base64)`;
    
    try {
        const reader = new FileReader();
        reader.onload = function(e) {
            const base64Image = e.target.result;
            currentPhotoAssignmentData[targetZoneId] = base64Image;
            renderPhotoInPhotoGridCell(targetZoneId, base64Image);
            
            STATUS_ELEMENT.innerText = `SUCCESS: Photo **${file.name}** uploaded successfully to Zone ${targetZoneId}. Triggering Fused Analysis...`;
            
            // Clear the file input value so the same file can be selected again
            event.target.value = ''; 
            
            // Analysis is triggered
            triggerComprehensiveAnalysisCycle(); 
        };
        
        reader.onerror = function(e) {
            STATUS_ELEMENT.innerText = `CRITICAL READ ERROR: Failed to read file for Zone ${targetZoneId}. Error: ${e.target.error.name}`;
        };

        reader.readAsDataURL(file);
    } catch(e) {
        STATUS_ELEMENT.innerText = `CRITICAL JS ERROR: An exception occurred during file reading. ${e.message}`;
    }
}

// ------------------------------------------
// HISTORY FUNCTIONS 
// ------------------------------------------

/**
 * CRITICAL FIX: Opens the history modal and populates the list.
 */
function openHistoryRetrievalModal() {
    const historyList = document.getElementById('trialHistoryList');
    historyList.innerHTML = '';
    
    if (trialHistoryRecords.length === 0) {
        historyList.innerHTML = '<p style="font-size: 1.2em; color: #f08047;">No saved trials found in local storage. Start logging data to create a history preset.</p>';
    } else {
        // Render from newest to oldest
        trialHistoryRecords.slice().reverse().forEach(trial => {
            const item = document.createElement('div');
            item.className = 'trial-item';
            const logsCount = trial.sensorLogs ? trial.sensorLogs.length : 0;
            const photosCount = trial.photoAssignments ? Object.keys(trial.photoAssignments).length : 0;
            
            item.innerHTML = `
                <strong>TRIAL ID: ${trial.id}</strong> - Saved on: ${trial.timestamp}
                <br> Sensor Logs: ${logsCount}, Photo Assignments: ${photosCount}
            `;
            item.onclick = () => loadTrialFromHistory(trial.id);
            historyList.appendChild(item);
        });
    }
    
    HISTORY_MODAL.style.display = "block";
    historyIsBeingViewed = true;
    STATUS_ELEMENT.innerText = `History modal opened. Displaying ${trialHistoryRecords.length} saved presets.`;
}

function closeHistoryModal() {
    HISTORY_MODAL.style.display = "none";
    historyIsBeingViewed = false;
    HISTORY_TRIAL_COUNTER.innerText = currentIncrementalTrialID;
    STATUS_ELEMENT.innerText = `History modal closed. Current Trial ${currentIncrementalTrialID} is now active.`;
}

/**
 * CRITICAL FIX: Loads the saved state from history into the current session.
 */
function loadTrialFromHistory(trialId) {
    const trial = trialHistoryRecords.find(t => t.id === trialId);
    if (!trial) return;
    
    // Load state
    systemLoggedSensorDataArray = trial.sensorLogs || [];
    currentPhotoAssignmentData = trial.photoAssignments || {}; 
    currentRoverKinematicState = trial.roverState || {latitude: 'N/A', longitude: 'N/A', heading: 0.0, x_position_m: 2.0, y_position_m: 2.0};
    
    // Update UI components
    updateMapVisualization();
    draw3DMap();
    generatePhotoGrid(); 
    
    // Restore Analysis Grid from the saved HTML
    document.getElementById('plantAnalysisGrid').innerHTML = trial.aiData.analysisGridHTML || '<h2><strong style="color: #79c0ff;">HISTORICAL DATA RESTORED.</strong> This trial had no final analysis data.</h2>'; 
    
    // Restore sensor data display
    const lastLog = systemLoggedSensorDataArray[systemLoggedSensorDataArray.length - 1];
    if (lastLog) {
        document.getElementById('moistureData').innerText = `${lastLog.moisture}%`;
        document.getElementById('npkData').innerText = `N:${lastLog.npk_n}, P:${lastLog.npk_p}, K:${lastLog.npk_k}`;
    } else {
        document.getElementById('moistureData').innerText = 'N/A';
        document.getElementById('npkData').innerText = 'N/A';
    }

    // Restore GPS/Kinematics display (using state values if available, otherwise 'N/A' from init)
    document.getElementById('latitudeData').innerText = currentRoverKinematicState.latitude;
    document.getElementById('longitudeData').innerText = currentRoverKinematicState.longitude;
    document.getElementById('headingData').innerText = currentRoverKinematicState.heading + ' deg';
    document.getElementById('gpsFix').innerText = 'Historical Log';
    
    STATUS_ELEMENT.innerText = `SUCCESS: Loaded data for Trial ${trialId}.`;
    HISTORY_TRIAL_COUNTER.innerText = `${currentIncrementalTrialID} (VIEWING ${trialId})`;
    closeHistoryModal();
}

// ------------------------------------------
// Standard UI/Map/3D Functions
// ------------------------------------------

function executeTrialSaveOperation() {
    if (trialHistoryRecords.length >= MAX_HISTORY_TRIALS) {
        trialHistoryRecords.shift(); 
    }

    const trialDataRecord = {
        id: currentIncrementalTrialID,
        timestamp: new Date().toLocaleString(),
        roverState: { ...currentRoverKinematicState },
        sensorLogs: [...systemLoggedSensorDataArray],
        photoAssignments: JSON.parse(JSON.stringify(currentPhotoAssignmentData)), 
        aiData: {
            analysisGridHTML: document.getElementById('plantAnalysisGrid').innerHTML 
        }
    };
    
    trialHistoryRecords.push(trialDataRecord);
    localStorage.setItem('trialHistory', JSON.stringify(trialHistoryRecords));
    STATUS_ELEMENT.innerText = `TRIAL SAVE COMPLETE: Trial ${currentIncrementalTrialID} saved. Starting new session...`;
    
    systemLoggedSensorDataArray = [];
    currentPhotoAssignmentData = {};
    currentIncrementalTrialID++;
    HISTORY_TRIAL_COUNTER.innerText = currentIncrementalTrialID;
    resetSensorAndMapData(true);
    triggerComprehensiveAnalysisCycle(); 
}

/**
 * CRITICAL V14.1 FIX: Handles zone selection via a simple click on the cell.
 */
function generatePhotoGrid() {
    const grid = document.getElementById('photoGrid');
    grid.innerHTML = ''; // Clear all existing cells

    for (let i = 1; i <= 16; i++) {
        const cell = document.createElement('div');
        cell.className = 'grid-cell';
        cell.id = `zone-cell-${i}`;
        cell.style.position = 'relative'; 
        
        // 1. Set Zone Selection on simple click (NEW/FIXED LOGIC)
        cell.onclick = function() {
            currentlySelectedPlantZone = i;
            CURRENT_ZONE_SELECTION_DISPLAY.innerText = i;
            document.getElementById('modalCurrentZoneSelection').innerText = i;
            STATUS_ELEMENT.innerText = `Zone ${i} selected as the target. Click the Zone cell again to upload a photo, or use the Stock Gallery.`;
        };
        
        // 2. Embedded File Input (ONLY triggers file selection, relies on zone being set by cell.onclick)
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = 'image/*';
        fileInput.id = `fileInput-${i}`; 
        
        fileInput.style.cssText = `
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0; 
            cursor: pointer;
            z-index: 5; 
        `;
        
        // **IMPORTANT:** The handler assumes `currentlySelectedPlantZone` is already set.
        fileInput.onchange = handleFileSelect;
        
        // 3. Add UI Elements (Label and Delete Button)
        cell.innerHTML = `
        <span class="cell-label">Zone ${i}</span>
        <button class="delete-photo-btn" onclick="event.stopPropagation(); deletePhoto(${i})">X</button>
        `;
        
        cell.appendChild(fileInput);
        grid.appendChild(cell);
        
        if (currentPhotoAssignmentData[i]) {
             renderPhotoInPhotoGridCell(i, currentPhotoAssignmentData[i]);
        }
    }
}

function renderPhotoInPhotoGridCell(zoneId, base64Image) {
    const cell = document.getElementById(`zone-cell-${zoneId}`);
    
    // Remove all children *except* the file input and delete button/label
    Array.from(cell.children).forEach(child => {
        if (!child.classList.contains('delete-photo-btn') && !child.classList.contains('cell-label') && child.type !== 'file') {
            cell.removeChild(child);
        }
    });

    const img = document.createElement('img');
    img.src = base64Image;
    img.style.width = '100%';
    img.style.height = '100%';
    img.style.objectFit = 'cover';
    img.style.position = 'absolute';
    img.style.top = '0';
    img.style.left = '0';
    img.style.zIndex = '1'; // Below the input/delete button

    cell.appendChild(img);
    
    // Bring the label and delete button back to the front
    const label = cell.querySelector('.cell-label');
    const deleteBtn = cell.querySelector('.delete-photo-btn');
    if (label) label.style.zIndex = 10;
    if (deleteBtn) deleteBtn.style.zIndex = 10;
}

function deletePhoto(zoneId) {
    delete currentPhotoAssignmentData[zoneId];
    // Re-render the cell without the image
    const cell = document.getElementById(`zone-cell-${zoneId}`);
    
    // Remove all children *except* the file input and delete button/label
    Array.from(cell.children).forEach(child => {
        if (child.tagName === 'IMG') {
            cell.removeChild(child);
        }
    });

    // Reset the cell text
    const label = cell.querySelector('.cell-label');
    label.innerText = `Zone ${zoneId}`;

    // Clear the file input value so the user can upload a new photo
    const fileInput = document.getElementById(`fileInput-${zoneId}`);
    if (fileInput) fileInput.value = '';

    STATUS_ELEMENT.innerText = `Photo cleared from Zone ${zoneId}. Re-running analysis...`;
    triggerComprehensiveAnalysisCycle();
}

function populateStockPhotos() {
    if (Object.keys(stockPhotoLibraryData).length === MAX_STOCK_PHOTOS) return;
    const diseaseList = TOMATO_DIAGNOSTIC_KB.DISEASE_TIERS;
    for (let i = 1; i <= MAX_STOCK_PHOTOS; i++) {
        const diseaseIndex = i % diseaseList.length;
        const diseaseName = diseaseList[diseaseIndex].name;
        // Mock image with diagnostic info embedded in base64 string
        const base64 = `data:image/svg+xml;base64,mocked_stock_photo_hash_${i}_diag:${diseaseName.replace(/\s/g, '_').replace(/[()]/g, '')}`;
        stockPhotoLibraryData[i] = base64;
    }
}

/**
 * CRITICAL V14.1 FIX: Removed the restrictive check.
 */
function openStockImageGalleryModal() {
    populateStockPhotos();
    renderStockImageGrid();
    STOCK_MODAL.style.display = "block";
    
    const zoneText = currentlySelectedPlantZone !== 0 ? currentlySelectedPlantZone : "N/A";
    document.getElementById('modalCurrentZoneSelection').innerText = zoneText;
    
    if (currentlySelectedPlantZone === 0) {
        STATUS_ELEMENT.innerText = "Stock Photo Gallery opened. **Please select a Zone on the main control panel** before choosing a stock photo.";
    } else {
        STATUS_ELEMENT.innerText = `Stock Photo Gallery opened. Select a photo to assign to target Zone ${currentlySelectedPlantZone}.`;
    }
}

function closeStockImageGalleryModal() {
    STOCK_MODAL.style.display = "none";
    STATUS_ELEMENT.innerText = "Stock Photo Gallery closed. Rover Control System Online.";
}

function renderStockImageGrid() {
    const stockGrid = document.getElementById('stockImageGrid');
    stockGrid.innerHTML = '';
    
    for (let i = 1; i <= MAX_STOCK_PHOTOS; i++) {
        const base64 = stockPhotoLibraryData[i];
        const cell = document.createElement('div');
        cell.className = 'grid-cell';
        cell.style.border = 'none';
        cell.onclick = () => assignStockPhotoToZone(i);

        const img = document.createElement('img');
        img.src = base64; 
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.objectFit = 'cover';
        
        const label = document.createElement('div');
        label.style.position = 'absolute';
        label.style.bottom = '0';
        label.style.right = '0';
        label.style.backgroundColor = 'rgba(255,215,0,0.8)';
        label.style.color = '#000';
        label.style.padding = '3px 5px';
        label.style.fontSize = '0.7em';
        label.innerText = `ID ${i}`;

        cell.appendChild(img);
        cell.appendChild(label);
        stockGrid.appendChild(cell);
    }
}

function assignStockPhotoToZone(stockId) {
    if (currentlySelectedPlantZone === 0) {
        alert("ERROR: Please click one of the 16 Plant Zones on the main screen first to set the assignment target.");
        return;
    }
    
    const base64Image = stockPhotoLibraryData[stockId];
    const targetZoneId = currentlySelectedPlantZone;

    currentPhotoAssignmentData[targetZoneId] = base64Image;
    renderPhotoInPhotoGridCell(targetZoneId, base64Image);
    
    STATUS_ELEMENT.innerText = `Stock Photo ID ${stockId} assigned to Zone ${targetZoneId}. Triggering Fused Analysis.`;
    
    closeStockImageGalleryModal();
    triggerComprehensiveAnalysisCycle();
}

function executeAllHistoryClearance() {
    if (confirm("üö® ARE YOU ABSOLUTELY SURE? This action will permanently delete ALL saved trial history (50 presets).")) {
        localStorage.removeItem('trialHistory');
        trialHistoryRecords = [];
        currentIncrementalTrialID = 1;
        HISTORY_TRIAL_COUNTER.innerText = currentIncrementalTrialID;
        closeHistoryModal();
        STATUS_ELEMENT.innerText = "All trial history cleared. Starting fresh Trial 1.";
    }
}

function findNearestPlantZone(x_m, y_m) {
    let nearest = null;
    let min_dist_sq = Infinity;

    FIELD_PLANT_LOCATIONS_M.forEach(plant => {
        let dx = plant.x - x_m;
        let dy = plant.y - y_m;
        let dist_sq = dx * dx + dy * dy;

        if (dist_sq < min_dist_sq) {
            min_dist_sq = dist_sq;
            nearest = plant;
        }
    });
    return nearest;
}

function resetSensorAndMapData(fullReset = true) {
    if (fullReset) {
        systemLoggedSensorDataArray = [];
        currentPhotoAssignmentData = {};
        document.getElementById('moistureData').innerText = 'N/A';
        document.getElementById('npkData').innerText = 'N/A';
        document.getElementById('latitudeData').innerText = 'N/A';
        document.getElementById('longitudeData').innerText = 'N/A';
        document.getElementById('headingData').innerText = 'N/A';
        document.getElementById('gpsFix').innerText = 'N/A';
        document.getElementById('thingspeakStatus').innerText = 'Awaiting Connection';
        
        currentlySelectedPlantZone = 0;
        CURRENT_ZONE_SELECTION_DISPLAY.innerText = 'N/A';
    }
    currentRoverKinematicState.x_position_m = 2.0;
    currentRoverKinematicState.y_position_m = 2.0;
    currentRoverKinematicState.heading = 0.0;
    
    updateMapVisualization(); 
    draw3DMap(); 
    
    if (fullReset) {
        generatePhotoGrid();
        historyIsBeingViewed = false;
        CURRENT_ZONE_SELECTION_DISPLAY.innerText = 'N/A';
    }
}

function updateMapVisualization() {
    const ctx = MAP_CONTEXT;
    const size = MAP_CANVAS_PIXELS;
    const scale = size / FIELD_GRID_SIZE_M;

    ctx.clearRect(0, 0, size, size);
    ctx.fillStyle = '#1e1e1e';
    ctx.fillRect(0, 0, size, size);
    ctx.strokeStyle = '#30363d'; 
    ctx.lineWidth = 0.5; 
    for (let i = 0; i <= FIELD_GRID_SIZE_M; i++) {
        ctx.beginPath();
        ctx.moveTo(i * scale, 0);
        ctx.lineTo(i * scale, size);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(0, i * scale);
        ctx.lineTo(size, i * scale);
        ctx.stroke();
    }

    FIELD_PLANT_LOCATIONS_M.forEach(plant => {
        const x_pix = plant.x * scale;
        const y_pix = size - (plant.y * scale);
        
        ctx.beginPath();
        ctx.arc(x_pix, y_pix, PLANT_CIRCLE_RADIUS, 0, 2 * Math.PI);
        ctx.fillStyle = '#4ec9b0'; 
        ctx.fill();
    });
    
    systemLoggedSensorDataArray.forEach(data => {
        const x_pix = data.x_m * scale;
        const y_pix = size - (data.y_m * scale);
        
        let color = '#f85149'; 
        if (data.moisture > 35 && data.moisture < 65) color = '#3fb950'; 
        else if (data.moisture >= 25 && data.moisture <= 75) color = '#e3b341'; 

        ctx.beginPath();
        ctx.arc(x_pix, y_pix, 2, 0, 2 * Math.PI); 
        ctx.fillStyle = color;
        ctx.fill();
    });

    const x_r = currentRoverKinematicState.x_position_m * scale;
    const y_r = size - (currentRoverKinematicState.y_position_m * scale);
    const roverSize = 12;
    
    ctx.save();
    ctx.translate(x_r, y_r);
    ctx.rotate(-currentRoverKinematicState.heading * Math.PI / 180); 
    
    ctx.beginPath();
    ctx.moveTo(0, -roverSize); 
    ctx.lineTo(-roverSize * 0.7, roverSize * 0.5); 
    ctx.lineTo(roverSize * 0.7, roverSize * 0.5); 
    ctx.closePath();
    ctx.fillStyle = '#58a6ff'; 
    ctx.fill();
    ctx.strokeStyle = '#ffffff';
    ctx.lineWidth = 1;
    ctx.stroke();
    ctx.restore();
}

// ------------------------------------------
// THREE.JS (3D) Functions
// ------------------------------------------

let scene, camera, renderer, controls;
const cubes = [];

function initThreeD() {
    const container = document.getElementById('threeDContainer');
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x0f131a);
    camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
    camera.position.set(2, 5, 5); 

    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(container.clientWidth, container.clientHeight);
    container.appendChild(renderer.domElement);

    const ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
    scene.add(ambientLight);
    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.9);
    directionalLight.position.set(5, 12, 7.5);
    scene.add(directionalLight);

    controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true; 
    controls.dampingFactor = 0.04;
    controls.minDistance = 2;
    controls.maxDistance = 15;
    
    const gridHelper = new THREE.GridHelper(FIELD_GRID_SIZE_M, FIELD_GRID_SIZE_M, 0x444444, 0x444444);
    gridHelper.position.y = -0.01;
    gridHelper.position.x = FIELD_GRID_SIZE_M / 2;
    gridHelper.position.z = FIELD_GRID_SIZE_M / 2;
    scene.add(gridHelper);
    
    FIELD_PLANT_LOCATIONS_M.forEach(plant => {
        const geometry = new THREE.BoxGeometry(0.8, 0.1, 0.8);
        const material = new THREE.MeshLambertMaterial({ color: 0xcccccc });
        const cube = new THREE.Mesh(geometry, material);
        cube.position.set(plant.x, 0.05, plant.y);
        cube.userData.id = plant.id;
        scene.add(cube);
        cubes.push(cube);
    });

    function animate() {
        requestAnimationFrame(animate);
        controls.update(); 
        renderer.render(scene, camera);
    }
    animate();

    window.addEventListener('resize', onWindowResize, false);
}

function onWindowResize() {
    const container = document.getElementById('threeDContainer');
    camera.aspect = container.clientWidth / container.clientHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(container.clientWidth, container.clientHeight);
}

function draw3DMap() {
    cubes.forEach(cube => {
        const plant = FIELD_PLANT_LOCATIONS_M.find(p => p.id === cube.userData.id);
        const sensorData = findNearestSensorDataPoint(plant.x, plant.y);
        
        let moisture = sensorData ? sensorData.moisture : 0;
        let color = 0xcccccc; 

        if (sensorData) {
            const dummyAnalysis = performFinalDataFusionAndDiagnosis(plant, sensorData, null);
            
            if (dummyAnalysis.healthClassification === 'rec-optimal') color = 0x3fb950;
            else if (dummyAnalysis.healthClassification === 'rec-action') color = 0xe3b341;
            else if (dummyAnalysis.healthClassification === 'rec-critical') color = 0xf85149;
            else color = 0x79c0ff; 
        }
        
        const normalizedHeight = Math.max(0.1, moisture / 100 * 2.5); 
        
        cube.scale.y = normalizedHeight / 0.1; 
        cube.position.y = normalizedHeight / 2;
        (cube.material).color.setHex(color);
    });
}

function updateRover3DPosition() {
    let roverMesh = scene.getObjectByName('rover_model');
    if (!roverMesh) {
        const roverGeometry = new THREE.SphereGeometry(0.15, 16, 16);
        const roverMaterial = new THREE.MeshBasicMaterial({ color: 0x58a6ff });
        roverMesh = new THREE.Mesh(roverGeometry, roverMaterial);
        roverMesh.name = 'rover_model';
        roverMesh.position.y = 0.5;
        scene.add(roverMesh);
    }
    roverMesh.position.x = parseFloat(currentRoverKinematicState.x_position_m);
    roverMesh.position.z = parseFloat(currentRoverKinematicState.y_position_m);
}

// ------------------------------------------
// FINAL INITIALIZATION
// ------------------------------------------

// Small utility for robustness
(function(D){
    D.querySelector = function(s){
        if(s.indexOf(':contains') === -1) return D.querySelector(s);
        let [selector, text] = s.split(':contains');
        text = text.replace(/["()]/g, '');
        return [...D.querySelectorAll(selector)].find(el => el.textContent.includes(text));
    };
    D.querySelectorAll = function(s){
        if(s.indexOf(':contains') === -1) return D.querySelectorAll(s);
        let [selector, text] = s.split(':contains');
        text = text.replace(/["()]/g, '');
        return [...D.querySelectorAll(selector)].filter(el => el.textContent.includes(text));
    };
})(document.constructor.prototype);


function onDocumentReady() {
    initThreeD();
    populateStockPhotos(); 
    generatePhotoGrid();
    resetSensorAndMapData(false); // Do not clear sensor/photo data on soft init
    
    // CRITICAL V9.0 FIX: Guarantee analysis view is rendered with the 16 card structure on load.
    if (systemLoggedSensorDataArray.length === 0 && Object.keys(currentPhotoAssignmentData).length === 0) {
        renderNoDataCards(); // Ensure the UI is populated even with no data
    } else {
        triggerComprehensiveAnalysisCycle(); // Load state if history was found in localStorage
    }
    
    STATUS_ELEMENT.innerText = "SYSTEM BOOT: DOM Ready. Awaiting OpenCV.js initialization for full CV capability.";
}

window.onload = onDocumentReady;

function onOpenCvReady() {
    openCvLibraryIsReady = true;
    STATUS_ELEMENT.innerText = "System Status: OpenCV.js Library Initialized. Rover Control System Fully Operational.";
}
</script>
</body>
</html>
