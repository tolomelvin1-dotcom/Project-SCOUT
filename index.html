<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>S.C.O.U.T. Rover Full-Spectrum Data Fusion & Control Console (V5 - MAXIMAL REVISION)</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://unpkg.com/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
<script async src="https://docs.opencv.org/4.x/opencv.js" onload="onOpenCvReady();"></script>
<style>
/* =================================================================
   SECTION 0.1: CRITICAL SYSTEM-WIDE CSS STYLES (Highly Detailed Dark Theme)
   ================================================================= */
body { 
    font-family: 'Consolas', 'Segoe UI', monospace; 
    margin: 0; 
    padding: 25px; 
    background-color: #0c1015; /* Deeper background */
    color: #c9d1d9; 
    transition: background-color 0.5s;
    line-height: 1.5; /* Enhanced readability */
}
.container {
    max-width: 1800px; /* Further expanded width */
    margin: auto;
    background: #161b22; 
    padding: 40px;
    border-radius: 18px;
    box-shadow: 0 12px 30px rgba(0,0,0,0.9);
    display: flex;
    flex-wrap: wrap; 
    border: 1px solid #30363d;
}

/* LAYOUT AND PANEL DEFINITION (Ensuring Robust Flex Behavior) */
.controls-panel { flex: 1; min-width: 400px; padding-right: 35px; border-right: 1px dashed #30363d; }
.map-panel { flex: 1; min-width: 480px; padding: 0 35px; }
.photo-panel { flex: 1; min-width: 480px; padding-left: 35px; border-left: 1px dashed #30363d; }
.map-3d-panel { flex-basis: 100%; min-width: 100%; margin-top: 40px; padding-top: 20px; border-top: 3px solid #30363d; }
.plant-analysis-panel {
    flex-basis: 100%; 
    margin-top: 50px;
    padding-top: 30px;
    border-top: 3px solid #30363d;
}

/* Typography and Status Indicators */
h1 { color: #58a6ff; border-bottom: 5px double #30363d; padding-bottom: 15px; margin-bottom: 30px; font-size: 2.4em; font-weight: 700; }
h2 { color: #79c0ff; margin-top: 35px; margin-bottom: 15px; font-size: 1.8em; border-bottom: 1px solid #30363d; padding-bottom: 5px; }
h3 { color: #4ac9b0; margin-top: 20px; font-size: 1.3em; }
#status { font-weight: 900; color: #f08047; font-size: 1.2em; display: block; margin-top: 10px; }
.data-display { 
    margin-top: 30px; 
    padding: 25px; 
    border: 2px solid #30363d; 
    border-radius: 12px; 
    background-color: #0f131a; 
    transition: box-shadow 0.3s;
}
.data-display:hover { box-shadow: 0 0 15px rgba(88, 166, 255, 0.2); }
.data-row { margin: 10px 0; }
.data-row strong { 
    display: inline-block; 
    width: 210px; /* Increased width for alignment */
    color: #4ac9b0; 
}

/* Control Buttons (Explicit Color Coding) */
button { 
    padding: 15px 22px; 
    margin: 8px 6px; 
    cursor: pointer; 
    border: none; 
    border-radius: 10px; 
    font-weight: bold; 
    transition: background-color 0.3s ease, transform 0.1s, box-shadow 0.3s; 
    letter-spacing: 1px;
    font-size: 1.05em;
    text-transform: uppercase;
    box-shadow: 0 4px 6px rgba(0,0,0,0.4);
}
button:hover { transform: translateY(-2px); box-shadow: 0 6px 10px rgba(0,0,0,0.6); }
.move-controls button { background-color: #58a6ff; color: #0d1117; } 
.arm-controls button { background-color: #3fb950; color: #0d1117; } 
.history-controls button { background-color: #e3b341; color: #0d1117; } 
.photo-controls button { background-color: #f08047; color: #0d1117; }

/* MAP STYLES */
#roverMap {
    border: 4px solid #58a6ff;
    border-radius: 5px;
    background-color: #0f131a;
}

/* GRID STYLES (4x4 Zones) */
#photoGrid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    grid-template-rows: repeat(4, 1fr);
    gap: 8px;
    border: 3px solid #58a6ff;
    max-width: 480px; /* Increased size */
    margin: 25px auto;
    aspect-ratio: 1 / 1;
    background-color: #0f131a;
}
.grid-cell {
    background-color: #21262d;
    border: 1px solid #3fb950;
    position: relative;
    cursor: pointer;
    overflow: hidden;
    aspect-ratio: 1/1;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 0.9em;
    font-weight: bold;
    color: #4ac9b0;
    transition: border 0.2s;
}
.grid-cell:hover { border: 3px solid #79c0ff; }

/* ANALYSIS CARD STYLING */
#plantAnalysisGrid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(480px, 1fr)); /* Maximized card size */
    gap: 35px;
    margin-top: 30px;
}
.analysis-card {
    padding: 30px;
    border-radius: 15px;
    background-color: #21262d;
    box-shadow: 0 8px 20px rgba(0,0,0,0.7);
}
.plant-id-label {
    font-size: 2.0em;
    font-weight: 900;
    color: #ffd700;
    border-bottom: 4px dashed #30363d;
    padding-bottom: 12px;
    margin-bottom: 20px;
}
.assessment-section { margin-bottom: 25px; padding: 20px; border-radius: 10px; }

/* Visual Pre-Assessment (Greenish, then assist) */
.pre-assessment { border: 2px dashed #58a6ff; background-color: rgba(88, 166, 255, 0.1); }
/* Final Fused Recommendation */
.final-recommendation { border: 4px solid #3fb950; background-color: rgba(63, 185, 80, 0.15); }

/* Recommendation Coloring */
.rec-optimal, .rec-action, .rec-critical {
    padding: 12px;
    border-radius: 8px;
    display: block;
    font-weight: bold;
    margin-top: 15px;
    font-size: 1.1em;
}
.rec-optimal { background-color: #3fb950; color: #0d1117; }
.rec-action { background-color: #e3b341; color: #0d1117; }
.rec-critical { background-color: #f85149; color: #0d1117; }

/* MODAL AND HISTORY LIST STYLES (50 Presets) */
.modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.95); }
.modal-content { background-color: #161b22; margin: 3% auto; padding: 50px; border: 3px solid #30363d; width: 95%; max-width: 1500px; border-radius: 20px; }
.close-btn { color: #aaa; float: right; font-size: 45px; font-weight: bold; }
.trial-item { 
    padding: 18px; 
    margin-bottom: 10px; 
    background-color: #0f131a; 
    border-radius: 10px; 
    cursor: pointer; 
    transition: background-color 0.3s;
    border-left: 5px solid #e3b341;
}
.trial-item:hover { background-color: #21262d; border-left: 5px solid #79c0ff; }
#stockImageGrid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); 
    gap: 15px;
    max-width: 100%;
    margin-top: 25px;
    border: 1px solid #30363d;
    padding: 15px;
    border-radius: 10px;
}
</style>
</head>
<body>
<div class="container">
<div class="controls-panel">
    <h1>S.C.O.U.T. Rover Control & Telemetry Bridge</h1>
    <p>System Diagnostic Status: <span id="status">AWAITING OPENCV.JS INITIALIZATION...</span></p>

    <div class="data-display history-controls">
        <h2>Trial Preservation Console (50 Presets Capacity) üíæ  </h2>
        <div class="data-row"><strong>Current System Trial ID:</strong> <span id="currentTrialNumber">1</span></div>
        <p>
            <button onclick="executeTrialSaveOperation()"> üíæ  EXECUTE TRIAL SAVE OPERATION</button>
            <button onclick="openHistoryRetrievalModal()"> üìÖ  RETRIEVE HISTORY (MAX 50)</button>
        </p>
        <p><small>Storage Capacity: **${MAX_HISTORY_TRIALS} Historical Presets**. Oldest trial is automatically overwritten upon capacity breach.</small></p>
    </div>

    <div class="data-display move-controls">
        <h2>Rover Translational Control (X/Y Axis)</h2>
        <p>Command Structure: X-Axis (Left/Right), Y-Axis (Forward/Backward)</p>
        <button onclick="dispatchRoverMovementCommand('forward')">FORWARD (Y+)</button>
        <button onclick="dispatchRoverMovementCommand('stop')"> üõë EMERGENCY STOP</button>
        <button onclick="dispatchRoverMovementCommand('backward')">BACKWARD (Y-)</button><br>
        <button onclick="dispatchRoverMovementCommand('left')">LEFT (X-)</button>
        <button onclick="dispatchRoverMovementCommand('right')">RIGHT (X+)</button>
    </div>

    <div class="data-display arm-controls">
        <h2>Data Acquisition (Arduino R3 Sensor Payload)</h2>
        <p>The **ESP32** serves as the critical Wi-Fi bridge to the cloud.</p>
        <button onclick="dispatchRoverMovementCommand('probe')"> üî¨ EXTEND PROBE (SOIL READ)</button>
        <button onclick="dispatchRoverMovementCommand('read_sensors')"> üíß READ ENVIRONMENTAL DATA</button>
        <button onclick="dispatchRoverMovementCommand('read_nav')"> üß≠ ACQUIRE GPS/IMU DATA</button>
    </div>

    <div class="data-display">
        <h2>Real-time Sensor Telemetry (Raw Feed)</h2>
        <h3>Navigation Subsystem</h3>
        <div class="data-row"><strong>Latitude (GPS):</strong> <span id="latitudeData">N/A</span></div>
        <div class="data-row"><strong>Longitude (GPS):</strong> <span id="longitudeData">N/A</span></div>
        <div class="data-row"><strong>GPS Fix Status:</strong> <span id="gpsFix">N/A</span></div>
        <div class="data-row"><strong>Heading (IMU):</strong> <span id="headingData">N/A</span></div>
        <h3>Soil/Environment Subsystem</h3>
        <div class="data-row"><strong>Soil Moisture (%):</strong> <span id="moistureData">N/A</span></div>
        <div class="data-row"><strong>NPK (N, P, K ppm):</strong> <span id="npkData">N/A</span></div>
        <div class="data-row"><strong>ThingSpeak Status:</strong> <span id="thingspeakStatus">Awaiting Connection</span></div>
    </div>
</div>

<div class="map-panel">
    <h2>2D Field Map (4m x 4m Grid - Cleaned Visualization)</h2>
    <p>Grid Key: **White Lines** = 1m x 1m. **Green Circles** = Plant Zones. **Blue Triangle** = Rover Position.</p>
    <canvas id="roverMap" width="480" height="480"></canvas>
    <p style="margin-top: 15px;">
        <button onclick="resetSensorAndMapData()"> üóëÔ∏è CLEAR ALL TRANSIENT MAP DATA</button>
    </p>
</div>

<div class="photo-panel">
    <div class="camera-control data-display">
        <h2>Image Capture & Stock Library</h2>
        <p>To assign a photo, first click a Zone (1-16), then click one of the buttons below.</p>
        <button onclick="dispatchRoverMovementCommand('capture')" class="photo-controls"> üì∏ TRIGGER CAMERA CAPTURE</button>
        <button onclick="document.getElementById('fileInput').click()" class="photo-controls"> ‚¨ÜÔ∏è UPLOAD LOCAL PHOTO</button>
        <button onclick="openStockImageGalleryModal()" class="photo-controls"> üñºÔ∏è VIEW STOCK PHOTOS (50 Presets)</button>
        <p>Last photo status: <span id="lastPhotoStatus">Awaiting Capture...</span></p>
    </div>
    <hr style="border-top: 2px solid #30363d; margin: 30px 0;">
    <h2>Plant Zone Photo Assignments (16 Zones)</h2>
    <p>Click a zone to assign the next photo to it. Current Selection: **Zone <span id="currentZoneSelection">N/A</span>**</p>
    <div id="photoGrid">
    </div>
    <input type="file" id="fileInput" accept="image/*" style="display:none;" onchange="handleFileSelectedByUser(event)">
</div>

<div class="map-3d-panel">
    <h2>3D Soil Metric Visualization üìä (Height=Moisture, Color=Health)</h2>
    <div id="threeDContainer" style="height: 500px; width: 100%;"></div>
</div>

<div class="plant-analysis-panel">
    <h2>DATA FUSION ENGINE: Plant-Specific Final Diagnosis (16 Zones) üî¨ </h2>
    <p>This panel displays the **FUSED** assessment: **Leaf Visual Pre-Assessment (CV) (LOWER WEIGHT)** + **Local Soil Sensor Data (HIGHER WEIGHT)**.</p>
    <div id="plantAnalysisGrid">
        </div>
</div>
</div>

<div id="historyModal" class="modal" onclick="if(event.target.id === 'historyModal') closeHistoryModal()">
    <div class="modal-content">
        <span class="close-btn" onclick="closeHistoryModal()">&times;</span>
        <h2>Saved Trial History Retrieval Console (Maximum Capacity: 50 Presets)</h2>
        <p>Click a trial to restore its exact state (map, photos, and final analysis).</p>
        <div id="trialHistoryList">
        </div>
        <hr style="border-top: 2px solid #30363d; margin-top: 20px;">
        <button onclick="executeAllHistoryClearance()" style="background-color: #f85149;"> üö® EXECUTE ALL SAVED TRIALS CLEARANCE</button>
    </div>
</div>

<div id="stockImageModal" class="modal" onclick="if(event.target.id === 'stockImageModal') closeStockImageGalleryModal()">
    <div class="modal-content">
        <span class="close-btn" onclick="closeStockImageGalleryModal()">&times;</span>
        <h2>Stock Photo Gallery (50 Pre-Diagnosed Leaf Presets)</h2>
        <p>Select a photo to assign it to your currently selected plant zone for CV analysis.</p>
        <div id="stockImageGrid">
        </div>
    </div>
</div>

<script>
// ==================================================================================
// SECTION 0.2: CORE SYSTEM CONSTANTS AND GLOBAL CONFIGURATION (MAX VERBOSITY)
// ==================================================================================

/**
 * @fileoverview S.C.O.U.T. Rover Control System JavaScript Core.
 * This script manages hardware communications, data fusion, and visualization.
 * Version 5.0: Enhanced stability, cleaner UI, and maximal structural verbosity.
 */

// --- 0.2.1 HARDWARE AND NETWORK CONFIGURATION (CRITICAL) ---
const HARDWARE_ESP32_IP_ADDRESS = '192.168.1.50';
const ESP32_BASE_URL = `http://${HARDWARE_ESP32_IP_ADDRESS}`;
const THINGSPEAK_API_KEY = '6OXH3SUQ4VNSOJX1'; // CRITICAL: User-provided ThingSpeak Write API Key
const STATUS_REPORT_INTERVAL_MS = 5000; // Interval for system self-check logging

// --- 0.2.2 PHYSICAL SYSTEM AND UI CONSTANTS (STRICT ADHERENCE) ---
const FIELD_GRID_SIZE_M = 4; // 4m x 4m field dimensions
const MAP_CANVAS_PIXELS = 480; // Larger canvas for better map clarity
const MAX_STOCK_PHOTOS = 50; // CRITICAL: Strict 50 presets for the gallery
const MAX_HISTORY_TRIALS = 50; // CRITICAL: Strict 50 presets for history storage capacity
const PLANT_CIRCLE_RADIUS = 5; // Radius for plant markers on 2D map

// --- 0.2.3 DOM ELEMENT REFERENCES (for clarity and maintenance) ---
const STATUS_ELEMENT = document.getElementById('status');
const MOISTURE_DISPLAY_ELEMENT = document.getElementById('moistureData');
const NPK_DISPLAY_ELEMENT = document.getElementById('npkData');
const HISTORY_TRIAL_COUNTER = document.getElementById('currentTrialNumber');
const THINGSPEAK_STATUS_ELEMENT = document.getElementById('thingspeakStatus');
const MAP_CONTEXT = document.getElementById('roverMap').getContext('2d');
const HISTORY_MODAL = document.getElementById('historyModal');
const STOCK_MODAL = document.getElementById('stockImageModal');
const FILE_INPUT_ELEMENT = document.getElementById('fileInput');
const CURRENT_ZONE_SELECTION_DISPLAY = document.getElementById('currentZoneSelection');

// --- 0.2.4 GLOBAL STATE VARIABLES (Clean Initial State) ---
let openCvLibraryIsReady = false;
let systemLoggedSensorDataArray = []; // Array stores historical sensor logs
let currentPhotoAssignmentData = {}; // Object maps Zone ID to Base64 image
let stockPhotoLibraryData = {}; // Object stores 50 stock presets
let currentlySelectedPlantZone = 0; // The 4x4 zone currently clicked by the user
let historyIsBeingViewed = false;

// Rover Kinematic State (Simulation - Initialized Cleanly)
let currentRoverKinematicState = {
    latitude: 'N/A',
    longitude: 'N/A',
    heading: 0.0,
    x_position_m: 2.0, // Starting center (2, 2)
    y_position_m: 2.0
};

// Persistent Storage Management (Ensure 50 preset capacity logic is used)
let trialHistoryRecords = JSON.parse(localStorage.getItem('trialHistory') || '[]');
let currentIncrementalTrialID = trialHistoryRecords.length + 1;
HISTORY_TRIAL_COUNTER.innerText = currentIncrementalTrialID;

// Pre-calculated Plant Locations (16 zones)
const FIELD_PLANT_LOCATIONS_M = [];
for(let r=0; r<FIELD_GRID_SIZE_M; r++) {
    for(let c=0; c<FIELD_GRID_SIZE_M; c++) {
        FIELD_PLANT_LOCATIONS_M.push({x: c + 0.5, y: r + 0.5, id: (r * FIELD_GRID_SIZE_M) + c + 1});
    }
}


// ==================================================================================
// SECTION 1.0: HARDWARE COMMUNICATIONS & THINGSPEAK BRIDGE LOGIC (VERBOSE)
// ==================================================================================

/**
 * 1.1 CRITICAL FUNCTION: Simulates the ESP32 bridging the Arduino R3 sensor data
 * and pushing it to the ThingSpeak Cloud Platform using the provided API key.
 * @param {object} dataPacket - The NPK/Moisture data payload.
 */
function transmitSensorDataViaESP32ToThingSpeak(dataPacket) {
    const apiEndpointUrl = "https://api.thingspeak.com/update";
    THINGSPEAK_STATUS_ELEMENT.innerText = 'TRANSMITTING... (W-Fi Bridge Active)';

    // Construct the URL with the mandatory API Key and field values for the 4 data fields
    const urlPayload = `${apiEndpointUrl}?api_key=${THINGSPEAK_API_KEY}` +
                `&field1=${dataPacket.moisture}` +
                `&field2=${dataPacket.N}` +
                `&field3=${dataPacket.P}` +
                `&field4=${dataPacket.K}`;

    // Note: The 'no-cors' mode is necessary for ThingSpeak GET requests in client-side scripts.
    fetch(urlPayload, { method: 'GET', mode: 'no-cors' })
        .then(() => {
            THINGSPEAK_STATUS_ELEMENT.innerText = `SUCCESS: Data pushed to Cloud (Moisture=${dataPacket.moisture}).`;
        })
        .catch(error => {
            THINGSPEAK_STATUS_ELEMENT.innerText = `ERROR: ThingSpeak Transmission Failed. (Key: ${THINGSPEAK_API_KEY.substring(0, 4)}...). Check network logs.`;
            console.error("ThingSpeak Transmission Error (Expected in non-CORS dev env):", error);
        });
}

/**
 * 1.2 DISPATCH: Sends a simulated command to the ESP32 bridge.
 * @param {string} commandIdentifier - The action to perform (e.g., 'forward', 'probe', 'capture').
 */
function dispatchRoverMovementCommand(commandIdentifier) {
    STATUS_ELEMENT.innerText = `DISPATCH: Sending command '${commandIdentifier}' to ESP32 Bridge... (Simulating radio link latency)`;
    
    // --- SIMULATED ASYNCHRONOUS RESPONSE (750ms latency for realism) ---
    setTimeout(() => {
        STATUS_ELEMENT.innerText = `RESPONSE: Command '${commandIdentifier}' Acknowledged by ESP32.`;

        if (commandIdentifier.startsWith('read_') || commandIdentifier === 'probe') {
            executeDataAcquisition(commandIdentifier); // Trigger sensor read from Arduino R3
        } else if (commandIdentifier === 'capture') {
            document.getElementById('lastPhotoStatus').innerText = 'Photo captured successfully (Simulated high-res asset).';
            const nearestPlant = findNearestPlantZone(currentRoverKinematicState.x_position_m, currentRoverKinematicState.y_position_m);
            if (nearestPlant && currentlySelectedPlantZone !== 0) {
                // Ensure photo is assigned to the CURRENTLY SELECTED zone, not just the nearest
                const targetZoneId = currentlySelectedPlantZone;
                // Mock capture: uses a deterministic hash for consistent analysis
                currentPhotoAssignmentData[targetZoneId] = `data:image/jpeg;base64,mocked_rover_capture_zone_${targetZoneId}_diag:General_Severe_Yellowing_(Chlorosis-N)`;
                renderPhotoInPhotoGridCell(targetZoneId, currentPhotoAssignmentData[targetZoneId]);
                // Clear selection after capture
                handleZoneSelection(0); 
            } else if (currentlySelectedPlantZone === 0) {
                STATUS_ELEMENT.innerText = "WARNING: No plant zone selected. Photo taken but not assigned.";
            }
            triggerComprehensiveAnalysisCycle();
        } else {
             // Simulate Rover Kinematics Update (0.1m step)
             const step = 0.1;
             if (commandIdentifier === 'forward') currentRoverKinematicState.y_position_m = Math.min(FIELD_GRID_SIZE_M, parseFloat(currentRoverKinematicState.y_position_m) + step).toFixed(2);
             if (commandIdentifier === 'backward') currentRoverKinematicState.y_position_m = Math.max(0, parseFloat(currentRoverKinematicState.y_position_m) - step).toFixed(2);
             if (commandIdentifier === 'left') currentRoverKinematicState.x_position_m = Math.max(0, parseFloat(currentRoverKinematicState.x_position_m) - step).toFixed(2);
             if (commandIdentifier === 'right') currentRoverKinematicState.x_position_m = Math.min(FIELD_GRID_SIZE_M, parseFloat(currentRoverKinematicState.x_position_m) + step).toFixed(2);
             updateMapVisualization();
             updateRover3DPosition();
        }
    }, 750);
}

/**
 * 1.3 ACQUISITION: Executes the sensor reading process, simulating data from the Arduino R3.
 * Initializes data if all are 'N/A', otherwise generates new realistic readings.
 */
function executeDataAcquisition(acquisitionType) {
    STATUS_ELEMENT.innerText = "SENSOR READ: Acquiring raw data from Arduino R3 sensor payload...";
    
    // --- Simulate Realistic Sensor Data (Based on a random distribution) ---
    const moistureVal = (Math.random() * 80 + 10).toFixed(1);
    const npk_n = Math.floor(Math.random() * 150 + 50);
    const npk_p = Math.floor(Math.random() * 100 + 40);
    const npk_k = Math.floor(Math.random() * 180 + 60);

    // Update Live Display Elements
    MOISTURE_DISPLAY_ELEMENT.innerText = `${moistureVal}%`;
    NPK_DISPLAY_ELEMENT.innerText = `N:${npk_n}, P:${npk_p}, K:${npk_k}`;
    document.getElementById('headingData').innerText = (Math.random() * 360).toFixed(1) + ' deg';
    document.getElementById('latitudeData').innerText = `40.7128${(Math.random()*100).toFixed(0)}`;
    document.getElementById('longitudeData').innerText = `-74.0060${(Math.random()*100).toFixed(0)}`;
    document.getElementById('gpsFix').innerText = '3D Fix Acquired';

    // 1. Send data to ThingSpeak (ESP32 Bridge Action)
    transmitSensorDataViaESP32ToThingSpeak({ 
        moisture: parseFloat(moistureVal), 
        N: npk_n, 
        P: npk_p, 
        K: npk_k 
    });

    if (acquisitionType === 'probe' || acquisitionType === 'read_sensors') {
        // 2. Log data for Fused Analysis
        systemLoggedSensorDataArray.push({
            x_m: parseFloat(currentRoverKinematicState.x_position_m),
            y_m: parseFloat(currentRoverKinematicState.y_position_m),
            moisture: parseFloat(moistureVal),
            npk_n: npk_n, 
            npk_p: npk_p, 
            npk_k: npk_k
        });
        
        STATUS_ELEMENT.innerText = `SENSOR READ: Data logged. ThingSpeak push complete. Triggering Analysis...`;
        triggerComprehensiveAnalysisCycle();
    }
    updateMapVisualization();
    draw3DMap(); 
}


// ==================================================================================
// SECTION 2.0: DIAGNOSTIC KNOWLEDGE BASE & FUSED ANALYSIS CORE
// ==================================================================================

// 2.1 TOMATO DIAGNOSTIC KNOWLEDGE BASE (EXPANDED FOR VERBOSITY)
const TOMATO_DIAGNOSTIC_KB = {
    DISEASE_TIERS: [
        { name: "Mottling/Mosaic Pattern (Viral-TMV)", severity_score: 95, class: 'rec-critical', 
          recommendation: "CRITICAL ISOLATION REQUIRED: Strong indicator of Tobacco Mosaic Virus (TMV). **IMMEDIATELY REMOVE AND DESTROY** the plant to prevent field-wide contamination. No chemical cure exists." },
        { name: "Dark Spots & Lesions (Fungal/Bacterial)", severity_score: 85, class: 'rec-critical', 
          recommendation: "FUNGICIDE/BACTERICIDE APPLICATION: Likely Early Blight or Bacterial Spot. Apply broad-spectrum copper-based fungicide and focus on improving air circulation to reduce humidity." },
        { name: "General Severe Yellowing (Chlorosis-N)", severity_score: 50, class: 'rec-action', 
          recommendation: "NPK DEFICIENCY LIKELY: Check current NPK data for confirmation. Severe yellowing often indicates primary Nitrogen (N) deficiency. Adjust fertilizer immediately." },
        { name: "Healthy, Deep Green Foliage", severity_score: 0, class: 'rec-optimal', 
          recommendation: "OPTIMAL: No visual symptoms detected. Continue regular monitoring. The overall system health looks excellent based on visual inspection." }
    ],
    NPK_GUIDELINES: {
        moisture: { ideal_min: 40, ideal_max: 60, low_crit: 25, high_crit: 75, penalty_minor: 10, penalty_major: 30, low_rec: "deep supplemental irrigation", high_rec: "review soil drainage/stop all irrigation" },
        N: { ideal_min: 60, ideal_max: 100, low_crit: 30, high_crit: 150, penalty_minor: 15, penalty_major: 40, low_rec: "high-Nitrogen (N) liquid feed", high_rec: "stop all N-fertilizer, flush soil" },
        P: { ideal_min: 50, ideal_max: 80, low_crit: 20, high_crit: 120, penalty_minor: 10, penalty_major: 25, low_rec: "Phosphorus (P) booster for root development", high_rec: "check fertilizer blend for P excess" },
        K: { ideal_min: 70, ideal_max: 120, low_crit: 40, high_crit: 180, penalty_minor: 10, penalty_major: 25, low_rec: "Potassium (K) to boost resistance/fruit set", high_rec: "check for K salt toxicity" },
    }
};

/**
 * 2.2 COMPUTER VISION: LEAF PRE-ASSESSMENT LOGIC
 * Generates the descriptive summary based ONLY on the visual CV score (Pre-Assessment).
 */
function getVisualPreAssessment(visualScore, diagnosedDiseaseName) {
    const diseaseBaseName = diagnosedDiseaseName.split('(')[0].trim();
    
    // Explicitly generate the conversational pre-assessment based on health tiers
    if (visualScore >= 90) return `Leaf condition: **Greenish/Excellent**. CV Score: ${visualScore}%.`;
    if (visualScore >= 80) return `Leaf is **Healthy**, showing only minor localized discoloration. CV Score: ${visualScore}%.`;
    if (visualScore >= 60) return `Leaf shows **Notable Discoloration**. Assists health as ${diseaseBaseName} is likely. CV Score: ${visualScore}%.`;
    return `**Critical Visual Alert**. Assists health: analysis suggests ${diseaseBaseName} is imminent. CV Score: ${visualScore}%.`;
}

/**
 * 2.3 FUSED ANALYSIS: Locates the most relevant sensor data point near a plant location (within the grid cell).
 */
function findNearestSensorDataPoint(plantX, plantY) {
    let nearestDataPoint = null;
    let minimumDistanceSquared = Infinity;
    const MAX_SEARCH_RADIUS_SQ = 0.707 * 0.707; // 1m diagonal sq

    // Iterate through all logged sensor data points
    systemLoggedSensorDataArray.forEach(dataPoint => {
        let dx = dataPoint.x_m - plantX;
        let dy = dataPoint.y_m - plantY;
        let dist_sq = dx * dx + dy * dy;

        if (dist_sq < MAX_SEARCH_RADIUS_SQ && dist_sq < minimumDistanceSquared) {
            minimumDistanceSquared = dist_sq;
            nearestDataPoint = dataPoint;
        }
    });
    return nearestDataPoint;
}

/**
 * 2.4 CRITICAL FUNCTION: Performs the final, combined analysis (CV + Sensors).
 * Weighting: Soil Sensor Data (Higher Priority) + Visual Data (Lower Priority).
 */
function performFinalDataFusionAndDiagnosis(plant, sensorData, visualResult) {
    let fusedHealthScore = 100;
    let soilHealthPenalties = [];
    let sensorDataSummary = "Soil Data: Sensor Data Missing (N/A) - **HIGH PRIORITY GAP**";
    let visualPreAssessment = "Leaf Pre-Assessment: No Photo Taken.";

    // --- 1. SOIL SENSOR DATA ASSESSMENT (High Priority - Arduino R3 data) ---
    if (sensorData) {
        const { moisture, npk_n, npk_p, npk_k } = sensorData;
        const sensorReadings = { moisture, N: npk_n, P: npk_p, K: npk_k };
        sensorDataSummary = `Soil Readings: M=${moisture}%, NPK=${npk_n}/${npk_p}/${npk_k} (Logged at ${sensorData.x_m}m, ${sensorData.y_m}m)`;

        Object.keys(TOMATO_DIAGNOSTIC_KB.NPK_GUIDELINES).forEach(key => {
            const guideline = TOMATO_DIAGNOSTIC_KB.NPK_GUIDELINES[key];
            const value = sensorReadings[key];
            let penaltyMagnitude = 0;
            let problemClassification = '';

            if (value < guideline.low_crit || value > guideline.high_crit) {
                penaltyMagnitude = guideline.penalty_major;
                problemClassification = `CRITICAL DEVIATION (${key})`;
            } else if (value < guideline.ideal_min || value > guideline.ideal_max) {
                penaltyMagnitude = guideline.penalty_minor;
                problemClassification = `MILD IMBALANCE (${key})`;
            }

            if (problemClassification) {
                fusedHealthScore = Math.max(0, fusedHealthScore - penaltyMagnitude);
                const specificRec = (value < guideline.ideal_min ? guideline.low_rec : guideline.high_rec);
                soilHealthPenalties.push({ key, value, problemClassification, specificRec });
            }
        });
    }

    // --- 2. VISUAL (CV) DATA ASSESSMENT (Lower Weight) ---
    let visualPredictionTier = TOMATO_DIAGNOSTIC_KB.DISEASE_TIERS.find(d => d.name.includes("Healthy"));
    if (visualResult) {
        visualPredictionTier = visualResult.prediction;
        const visualScore = visualResult.score;
        visualPreAssessment = getVisualPreAssessment(visualScore, visualResult.diagnosis);
        
        // **KEY WEIGHTING LOGIC**: Only 20% of the visual deficit is applied to the final score.
        const visualDeficit = 100 - visualScore;
        fusedHealthScore = Math.max(0, fusedHealthScore - (visualDeficit * 0.20)); 
    }

    // --- 3. FINAL FUSED RECOMMENDATION LOGIC (Override Hierarchy) ---
    let finalActionRecommendation = 'Optimal health confirmed. Continue monitoring.';
    let finalHealthClassification = 'rec-optimal';
    
    const isMajorViral = visualPredictionTier.name.includes('Mottling');
    const hasCriticalSoilIssue = soilHealthPenalties.some(p => p.problemClassification.includes('CRITICAL'));
    
    // HIERARCHY 1: VIRAL OVERRIDE (Most Severe)
    if (isMajorViral) {
        finalActionRecommendation = visualPredictionTier.recommendation;
        finalHealthClassification = visualPredictionTier.class;
        fusedHealthScore = Math.min(10, fusedHealthScore); 
    }
    // HIERARCHY 2: CRITICAL SOIL STRESS (High Severity)
    else if (hasCriticalSoilIssue) {
        const criticalProblem = soilHealthPenalties.find(p => p.problemClassification.includes('CRITICAL'));
        finalActionRecommendation = `CRITICAL SOIL ALERT: ${criticalProblem.problemClassification} detected. Urgent Action: ${criticalProblem.specificRec}.`;
        finalHealthClassification = 'rec-critical';
    }
    // HIERARCHY 3: MILD/MODERATE SOIL IMBALANCES (Moderate Severity)
    else if (soilHealthPenalties.length > 0) {
        const recString = soilHealthPenalties.map(p => p.specificRec).join('; ');
        finalActionRecommendation = `CAUTION: Moderate Soil Imbalance. Recommended adjustments: ${recString}`;
        finalHealthClassification = fusedHealthScore <= 70 ? 'rec-action' : 'rec-optimal';
    }
    // HIERARCHY 4: VISUAL-ONLY OR OPTIMAL
    else {
        finalActionRecommendation = visualPredictionTier.recommendation;
        finalHealthClassification = visualPredictionTier.class;
    }

    return {
        id: plant.id,
        fusedScore: Math.round(fusedHealthScore).toFixed(0),
        preAssessmentVisual: visualPreAssessment,
        preAssessmentSensor: sensorDataSummary,
        finalRecommendation: finalActionRecommendation.trim(),
        healthClassification: finalHealthClassification
    };
}


/**
 * 2.5 COMPUTER VISION ENGINE: Core Image Processing Logic (Using Mock/OpenCV)
 * (The full verbose implementation of executeCoreCVAnalysis and executePhotoPrediction
 * is included here for maximum code length, but remains functionally identical
 * to the previous step's logic for processing.)
 */
function executeCoreCVAnalysis(base64Image) {
    if (!openCvLibraryIsReady) {
        const fallbackPrediction = TOMATO_DIAGNOSTIC_KB.DISEASE_TIERS.find(d => d.name.includes("Mottling"));
        return Promise.resolve({ score: 5, diagnosis: "CV Library Not Ready (Delayed Init)", prediction: fallbackPrediction });
    }
    
    return new Promise((resolve) => {
        // [BLOCK OF HIGHLY DETAILED IMAGE LOADING AND CV.JS MANIPULATION]
        const imageElement = document.createElement('img');
        imageElement.onload = function() {
            let src, hsv, green_mask, yellow_mask; 
            try {
                src = cv.imread(imageElement);
                if (src.cols === 0 || src.rows === 0) throw new Error("Image read failure: zero size.");
                hsv = new cv.Mat();
                cv.cvtColor(src, hsv, cv.COLOR_RGBA2HSV);
        
                // Define Green Thresholds (Hue 30-90)
                const green_low = new cv.Mat(hsv.rows, hsv.cols, hsv.type(), [30, 40, 40, 0]);
                const green_high = new cv.Mat(hsv.rows, hsv.cols, hsv.type(), [90, 255, 255, 255]);
                green_mask = new cv.Mat();
                cv.inRange(hsv, green_low, green_high, green_mask);

                // Define Yellow/Chlorosis Thresholds (Hue 15-30)
                const yellow_low = new cv.Mat(hsv.rows, hsv.cols, hsv.type(), [15, 60, 60, 0]);
                const yellow_high = new cv.Mat(hsv.rows, hsv.cols, hsv.type(), [30, 255, 255, 255]);
                yellow_mask = new cv.Mat();
                cv.inRange(hsv, yellow_low, yellow_high, yellow_mask);
                
                green_low.delete(); green_high.delete(); yellow_low.delete(); yellow_high.delete();

                // Calculate Score based on pixel ratios
                const greenPixels = cv.countNonZero(green_mask);
                const unhealthyPixels = cv.countNonZero(yellow_mask);
                const totalAnalyzedPixels = greenPixels + unhealthyPixels;

                let calculatedScore = 100;
                let predictionTier = TOMATO_DIAGNOSTIC_KB.DISEASE_TIERS.find(d => d.name.includes("Healthy"));
                
                if (totalAnalyzedPixels > 500) { 
                    const ratioOfGreen = greenPixels / totalAnalyzedPixels;
                    calculatedScore = Math.max(10, Math.min(100, Math.round(ratioOfGreen * 100)));
                    if (ratioOfGreen < 0.6) predictionTier = TOMATO_DIAGNOSTIC_KB.DISEASE_TIERS.find(d => d.name.includes("Yellowing"));
                } else {
                    calculatedScore = 85;
                }
                
                resolve({ score: calculatedScore, diagnosis: predictionTier.name, prediction: predictionTier });
            } catch (e) {
                console.error("CRITICAL OpenCV Analysis Exception:", e);
                const errorPrediction = TOMATO_DIAGNOSTIC_KB.DISEASE_TIERS.find(d => d.name.includes("Mottling"));
                resolve({ score: 1, diagnosis: `CV Engine Failed: ${e.message}`, prediction: errorPrediction });
            } finally {
                if (src) src.delete();
                if (hsv) hsv.delete();
                if (green_mask) green_mask.delete();
                if (yellow_mask) yellow_mask.delete();
            }
        };
        imageElement.onerror = function() {
            const errorPrediction = TOMATO_DIAGNOSTIC_KB.DISEASE_TIERS.find(d => d.name.includes("Mottling"));
            resolve({ score: 1, diagnosis: "CV Image Load Error (Corrupted Data)", prediction: errorPrediction });
        }
        imageElement.src = base64Image;
    });
}

function executePhotoPrediction(base64Image) {
    if (base64Image.includes('mocked_stock_photo_hash') || base64Image.includes('mocked_rover_capture_zone')) {
        // MOCK PATH: Deterministic diagnosis based on hash for consistency
        const mockMatch = base64Image.match(/diag:([a-zA-Z_()\-]+)/);
        const mockDiseaseName = mockMatch ? mockMatch[1].replace(/_/g, ' ') : "Healthy, Deep Green Foliage";

        let prediction = TOMATO_DIAGNOSTIC_KB.DISEASE_TIERS.find(d => d.name.includes(mockDiseaseName.split('(')[0].trim())) || TOMATO_DIAGNOSTIC_KB.DISEASE_TIERS[3];
        const mockScore = 100 - prediction.severity_score; 
        
        return Promise.resolve({ score: mockScore, diagnosis: prediction.name, prediction: prediction });
    } else {
        // ACTUAL CV PATH
        return executeCoreCVAnalysis(base64Image);
    }
}


// ==================================================================================
// SECTION 3.0: USER INTERFACE, RENDERING, AND INITIALIZATION (CLEANED)
// ==================================================================================

/**
 * 3.1 Master function to trigger the full asynchronous analysis and UI update cycle.
 */
async function triggerComprehensiveAnalysisCycle() {
    const analysisGridContainer = document.getElementById('plantAnalysisGrid');
    analysisGridContainer.innerHTML = '<h2>DATA FUSION ENGINE: Processing. Waiting for all Photo and Sensor data to resolve...</h2>';

    const fusionPromises = FIELD_PLANT_LOCATIONS_M.map(async plant => {
        const sensorData = findNearestSensorDataPoint(plant.x, plant.y);
        const photoBase64 = currentPhotoAssignmentData[plant.id];
        
        let visualResult = null;
        if (photoBase64) {
            visualResult = await executePhotoPrediction(photoBase64); 
        }
        
        return performFinalDataFusionAndDiagnosis(plant, sensorData, visualResult); 
    });

    const finalAnalysesResults = await Promise.all(fusionPromises); 
    analysisGridContainer.innerHTML = ''; 

    finalAnalysesResults.forEach(renderAnalysisCard);

    // Update 3D map based on new health data
    draw3DMap(); 

    STATUS_ELEMENT.innerText = `DATA FUSION COMPLETE: All ${FIELD_PLANT_LOCATIONS_M.length} zones analyzed and results rendered. Rover is STANDBY.`;
}

/**
 * 3.2 Renders a single, verbose analysis card.
 */
function renderAnalysisCard(analysisResult) {
    const analysisGridContainer = document.getElementById('plantAnalysisGrid');
    
    const cardHTML = `
    <div class="analysis-card">
        <div class="plant-id-label">ZONE ${analysisResult.id} DIAGNOSTIC REPORT</div>
        
        <div class="assessment-section pre-assessment">
            <strong>1. Leaf Pre-Assessment (CV Engine - Visual Health)</strong>
            <p>${analysisResult.preAssessmentVisual}</p>
        </div>
        
        <div class="assessment-section pre-assessment">
            <strong>2. Soil Sensor Pre-Assessment (Arduino R3 Data Log)</strong>
            <p>${analysisResult.preAssessmentSensor}</p>
        </div>
        
        <hr style="border-top: 2px solid #30363d; margin: 25px 0;">
        
        <div class="assessment-section final-recommendation">
            <strong>3. FINAL COMPOSITE HEALTH SCORE (FUSED):</strong> 
            <span class="${analysisResult.healthClassification}">${analysisResult.fusedScore}/100</span>
            
            <h4 style="color: #c9d1d9; margin-top: 20px;">Final Action Recommendation (Priority Action):</h4>
            <span class="${analysisResult.healthClassification}">${analysisResult.finalRecommendation}</span>
        </div>
    </div>
    `;
    analysisGridContainer.insertAdjacentHTML('beforeend', cardHTML);
}

// 3.3 PHOTO GRID MANAGEMENT

/**
 * Generates the 4x4 interactive photo grid.
 */
function generatePhotoGrid() {
    const photoGrid = document.getElementById('photoGrid');
    photoGrid.innerHTML = '';
    for (let i = 1; i <= 16; i++) {
        const cell = document.createElement('div');
        cell.className = 'grid-cell';
        cell.id = `zone-cell-${i}`;
        cell.innerText = `Zone ${i} - AWAITING PHOTO`;
        cell.onclick = () => handleZoneSelection(i);
        photoGrid.appendChild(cell);
        
        // Restore photos if they exist in the current session data
        if (currentPhotoAssignmentData[i]) {
             renderPhotoInPhotoGridCell(i, currentPhotoAssignmentData[i]);
        }
    }
}

/**
 * Handles the click event for a specific plant zone.
 */
function handleZoneSelection(zoneId) {
    currentlySelectedPlantZone = zoneId;
    
    // De-highlight all cells
    document.querySelectorAll('.grid-cell').forEach(c => c.style.border = '1px solid #3fb950');

    if (zoneId !== 0) {
        // Highlight the selected cell
        document.getElementById(`zone-cell-${zoneId}`).style.border = '3px solid #ffd700';
        CURRENT_ZONE_SELECTION_DISPLAY.innerText = zoneId;
        STATUS_ELEMENT.innerText = `ACTION REQUIRED: Zone ${zoneId} selected. Proceed to Capture, Upload, or select Stock Photo.`;
    } else {
        CURRENT_ZONE_SELECTION_DISPLAY.innerText = 'N/A';
        STATUS_ELEMENT.innerText = 'Zone selection cleared. Rover Control System Online.';
    }
}

/**
 * Handles file selection from the user's local machine (FIXED: ensures input is used).
 */
function handleFileSelectedByUser(event) {
    const file = event.target.files[0];
    if (!file || currentlySelectedPlantZone === 0) {
        STATUS_ELEMENT.innerText = "ERROR: No file selected or no plant zone chosen. Please select a zone (1-16) first.";
        return;
    }

    STATUS_ELEMENT.innerText = `Processing file ${file.name} for Zone ${currentlySelectedPlantZone}...`;
    const reader = new FileReader();
    reader.onload = function(e) {
        const base64Image = e.target.result;
        currentPhotoAssignmentData[currentlySelectedPlantZone] = base64Image;
        renderPhotoInPhotoGridCell(currentlySelectedPlantZone, base64Image);
        
        STATUS_ELEMENT.innerText = `Photo uploaded successfully to Zone ${currentlySelectedPlantZone}. Triggering Fused Analysis...`;
        
        // Clean up and reset selection
        handleZoneSelection(0); 
        event.target.value = ''; 
        
        triggerComprehensiveAnalysisCycle(); 
    };
    
    reader.readAsDataURL(file);
}

/**
 * Renders the photo thumbnail inside the 4x4 grid cell.
 */
function renderPhotoInPhotoGridCell(zoneId, base64Image) {
    const cell = document.getElementById(`zone-cell-${zoneId}`);
    cell.innerHTML = ''; // Clear existing content
    const img = document.createElement('img');
    img.src = base64Image;
    img.style.width = '100%';
    img.style.height = '100%';
    img.style.objectFit = 'cover';
    cell.appendChild(img);
    
    const label = document.createElement('div');
    label.style.position = 'absolute';
    label.style.top = '0';
    label.style.left = '0';
    label.style.backgroundColor = 'rgba(0,0,0,0.7)';
    label.style.color = '#ffd700';
    label.style.padding = '5px 7px';
    label.style.fontSize = '0.7em';
    label.innerText = `ZONE ${zoneId} (ASSIGNED)`;
    cell.appendChild(label);
}

function clearPhotoGrid() {
    currentPhotoAssignmentData = {};
    generatePhotoGrid();
}

// 3.4 STOCK PHOTO GALLERY (50 PRESETS)

/**
 * Populates the 50-preset stock photo library using deterministic mock data.
 */
function populateStockPhotos() {
    if (Object.keys(stockPhotoLibraryData).length === MAX_STOCK_PHOTOS) return;
    const diseaseList = TOMATO_DIAGNOSTIC_KB.DISEASE_TIERS;
    for (let i = 1; i <= MAX_STOCK_PHOTOS; i++) {
        const diseaseIndex = i % diseaseList.length;
        const diseaseName = diseaseList[diseaseIndex].name;
        // Mock Base64 containing the diagnosis name for consistent mock analysis
        const base64 = `data:image/svg+xml;base64,mocked_stock_photo_hash_${i}_diag:${diseaseName.replace(/\s/g, '_').replace(/[()]/g, '')}`;
        stockPhotoLibraryData[i] = base64;
    }
}

function openStockImageGalleryModal() {
    populateStockPhotos();
    renderStockImageGrid();
    STOCK_MODAL.style.display = "block";
}

function closeStockImageGalleryModal() {
    STOCK_MODAL.style.display = "none";
}

/**
 * Assigns a selected stock photo (preset) to the currently selected zone.
 */
function assignStockPhotoToZone(stockId) {
    if (currentlySelectedPlantZone === 0) {
        STATUS_ELEMENT.innerText = "ERROR: Please click one of the 16 Plant Zones first before selecting a stock photo.";
        return;
    }
    
    const base64Image = stockPhotoLibraryData[stockId];
    currentPhotoAssignmentData[currentlySelectedPlantZone] = base64Image;
    renderPhotoInPhotoGridCell(currentlySelectedPlantZone, base64Image);
    
    STATUS_ELEMENT.innerText = `Stock Photo ID ${stockId} assigned to Zone ${currentlySelectedPlantZone}. Triggering Fused Analysis.`;
    
    // Reset state and trigger analysis
    handleZoneSelection(0); 
    closeStockImageGalleryModal();
    triggerComprehensiveAnalysisCycle();
}


// 3.5 HISTORY MANAGEMENT (50 PRESETS ENFORCED)

function executeTrialSaveOperation() {
    // Enforcement of 50 Preset Capacity (CRITICAL FIX)
    if (trialHistoryRecords.length >= MAX_HISTORY_TRIALS) {
        // Remove the oldest record (FIFO)
        const removedTrial = trialHistoryRecords.shift(); 
        STATUS_ELEMENT.innerText = `WARNING: Trial history is full (${MAX_HISTORY_TRIALS} presets). Trial ${removedTrial.id} was purged.`;
    }

    const trialDataRecord = {
        id: currentIncrementalTrialID,
        timestamp: new Date().toLocaleString(),
        roverState: { ...currentRoverKinematicState },
        sensorLogs: [...systemLoggedSensorDataArray],
        photoAssignments: { ...currentPhotoAssignmentData },
        aiData: {
            analysisGridHTML: document.getElementById('plantAnalysisGrid').innerHTML 
        }
    };
    
    trialHistoryRecords.push(trialDataRecord);
    localStorage.setItem('trialHistory', JSON.stringify(trialHistoryRecords));
    STATUS_ELEMENT.innerText = `TRIAL SAVE COMPLETE: Trial ${currentIncrementalTrialID} saved. Starting new session...`;
    
    // Reset state for new trial
    systemLoggedSensorDataArray = [];
    currentPhotoAssignmentData = {};
    currentIncrementalTrialID++;
    HISTORY_TRIAL_COUNTER.innerText = currentIncrementalTrialID;
    resetSensorAndMapData(true);
    clearPhotoGrid();
    triggerComprehensiveAnalysisCycle();
}

function openHistoryRetrievalModal() {
    const list = document.getElementById('trialHistoryList');
    list.innerHTML = '';
    
    if (trialHistoryRecords.length === 0) {
        list.innerHTML = '<p>No historical trial records (50 preset capacity) found.</p>';
    } else {
        const sortedHistory = trialHistoryRecords.slice().sort((a, b) => b.id - a.id);
        
        sortedHistory.forEach(trial => {
            const item = document.createElement('div');
            item.className = 'trial-item';
            item.innerHTML = `<strong>TRIAL ID ${trial.id}:</strong> ${trial.timestamp} (${trial.sensorLogs.length} sensor logs, ${Object.keys(trial.photoAssignments).length} photos)`;
            item.onclick = () => loadPastTrialRecord(trial.id);
            list.appendChild(item);
        });
        list.insertAdjacentHTML('afterbegin', `<p style="color:#ffd700;">Showing ${trialHistoryRecords.length} of ${MAX_HISTORY_TRIALS} presets saved.</p>`);
    }
    HISTORY_MODAL.style.display = "block";
}

/**
 * 3.6 MAP AND VISUALIZATION FUNCTIONS
 */

/**
 * Resets all transient data (logs, photos, map) for a fresh trial.
 */
function resetSensorAndMapData(fullReset = true) {
    if (fullReset) {
        systemLoggedSensorDataArray = [];
        currentPhotoAssignmentData = {};
        // Reset sensor displays to N/A
        MOISTURE_DISPLAY_ELEMENT.innerText = 'N/A';
        NPK_DISPLAY_ELEMENT.innerText = 'N/A';
        document.getElementById('latitudeData').innerText = 'N/A';
        document.getElementById('longitudeData').innerText = 'N/A';
        document.getElementById('headingData').innerText = 'N/A';
        document.getElementById('gpsFix').innerText = 'N/A';
        THINGSPEAK_STATUS_ELEMENT.innerText = 'Awaiting Connection';
    }
    currentRoverKinematicState.x_position_m = 2.0;
    currentRoverKinematicState.y_position_m = 2.0;
    currentRoverKinematicState.heading = 0.0;
    
    updateMapVisualization(); 
    draw3DMap(); 
    
    if (fullReset) {
        clearPhotoGrid();
        triggerComprehensiveAnalysisCycle();
        historyIsBeingViewed = false;
        handleZoneSelection(0); // Clear zone selection
    }
}

/**
 * Draws the 2D field map, rover, and logged sensor data points (FIXED: Cleaned Visualization).
 */
function updateMapVisualization() {
    const ctx = MAP_CONTEXT;
    const size = MAP_CANVAS_PIXELS;
    const scale = size / FIELD_GRID_SIZE_M;

    // 1. Clear Canvas and Draw Background Grid
    ctx.clearRect(0, 0, size, size);
    ctx.fillStyle = '#1e1e1e';
    ctx.fillRect(0, 0, size, size);
    ctx.strokeStyle = '#30363d'; // Lighter grid for cleaner look
    ctx.lineWidth = 0.5; // Thinner lines
    for (let i = 0; i <= FIELD_GRID_SIZE_M; i++) {
        ctx.beginPath();
        ctx.moveTo(i * scale, 0);
        ctx.lineTo(i * scale, size);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(0, i * scale);
        ctx.lineTo(size, i * scale);
        ctx.stroke();
    }

    // 2. Draw Plant Locations (Simple Green Circles)
    FIELD_PLANT_LOCATIONS_M.forEach(plant => {
        const x_pix = plant.x * scale;
        const y_pix = size - (plant.y * scale);
        
        ctx.beginPath();
        ctx.arc(x_pix, y_pix, PLANT_CIRCLE_RADIUS, 0, 2 * Math.PI);
        ctx.fillStyle = '#4ec9b0'; // Bright Green for visibility
        ctx.fill();
        
        // Label the zone
        ctx.fillStyle = '#c9d1d9';
        ctx.font = '10px monospace';
        ctx.fillText(`Z${plant.id}`, x_pix + 7, y_pix - 7);
    });
    
    // 3. Draw Logged Sensor Data Points (Small dots, only if data exists)
    systemLoggedSensorDataArray.forEach(data => {
        const x_pix = data.x_m * scale;
        const y_pix = size - (data.y_m * scale);
        
        // Color based on simple moisture metric
        let color = '#f85149'; // Red
        if (data.moisture > 35 && data.moisture < 65) color = '#3fb950'; // Green
        else if (data.moisture >= 25 && data.moisture <= 75) color = '#e3b341'; // Yellow

        ctx.beginPath();
        ctx.arc(x_pix, y_pix, 2, 0, 2 * Math.PI); // Smaller marker to reduce chaos
        ctx.fillStyle = color;
        ctx.fill();
    });

    // 4. Draw Rover Position (Blue Triangle)
    const x_r = currentRoverKinematicState.x_position_m * scale;
    const y_r = size - (currentRoverKinematicState.y_position_m * scale);
    const roverSize = 12;
    
    ctx.save();
    ctx.translate(x_r, y_r);
    ctx.rotate(-currentRoverKinematicState.heading * Math.PI / 180); 
    
    ctx.beginPath();
    ctx.moveTo(0, -roverSize); 
    ctx.lineTo(-roverSize * 0.7, roverSize * 0.5); 
    ctx.lineTo(roverSize * 0.7, roverSize * 0.5); 
    ctx.closePath();
    ctx.fillStyle = '#58a6ff'; // Blue
    ctx.fill();
    ctx.strokeStyle = '#ffffff';
    ctx.lineWidth = 1;
    ctx.stroke();
    ctx.restore();
}

/**
 * 3.7 INITIALIZATION SEQUENCING
 */
let scene, camera, renderer, controls;
const cubes = [];

function initThreeD() {
    // [THREE.JS Initialization logic - identical to previous step but highly verbose]
    const container = document.getElementById('threeDContainer');
    
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x0f131a);

    camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
    camera.position.set(2, 5, 5); 

    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(container.clientWidth, container.clientHeight);
    container.appendChild(renderer.domElement);

    const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
    scene.add(ambientLight);
    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
    directionalLight.position.set(5, 10, 7.5);
    scene.add(directionalLight);

    controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true; 
    controls.dampingFactor = 0.05;
    controls.screenSpacePanning = false;
    controls.minDistance = 2;
    controls.maxDistance = 15;
    
    const gridHelper = new THREE.GridHelper(FIELD_GRID_SIZE_M, FIELD_GRID_SIZE_M, 0x444444, 0x444444);
    gridHelper.position.y = -0.01;
    gridHelper.position.x = FIELD_GRID_SIZE_M / 2;
    gridHelper.position.z = FIELD_GRID_SIZE_M / 2;
    scene.add(gridHelper);
    
    FIELD_PLANT_LOCATIONS_M.forEach(plant => {
        const geometry = new THREE.BoxGeometry(0.8, 0.1, 0.8);
        const material = new THREE.MeshLambertMaterial({ color: 0xcccccc });
        const cube = new THREE.Mesh(geometry, material);
        cube.position.set(plant.x, 0.05, plant.y);
        cube.userData.id = plant.id;
        cube.userData.moisture = 0;
        scene.add(cube);
        cubes.push(cube);
    });

    function animate() {
        requestAnimationFrame(animate);
        controls.update(); 
        renderer.render(scene, camera);
    }
    animate();

    window.addEventListener('resize', onWindowResize, false);
}
// [Additional verbose Three.js helpers]
function onWindowResize() {
    const container = document.getElementById('threeDContainer');
    camera.aspect = container.clientWidth / container.clientHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(container.clientWidth, container.clientHeight);
}

// Draw the 3D bars based on the analysis results
function draw3DMap() {
    // ... (logic to find analysis card by zone ID - using the helper)
    cubes.forEach(cube => {
        const plant = FIELD_PLANT_LOCATIONS_M.find(p => p.id === cube.userData.id);
        const sensorData = findNearestSensorDataPoint(plant.x, plant.y);
        
        let moisture = sensorData ? sensorData.moisture : 0;
        let color = 0xcccccc; 

        if (sensorData) {
            // Use the final health classification for 3D bar color
            const analysisCard = document.querySelector(`.analysis-card .plant-id-label:contains("ZONE ${plant.id}")`)?.parentElement;
            const healthClass = analysisCard?.querySelector('.final-recommendation span[class^="rec-"]')?.className;
            
            if (healthClass === 'rec-optimal') color = 0x3fb950;
            else if (healthClass === 'rec-action') color = 0xe3b341;
            else if (healthClass === 'rec-critical') color = 0xf85149;
        }

        const normalizedHeight = Math.max(0.1, moisture / 100 * 2.5); // Max height 2.5m
        
        cube.scale.y = normalizedHeight / 0.1; 
        cube.position.y = normalizedHeight / 2;
        (cube.material).color.setHex(color);

        cube.userData.moisture = moisture;
    });
}

function updateRover3DPosition() {
    let roverMesh = scene.getObjectByName('rover_model');
    if (!roverMesh) {
        const roverGeometry = new THREE.SphereGeometry(0.15, 16, 16);
        const roverMaterial = new THREE.MeshBasicMaterial({ color: 0x58a6ff });
        roverMesh = new THREE.Mesh(roverGeometry, roverMaterial);
        roverMesh.name = 'rover_model';
        roverMesh.position.y = 0.5;
        scene.add(roverMesh);
    }
    roverMesh.position.x = parseFloat(currentRoverKinematicState.x_position_m);
    roverMesh.position.z = parseFloat(currentRoverKinematicState.y_position_m);
}

// Final Initialization Sequence
function onDocumentReady() {
    initThreeD();
    generatePhotoGrid();
    populateStockPhotos(); 
    resetSensorAndMapData(true); // Ensure a clean, N/A state on boot
    triggerComprehensiveAnalysisCycle(); 
}

// Ensure the code runs after the DOM and OpenCV are ready
window.onload = onDocumentReady;

// Small utility to allow querySelector to use :contains for the 3D map coloring logic
(function(D){
    D.querySelector = function(s){
        if(s.indexOf(':contains') === -1) return D.querySelector(s);
        let [selector, text] = s.split(':contains');
        text = text.replace(/["()]/g, '');
        return [...D.querySelectorAll(selector)].find(el => el.textContent.includes(text));
    };
    D.querySelectorAll = function(s){
        if(s.indexOf(':contains') === -1) return D.querySelectorAll(s);
        let [selector, text] = s.split(':contains');
        text = text.replace(/["()]/g, '');
        return [...D.querySelectorAll(selector)].filter(el => el.textContent.includes(text));
    };
})(document.constructor.prototype);

// OpenCV Library Readiness Check
function onOpenCvReady() {
    openCvLibraryIsReady = true;
    STATUS_ELEMENT.innerText = "System Status: OpenCV.js Library Initialized. Rover Control System Online.";
    triggerComprehensiveAnalysisCycle();
}
</script>
</body>
</html>
