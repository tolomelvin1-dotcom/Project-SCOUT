<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>S.C.O.U.T. Rover Full-Spectrum Data Fusion & Control Console (V19.0 - Post-Flood AI / Manual Entry)</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://unpkg.com/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
<script async src="https://docs.opencv.org/4.x/opencv.js" onload="onOpenCvReady();"></script>
<style>
/* =================================================================
   SECTION 0.1: CRITICAL SYSTEM-WIDE CSS STYLES (Highly Detailed Dark Theme)
   ================================================================= */
body { 
    font-family: 'Consolas', 'Segoe UI', monospace; 
    margin: 0; 
    padding: 25px; 
    background-color: #0c1015; /* Deeper background for the ultimate dark mode */
    color: #c9d1d9; 
    transition: background-color 0.5s;
    line-height: 1.5; 
}
.container {
    max-width: 1920px; /* Maximizing width for high-resolution displays */
    margin: auto;
    background: #161b22; 
    padding: 40px;
    border-radius: 18px;
    box-shadow: 0 15px 40px rgba(0,0,0,1.0); /* Increased shadow depth */
    display: flex;
    flex-wrap: wrap;
    border: 3px solid #30363d; /* Thicker border for structural definition */
}
/* LAYOUT AND PANEL DEFINITION (Ensuring Robust Flex Behavior) */
.controls-panel { flex: 1; min-width: 400px; padding-right: 35px; border-right: 1px dashed #30363d; }
.map-panel { flex: 1; min-width: 480px; padding: 0 35px; }
.photo-panel { flex: 1; min-width: 480px; padding-left: 35px; border-left: 1px dashed #30363d; }
.map-3d-panel { flex-basis: 100%; min-width: 100%; margin-top: 40px; padding-top: 20px; border-top: 3px solid #30363d; }
.plant-analysis-panel {
    flex-basis: 100%; 
    margin-top: 50px; 
    padding-top: 30px; 
    border-top: 3px solid #30363d; 
}
/* Typography and Status Indicators (Enhanced Visual Feedback) */
h1 { color: #58a6ff; border-bottom: 5px double #30363d; padding-bottom: 15px; margin-bottom: 30px; font-size: 2.6em; font-weight: 800; }
h2 { color: #79c0ff; margin-top: 35px; margin-bottom: 15px; font-size: 1.9em; border-bottom: 1px solid #30363d; padding-bottom: 5px; }
h3 { color: #4ac9b0; margin-top: 20px; font-size: 1.4em; }
#status { font-weight: 900; color: #f08047; font-size: 1.25em; display: block; margin-top: 10px; }
.data-display {
    margin-top: 30px;
    padding: 25px;
    border: 2px solid #30363d;
    border-radius: 12px;
    background-color: #0f131a;
    transition: box-shadow 0.3s;
}
.data-display:hover { box-shadow: 0 0 18px rgba(88, 166, 255, 0.3); }
/* Data Rows (Alignment Control) */
.data-row strong {
    display: inline-block;
    width: 220px; /* Increased for clean alignment */
    color: #4ac9b0;
}
/* Control Buttons (Explicit Color Coding & Code Clean-up) */
button {
    padding: 16px 24px;
    margin: 8px 6px;
    cursor: pointer;
    border: none;
    border-radius: 10px;
    font-weight: bold;
    transition: background-color 0.3s ease, transform 0.1s, box-shadow 0.3s;
    letter-spacing: 1.2px;
    font-size: 1.08em;
    text-transform: uppercase;
    box-shadow: 0 5px 8px rgba(0,0,0,0.5);
    white-space: nowrap;
}
button:hover { transform: translateY(-3px); box-shadow: 0 8px 12px rgba(0,0,0,0.8); }
.move-controls button { background-color: #58a6ff; color: #0d1117; }
.arm-controls button { background-color: #3fb950; color: #0d1117; }
.history-controls button { background-color: #e3b341; color: #0d1117; }
.photo-controls button { background-color: #f08047; color: #0d1117; }

/* Manual Entry Button Specific Style */
#openManualEntryButton {
    background-color: #ffd700;
    color: #0d1117;
    border: 2px solid #e3b341;
}

/* MAP STYLES */
#roverMap {
    border: 4px solid #58a6ff;
    border-radius: 5px;
    background-color: #0f131a;
}
/* GRID STYLES (4x4 Zones) */
#photoGrid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    grid-template-rows: repeat(4, 1fr);
    gap: 8px;
    border: 3px solid #58a6ff;
    max-width: 480px;
    margin: 25px auto;
    aspect-ratio: 1 / 1;
    background-color: #0f131a;
    position: relative;
}
.grid-cell {
    background-color: #21262d;
    border: 1px solid #3fb950;
    position: relative;
    cursor: pointer;
    overflow: hidden;
    aspect-ratio: 1/1;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 0.9em;
    font-weight: bold;
    color: #4ac9b0;
    transition: border 0.2s, background-color 0.2s;
}
.grid-cell:hover { background-color: #2a3038; }
/* Image overlay must allow clicks to pass through to the cell and MUST be visible. */
.grid-cell-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    position: absolute;
    top: 0;
    left: 0;
    z-index: 5;
    /* Prevents the image element itself from capturing the mouse click */
    pointer-events: none !important;
}
/* Styles for delete button */
.delete-photo-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    padding: 2px 5px;
    font-size: 0.8em;
    z-index: 10; /* Ensure button is on top of the image */
    background-color: #f85149;
    color: #0d1117;
    border-radius: 50%;
}
/* ANALYSIS CARD STYLING */
#plantAnalysisGrid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(550px, 1fr));
    gap: 40px;
    margin-top: 30px;
}
.analysis-card {
    padding: 35px;
    border-radius: 20px;
    background-color: #21262d;
    box-shadow: 0 10px 25px rgba(0,0,0,0.8);
}
.plant-id-label {
    font-size: 2.2em;
    font-weight: 900;
    color: #ffd700;
    border-bottom: 5px double #30363d;
    padding-bottom: 15px;
    margin-bottom: 25px;
}
.assessment-section { margin-bottom: 30px; padding: 25px; border-radius: 12px; }
/* Recommendation Coloring */
.rec-optimal, .rec-action, .rec-critical, .rec-no-data {
    padding: 15px;
    border-radius: 10px;
    display: block;
    font-weight: bold;
    margin-top: 18px;
    font-size: 1.15em;
    line-height: 1.4;
}
.rec-optimal { background-color: #3fb950; color: #0d1117; }
.rec-action { background-color: #e3b341; color: #0d1117; }
.rec-critical { background-color: #f85149; color: #0d1117; }
.rec-no-data { background-color: #58a6ff; color: #0d1117; }
/* MODAL STYLES */
.modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.98);
}
.modal-content { 
    background-color: #161b22; 
    margin: 3% auto; 
    padding: 50px; 
    border: 3px solid #30363d; 
    width: 95%; 
    max-width: 800px; /* Smaller max-width for manual data entry */
    border-radius: 20px; 
}
/* Manual Input Form Styles */
.form-group { margin-bottom: 20px; }
.form-group label { display: block; margin-bottom: 8px; font-weight: bold; color: #4ac9b0; }
.form-group input, .form-group select {
    width: 100%;
    padding: 12px;
    border: 1px solid #30363d;
    border-radius: 8px;
    box-sizing: border-box;
    background-color: #0f131a;
    color: #c9d1d9;
    font-size: 1.1em;
}
</style>
</head>
<body>
<div class="container">
    <div class="controls-panel">
        <h1>S.C.O.U.T. Rover Control System (V19.0)</h1>
        <p>System Diagnostic Status: <span id="status">AWAITING SYSTEM BOOT SEQUENCE COMPLETION...</span></p>

        <div class="data-display history-controls">
            <h2>Trial Preservation Console (MAX 50 Presets)   üíæ    </h2>
            <div class="data-row"><strong>Current System Trial ID:</strong> <span id="currentTrialNumber">1</span></div>
            <p>
                <button onclick="executeTrialSaveOperation()">   üíæ    EXECUTE TRIAL SAVE OPERATION</button>
                <button onclick="openHistoryRetrievalModal()">   üìÖ    RETRIEVE HISTORY (MAX 50)</button>
            </p>
            <p><small>Storage Capacity: 50 Historical Presets. Oldest trial is automatically purged (FIFO) upon capacity breach.</small></p>
        </div>
        
        <div class="data-display arm-controls">
            <h2>Data Acquisition & Manual Override</h2>
            <p>Use the Rover controls or the **Manual Data Entry** feature below.</p>
            <button onclick="dispatchRoverMovementCommand('probe')">   üî¨   EXTEND PROBE (SOIL READ)</button>
            <button onclick="dispatchRoverMovementCommand('capture')" class="photo-controls">   üì∏   TRIGGER CAMERA CAPTURE</button>
            <hr style="border-top: 1px solid #30363d; margin: 15px 0;">
            <button id="openManualEntryButton" onclick="openManualDataEntryModal()">   ‚úèÔ∏è   MANUAL DATA & PHOTO ENTRY</button>
        </div>
        
        <div class="data-display">
            <h2>System Telemetry & Network Status</h2>
            <div class="data-row"><strong>ESP32 IP Address:</strong> <span style="color: #3fb950;">**10.101.146.88**</span></div>
            <div class="data-row"><strong>ThingSpeak API Key:</strong> <span style="color: #3fb950;">**6OXH3SUQ4VNSOJX1**</span></div>
            <div class="data-row"><strong>ThingSpeak Status:</strong> <span id="thingspeakStatus">Awaiting Connection</span></div>
            <h3>Latest Sensor Reading</h3>
            <div class="data-row"><strong>Soil Moisture (%):</strong> <span id="moistureData">N/A</span></div>
            <div class="data-row"><strong>NPK (N, P, K ppm):</strong> <span id="npkData">N/A</span></div>
        </div>
    </div>
    
    <div class="map-panel">
        <h2>2D Field Map (4m x 4m Grid - Health Visualization)</h2>
        <p>Colored Circles mark the 16 plant zones; their **color reflects the Fused Health Score (Red to Green)**.</p>
        <canvas id="roverMap" width="480" height="480"></canvas>
        <p style="margin-top: 15px;">
            <button onclick="resetSensorAndMapData()">   üóë  Ô∏è CLEAR ALL MAP & DATA</button>
        </p>
    </div>
    
    <div class="photo-panel">
        <div class="camera-control data-display">
            <h2>Plant Zone Photo Assignments (16 Zones)</h2>
            <p>TO UPLOAD/REPLACE: **Click any Zone (1-16)** or use the Manual Entry button.</p>
            <button onclick="openStockImageGalleryModal()" class="photo-controls">   üñº  Ô∏è VIEW STOCK PHOTOS (50 Presets)</button>
            <p>Current Target Zone: **Zone <span id="currentZoneSelection">N/A</span>**</p>
        </div>

        <hr style="border-top: 2px solid #30363d; margin: 30px 0;">
        <div id="photoGrid">
        </div>
        <input type="file" id="zoneFileInput" accept="image/*" style="display: none;" onchange="handleFileUpload(event)"> 
    </div>
    
    <div class="map-3d-panel">
        <h2>3D Plant Health Visualization üåø (Height/Color=Score, **Stem/Leaf Mesh**)</h2>
        <div id="threeDContainer" style="height: 550px; width: 100%;"></div>
        <p class="map-description" style="color: #c9d1d9; font-size: 0.9em; margin-top: 15px; border-top: 1px dashed #30363d; padding-top: 10px;">
            3D Map Description: Visualizes the 16 plant zones. Each **Custom Plant Mesh (Stem/Leaves)** is placed at a plant's location.
            The Plant's **Height/Volume is scaled to the Fused Health Score (taller/fuller=healthier)**, and its **Color changes smoothly from Red (score=0) to Green (score=100)**.
        </p>
    </div>

    <div class="plant-analysis-panel">
        <h2>DATA FUSION ENGINE V19.0: Comprehensive Plant Diagnosis & Post-Flood Assessment   üî¨   </h2>
        <p>The **FUSED** assessment combines Leaf Visual (CV) + Local Sensor Data. Now includes advanced checks like **NPK Balance Penalty** and specific **Post-Flood Resilience Metrics**.</p>
        <div id="plantAnalysisGrid">
        </div>
    </div>
</div>
<footer style="text-align: center; margin-top: 40px; padding: 15px; background-color: #161b22; border-top: 1px solid #30363d; border-radius: 0 0 18px 18px; color: #79c0ff; font-size: 0.9em;">
    **S.C.O.U.T. Rover Control System V19.0** | All Rights Reserved: BanScie RIM Team 2025
</footer>

<div id="historyModal" class="modal" onclick="if(event.target.id === 'historyModal') closeHistoryModal()">
    <div class="modal-content">
        <span class="close-btn" onclick="closeHistoryModal()">&times;</span>
        <h2>Saved Trial History Retrieval Console</h2>
        <p>Click a trial to restore its exact state.</p>
        <div id="trialHistoryList"></div>
    </div>
</div>

<div id="stockImageModal" class="modal" onclick="if(event.target.id === 'stockImageModal') closeStockImageGalleryModal()">
    <div class="modal-content">
        <span class="close-btn" onclick="closeStockImageGalleryModal()">&times;</span>
        <h2>Stock Photo Gallery (Click to Assign)</h2>
        <p>Target Zone: **Zone <span id="modalCurrentZoneSelection">N/A</span>**</p>
        <div id="stockImageGrid"></div>
    </div>
</div>

<div id="manualEntryModal" class="modal" onclick="if(event.target.id === 'manualEntryModal') closeManualDataEntryModal()">
    <div class="modal-content" style="max-width: 600px;">
        <span class="close-btn" onclick="closeManualDataEntryModal()">&times;</span>
        <h2>Manual Data Entry & Override</h2>
        <p>Input sensor data and assign a photo to a specific plant zone.</p>
        <form id="manualDataForm">
            <div class="form-group">
                <label for="manualZoneID">Target Plant Zone ID (1-16):</label>
                <select id="manualZoneID" required></select>
            </div>
            <div class="form-group">
                <label for="manualMoisture">Soil Moisture % (0-100):</label>
                <input type="number" id="manualMoisture" min="0" max="100" placeholder="e.g., 85" required>
            </div>
            <div class="form-group">
                <label>NPK Values (ppm, e.g., N:150 P:30 K:100):</label>
                <input type="number" id="manualN" min="0" placeholder="Nitrogen (N)" required>
                <input type="number" id="manualP" min="0" placeholder="Phosphorous (P)" required style="margin-top: 5px;">
                <input type="number" id="manualK" min="0" placeholder="Potassium (K)" required style="margin-top: 5px;">
            </div>
            <div class="form-group">
                <label for="manualPhotoUpload">Upload or Select Photo for Zone:</label>
                <input type="file" id="manualPhotoUpload" accept="image/*" onchange="previewManualPhoto(event)">
                <img id="manualPhotoPreview" src="" alt="Photo Preview" style="max-width: 100%; max-height: 150px; display: none; margin-top: 10px; border-radius: 8px;">
            </div>
            <button type="button" style="background-color: #3fb950; color: #0d1117; width: 100%;" onclick="submitManualData()">   ‚úÖ   SUBMIT AND RUN ANALYSIS</button>
        </form>
    </div>
</div>

<script>
// ==================================================================================
// SECTION 0.2: CORE SYSTEM CONSTANTS AND GLOBAL CONFIGURATION (MAXIMAL VERBOSITY)
// ----------------------------------------------------------------------------------
/**
 * @fileoverview S.C.O.U.T. Rover Control System JavaScript Core.
 * Version 19.0: CRITICAL EXTENSION: Manual Data Entry, Post-Flood Logic, Stem/Leaf 3D Meshes, FileReader Image Persistence.
 */
// --- 0.2.1 HARDWARE AND NETWORK CONFIGURATION (CRITICAL SYSTEM IDENTIFIERS) ---
const HARDWARE_ESP32_IP_ADDRESS = '10.101.146.88'; // **CRITICAL USER-REQUESTED IP ADDRESS**
const THINGSPEAK_API_KEY = '6OXH3SUQ4VNSOJX1'; // **CRITICAL USER-REQUESTED API KEY**
const MAX_HISTORY_TRIALS = 50;

// --- 0.2.2 PHYSICAL SYSTEM AND UI CONSTANTS (STRICT ADHERENCE TO SPECIFICATIONS) ---
const FIELD_GRID_SIZE_M = 4; // 4x4 Grid
const MAP_CANVAS_PIXELS = 480; 
const MAX_STOCK_PHOTOS = 50;
const PLANT_CIRCLE_RADIUS = 5;
const SCORE_CAP_ON_PARTIAL_DATA = 50;

// --- 0.2.3 DOM ELEMENT REFERENCES (MAPPING CORE UI COMPONENTS) ---
const STATUS_ELEMENT = document.getElementById('status');
const MOISTURE_DISPLAY_ELEMENT = document.getElementById('moistureData');
const NPK_DISPLAY_ELEMENT = document.getElementById('npkData');
const MAP_CANVAS = document.getElementById('roverMap');
const MAP_CONTEXT = MAP_CANVAS.getContext('2d');
const HISTORY_MODAL = document.getElementById('historyModal');
const STOCK_MODAL = document.getElementById('stockImageModal');
const MANUAL_ENTRY_MODAL = document.getElementById('manualEntryModal'); // V19.0
const CURRENT_ZONE_SELECTION_DISPLAY = document.getElementById('currentZoneSelection');
const MODAL_ZONE_SELECTION_DISPLAY = document.getElementById('modalCurrentZoneSelection');
const PHOTO_GRID_ELEMENT = document.getElementById('photoGrid');
const PLANT_ANALYSIS_GRID = document.getElementById('plantAnalysisGrid');
const ZONE_FILE_INPUT = document.getElementById('zoneFileInput'); 
const MANUAL_ZONE_SELECT = document.getElementById('manualZoneID'); // V19.0
const MANUAL_PHOTO_PREVIEW = document.getElementById('manualPhotoPreview'); // V19.0

// --- 0.2.4 GLOBAL STATE VARIABLES (Clean Initial State Definition) ---
let openCvLibraryIsReady = false; 
let systemLoggedSensorDataArray = []; // Stores {zoneID, moisture, N, P, K}
let currentPhotoAssignmentData = JSON.parse(localStorage.getItem('photoAssignments') || '{}'); 
let stockPhotoLibraryData = {}; 
let latestAnalysisResults = {}; // Cache for health scores/colors

// Persistent Storage Management
let trialHistoryRecords = JSON.parse(localStorage.getItem('trialHistory') || '[]');
let currentIncrementalTrialID = trialHistoryRecords.length + 1;
document.getElementById('currentTrialNumber').innerText = currentIncrementalTrialID;

// Pre-calculated Plant Locations (16 zones)
const FIELD_PLANT_LOCATIONS_M = [];
for(let r=0; r<FIELD_GRID_SIZE_M; r++) {
    for(let c=0; c<FIELD_GRID_SIZE_M; c++) {
        FIELD_PLANT_LOCATIONS_M.push({x: c + 0.5, y: r + 0.5, id: (r * FIELD_GRID_SIZE_M) + c + 1});
    }
}
// 3D Visualization Globals
let scene, camera, renderer, controls;
let threeDMapObjects = [];

// ==================================================================================
// SECTION 1.0: DATA ACQUISITION AND STORAGE (CRITICAL V19.0 REFINEMENTS)
// ----------------------------------------------------------------------------------

/**
 * @function generateRandomMockSensorData
 * Generates mock sensor data, with an increased chance of 'post-flood' conditions.
 * @param {number} zoneID The ID of the zone.
 * @returns {object} Mock sensor data.
 */
function generateRandomMockSensorData(zoneID) {
    // 50% chance of simulating post-flood/waterlogged conditions (high moisture, low N)
    const isPostFlood = Math.random() < 0.5; 
    let moisture, N, P, K;

    if (isPostFlood) {
        moisture = Math.floor(Math.random() * (95 - 75 + 1)) + 75; // 75-95% (Waterlogged)
        N = Math.floor(Math.random() * (50 - 10 + 1)) + 10; // 10-50 ppm (Nitrogen Leached)
        P = Math.floor(Math.random() * (40 - 20 + 1)) + 20; // 20-40 ppm
        K = Math.floor(Math.random() * (60 - 30 + 1)) + 30; // 30-60 ppm
    } else {
        moisture = Math.floor(Math.random() * (70 - 20 + 1)) + 20; // 20-70% (Normal/Dry)
        N = Math.floor(Math.random() * (250 - 80 + 1)) + 80; // 80-250 ppm (Normal range)
        P = Math.floor(Math.random() * (60 - 30 + 1)) + 30;
        K = Math.floor(Math.random() * (150 - 50 + 1)) + 50;
    }

    return { 
        zoneID, 
        moisture, 
        N, 
        P, 
        K,
        isPostFlood: isPostFlood // Flag for analysis
    };
}

/**
 * @function executeDataAcquisition
 * Simulates rover deploying the probe and reading sensors for a zone.
 */
function executeDataAcquisition() {
    // 1. Determine Target Zone (nearest to the rover's mock position)
    const roverPos = { x: 2.0, y: 2.0 }; // Mocked center position
    const nearestPlant = FIELD_PLANT_LOCATIONS_M.reduce((prev, curr) => {
        const distA = Math.hypot(roverPos.x - prev.x, roverPos.y - prev.y);
        const distB = Math.hypot(roverPos.x - curr.x, roverPos.y - curr.y);
        return distA < distB ? prev : curr;
    });
    const zoneID = nearestPlant.id;
    
    // 2. Acquire Data
    const sensorData = generateRandomMockSensorData(zoneID);
    
    // 3. Log Data to State
    // Check if data for this zone already exists
    const existingIndex = systemLoggedSensorDataArray.findIndex(data => data.zoneID === zoneID);
    if (existingIndex !== -1) {
        systemLoggedSensorDataArray[existingIndex] = sensorData;
    } else {
        systemLoggedSensorDataArray.push(sensorData);
    }
    
    // 4. Update UI
    MOISTURE_DISPLAY_ELEMENT.innerText = `${sensorData.moisture}%`;
    NPK_DISPLAY_ELEMENT.innerText = `N:${sensorData.N}, P:${sensorData.P}, K:${sensorData.K}`;
    STATUS_ELEMENT.innerText = `RESPONSE: Sensor data acquired for Zone ${zoneID}.`;
    
    triggerComprehensiveAnalysisCycle();
    transmitSensorDataViaESP32ToThingSpeak(sensorData);
}

/**
 * @function handleFileUpload
 * CRITICAL V19.0 FIX: Uses FileReader to convert File to DataURL, ensuring image persistence 
 * via localStorage, even after a page refresh.
 */
function handleFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    // Use currentlySelectedPlantZone, which is set when a grid cell is clicked.
    const zoneID = currentlySelectedPlantZone;
    if (zoneID === 0) {
        alert("ERROR: Please click a Zone (1-16) first before uploading a file.");
        return;
    }

    const reader = new FileReader();
    reader.onload = (e) => {
        // Mock a diagnosis string (real system uses OpenCV/server CV analysis)
        const mockDiagnosis = generateRandomMockDiagnosis(); 
        const photoData = e.target.result + `_diag:${mockDiagnosis.replace(/\s/g, '_').replace(/[()]/g, '')}`;

        currentPhotoAssignmentData[zoneID] = photoData;
        localStorage.setItem('photoAssignments', JSON.stringify(currentPhotoAssignmentData));
        
        // Re-render the grid to display the new image
        generatePhotoGrid();
        
        // Run analysis on the updated photo/data
        triggerComprehensiveAnalysisCycle();
        STATUS_ELEMENT.innerText = `SUCCESS: User image uploaded and assigned to Zone ${zoneID}. Running analysis...`;
    };
    reader.readAsDataURL(file);
}

// ==================================================================================
// SECTION 2.0: MANUAL DATA ENTRY (NEW V19.0 FEATURE)
// ----------------------------------------------------------------------------------

/**
 * @function openManualDataEntryModal
 * Initializes the dropdown and displays the manual entry modal.
 */
function openManualDataEntryModal() {
    // Populate the Zone ID dropdown (1-16)
    MANUAL_ZONE_SELECT.innerHTML = '<option value="" disabled selected>Select Zone</option>';
    for (let i = 1; i <= 16; i++) {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = `Zone ${i}`;
        MANUAL_ZONE_SELECT.appendChild(option);
    }
    document.getElementById('manualDataForm').reset();
    MANUAL_PHOTO_PREVIEW.style.display = 'none';
    MANUAL_ENTRY_MODAL.style.display = 'block';
}

/**
 * @function closeManualDataEntryModal
 * Hides the modal.
 */
function closeManualDataEntryModal() {
    MANUAL_ENTRY_MODAL.style.display = 'none';
}

/**
 * @function previewManualPhoto
 * Displays a preview of the photo selected in the manual entry form.
 */
function previewManualPhoto(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            MANUAL_PHOTO_PREVIEW.src = e.target.result;
            MANUAL_PHOTO_PREVIEW.style.display = 'block';
        };
        reader.readAsDataURL(file);
    } else {
        MANUAL_PHOTO_PREVIEW.style.display = 'none';
    }
}

/**
 * @function submitManualData
 * Collects data from the manual entry form, validates it, and pushes it to the system state.
 */
function submitManualData() {
    const zoneID = parseInt(document.getElementById('manualZoneID').value);
    const moisture = parseInt(document.getElementById('manualMoisture').value);
    const N = parseInt(document.getElementById('manualN').value);
    const P = parseInt(document.getElementById('manualP').value);
    const K = parseInt(document.getElementById('manualK').value);
    const photoFile = document.getElementById('manualPhotoUpload').files[0];

    if (isNaN(zoneID) || isNaN(moisture) || isNaN(N) || isNaN(P) || isNaN(K)) {
        alert("Please fill in all numerical fields correctly.");
        return;
    }
    
    // 1. Prepare Sensor Data
    const sensorData = { 
        zoneID, 
        moisture, 
        N, 
        P, 
        K, 
        // Heuristic to flag for post-flood status in manual entry
        isPostFlood: (moisture >= 75 && N <= 50) 
    };

    // Update systemLoggedSensorDataArray
    const existingIndex = systemLoggedSensorDataArray.findIndex(data => data.zoneID === zoneID);
    if (existingIndex !== -1) {
        systemLoggedSensorDataArray[existingIndex] = sensorData;
    } else {
        systemLoggedSensorDataArray.push(sensorData);
    }
    
    // 2. Handle Photo Upload/Assignment
    const finalizeDataEntry = (photoData) => {
        if (photoData) {
            // Mock a diagnosis for the manual photo
            const mockDiagnosis = generateRandomMockDiagnosis(); 
            const photoDataWithDiag = photoData + `_diag:${mockDiagnosis.replace(/\s/g, '_').replace(/[()]/g, '')}`;
            currentPhotoAssignmentData[zoneID] = photoDataWithDiag;
            localStorage.setItem('photoAssignments', JSON.stringify(currentPhotoAssignmentData));
        }

        // Update UI displays
        MOISTURE_DISPLAY_ELEMENT.innerText = `${moisture}%`;
        NPK_DISPLAY_ELEMENT.innerText = `N:${N}, P:${P}, K:${K}`;
        
        generatePhotoGrid();
        triggerComprehensiveAnalysisCycle();
        closeManualDataEntryModal();
        STATUS_ELEMENT.innerText = `SUCCESS: Manual data and photo assigned to Zone ${zoneID}. Running analysis...`;
    };

    if (photoFile) {
        const reader = new FileReader();
        reader.onload = (e) => finalizeDataEntry(e.target.result);
        reader.readAsDataURL(photoFile);
    } else {
        finalizeDataEntry(null); // No photo uploaded, but data is logged.
    }
}


// ==================================================================================
// SECTION 3.0: ADVANCED DATA FUSION (V19.0 LOGIC EXPANSION)
// ----------------------------------------------------------------------------------

/**
 * @function calculateFusedHealthScoreV19
 * Implements the core multi-sensor data fusion algorithm (V19.0).
 * Score range: 0 (Critical) to 100 (Optimal).
 * @param {object} sensorData Sensor data object.
 * @param {string} cvDiagnosis Computer Vision diagnosis string.
 * @returns {object} {score: number, color: string, isPostFlood: boolean}
 */
function calculateFusedHealthScoreV19(sensorData, cvDiagnosis) {
    if (!sensorData) {
        return { score: 0, color: '#f85149', isPostFlood: false }; // Max penalty for missing data
    }
    
    const { moisture, N, P, K } = sensorData;
    let score = 100; // Start at optimal
    let totalPenalty = 0;
    let postFloodPenalty = 0;

    // --- 3.1 SENSOR-BASED PENALTIES (Higher Weight) ---
    // 1. Moisture Penalty (Optimal: 40-60%)
    const OPTIMAL_MOISTURE_RANGE = [40, 60];
    if (moisture < OPTIMAL_MOISTURE_RANGE[0]) {
        // Dry/Drought penalty (Max 25)
        totalPenalty += Math.min(25, 1.25 * (OPTIMAL_MOISTURE_RANGE[0] - moisture)); 
    } else if (moisture > OPTIMAL_MOISTURE_RANGE[1]) {
        // Waterlogged/Flood penalty (Max 40)
        totalPenalty += Math.min(40, 1.5 * (moisture - OPTIMAL_MOISTURE_RANGE[1])); 
        postFloodPenalty += totalPenalty * 0.5; // Half of water penalty counts toward flood flag
    }

    // 2. NPK Level Penalty (Optimal N: 100-200, P: 30-50, K: 80-120)
    // Nitrogen is most critical and easily leached in flood conditions
    const N_OPTIMAL_LOW = 100;
    const P_OPTIMAL_LOW = 30;
    const K_OPTIMAL_LOW = 80;

    // A. N-Deficiency Penalty (Max 30)
    if (N < N_OPTIMAL_LOW) {
        totalPenalty += Math.min(30, 0.4 * (N_OPTIMAL_LOW - N));
        postFloodPenalty += totalPenalty * 0.3; // N-deficiency is a major flood indicator
    }
    // B. P-Deficiency Penalty (Max 15)
    if (P < P_OPTIMAL_LOW) {
        totalPenalty += Math.min(15, 0.3 * (P_OPTIMAL_LOW - P));
    }
    // C. K-Deficiency Penalty (Max 20)
    if (K < K_OPTIMAL_LOW) {
        totalPenalty += Math.min(20, 0.35 * (K_OPTIMAL_LOW - K));
    }
    
    // D. V19.0: NPK Balance Penalty (Severe imbalance suggests a systemic issue, max 10)
    // High N + Low P/K or Low N + High P/K (should be roughly 3:1:2 or 4:1:2 for many crops)
    const NPK_RATIO_SCORE = Math.abs(N / 150 - 1) + Math.abs(P / 40 - 1) + Math.abs(K / 100 - 1);
    if (NPK_RATIO_SCORE > 1.5) {
        totalPenalty += 10;
    }


    // --- 3.2 COMPUTER VISION PENALTY (Lower Weight) ---
    // Diagnosis is extracted from the photo string (e.g., "Mottling", "Yellowing")
    let cvPenalty = 0;
    if (cvDiagnosis.includes('Mottling')) cvPenalty = 25; // Critical Viral/Severe Fungal
    else if (cvDiagnosis.includes('Dark Spots')) cvPenalty = 15; // Moderate Fungal/Bacterial
    else if (cvDiagnosis.includes('Yellowing') || cvDiagnosis.includes('Edging Burn')) cvPenalty = 8; // Mild Nutrient/Slight Stress
    // Healthy or No Data (0)
    
    // CV Penalty is applied at 50% weight compared to full sensor penalty.
    totalPenalty += cvPenalty * 0.5;

    // --- 3.3 FINAL CALCULATION ---
    let finalScore = Math.max(0, score - Math.round(totalPenalty));
    
    // --- 3.4 POST-FLOOD STATUS FLAG ---
    const isPostFloodStatus = (sensorData.isPostFlood || postFloodPenalty > 30); 

    // Adjust score based on post-flood status - if true, cap max score at 75 due to high root stress risk
    if (isPostFloodStatus && finalScore > 75) {
        finalScore = 75; 
    }

    // Determine Color (Smooth Red to Green Gradient)
    const color = scoreToColor(finalScore);

    return { 
        score: finalScore, 
        color: color, 
        isPostFlood: isPostFloodStatus,
        sensorPenalty: Math.round(totalPenalty),
        cvPenalty: cvPenalty
    };
}

/**
 * @function scoreToColor
 * Converts a 0-100 score into a hexadecimal color (Red to Green).
 * @param {number} score Health score (0-100).
 * @returns {string} Hex color string (#RRGGBB).
 */
function scoreToColor(score) {
    // Clamp score between 0 and 100
    const normalizedScore = Math.min(100, Math.max(0, score));
    
    // Interpolation (Red is 0, Green is 1)
    const r = normalizedScore < 50 ? 255 : Math.floor(255 - (normalizedScore - 50) * 5.1);
    const g = normalizedScore > 50 ? 255 : Math.floor((normalizedScore) * 5.1);
    const b = 0;

    // Convert to hex
    const toHex = (c) => Math.round(c).toString(16).padStart(2, '0');
    return `#${toHex(r)}${toHex(g)}${toHex(b)}`;
}

/**
 * @function getRecommendationV19
 * Generates a detailed recommendation based on the score and post-flood status.
 * @param {object} analysisResult Result object from calculateFusedHealthScoreV19.
 * @returns {string} HTML-formatted recommendation string.
 */
function getRecommendationV19(analysisResult) {
    const { score, isPostFlood, sensorData } = analysisResult;
    let recommendation = "";
    let colorClass = 'rec-no-data';

    if (score >= 80) {
        colorClass = 'rec-optimal';
        [cite_start]recommendation += "## Optimal Health Status Detected [cite: 59]\n- **Current Action**: Continue daily monitoring. No immediate intervention required. [cite_start]Plant appears highly resilient. [cite: 59]";
    } else if (score >= 50) {
        colorClass = 'rec-action';
        [cite_start]recommendation += "## Action Recommended (Minor/Moderate Stress Detected) [cite: 59]\n";
        
        if (sensorData && sensorData.moisture > 65) {
            [cite_start]recommendation += `- **Soil Management**: Reduce irrigation immediately. Aerate the topsoil gently to promote oxygenation and reduce compaction. [cite: 59]`;
        } else if (sensorData && sensorData.N < 100) {
             recommendation += `- **Nutrition**: Apply a fast-acting Nitrogen supplement to correct deficiency (N:${sensorData.N} ppm). [cite_start]Monitor new leaf growth for color change. [cite: 59]`;
        } else {
            recommendation += `- **CV Inspection**: Re-scan in 24 hours. [cite_start]Consider mild systemic fungicide application if spots/discoloration persist. [cite: 59]`;
        }
    } else {
        colorClass = 'rec-critical';
        [cite_start]recommendation += "## CRITICAL INTERVENTION REQUIRED (Severe Stress/Root Failure Risk) [cite: 59]\n";
        
        if (sensorData && sensorData.moisture > 80) {
            [cite_start]recommendation += `- **EMERGENCY DRAINAGE**: The zone is waterlogged (${sensorData.moisture}% moisture). **Install immediate drainage or trenching** to save the plant roots. Risk of root rot is high. [cite: 59]`;
        } else if (sensorData && sensorData.N < 50) {
            recommendation += `- **EMERGENCY NUTRITION**: Critical Nitrogen leaching detected (N:${sensorData.N} ppm). [cite_start]Apply a high-concentration, slow-release NPK fertilizer immediately after soil drainage/drying. [cite: 59]`;
        } else {
            recommendation += `- **Physical Removal**: If visual mottling/severe discoloration is confirmed, the plant may be virally infected. [cite_start]Remove it immediately to prevent spread to adjacent zones. [cite: 59]`;
        }
    }

    // V19.0: POST-FLOOD ASSESSMENT (Highest Priority Addendum)
    if (isPostFlood) {
        recommendation += `\n<div class="assessment-section" style="background-color: #f08047; color: #0d1117;">
            <h3>üö® POST-FLOOD ASSESSMENT STATUS: ACTIVE (Moisture > 75% or High Leaching Detected)</h3>
            <p><strong>Primary Recommendation:</strong> This plant is exhibiting signs of **Root Zone Hypoxia** (lack of oxygen) and **Severe Nutrient Leaching**. [cite_start]The health score is capped until flood conditions subside. [cite: 59]</p>
            <p><strong>Immediate Action:</strong> Focus entirely on **soil aeration** (shallow tilling/mulching) and **pH stabilization**. [cite_start]Wait 72 hours before applying any high-dosage NPK to avoid further nutrient shock. [cite: 59]</p>
            <p><strong>Next Step:</strong> Re-run a full sensor read in 24 hours to monitor the moisture drop. [cite_start]If moisture remains above 70%, physical draining is mandatory. [cite: 59]</p>
        </div>`;
        colorClass = (score >= 60) ? 'rec-action' : 'rec-critical'; // Override visual class for severity
    }
    
    // Return HTML structure
    return `<div class="${colorClass}">${recommendation.replace(/\n/g, '<br>')}</div>`;
}

// ==================================================================================
// SECTION 4.0: 3D VISUALIZATION (V19.0: STEM/LEAF MESH)
// ----------------------------------------------------------------------------------

/**
 * @function createPlantMesh
 * Creates a simple 3D plant structure with a stem and leaves.
 * @param {number} zoneID The ID of the zone.
 * @param {number} heightScale Scale factor based on health score.
 * @param {string} color Hexadecimal color string.
 * @returns {THREE.Group} A group containing the stem and leaf meshes.
 */
function createPlantMesh(zoneID, heightScale, color) {
    const plantGroup = new THREE.Group();
    plantGroup.userData.zoneID = zoneID;
    
    const plantColor = new THREE.Color(color);

    // 1. Stem (Cylinder Geometry)
    const stemHeight = 0.1 + (heightScale * 0.5); 
    const stemGeometry = new THREE.CylinderGeometry(0.02, 0.03, stemHeight, 16);
    const stemMaterial = new THREE.MeshPhongMaterial({ color: 0x4d794d }); // Dark Green/Brown
    const stem = new THREE.Mesh(stemGeometry, stemMaterial);
    stem.position.y = stemHeight / 2;
    plantGroup.add(stem);

    // 2. Leaves (Simple Plane/Box Geometry for simplicity)
    const leafMaterial = new THREE.MeshPhongMaterial({ color: plantColor, side: THREE.DoubleSide });
    const numLeaves = 4;
    for (let i = 0; i < numLeaves; i++) {
        // Create a simple leaf shape (thin box)
        const leafGeometry = new THREE.BoxGeometry(0.2, 0.01, 0.4);
        const leaf = new THREE.Mesh(leafGeometry, leafMaterial);
        
        // Position and rotate leaves around the top of the stem
        const angle = (i / numLeaves) * Math.PI * 2;
        const radius = 0.1;
        leaf.position.set(Math.cos(angle) * radius, stemHeight * 0.8, Math.sin(angle) * radius);
        
        // Tilt the leaf
        leaf.rotation.x = Math.PI / 4; 
        leaf.rotation.y = angle + Math.PI / 2;

        // Scale the leaf volume based on score
        leaf.scale.set(heightScale * 0.8 + 0.2, 1, heightScale * 0.8 + 0.2);

        plantGroup.add(leaf);
    }
    
    return plantGroup;
}


// --- Functions from the original code (modified/included) ---

/**
 * @function initThreeD
 * Initializes the Three.js scene, camera, and renderer.
 */
function initThreeD() {
    const container = document.getElementById('threeDContainer');
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x111111); // Dark background for the console theme

    camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
    camera.position.set(2, 5, 5); // Initial camera position (looking down at the 4x4 grid)

    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(container.clientWidth, container.clientHeight);
    container.appendChild(renderer.domElement);

    // Add controls for user interaction
    controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;
    controls.screenSpacePanning = false;
    controls.minDistance = 2;
    controls.maxDistance = 10;
    controls.maxPolarAngle = Math.PI / 2;

    // Add lighting
    const ambientLight = new THREE.AmbientLight(0x404040, 3); // soft white light
    scene.add(ambientLight);
    const directionalLight = new THREE.DirectionalLight(0xffffff, 2);
    directionalLight.position.set(5, 5, 5);
    scene.add(directionalLight);

    // Add a simple ground plane (4m x 4m)
    const planeGeometry = new THREE.PlaneGeometry(FIELD_GRID_SIZE_M, FIELD_GRID_SIZE_M);
    const planeMaterial = new THREE.MeshPhongMaterial({ color: 0x3d3d3d, side: THREE.DoubleSide });
    const plane = new THREE.Mesh(planeGeometry, planeMaterial);
    plane.rotation.x = Math.PI / 2;
    plane.position.set(FIELD_GRID_SIZE_M / 2, 0, FIELD_GRID_SIZE_M / 2); // Center the plane
    scene.add(plane);

    // Initial grid lines (optional but helpful)
    const gridHelper = new THREE.GridHelper(FIELD_GRID_SIZE_M, FIELD_GRID_SIZE_M, 0xaaaaaa, 0x444444);
    gridHelper.position.set(FIELD_GRID_SIZE_M / 2, 0.001, FIELD_GRID_SIZE_M / 2); // Lift slightly above plane
    scene.add(gridHelper);

    animate();
}

/**
 * @function draw3DMap
 * Clears the 3D scene and redraws the plant meshes based on the latest analysis results.
 */
function draw3DMap() {
    // Clear existing plant objects
    threeDMapObjects.forEach(obj => scene.remove(obj));
    threeDMapObjects = [];

    FIELD_PLANT_LOCATIONS_M.forEach(plantLoc => {
        const zoneID = plantLoc.id;
        const result = latestAnalysisResults[zoneID];
        
        let score = 0;
        let color = '#777777'; // Grey (No Data)
        let heightScale = 0.2; // Min height for visibility

        if (result && result.score !== undefined) {
            score = result.score;
            color = result.color;
            // Scale height from 0.2 (min) to 1.0 (max) based on score
            heightScale = 0.2 + (score / 100) * 0.8;
        }

        const plantMesh = createPlantMesh(zoneID, heightScale, color);
        
        // Position the plant in the 3D space (X, Z) and lift it slightly off the ground (Y=0)
        // Note: Field X/Y coordinates map to Three.js X/Z coordinates
        plantMesh.position.set(plantLoc.x, 0, plantLoc.y); 
        
        scene.add(plantMesh);
        threeDMapObjects.push(plantMesh);
    });
}

/**
 * @function animate
 * The Three.js render loop.
 */
function animate() {
    requestAnimationFrame(animate);
    controls.update(); // only required if controls.enableDamping is set to true
    renderer.render(scene, camera);
}


// --- Remaining V18.0 functions (updated for V19.0 references) ---

function triggerComprehensiveAnalysisCycle() {
    // 1. Loop through all 16 zones (guarantee analysis even if no data exists)
    FIELD_PLANT_LOCATIONS_M.forEach(plant => {
        const zoneID = plant.id;
        const sensorData = systemLoggedSensorDataArray.find(d => d.zoneID === zoneID);
        const photoData = currentPhotoAssignmentData[zoneID];
        
        // Extract diagnosis from photo string if available
        let cvDiagnosis = 'No Data';
        if (photoData && photoData.includes('_diag:')) {
            cvDiagnosis = photoData.split('_diag:')[1].replace(/_/g, ' ');
        }

        let result;
        if (sensorData || photoData) {
            // Run V19.0 FUSION ENGINE
            result = calculateFusedHealthScoreV19(sensorData, cvDiagnosis);
        } else {
            // Render no data card
            result = { 
                score: SCORE_CAP_ON_PARTIAL_DATA, // Neutral score for "No Data"
                color: '#58a6ff', 
                cvDiagnosis: 'No Data',
                sensorData: null,
                isPostFlood: false
            };
        }
        
        // Cache the full result, including sensor data and diagnosis for the rendering step
        latestAnalysisResults[zoneID] = {
            ...result,
            cvDiagnosis: cvDiagnosis,
            sensorData: sensorData || {moisture: 'N/A', N: 'N/A', P: 'N/A', K: 'N/A'}
        };
    });

    // 2. Update UI
    renderAnalysisCards();
    updateMapVisualization();
    draw3DMap(); // Redraw 3D map with new results
}


function renderAnalysisCards() {
    PLANT_ANALYSIS_GRID.innerHTML = '';
    FIELD_PLANT_LOCATIONS_M.forEach(plant => {
        const zoneID = plant.id;
        const result = latestAnalysisResults[zoneID];

        const card = document.createElement('div');
        card.className = 'analysis-card';
        
        let scoreDisplay = 'N/A';
        let recommendationHTML = `<div class="rec-no-data">Data Fusion Pending. No sensor/photo data available.</div>`;

        if (result && result.score !== undefined) {
            scoreDisplay = result.score;
            recommendationHTML = getRecommendationV19(result);
        }
        
        const healthColorStyle = result ? `color: ${result.color};` : '';
        const sensorData = result ? result.sensorData : { moisture: 'N/A', N: 'N/A', P: 'N/A', K: 'N/A' };
        const cvDiagnosis = result ? result.cvDiagnosis : 'N/A';
        
        card.innerHTML = `
            <div class="plant-id-label" style="${healthColorStyle}">Zone ${zoneID} | FUSED HEALTH SCORE: ${scoreDisplay}</div>
            <div class="assessment-section" style="border: 2px solid ${result ? result.color : '#30363d'};">
                <h3>V19.0 Analysis Summary</h3>
                <div class="data-row"><strong>CV Visual Diagnosis:</strong> <span style="color: #4ac9b0;">${cvDiagnosis}</span></div>
                <div class="data-row"><strong>Soil Moisture:</strong> <span>${sensorData.moisture}%</span></div>
                <div class="data-row"><strong>NPK Status (ppm):</strong> <span>N:${sensorData.N}, P:${sensorData.P}, K:${sensorData.K}</span></div>
                <div class="data-row"><strong>Post-Flood Status:</strong> <span style="color: ${result && result.isPostFlood ? '#f85149' : '#3fb950'};">**${result && result.isPostFlood ? 'ACTIVE' : 'INACTIVE'}**</span></div>
            </div>
            <h3>Final Fused Recommendation</h3>
            ${recommendationHTML}
        `;
        PLANT_ANALYSIS_GRID.appendChild(card);
    });
}

function updateMapVisualization() {
    MAP_CONTEXT.clearRect(0, 0, MAP_CANVAS_PIXELS, MAP_CANVAS_PIXELS);
    
    // Draw grid lines
    const gridSize = MAP_CANVAS_PIXELS / FIELD_GRID_SIZE_M;
    MAP_CONTEXT.strokeStyle = '#30363d';
    MAP_CONTEXT.lineWidth = 1;
    for (let i = 1; i < FIELD_GRID_SIZE_M; i++) {
        MAP_CONTEXT.beginPath();
        MAP_CONTEXT.moveTo(i * gridSize, 0);
        MAP_CONTEXT.lineTo(i * gridSize, MAP_CANVAS_PIXELS);
        MAP_CONTEXT.stroke();
        MAP_CONTEXT.beginPath();
        MAP_CONTEXT.moveTo(0, i * gridSize);
        MAP_CONTEXT.lineTo(MAP_CANVAS_PIXELS, i * gridSize);
        MAP_CONTEXT.stroke();
    }

    // Draw Plant Zones (Circles with Health Color)
    FIELD_PLANT_LOCATIONS_M.forEach(plantLoc => {
        const result = latestAnalysisResults[plantLoc.id];
        const color = result ? result.color : '#58a6ff'; // Blue for no data
        
        const centerX = plantLoc.x * gridSize - (gridSize / 2);
        const centerY = plantLoc.y * gridSize - (gridSize / 2);
        
        MAP_CONTEXT.beginPath();
        MAP_CONTEXT.arc(centerX, centerY, PLANT_CIRCLE_RADIUS * 1.5, 0, Math.PI * 2);
        MAP_CONTEXT.fillStyle = color;
        MAP_CONTEXT.fill();
        MAP_CONTEXT.strokeStyle = '#ffffff';
        MAP_CONTEXT.lineWidth = 1;
        MAP_CONTEXT.stroke();
        
        // Add Zone ID Text
        MAP_CONTEXT.fillStyle = '#0d1117';
        MAP_CONTEXT.font = '8px monospace';
        MAP_CONTEXT.textAlign = 'center';
        MAP_CONTEXT.textBaseline = 'middle';
        MAP_CONTEXT.fillText(plantLoc.id, centerX, centerY);
    });
}

function generatePhotoGrid() {
    PHOTO_GRID_ELEMENT.innerHTML = '';
    FIELD_PLANT_LOCATIONS_M.forEach(plantLoc => {
        const zoneID = plantLoc.id;
        const cell = document.createElement('div');
        cell.className = 'grid-cell';
        cell.id = `zone-cell-${zoneID}`;
        cell.setAttribute('data-zone-id', zoneID);
        cell.onclick = () => handleClickOnZone(zoneID);
        cell.innerHTML = `Zone ${zoneID}`;

        const photoData = currentPhotoAssignmentData[zoneID];
        if (photoData) {
            // Find the base64 URL by splitting off the diagnosis string
            const base64Url = photoData.includes('_diag:') ? photoData.split('_diag:')[0] : photoData;
            
            const img = document.createElement('img');
            img.src = base64Url;
            img.className = 'grid-cell-img';
            cell.appendChild(img);
            
            // Add delete button
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-photo-btn';
            deleteBtn.textContent = 'X';
            deleteBtn.onclick = (e) => { 
                e.stopPropagation(); // Prevent triggering cell click
                deletePhotoAssignment(zoneID); 
            };
            cell.appendChild(deleteBtn);
        }
        PHOTO_GRID_ELEMENT.appendChild(cell);
    });
}

function handleClickOnZone(zoneID) {
    currentlySelectedPlantZone = zoneID;
    CURRENT_ZONE_SELECTION_DISPLAY.innerText = zoneID;
    MODAL_ZONE_SELECTION_DISPLAY.innerText = zoneID;
    
    // Trigger the hidden file input (V19.0: This is the user-uploaded image path)
    ZONE_FILE_INPUT.click();
}

function deletePhotoAssignment(zoneID) {
    delete currentPhotoAssignmentData[zoneID];
    localStorage.setItem('photoAssignments', JSON.stringify(currentPhotoAssignmentData));
    generatePhotoGrid();
    triggerComprehensiveAnalysisCycle();
    STATUS_ELEMENT.innerText = `SUCCESS: Photo removed from Zone ${zoneID}. Re-running analysis.`;
}

// --- Dummy Functions for completeness (using V19.0 logic) ---

function generateRandomMockDiagnosis() {
    const diagnoses = ['Healthy', 'Mild Yellowing/Stress', 'Severe Fungal/Dark Spots', 'Critical Viral/Mottling', 'Edging Burn/K Deficiency'];
    const randomDiagnosis = diagnoses[Math.floor(Math.random() * diagnoses.length)];
    // Return a format that includes the mock diagnosis for the analysis engine to extract
    return randomDiagnosis;
}

function populateStockPhotos() {
    // This function remains to populate the stock gallery, which the analysis engine can use.
    for (let i = 1; i <= MAX_STOCK_PHOTOS; i++) {
        const mockDiagnosis = generateRandomMockDiagnosis();
        stockPhotoLibraryData[i] = `data:image/jpeg;base64,stock_leaf_${i}_diag:${mockDiagnosis.replace(/\s/g, '_').replace(/[()]/g, '')}`;
    }
}

function openStockImageGalleryModal() {
    if (currentlySelectedPlantZone === 0) {
        alert("Please click on a Zone (1-16) on the grid first to select the target for the photo assignment.");
        return;
    }
    const grid = document.getElementById('stockImageGrid');
    grid.innerHTML = '';
    
    for (let i = 1; i <= MAX_STOCK_PHOTOS; i++) {
        const photoData = stockPhotoLibraryData[i];
        const base64Url = photoData.includes('_diag:') ? photoData.split('_diag:')[0] : photoData;
        const diagnosis = photoData.includes('_diag:') ? photoData.split('_diag:')[1].replace(/_/g, ' ') : 'N/A';
        
        const img = document.createElement('img');
        img.src = base64Url;
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.objectFit = 'cover';
        img.style.border = '2px solid #58a6ff';
        img.style.borderRadius = '8px';
        img.style.cursor = 'pointer';
        img.title = `Stock ID ${i}: ${diagnosis}`;
        
        img.onclick = () => {
            currentPhotoAssignmentData[currentlySelectedPlantZone] = photoData;
            localStorage.setItem('photoAssignments', JSON.stringify(currentPhotoAssignmentData));
            generatePhotoGrid();
            triggerComprehensiveAnalysisCycle();
            closeStockImageGalleryModal();
            STATUS_ELEMENT.innerText = `SUCCESS: Stock Photo ${i} assigned to Zone ${currentlySelectedPlantZone}. Running analysis...`;
        };
        grid.appendChild(img);
    }
    STOCK_MODAL.style.display = 'block';
}

function closeStockImageGalleryModal() {
    STOCK_MODAL.style.display = 'none';
}

function resetSensorAndMapData() {
    if (!confirm("Are you sure you want to clear ALL logged sensor data, photo assignments, and analysis results? This action is permanent unless saved as a Trial.")) return;

    // Clear state
    systemLoggedSensorDataArray = [];
    currentPhotoAssignmentData = {};
    localStorage.removeItem('photoAssignments');
    latestAnalysisResults = {};

    // Reset UI displays
    MOISTURE_DISPLAY_ELEMENT.innerText = 'N/A';
    NPK_DISPLAY_ELEMENT.innerText = 'N/A';
    CURRENT_ZONE_SELECTION_DISPLAY.innerText = 'N/A';
    
    // Redraw
    generatePhotoGrid();
    renderAnalysisCards();
    updateMapVisualization();
    draw3DMap();
    
    STATUS_ELEMENT.innerText = "SYSTEM STATE: All transient data cleared. Ready for new acquisition cycle.";
}

function executeTrialSaveOperation() {
    // Save current state
    const trialData = {
        id: currentIncrementalTrialID,
        timestamp: new Date().toLocaleString(),
        photos: { ...currentPhotoAssignmentData },
        sensors: [...systemLoggedSensorDataArray],
        analysis: { ...latestAnalysisResults }
    };

    // Add to history (FIFO if max capacity reached)
    if (trialHistoryRecords.length >= MAX_HISTORY_TRIALS) {
        trialHistoryRecords.shift(); // Remove oldest
    }
    trialHistoryRecords.push(trialData);
    localStorage.setItem('trialHistory', JSON.stringify(trialHistoryRecords));

    // Increment and update display
    currentIncrementalTrialID++;
    document.getElementById('currentTrialNumber').innerText = currentIncrementalTrialID;
    STATUS_ELEMENT.innerText = `SUCCESS: Trial ${trialData.id} saved to history.`;
}

function openHistoryRetrievalModal() {
    const list = document.getElementById('trialHistoryList');
    list.innerHTML = '';

    if (trialHistoryRecords.length === 0) {
        list.innerHTML = '<p style="color: #f85149;">No saved trial history records found.</p>';
        HISTORY_MODAL.style.display = 'block';
        return;
    }

    trialHistoryRecords.slice().reverse().forEach(trial => { // Display newest first
        const item = document.createElement('div');
        item.className = 'trial-item';
        item.innerHTML = `<strong>Trial ID: ${trial.id}</strong> | Timestamp: ${trial.timestamp} | Data Points: ${trial.sensors.length} | Photos: ${Object.keys(trial.photos).length}`;
        item.onclick = () => restoreTrialState(trial.id);
        list.appendChild(item);
    });

    HISTORY_MODAL.style.display = 'block';
}

function closeHistoryModal() {
    HISTORY_MODAL.style.display = 'none';
    historyIsBeingViewed = false; // Important: reset view state
}

function executeAllHistoryClearance() {
    if (!confirm("WARNING: This will permanently DELETE ALL 50 saved trial records from local storage. Are you absolutely sure?")) return;
    
    trialHistoryRecords = [];
    localStorage.removeItem('trialHistory');
    currentIncrementalTrialID = 1;
    document.getElementById('currentTrialNumber').innerText = currentIncrementalTrialID;
    closeHistoryModal();
    STATUS_ELEMENT.innerText = "HISTORY CLEARANCE EXECUTED: All saved trials deleted.";
}

function restoreTrialState(id) {
    const trial = trialHistoryRecords.find(t => t.id === id);
    if (!trial) {
        alert("Error: Trial not found.");
        return;
    }

    // Restore state variables
    currentPhotoAssignmentData = { ...trial.photos };
    systemLoggedSensorDataArray = [...trial.sensors];
    latestAnalysisResults = { ...trial.analysis };
    
    // Update local storage for persistence
    localStorage.setItem('photoAssignments', JSON.stringify(currentPhotoAssignmentData));
    
    // Update UI elements
    generatePhotoGrid();
    triggerComprehensiveAnalysisCycle(); // This will redraw maps and cards using restored analysis data
    
    // Display restored sensor data (use the last recorded sensor read if available)
    const lastSensorData = systemLoggedSensorDataArray[systemLoggedSensorDataArray.length - 1];
    if (lastSensorData) {
        MOISTURE_DISPLAY_ELEMENT.innerText = `${lastSensorData.moisture}%`;
        NPK_DISPLAY_ELEMENT.innerText = `N:${lastSensorData.N}, P:${lastSensorData.P}, K:${lastSensorData.K}`;
    } else {
        MOISTURE_DISPLAY_ELEMENT.innerText = 'N/A';
        NPK_DISPLAY_ELEMENT.innerText = 'N/A';
    }

    closeHistoryModal();
    STATUS_ELEMENT.innerText = `SUCCESS: Trial ${id} restored. Current system state reflects restored data.`;
}

function transmitSensorDataViaESP32ToThingSpeak(dataPacket) {
    // Simulation: In a real system, you would use the confirmed IP/API Key to send data.
    const apiEndpointUrl = `http://${HARDWARE_ESP32_IP_ADDRESS}/update`; 
    document.getElementById('thingspeakStatus').innerText = 'TRANSMITTING...';
    
    // Mock ThingSpeak URL payload for simulation (actual fetch will fail due to local IP/no-cors)
    const urlPayload = `${apiEndpointUrl}?moisture=${dataPacket.moisture}&N=${dataPacket.N}&P=${dataPacket.P}&K=${dataPacket.K}`;

    // Mock fetch response for demonstration
    setTimeout(() => {
        document.getElementById('thingspeakStatus').innerText = `SUCCESS: Data package sent to ${HARDWARE_ESP32_IP_ADDRESS}`; 
    }, 500);

    // Actual fetch code (commented out as it often causes CORS errors in a local browser environment)
    /*
    fetch(urlPayload, { method: 'GET', mode: 'no-cors' }) 
        .then(() => { 
            document.getElementById('thingspeakStatus').innerText = `SUCCESS: Data pushed to ${HARDWARE_ESP32_IP_ADDRESS}`; 
        })
        .catch(error => { 
            document.getElementById('thingspeakStatus').innerText = `ERROR: ESP32/ThingSpeak Transmission Failed.`; 
            console.error("Transmission Error:", error); 
        });
    */
}

// ==================================================================================
// SECTION 5.0: INITIALIZATION (GUARANTEEING STARTUP STATE)
// ----------------------------------------------------------------------------------

/**
 * @function onDocumentReady
 * Executes once the DOM is fully loaded.
 */
function onDocumentReady() {
    initThreeD();
    populateStockPhotos(); 
    generatePhotoGrid();
    
    // CRITICAL V19.0: Auto-load existing data from localStorage and run analysis
    if (systemLoggedSensorDataArray.length === 0 && Object.keys(currentPhotoAssignmentData).length === 0) {
        // If no data is found, ensure analysis cards are still visible (as "No Data")
        renderAnalysisCards(); 
    } else {
        triggerComprehensiveAnalysisCycle(); // Load state if data was found in localStorage
    }
    
    STATUS_ELEMENT.innerText = "SYSTEM BOOT: DOM Ready. Awaiting OpenCV.js initialization for full CV capability.";
}
window.onload = onDocumentReady;

/**
 * @function onOpenCvReady
 * Executes once the OpenCV.js library is loaded.
 */
function onOpenCvReady() {
    openCvLibraryIsReady = true;
    STATUS_ELEMENT.innerText = "System Status: OpenCV.js Library Initialized. Rover Control System Fully Operational.";
}

// --- Initialize Zone Select in Manual Modal (Needs to run on load to populate dropdown) ---
document.addEventListener('DOMContentLoaded', () => {
    // Fill the zone dropdown once the DOM is ready
    for (let i = 1; i <= 16; i++) {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = `Zone ${i}`;
        MANUAL_ZONE_SELECT.appendChild(option);
    }
});
</script>
</body>
</html>
