<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S.C.O.U.T. Rover Mapping & Control (4m Grid)</title>
    <style>
        /* BASE STYLING (Dark Theme) */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background-color: #1e1e1e; color: #d4d4d4; }
        .container { max-width: 1400px; margin: auto; background: #2d2d30; padding: 25px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.5); display: flex; flex-wrap: wrap; }
        
        /* LAYOUT PANELS */
        .controls-panel { flex: 1; min-width: 350px; padding-right: 20px; }
        .map-panel { flex: 1; min-width: 450px; }
        .photo-panel { flex: 1; min-width: 450px; padding-left: 20px; border-left: 1px solid #3c3c3c; } 
        
        /* TYPOGRAPHY & HEADERS */
        h1 { color: #569cd6; border-bottom: 3px solid #3c3c3c; padding-bottom: 10px; }
        h2 { color: #4ec9b0; margin-top: 20px; }
        h3 { color: #c8c8c8; margin-top: 10px; }
        #status { font-weight: bold; color: #ffcc00; }

        /* BUTTONS */
        button { padding: 12px 18px; margin: 8px 5px; cursor: pointer; border: none; border-radius: 6px; font-weight: bold; transition: background-color 0.2s; }
        .move-controls button { background-color: #569cd6; color: white; }
        .arm-controls button { background-color: #6a9955; color: white; }
        .camera-control button { background-color: #ce4257; color: white; }
        
        /* DATA DISPLAY */
        .data-display { margin-top: 20px; padding: 15px; border: 1px solid #3c3c3c; border-radius: 6px; background-color: #252526; }
        .data-row strong { display: inline-block; width: 140px; color: #9cdcfe; }
        
        /* CANVAS MAP (4m x 4m) */
        #roverMap { border: 3px solid #6a9955; background-color: #3d3d3d; display: block; margin: 20px auto 0; }
        
        /* AI RESULTS STYLING */
        #ai-analysis { margin-top: 15px; padding: 15px; border: 2px solid #ff007f; border-radius: 6px; background-color: #3e2d30; }
        #ai-analysis strong { color: #f28b82; }

        /* 4x4 PHOTO GRID STYLES */
        #photoGrid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(4, 1fr);
            gap: 5px;
            border: 2px solid #569cd6;
            max-width: 450px;
            margin: 20px auto;
            aspect-ratio: 1 / 1; 
            background-color: #252526;
        }
        .grid-cell {
            background-color: #3d3d3d;
            border: 1px solid #4ec9b0;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            overflow: hidden;
            transition: background-color 0.1s;
        }
        .grid-cell:hover { background-color: #555; }
        .cell-label {
            position: absolute;
            top: 5px;
            left: 5px;
            font-weight: bold;
            color: #4ec9b0;
            font-size: 16px;
            z-index: 10;
            background: rgba(45, 45, 48, 0.7);
            padding: 2px 5px;
            border-radius: 3px;
        }
        .cell-photo {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="controls-panel">
        <h1>S.C.O.U.T. Rover Control</h1>
        <p>System Status: <span id="status">Connecting...</span></p>

        <div id="ai-analysis">
            <h2>Comprehensive Analysis üß†</h2>
            <p><strong>Last Update Time:</strong> <span id="ai-time">N/A</span></p>
            
            <h3>Image Analysis</h3>
            <p><strong>Crop Health Score:</strong> <span id="ai-health">N/A</span></p>
            
            <h3>Soil Moisture Analysis</h3>
            <p><strong>Moisture Status:</strong> <span id="ai-moisture-status">N/A</span></p>
            <p><strong>Moisture Reading:</strong> <span id="ai-moisture-value">N/A</span></p>

            <h3>NPK Analysis</h3>
            <p><strong>Nutrient Balance:</strong> <span id="ai-npk-status">N/A</span></p>
            <p><strong>NPK Reading:</strong> <span id="ai-npk-value">N/A</span></p>

            <h3 style="border-bottom: none;">Overall Recommendation</h3>
            <p><strong>Action Required:</strong> <span id="ai-recommendation">N/A</span></p>
        </div>

        <div class="move-controls">
            <h2>Rover Movement</h2>
            <button onclick="sendCommand('forward')">Forward (‚Üë)</button>
            <button onclick="sendCommand('stop')">üõë STOP</button>
            <button onclick="sendCommand('backward')">Backward (‚Üì)</button><br>
            <button onclick="sendCommand('left')">Left (‚Üê)</button>
            <button onclick="sendCommand('right')">Right (‚Üí)</button>
        </div>

        <hr style="border-top: 1px solid #3c3c3c;">

        <div class="arm-controls">
            <h2>Data Acquisition</h2>
            <button onclick="sendCommand('probe')">üî¨ Probe Soil (Arm Down)</button>
            <button onclick="sendCommand('read_sensors')">üíß Read Soil Data</button>
            <button onclick="sendCommand('read_nav')">üß≠ Get GPS/Heading</button>
        </div>

        <hr style="border-top: 1px solid #3c3c3c;">

        <div class="data-display">
            <h2>Live Sensor Data</h2>
            
            <h3>Navigation Data</h3>
            <div class="data-row"><strong>Latitude:</strong> <span id="latitudeData">N/A</span></div>
            <div class="data-row"><strong>Longitude:</strong> <span id="longitudeData">N/A</span></div>
            <div class="data-row"><strong>GPS Fix:</strong> <span id="gpsFix">No Fix</span></div>
            <div class="data-row"><strong>Heading:</strong> <span id="headingData">N/A</span></div>

            <h3>Soil Data</h3>
            <div class="data-row"><strong>Moisture:</strong> <span id="moistureData">N/A</span></div>
            <div class="data-row"><strong>NPK (N, P, K):</strong> <span id="npkData">N/A</span></div>
        </div>
    </div>

    <div class="map-panel">
        <h2>Field Map ($\mathbf{4\text{m} \times 4\text{m}}$ Grid)</h2>
        <canvas id="roverMap" width="450" height="450"></canvas>
        <p>Map Key: $\text{Grid} = 1 \text{m} \times 1 \text{m}$. $\text{Circles} = \text{Health}$. $\text{Triangle} = \text{Rover}$.</p>
        <button onclick="clearMapData()">üóëÔ∏è Clear Map Data</button>
    </div>

    <div class="photo-panel">
        <div class="camera-control">
            <h2>Image Capture & Gallery</h2>
            <button onclick="sendCommand('capture')">üì∏ Take Photo (to Dell Wyse)</button>
            <p>Last photo status: <span id="lastPhotoStatus">N/A</span>. Sent to Dell Wyse server at <span id="server-ip">192.168.X.X:5000</span>.</p>
        </div>

        <hr style="border-top: 1px solid #3c3c3c;">

        <h2>Manual Photo Upload Map (Zones 1-16)</h2>
        <p>Click a zone below to manually upload a photo for that $\mathbf{1\text{m} \times 1\text{m}}$ area.</p>
        <div id="photoGrid">
            </div>
        <input type="file" id="fileInput" accept="image/*" style="display:none;" onchange="handleFileSelect(event)">
        <p><small>Note: Uploaded photos are stored locally in your browser's memory/cache.</small></p>
    </div>
</div>

<script>
    // JAVASCRIPT LOGIC
    
    // !!! CONFIGURE YOUR IPs HERE !!!
    const ESP32_IP = '192.168.1.50'; 
    const DELL_WYSE_IP = 'http://192.168.X.X:5000'; 
    
    const ESP32_URL_BASE = `http://${ESP32_IP}`;
    const STATUS_ELEMENT = document.getElementById('status');
    const LAST_PHOTO_STATUS = document.getElementById('lastPhotoStatus');
    
    // Update the server IP display on the page
    document.getElementById('server-ip').innerText = DELL_WYSE_IP.replace('http://', ''); 

    // --- MAP CONSTANTS (4m x 4m) ---
    const MAP_CANVAS = document.getElementById('roverMap');
    const CTX = MAP_CANVAS.getContext('2d');
    const MAP_SIZE = 450; 
    const FIELD_SIZE = 4; // 4 meters
    const PIXELS_PER_METER = MAP_SIZE / FIELD_SIZE;
    
    // Plant locations in meters (16 total for a 4x4 grid)
    const PLANT_LOCATIONS_M = [
        {x: 0.5, y: 0.5}, {x: 1.5, y: 0.5}, {x: 2.5, y: 0.5}, {x: 3.5, y: 0.5},
        {x: 0.5, y: 1.5}, {x: 1.5, y: 1.5}, {x: 2.5, y: 1.5}, {x: 3.5, y: 1.5},
        {x: 0.5, y: 2.5}, {x: 1.5, y: 2.5}, {x: 2.5, y: 2.5}, {x: 3.5, y: 2.5},
        {x: 0.5, y: 3.5}, {x: 1.5, y: 3.5}, {x: 2.5, y: 3.5}, {x: 3.5, y: 3.5}
    ];

    let loggedData = []; 
    let selectedZone = 0; 

    let currentRoverData = {
        latitude: 'N/A', 
        longitude: 'N/A', 
        heading: 0, 
        x_m: 2.0, 
        y_m: 2.0 
    };
    
    // ------------------------------------
    // --- PHOTO GRID FUNCTIONS ---
    // ------------------------------------
    
    function generatePhotoGrid() {
        const grid = document.getElementById('photoGrid');
        for (let i = 1; i <= 16; i++) {
            const cell = document.createElement('div');
            cell.className = 'grid-cell';
            cell.id = 'zone-' + i;
            cell.innerHTML = '<span class="cell-label">' + i + '</span>';
            
            cell.addEventListener('click', function() {
                selectedZone = i;
                document.getElementById('fileInput').click(); 
            });
            
            grid.appendChild(cell);
            loadPhoto(i); 
        }
    }

    function handleFileSelect(event) {
        const file = event.target.files[0];
        if (!file || selectedZone === 0) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            const base64Image = e.target.result;
            localStorage.setItem('zonePhoto' + selectedZone, base64Image);
            loadPhoto(selectedZone, base64Image);
            selectedZone = 0; 
        };
        reader.readAsDataURL(file); 
    }

    function loadPhoto(zoneId, base64Image) {
        const cell = document.getElementById('zone-' + zoneId);
        if (!cell) return;
        
        if (!base64Image) {
            base64Image = localStorage.getItem('zonePhoto' + zoneId);
        }
        
        const existingPhoto = cell.querySelector('.cell-photo');
        if (existingPhoto) existingPhoto.remove();

        if (base64Image) {
            const img = document.createElement('img');
            img.src = base64Image;
            img.className = 'cell-photo';
            cell.appendChild(img);
        }
    }

    // ------------------------------------
    // --- AI AND COMMUNICATION FUNCTIONS ---
    // ------------------------------------
    
    // Note: AI results still show N/A by default in HTML
    function fetchAIResults() {
        fetch(DELL_WYSE_IP + '/ai_results')
            .then(response => {
                if (!response.ok) { throw new Error('Dell Wyse Server returned error ' + response.status); }
                return response.json();
            })
            .then(data => {
                document.getElementById('ai-time').innerText = data.last_analysis_time || 'N/A';
                document.getElementById('ai-health').innerText = data.image_health_score || 'N/A';
                document.getElementById('ai-recommendation').innerText = data.overall_recommendation || 'N/A';
                document.getElementById('ai-moisture-status').innerText = data.moisture_status || 'N/A';
                document.getElementById('ai-moisture-value').innerText = data.moisture_value || 'N/A';
                document.getElementById('ai-npk-status').innerText = data.npk_status || 'N/A';
                document.getElementById('ai-npk-value').innerText = data.npk_value || 'N/A';
            })
            .catch(error => {
                // If fetch fails, explicitly set values back to ERROR/N/A
                document.getElementById('ai-time').innerText = 'ERROR';
                document.getElementById('ai-health').innerText = 'ERROR';
                document.getElementById('ai-recommendation').innerText = 'Cannot connect to Dell Wyse AI server.';
                document.getElementById('ai-moisture-status').innerText = 'ERROR';
                document.getElementById('ai-npk-status').innerText = 'ERROR';
                console.error('Fetch AI error:', error);
            });
    }

    function sendCommand(command) {
        let url = (command === 'capture') ? `${ESP32_URL_BASE}/capture` : `${ESP32_URL_BASE}/move?dir=${command}`;
        
        STATUS_ELEMENT.innerText = `Sending command: ${command}...`;
        if (command === 'capture') { LAST_PHOTO_STATUS.innerText = 'Attempting capture...'; }

        fetch(url)
            .then(response => {
                if (!response.ok) { throw new Error(`HTTP Error: ${response.status}`); }
                return response.text();
            })
            .then(data => {
                STATUS_ELEMENT.innerText = `Command '${command}' Success.`;
                if (command === 'capture') {
                    LAST_PHOTO_STATUS.innerText = 'Photo command sent. Awaiting Wyse confirmation (poll AI results).';
                }
                
                // Only run mock data/logging if a read command was sent
                if (command.startsWith('read_') || command === 'probe') {
                    setTimeout(() => fetchData(command), 500); 
                    setTimeout(() => fetchAIResults(), 1000); 
                }
            })
            .catch(error => {
                STATUS_ELEMENT.innerText = `ERROR: Command ${command} failed. Is ESP32 at ${ESP32_IP} online?`;
                if (command === 'capture') { LAST_PHOTO_STATUS.innerText = 'Capture Failed.'; }
                console.error('Error sending command:', error);
            });
    }
    
    // --- MOCK/SIMULATED DATA FETCH (Only runs on manual command for now) ---
    function fetchData(lastCommand = null) {
        
        STATUS_ELEMENT.innerText = "Fetching latest data...";
        
        setTimeout(() => {
            // Simulate GPS/Nav Data
             let headingStr = (Math.random() * 360).toFixed(1) + ' deg';
             currentRoverData.heading = parseFloat(headingStr.split(' ')[0]) || 0; 
             document.getElementById('latitudeData').innerText = "40.7128"; // Mock data starts here
             document.getElementById('longitudeData').innerText = "-74.0060";
             document.getElementById('gpsFix').innerText = "3D Fix";
             document.getElementById('headingData').innerText = headingStr;

             // Simulate Rover Movement (random walk)
             if (lastCommand !== 'read_nav' && lastCommand !== 'stop') {
                 currentRoverData.x_m = Math.min(FIELD_SIZE, Math.max(0, parseFloat(currentRoverData.x_m) + (Math.random() - 0.5) * 0.1)).toFixed(2);
                 currentRoverData.y_m = Math.min(FIELD_SIZE, Math.max(0, parseFloat(currentRoverData.y_m) + (Math.random() - 0.5) * 0.1)).toFixed(2);
             }

             // Simulate Soil Data
             let moistureStr = (Math.random() * 80 + 10).toFixed(1) + '%';
             let npkStr = `N:${Math.floor(Math.random() * 100)}, P:${Math.floor(Math.random() * 100)}, K:${Math.floor(Math.random() * 100)}`;
             document.getElementById('moistureData').innerText = moistureStr;
             document.getElementById('npkData').innerText = npkStr;
            
             // Log Data if a read command was sent
             if (lastCommand === 'probe' || lastCommand === 'read_sensors') {
                
                 let moisture = parseFloat(moistureStr.split('%')[0]) || 0;
                 let npk_values = npkStr.match(/N:(\d+), P:(\d+), K:(\d+)/);
                 let npk_n = npk_values ? parseInt(npk_values[1]) : 0;
                 let npk_p = npk_values ? parseInt(npk_values[2]) : 0;
                 let npk_k = npk_values ? parseInt(npk_values[3]) : 0;
                
                 let healthStatus = analyzeHealth(moisture, npk_n, npk_p, npk_k);

                 loggedData.push({
                     x_m: parseFloat(currentRoverData.x_m),
                     y_m: parseFloat(currentRoverData.y_m),
                     healthStatus: healthStatus,
                     moisture: moisture
                 });
                 STATUS_ELEMENT.innerText = `Data logged! Status: ${healthStatus}`;
             }

             // Draw the map with the new data
             drawMap();
             STATUS_ELEMENT.innerText = "Data update complete.";

        }, 500); // Simulate network delay
    }
    
    // ------------------------------------
    // --- MAP & HEALTH LOGIC (4x4) ---
    // ------------------------------------

    function analyzeHealth(moisture, npk_n, npk_p, npk_k) {
        let issues = 0;
        const MIN_MOISTURE = 30;
        const IDEAL_NPK_SUM = 150; 
        const NPK_TOLERANCE = 50;

        if (moisture < MIN_MOISTURE || moisture > 80) { issues++; } 
        
        let npk_sum = npk_n + npk_p + npk_k;
        if (Math.abs(npk_sum - IDEAL_NPK_SUM) > NPK_TOLERANCE) { issues++; } 

        if (issues >= 2) return 'Bad';
        if (issues === 1) return 'Caution';
        return 'Good';
    }
    
    function getHealthColor(status) {
        switch (status) {
            case 'Good': return '#28a745'; 
            case 'Caution': return '#ffc107'; 
            case 'Bad': return '#dc3545'; 
            default: return '#5a5a5a'; 
        }
    }
    
    function clearMapData() {
        loggedData = [];
        drawMap();
        STATUS_ELEMENT.innerText = "Map data cleared.";
    }

    function drawMap() {
        CTX.clearRect(0, 0, MAP_SIZE, MAP_SIZE);
        
        // 1. Draw the 4x4 Grid
        CTX.strokeStyle = '#5a5a5a'; 
        CTX.lineWidth = 1;
        for (let i = 1; i < FIELD_SIZE; i++) { 
            let px = i * PIXELS_PER_METER;
            CTX.beginPath(); CTX.moveTo(px, 0); CTX.lineTo(px, MAP_SIZE); CTX.stroke();
            CTX.beginPath(); CTX.moveTo(0, px); CTX.lineTo(MAP_SIZE, px); CTX.stroke();
        }

        // 2. Map Soil Condition (Background Squares)
        const GRID_SIZE_M = 1.0;
        for (let row = 0; row < FIELD_SIZE; row++) { 
            for (let col = 0; col < FIELD_SIZE; col++) { 
                let center_x_m = col * GRID_SIZE_M + 0.5;
                let center_y_m = row * GRID_SIZE_M + 0.5;

                let nearestData = null;
                let min_dist_sq = Infinity;

                loggedData.forEach(data => {
                    let dx = data.x_m - center_x_m;
                    let dy = data.y_m - center_y_m;
                    let dist_sq = dx * dx + dy * dy;

                    if (dist_sq < min_dist_sq) {
                        min_dist_sq = dist_sq;
                        nearestData = data;
                    }
                });

                if (nearestData && min_dist_sq < 0.5 * 0.5) { 
                    let moistureColor;
                    if (nearestData.moisture < 20) { moistureColor = '#0070e040'; } 
                    else if (nearestData.moisture > 70) { moistureColor = '#80008040'; } 
                    else { moistureColor = '#6a995540'; } 
                    
                    CTX.fillStyle = moistureColor;
                    CTX.fillRect(
                        col * PIXELS_PER_METER, 
                        MAP_SIZE - ((row + 1) * PIXELS_PER_METER), 
                        PIXELS_PER_METER, 
                        PIXELS_PER_METER
                    );
                }
            }
        }

        // 3. Draw Plant Health Circles
        PLANT_LOCATIONS_M.forEach((plant, index) => {
            let px = plant.x * PIXELS_PER_METER;
            let py = MAP_SIZE - (plant.y * PIXELS_PER_METER);

            let nearestData = null;
            let min_dist_sq = Infinity;

            loggedData.forEach(data => {
                let dx = data.x_m - plant.x;
                let dy = data.y_m - plant.y;
                let dist_sq = dx * dx + dy * dy;

                if (dist_sq < min_dist_sq) {
                    min_dist_sq = dist_sq;
                    nearestData = data;
                }
            });

            let plantColor = nearestData ? getHealthColor(nearestData.healthStatus) : '#5a5a5a'; 
            
            CTX.fillStyle = plantColor;
            CTX.beginPath();
            CTX.arc(px, py, 6, 0, 2 * Math.PI); 
            CTX.fill();
            
            if (nearestData) {
                CTX.fillStyle = 'white';
                CTX.font = '10px Arial';
                CTX.fillText(nearestData.healthStatus.charAt(0), px - 3, py + 3);
            }
        });

        // 4. Draw Rover Position and Heading (Triangle)
        let rover_x_px = currentRoverData.x_m * PIXELS_PER_METER;
        let rover_y_px = MAP_SIZE - (currentRoverData.y_m * PIXELS_PER_METER);
        let heading_rad = (currentRoverData.heading - 90) * (Math.PI / 180);

        CTX.fillStyle = '#9cdcfe';
        CTX.save();
        CTX.translate(rover_x_px, rover_y_px);
        CTX.rotate(heading_rad); 

        CTX.beginPath();
        CTX.moveTo(10, 0);  
        CTX.lineTo(-10, -8); 
        CTX.lineTo(-10, 8);  
        CTX.closePath();
        CTX.fill();

        CTX.restore();

        CTX.fillStyle = 'white';
        CTX.beginPath();
        CTX.arc(rover_x_px, rover_y_px, 3, 0, 2 * Math.PI);
        CTX.fill();
    }
    
    // --- Initialization ---
    window.onload = function() {
        drawMap(); 
        generatePhotoGrid(); 
        // We SKIP the initial fetchData() call here to ensure data fields start as N/A.
        // The data fields will only update/show mock data when a 'read' or 'probe' command is manually sent.
        
        fetchAIResults(); // Still check the AI server status, even if no data is available.
        // We SKIP the setInterval(fetchData, 3000) call to prevent automatic mock data updates.
        setInterval(fetchAIResults, 5000); // Polling for AI analysis results remains active.
        LAST_PHOTO_STATUS.innerText = 'No photos taken yet.';
    };
</script>

</body>
</html>
