<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>S.C.O.U.T. Rover Post-Flood Data Fusion & Control Console (V39.0 - Visibility Stack & Zone Selector Fix)</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://unpkg.com/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
<script async src="https://docs.opencv.org/4.x/opencv.js" onload="onOpenCvReady();"></script>
<style>
/* =================================================================
   SECTION 0.1: CRITICAL SYSTEM-WIDE CSS STYLES (Highly Detailed Dark Theme)
   ================================================================= */
body {
    font-family: 'Consolas', 'Segoe UI', monospace;
    margin: 0;
    padding: 25px;
    background-color: #0c1015; /* Deeper background for the ultimate dark mode */
    color: #c9d1d9;
    transition: background-color 0.5s;
    line-height: 1.5;
}
.container {
    max-width: 1920px; /* Maximizing width for high-resolution displays */
    margin: auto;
    background: #161b22;
    padding: 40px;
    border-radius: 18px;
    box-shadow: 0 15px 40px rgba(0,0,0,1.0); /* Increased shadow depth */
    display: flex;
    flex-wrap: wrap;
    border: 3px solid #30363d; /* Thicker border for structural definition */
}
/* LAYOUT AND PANEL DEFINITION (Ensuring Robust Flex Behavior) */
.controls-panel { flex: 1; min-width: 400px; padding-right: 35px; border-right: 1px dashed #30363d; }
.map-panel { flex: 1; min-width: 480px; padding: 0 35px; }
.photo-panel { flex: 1; min-width: 480px; padding-left: 35px; border-left: 1px dashed #30363d; }
.map-3d-panel { flex-basis: 100%; min-width: 100%; margin-top: 40px; padding-top: 20px; border-top: 3px solid #30363d; }
.plant-analysis-panel {
    flex-basis: 100%;
    margin-top: 50px;
    padding-top: 30px;
    border-top: 3px solid #30363d;
}
/* Typography and Status Indicators (Enhanced Visual Feedback) */
h1 { color: #58a6ff; border-bottom: 5px double #30363d; padding-bottom: 15px; margin-bottom: 30px; font-size: 2.6em; font-weight: 800; }
h2 { color: #79c0ff; margin-top: 35px; margin-bottom: 15px; font-size: 1.9em; border-bottom: 1px solid #30363d; padding-bottom: 5px; }
h3 { color: #4ac9b0; margin-top: 20px; font-size: 1.4em; }
#status { font-weight: 900; color: #f08047; font-size: 1.25em; display: block; margin-top: 10px; }
.data-display {
    margin-top: 30px;
    padding: 25px;
    border: 2px solid #30363d;
    border-radius: 12px;
    background-color: #0f131a;
    transition: box-shadow 0.3s;
}
.data-display:hover { box-shadow: 0 0 18px rgba(88, 166, 255, 0.3); }
/* Data Rows (Alignment Control) */
.data-row strong {
    display: inline-block;
    width: 220px; /* Increased for clean alignment */
    color: #4ac9b0;
}
/* Control Buttons (Explicit Color Coding & Code Clean-up) */
button {
    padding: 16px 24px;
    margin: 8px 6px;
    cursor: pointer;
    border: none;
    border-radius: 10px;
    font-weight: bold;
    transition: background-color 0.3s ease, transform 0.1s, box-shadow 0.3s;
    letter-spacing: 1.2px;
    font-size: 1.08em;
    text-transform: uppercase;
    box-shadow: 0 5px 8px rgba(0,0,0,0.5);
    white-space: nowrap;
}
button:hover { transform: translateY(-3px); box-shadow: 0 8px 12px rgba(0,0,0,0.8); }
.move-controls button { background-color: #58a6ff; color: #0d1117; }
.arm-controls button { background-color: #3fb950; color: #0d1117; }
.history-controls button { background-color: #e3b341; color: #0d1117; }
.photo-controls button { background-color: #f08047; color: #0d1117; }
/* Manual Input Styling */
.manual-input-fields input[type="number"], .manual-input-fields select {
    background-color: #0d1117;
    border: 1px solid #30363d;
    color: #c9d1d9;
    padding: 5px;
    border-radius: 4px;
}

/* MAP STYLES */
#roverMap {
    border: 4px solid #58a6ff;
    border-radius: 5px;
    background-color: #0f131a;
}
/* GRID STYLES (4x4 Zones) */
#photoGrid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    grid-template-rows: repeat(4, 1fr);
    gap: 8px;
    border: 3px solid #58a6ff;
    max-width: 480px;
    margin: 25px auto;
    aspect-ratio: 1 / 1;
    background-color: #0f131a;
    position: relative;
}
.grid-cell {
    background-color: #21262d;
    border: 1px solid #3fb950;
    position: relative;
    overflow: hidden;
    aspect-ratio: 1/1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    font-size: 0.9em;
    font-weight: bold;
    color: #4ac9b0;
    transition: border 0.2s, background-color 0.2s;
    cursor: pointer; /* Ensure the cell is clickable */
}
.grid-cell:hover { border: 3px solid #79c0ff; background-color: #2a3038; } 

/* Analysis UI/UX Styles (No change) */
.analysis-card {
    background-color: #0d1117; 
    padding: 25px;
    margin-bottom: 25px;
    border-radius: 12px;
    border: 3px solid; 
    transition: all 0.3s;
}
.analysis-card:hover {
    box-shadow: 0 0 15px rgba(255, 255, 255, 0.1);
}
.plant-id-label {
    font-size: 1.5em;
    font-weight: bold;
    color: #c9d1d9;
    margin-bottom: 10px;
}
.score-badge {
    padding: 8px 12px;
    border-radius: 6px;
    color: #0d1117;
    font-weight: bold;
    font-size: 1.1em;
    display: inline-block;
}
.assessment-section {
    padding: 15px;
    margin-top: 15px;
    margin-bottom: 15px;
    border-radius: 8px;
    border: 1px solid #30363d;
    background-color: #161b22; 
}
.rec-title {
    font-weight: bold;
    color: #79c0ff; 
    margin-bottom: 5px;
    border-bottom: 1px dashed #30363d;
    padding-bottom: 5px;
    font-size: 1.1em;
}
/* Diagnosis-specific text color classes */
.rec-optimal { color: #3fb950; font-weight: bold; } 
.rec-action { color: #e3b341; font-weight: bold; } 
.rec-critical { color: #f85149; font-weight: bold; } 
.rec-no-data { color: #58a6ff; font-style: italic; } 


/* Styles for delete button for embedded file input to work */
.delete-photo-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    padding: 2px 5px;
    font-size: 0.8em;
    z-index: 100; /* CRITICAL: Must be highest for accessibility */
    background-color: #f85149;
    color: #0d1117;
    border-radius: 50%;
    pointer-events: auto; 
}
/* Placeholder text is now visually covered by the file input's large click area */
.placeholder-text {
    position: relative;
    text-align: center;
    z-index: 0; 
}
/* CRITICAL V39.0 FIX: Style for the image, making it higher than the hidden input */
.grid-cell img {
    z-index: 10 !important; /* Higher than file input's z-index 5 */
}
</style>
</head>
<body>
<div class="container">
    <div class="controls-panel">
        <h1>S.C.O.U.T. Post-Flood Assessment Bridge (V39.0)</h1>
        <p>System Diagnostic Status: <span id="status">AWAITING SYSTEM BOOT SEQUENCE COMPLETION...</span></p>

        <div class="data-display history-controls">
            <h2>Trial Preservation Console (MAX 50 Presets)  üíæ   </h2>
            <div class="data-row"><strong>Current System Trial ID:</strong> <span id="currentTrialNumber">1</span></div>
            <p>
                <button onclick="executeTrialSaveOperation()">  üíæ   EXECUTE TRIAL SAVE OPERATION</button>
                <button onclick="openHistoryRetrievalModal()">  üìÖ   RETRIEVE HISTORY (MAX 50)</button>
            </p>
            <p><small>Storage Capacity: **50 Historical Presets**. Oldest trial is automatically purged (FIFO) upon capacity breach.</small></p>
        </div>

        <div class="data-display move-controls">
            <h2>Rover Translational Control (X/Y Axis)</h2>
            <p>Command Structure: X-Axis (Left/Right), Y-Axis (Forward/Backward). **No code leakage in button labels.**</p>
            <button onclick="dispatchRoverMovementCommand('forward')">FORWARD (Y+)</button>
            <button onclick="dispatchRoverMovementCommand('stop')">  üõë  EMERGENCY STOP</button>
            <button onclick="dispatchRoverMovementCommand('backward')">BACKWARD (Y-)</button><br>
            <button onclick="dispatchRoverMovementCommand('left')">LEFT (X-)</button>
            <button onclick="dispatchRoverMovementCommand('right')">RIGHT (X+)</button>
        </div>

        <div class="data-display arm-controls">
            <h2>Data Acquisition (Arduino R3 Sensor Payload)</h2>
            <p>The **ESP32** serves as the critical Wi-Fi bridge for cloud telemetry push. **IP: 10.101.146.88**</p>
            <button onclick="dispatchRoverMovementCommand('probe')">  üî¨  EXTEND PROBE (SOIL READ)</button>
            <button onclick="dispatchRoverMovementCommand('read_sensors')">  üíß  READ ENVIRONMENTAL DATA</button>
            <button onclick="dispatchRoverMovementCommand('read_nav')">  üß≠  ACQUIRE GPS/IMU DATA</button>
        </div>
        
        <div class="data-display arm-controls">
            <h2>Manually Add Sensor Data with Photo  üìù</h2>
            <p>Assign custom sensor data to a specific **Target Zone (1-16)**, then upload photo.</p>
            <div class="manual-input-fields" style="display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; align-items: center;">
                
                <label style="color:#79c0ff; font-weight: bold;">Zone: 
                    <select id="manualTargetZone" style="width: 60px;">
                        </select>
                </label>
                <label style="color:#79c0ff;">Moisture %: <input type="number" id="manualMoisture" min="0" max="100" step="0.1" value="50.0" style="width: 70px;"></label>
                <label style="color:#79c0ff;">N (ppm): <input type="number" id="manualN" min="1" value="150" style="width: 50px;"></label>
                <label style="color:#79c0ff;">P (ppm): <input type="number" id="manualP" min="1" value="80" style="width: 50px;"></label>
                <label style="color:#79c0ff;">K (ppm): <input type="number" id="manualK" min="1" value="150" style="width: 50px;"></label>
            </div>
            <button onclick="dispatchManualDataEntry()" style="background-color: #e341b3; color: #0d1117;">  üìù  SUBMIT MANUAL DATA + PHOTO</button>
            <p><small>**V39.0 Fix:** Select the zone above, then click the button. The photo upload will open automatically.</small></p>
        </div>

        <div class="data-display">
            <h2>Real-time Sensor Telemetry (Raw Feed)</h2>
            <h3>Navigation Subsystem</h3>
            <div class="data-row"><strong>Latitude (GPS):</strong> <span id="latitudeData">N/A</span></div>
            <div class="data-row"><strong>Longitude (GPS):</strong> <span id="longitudeData">N/A</span></div>
            <div class="data-row"><strong>GPS Fix Status:</strong> <span id="gpsFix">N/A</span></div>
            <div class="data-row"><strong>Heading (IMU):</strong> <span id="headingData">N/A</span></div>
            <h3>Soil/Environment Subsystem</h3>
            <div class="data-row"><strong>Soil Moisture (%):</strong> <span id="moistureData">N/A</span></div>
            <div class="data-row"><strong>NPK (N, P, K ppm):</strong> <span id="npkData">N/A</span></div>
            <div class="data-row"><strong>ThingSpeak Status:</strong> <span id="thingspeakStatus">Awaiting Connection (API Key: 6OXH3SUQ4VNSOJX1)</span></div>
        </div>
    </div>

    <div class="map-panel">
        <h2>2D Field Map (4m x 4m Grid - Cleaned Visualization)</h2>
        <p>Grid Key: **Thin Lines** = 1m x 1m. **Colored Circles** = Plant Health. **Blue Triangle** = Rover Position.
        **Zone numbers removed for clarity.**</p>
        <canvas id="roverMap" width="480" height="480"></canvas>
        <p style="margin-top: 15px;">
            <button onclick="resetSensorAndMapData()">  üóë Ô∏è CLEAR ALL TRANSIENT MAP DATA</button>
        </p>
    </div>

    <div class="photo-panel">
        <div class="camera-control data-display">
            <h2>Image Capture & Stock Library</h2>
            <p>TO UPLOAD: **Click any Zone (1-16)** which now guarantees to open the file selection dialog.</p>
            <button onclick="dispatchRoverMovementCommand('capture')" class="photo-controls">  üì∏  TRIGGER CAMERA CAPTURE (Mocked)</button>
            <button onclick="openStockImageGalleryModal()" class="photo-controls">  üñº Ô∏è VIEW STOCK PHOTOS (50 Presets)</button>
            <p>Current Active Zone: **Zone <span id="currentZoneSelection">N/A</span>** (Used for photo upload on cell click)</p>
        </div>
        <hr style="border-top: 2px solid #30363d; margin: 30px 0;">
        <h2>Plant Zone Photo Assignments (16 Zones)</h2>
        <div id="photoGrid">
        </div>
    </div>

    <div class="map-3d-panel">
        <h2>3D Soil Metric Visualization  üìä  (Height=Moisture, Color=Health) - Stem and Oval Leaves</h2>
        <div id="threeDContainer" style="height: 550px; width: 100%;"></div>
    </div>

    <div class="plant-analysis-panel">
        <h2>DATA FUSION ENGINE: Post-Flood Plant Diagnosis (16 Zones)  üî¨  </h2>
        <p>This panel displays the **FUSED** assessment: **Leaf Visual Pre-Assessment (CV)** + **Local Soil Sensor Data**.</p>
        <div id="plantAnalysisGrid">
        </div>
    </div>
</div>

<div id="historyModal" class="modal" onclick="if(event.target.id === 'historyModal') closeHistoryModal()">
    <div class="modal-content">
        <span class="close-btn" onclick="closeHistoryModal()">&times;</span>
        <h2>Saved Trial History Retrieval Console (Maximum Capacity: 50 Presets ENFORCED)</h2>
        <p>Click a trial to restore its exact state (map, photos, and final analysis).</p>
        <div id="trialHistoryList">
        </div>
        <hr style="border-top: 2px solid #30363d; margin-top: 20px;">
        <button onclick="executeAllHistoryClearance()" style="background-color: #f85149;">  üö®  EXECUTE ALL SAVED TRIALS CLEARANCE</button>
    </div>
</div>

<div id="stockImageModal" class="modal" onclick="if(event.target.id === 'stockImageModal') closeStockImageGalleryModal()">
    <div class="modal-content">
        <span class="close-btn" onclick="closeStockImageGalleryModal()">&times;</span>
        <h2>Stock Photo Gallery (50 Pre-Diagnosed Leaf Presets - Click to Assign)</h2>
        <p>Target Zone: **Zone <span id="modalCurrentZoneSelection">N/A</span>** (Click a cell to select a photo)</p>
        <div id="stockImageGrid">
        </div>
    </div>
</div>

<footer>
    <p>&copy; 2025 S.C.O.U.T. Rover Systems - Operational Bridge V39.0. Hardware ESP32 IP: 10.101.146.88 | ThingSpeak API: 6OXH3SUQ4VNSOJX1</p>
</footer>

<script>
// ==================================================================================
// SECTION 0.2: CORE SYSTEM CONSTANTS AND GLOBAL CONFIGURATION (MAXIMAL VERBOSITY)
// ----------------------------------------------------------------------------------
/**
 * @fileoverview S.C.O.U.T. Rover Control System JavaScript Core.
 * Version 39.0: Visibility Stack & Zone Selector Fix - Guarantees photo visibility 
 * and adds dedicated zone selector to manual entry.
 */
// --- 0.2.1 HARDWARE AND NETWORK CONFIGURATION (CRITICAL SYSTEM IDENTIFIERS) ---
const HARDWARE_ESP32_IP_ADDRESS = '10.101.146.88'; 
const THINGSPEAK_API_KEY = '6OXH3SUQ4VNSOJX1'; 
const MAX_HISTORY_TRIALS = 50;
// --- 0.2.2 PHYSICAL SYSTEM AND UI CONSTANTS (STRICT ADHERENCE TO SPECIFICATIONS) ---
const FIELD_GRID_SIZE_M = 4;
const MAP_CANVAS_PIXELS = 480;
const MAX_STOCK_PHOTOS = 50;
const PLANT_CIRCLE_RADIUS = 5;
const SCORE_CAP_ON_PARTIAL_DATA = 50;
// --- 0.2.3 DIAGNOSTIC CONSTANTS (V37.0 - HEALTH SCORE AND THRESHOLDS) ---
const HEALTH_SCORE_THRESHOLDS = {
    CRITICAL: { max: 40, color: '#f85149', label: 'CRITICAL', class: 'rec-critical' }, // Red (0-40)
    ACTION_REQUIRED: { max: 75, color: '#e3b341', label: 'ACTION REQUIRED', class: 'rec-action' }, // Amber (41-75)
    OPTIMAL: { max: 100, color: '#3fb950', label: 'OPTIMAL', class: 'rec-optimal' } // Green (76-100)
};
const SENSOR_SCORE_WEIGHTS = {
    MOISTURE_LOW: 30, 
    MOISTURE_HIGH: 45, 
    NPK_DEFICIENCY: 30, 
    NPK_IMBALANCE: 15, 
};
const OPTIMAL_MOISTURE_RANGE = { min: 35, max: 70 }; 
const FLOOD_MOISTURE_THRESHOLD = 85; 
const OPTIMAL_NPK_RATIO = { N: 150, P: 80, K: 150 }; 
// --- 0.2.4 DOM ELEMENT REFERENCES (MAPPING CORE UI COMPONENTS) ---
const STATUS_ELEMENT = document.getElementById('status');
const MOISTURE_DISPLAY_ELEMENT = document.getElementById('moistureData');
const NPK_DISPLAY_ELEMENT = document.getElementById('npkData');
const HISTORY_TRIAL_COUNTER = document.getElementById('currentTrialNumber');
const MAP_CONTEXT = document.getElementById('roverMap').getContext('2d');
const HISTORY_MODAL = document.getElementById('historyModal');
const STOCK_MODAL = document.getElementById('stockImageModal');
const CURRENT_ZONE_SELECTION_DISPLAY = document.getElementById('currentZoneSelection');
const MANUAL_TARGET_ZONE_SELECT = document.getElementById('manualTargetZone');
// --- 0.2.5 GLOBAL STATE VARIABLES (Clean Initial State Definition) ---
let openCvLibraryIsReady = false;
let systemLoggedSensorDataArray = [];
let currentPhotoAssignmentData = {};
let stockPhotoLibraryData = {};
let currentlySelectedPlantZone = 0; // Zone selected by clicking the grid cell
let historyIsBeingViewed = false;
let currentRoverKinematicState = {
    latitude: 'N/A',
    longitude: 'N/A',
    heading: 0.0,
    x_position_m: 2.0, // Starting center (2, 2)
    y_position_m: 2.0
};
// Persistent Storage Management 
let trialHistoryRecords = JSON.parse(localStorage.getItem('trialHistory') || '[]');
let currentIncrementalTrialID = trialHistoryRecords.length + 1;
HISTORY_TRIAL_COUNTER.innerText = currentIncrementalTrialID;
// Pre-calculated Plant Locations (16 zones)
const FIELD_PLANT_LOCATIONS_M = [];
for(let r=0; r<FIELD_GRID_SIZE_M; r++) {
    for(let c=0; c<FIELD_GRID_SIZE_M; c++) {
        FIELD_PLANT_LOCATIONS_M.push({x: c + 0.5, y: r + 0.5, id: (r * FIELD_GRID_SIZE_M) + c + 1});
    }
}

// ==================================================================================
// SECTION 1.0: HARDWARE COMMUNICATIONS & SENSOR DATA LOGGING (Standard Logic)
// ----------------------------------------------------------------------------------
function transmitSensorDataViaESP32ToThingSpeak(dataPacket) {
    const apiEndpointUrl = "https://api.thingspeak.com/update";
    document.getElementById('thingspeakStatus').innerText = 'TRANSMITTING... (API Key: 6OXH3SUQ4VNSOJX1)';
    const urlPayload = `${apiEndpointUrl}?api_key=${THINGSPEAK_API_KEY}`
        + `&field1=${dataPacket.moisture}&field2=${dataPacket.N}&field3=${dataPacket.P}&field4=${dataPacket.K}`
        + `&field5=${dataPacket.latitude}&field6=${dataPacket.longitude}&field7=${dataPacket.heading}`;

    fetch(urlPayload, { method: 'GET', mode: 'no-cors' })
        .then(() => {
            document.getElementById('thingspeakStatus').innerText = `SUCCESS: Data pushed. (API Key: 6OXH3SUQ4VNSOJX1)`;
        })
        .catch(error => {
            document.getElementById('thingspeakStatus').innerText = `ERROR: ThingSpeak Transmission Failed. (API Key: 6OXH3SUQ4VNSOJX1)`;
            console.error("ThingSpeak Transmission Error:", error);
        });
}

function dispatchRoverMovementCommand(commandIdentifier) {
    STATUS_ELEMENT.innerText = `DISPATCH: Sending command '${commandIdentifier}'...`;
    
    setTimeout(() => {
        STATUS_ELEMENT.innerText = `RESPONSE: Command '${commandIdentifier}' Acknowledged.`;

        if (commandIdentifier.startsWith('read_') || commandIdentifier === 'probe') {
            executeDataAcquisition(commandIdentifier);
        } else if (commandIdentifier === 'capture') {
            // Mock capture logic: Finds the nearest zone and assigns a mock photo
            const zoneID = findNearestPlantZone(currentRoverKinematicState.x_position_m, currentRoverKinematicState.y_position_m)?.id || 1;
            
            let mockDiagnosis;
            if (zoneID % 3 === 0) {
                 mockDiagnosis = 'Dark Spots & Lesions/Blackening of Leaf (Fungal/Bacterial)';
            } else if (zoneID % 5 === 0) {
                 mockDiagnosis = 'Mottling/Mosaic Pattern (Viral-TMV)';
            } else {
                 mockDiagnosis = 'Healthy, Deep Green Foliage';
            }
            
            const mockDataUrl = `data:image/jpeg;base64,mocked_rover_capture_zone_${zoneID}_diag:${mockDiagnosis.replace(/\s/g, '_').replace(/[()]/g, '')}`;

            const fileInput = document.getElementById(`fileInput-${zoneID}`);
            if(fileInput) {
                renderPhotoInPhotoGridCell(zoneID, mockDataUrl, fileInput); 
            } else {
                 console.error(`File input for Zone ${zoneID} not found.`);
            }
            
            selectZone(zoneID);

            STATUS_ELEMENT.innerText = `Photo captured and assigned to nearest Zone ${zoneID}. Triggering Analysis.`;
        } else {
            // Simulate Rover Kinematics Update (0.1m step)
            const step = 0.1;
            let newX = parseFloat(currentRoverKinematicState.x_position_m);
            let newY = parseFloat(currentRoverKinematicState.y_position_m);

            if (commandIdentifier === 'forward') newY = Math.min(FIELD_GRID_SIZE_M, newY + step).toFixed(2);
            if (commandIdentifier === 'backward') newY = Math.max(0, newY - step).toFixed(2);
            if (commandIdentifier === 'left') newX = Math.max(0, newX - step).toFixed(2);
            if (commandIdentifier === 'right') newX = Math.min(FIELD_GRID_SIZE_M, newX + step).toFixed(2);

            currentRoverKinematicState.x_position_m = newX;
            currentRoverKinematicState.y_position_m = newY;
            currentRoverKinematicState.heading = (currentRoverKinematicState.heading + (Math.random() * 5 - 2.5)).toFixed(1);

            updateMapVisualization();
            updateRover3DPosition();
        }
    }, 750);
}

function executeDataAcquisition(acquisitionType) {
    STATUS_ELEMENT.innerText = "SENSOR READ: Acquiring raw data...";
    
    // Simulate sensor data
    const nearestPlant = findNearestPlantZone(currentRoverKinematicState.x_position_m, currentRoverKinematicState.y_position_m);
    const plantID = nearestPlant ? nearestPlant.id : 1;
    
    let moistureVal = (Math.random() * 70 + 20).toFixed(1);
    let npk_n = Math.floor(Math.random() * 150 + 50);
    let npk_p = Math.floor(Math.random() * 100 + 40);
    let npk_k = Math.floor(Math.random() * 180 + 60);

    if (plantID % 3 === 0) {
        moistureVal = (Math.random() * 15 + 5).toFixed(1); 
        npk_n = Math.floor(Math.random() * 30 + 10); 
    } else if (plantID % 4 === 0) {
        moistureVal = (Math.random() * 10 + 85).toFixed(1);
        npk_n = Math.floor(Math.random() * 80 + 20); 
    }

    const heading = (Math.random() * 360).toFixed(1);
    const latitude = `40.7128${(Math.random()*100).toFixed(0)}`;
    const longitude = `-74.0060${(Math.random()*100).toFixed(0)}`;

    MOISTURE_DISPLAY_ELEMENT.innerText = `${moistureVal}%`;
    NPK_DISPLAY_ELEMENT.innerText = `N:${npk_n}, P:${npk_p}, K:${npk_k}`;
    document.getElementById('headingData').innerText = heading + ' deg';
    document.getElementById('latitudeData').innerText = latitude;
    document.getElementById('longitudeData').innerText = longitude;
    document.getElementById('gpsFix').innerText = '3D Fix Acquired';

    transmitSensorDataViaESP32ToThingSpeak({
        moisture: parseFloat(moistureVal),
        N: npk_n,
        P: npk_p,
        K: npk_k,
        latitude: latitude,
        longitude: longitude,
        heading: heading 
    });

    if (acquisitionType === 'probe' || acquisitionType === 'read_sensors') {
        systemLoggedSensorDataArray.push({
            x_m: parseFloat(currentRoverKinematicState.x_position_m),
            y_m: parseFloat(currentRoverKinematicState.y_position_m),
            moisture: parseFloat(moistureVal),
            npk_n: npk_n,
            npk_p: npk_p,
            npk_k: npk_k,
            timestamp: Date.now(),
            zoneID: plantID 
        });
        STATUS_ELEMENT.innerText = `SENSOR READ: Data logged (${systemLoggedSensorDataArray.length} total logs). Triggering Analysis...`;
        triggerComprehensiveAnalysisCycle();
    }
    
    updateMapVisualization();
    draw3DMap();
}

/**
 * V39.0 Fused Entry Fix: Now reads the Zone ID from the new dropdown. Logs data and then
 * immediately clicks the file input to open the upload dialog for the user.
 */
function dispatchManualDataEntry() {
    // V39.0: Read the target zone from the new selector
    const zoneID = parseInt(MANUAL_TARGET_ZONE_SELECT.value); 
    
    if (isNaN(zoneID) || zoneID < 1 || zoneID > 16) {
        STATUS_ELEMENT.innerText = "ERROR: Please select a valid target Zone (1-16) from the dropdown!";
        return;
    }
    
    const moistureVal = parseFloat(document.getElementById('manualMoisture').value);
    const npk_n = parseInt(document.getElementById('manualN').value);
    const npk_p = parseInt(document.getElementById('manualP').value);
    const npk_k = parseInt(document.getElementById('manualK').value);

    if (isNaN(moistureVal) || isNaN(npk_n) || isNaN(npk_p) || isNaN(npk_k)) {
        STATUS_ELEMENT.innerText = "ERROR: All manual sensor fields must contain valid numbers.";
        return;
    }
    
    // 1. Log the manual data to the system array. Use the fixed position of the selected zone.
    systemLoggedSensorDataArray.push({
        x_m: FIELD_PLANT_LOCATIONS_M[zoneID - 1].x,
        y_m: FIELD_PLANT_LOCATIONS_M[zoneID - 1].y,
        moisture: moistureVal,
        npk_n: npk_n,
        npk_p: npk_p,
        npk_k: npk_k,
        timestamp: Date.now(),
        zoneID: zoneID 
    });
    
    MOISTURE_DISPLAY_ELEMENT.innerText = `${moistureVal}% (MANUAL)`;
    NPK_DISPLAY_ELEMENT.innerText = `N:${npk_n}, P:${npk_p}, K:${npk_k} (MANUAL)`;

    // 2. V39.0: Update the current state to highlight the zone visually
    selectZone(zoneID); 
    
    // 3. CRITICAL V38.0/V39.0 Fused Entry Fix: Programmatically click the file input
    const fileInput = document.getElementById(`fileInput-${zoneID}`);
    if (fileInput) {
        fileInput.click();
        STATUS_ELEMENT.innerText = `SUCCESS: Manual Sensor Data for Zone ${zoneID} logged. Opening photo upload dialog now.`;
    } else {
         STATUS_ELEMENT.innerText = `ERROR: Manual Sensor Data for Zone ${zoneID} logged, but failed to find file input for photo upload.`;
    }
    
    // 4. Trigger analysis
    triggerComprehensiveAnalysisCycle();
}


// ==================================================================================
// SECTION 2.0: DIAGNOSTIC KNOWLEDGE BASE & FUSED ANALYSIS CORE (V38.0 Clean-up)
// ----------------------------------------------------------------------------------
const TOMATO_DIAGNOSTIC_KB = {
    'Mottling/Mosaic Pattern (Viral-TMV)': { score_penalty: 45, type: 'Viral', recommendation: "CRITICAL ISOLATION REQUIRED: Strong indicator of Tobacco Mosaic Virus (TMV). **IMMEDIATELY REMOVE AND DESTROY** the plant to prevent field-wide contamination. No chemical cure exists." },
    'Dark Spots & Lesions/Blackening of Leaf (Fungal/Bacterial)': { score_penalty: 35, type: 'Fungal/Bacterial', recommendation: "FUNGICIDE/BACTERICIDE APPLICATION: Likely Early Blight or Bacterial Spot. Apply broad-spectrum copper-based fungicide and focus on improving air circulation and reducing leaf wetness." },
    'General Severe Yellowing (Chlorosis-N)': { score_penalty: 15, type: 'Deficiency', recommendation: "NPK DEFICIENCY LIKELY: Severe general yellowing often indicates primary Nitrogen (N) deficiency. Review sensor data and apply a high-Nitrogen fertilizer source (e.g., urea)." },
    'Edging Burn/Tip Necrosis (K/Salt)': { score_penalty: 20, type: 'Deficiency', recommendation: "POTASSIUM/SALINITY ISSUE: Burnt edges suggest Potassium (K) deficiency or high soil salinity/over-fertilization. Test soil salinity and apply potash or flush the soil if necessary." },
    'Healthy, Deep Green Foliage': { score_penalty: 0, type: 'Optimal', recommendation: "OPTIMAL HEALTH: Visual assessment confirms deep green, vibrant foliage with no signs of disease or pest damage. Maintain current environmental conditions." }
};

function getDiagnosisAndRecommendations(plantData) {
    let totalHealthScore = 100;
    const { moisture, npk_n, npk_p, npk_k, photoDiagnosis } = plantData;

    let analysisDetail = "The Data Fusion Engine has completed a multi-spectral and chemical analysis.\n\n";
    let cv_rec_text = "N/A: No photo data available for visual assessment.";
    let sensor_rec_text = "N/A: No sensor data available for soil assessment.";
    let fused_rec_text = "Awaiting both visual and sensor data to generate a FUSED diagnosis.";
    let healthColorCode = HEALTH_SCORE_THRESHOLDS.CRITICAL.color;
    let cardBorderColor = healthColorCode;
    let isFloodScenario = false;
    
    // 1. --- VISUAL (PARTIAL) ASSESSMENT / PHOTO PENALTY ---
    if (photoDiagnosis) {
        const kbEntry = TOMATO_DIAGNOSTIC_KB[photoDiagnosis];
        if (kbEntry) {
            totalHealthScore -= kbEntry.score_penalty;
            cv_rec_text = `**Leaf Visual Assessment (${kbEntry.type}):** ${kbEntry.recommendation}`;
            analysisDetail += `**VISUAL ASSESSMENT (CV Analysis):** The analysis of the captured photo identified the condition: **${photoDiagnosis}**. This visual indication has triggered a **-${kbEntry.score_penalty} point** penalty, primarily signaling an acute disease or deficiency that requires immediate attention.\n\n`;
        } else {
            cv_rec_text = `**Leaf Visual Assessment (Optimal):** ${TOMATO_DIAGNOSTIC_KB['Healthy, Deep Green Foliage'].recommendation}`;
        }
    }
    
    // 2. --- SENSOR (FULL) ASSESSMENT / SOIL PENALTIES (Post-Flood Context Integrated) ---
    if (moisture !== null) {
        let moisturePenalty = 0;
        let npkPenalty = 0;
        let sensorAnalysis = "";

        // A. MOISTURE ASSESSMENT (Post-Flood Focus)
        if (moisture > FLOOD_MOISTURE_THRESHOLD) {
            moisturePenalty = SENSOR_SCORE_WEIGHTS.MOISTURE_HIGH;
            isFloodScenario = true;
            sensorAnalysis += `* **Moisture Alert (POST-FLOOD):** Soil moisture (${moisture}%) is CRITICALLY HIGH, exceeding the waterlogging threshold (${FLOOD_MOISTURE_THRESHOLD}%). This indicates a high risk of **root hypoxia/soil pathogens** following the flood event. Immediate action is required. (Penalty: -${moisturePenalty})\n`;
        } else if (moisture > OPTIMAL_MOISTURE_RANGE.max) {
            moisturePenalty = SENSOR_SCORE_WEIGHTS.MOISTURE_LOW / 2; 
            sensorAnalysis += `* **Moisture Warning (POST-FLOOD):** Soil moisture (${moisture}%) is above the optimal range. The soil is still saturated, prolonging the post-flood stress period. (Penalty: -${moisturePenalty})\n`;
        } else if (moisture < OPTIMAL_MOISTURE_RANGE.min) {
            moisturePenalty = SENSOR_SCORE_WEIGHTS.MOISTURE_LOW;
            sensorAnalysis += `* **Moisture Deficit (POST-FLOOD):** Soil moisture (${moisture}%) is CRITICALLY LOW. While this is good for flood recovery, it now indicates **drought stress** post-event. The plant may have experienced root damage and is struggling to uptake water. (Penalty: -${moisturePenalty})\n`;
        } else {
            sensorAnalysis += `* **Moisture Status (POST-FLOOD):** Soil moisture (${moisture}%) is within the optimal range of ${OPTIMAL_MOISTURE_RANGE.min}% to ${OPTIMAL_MOISTURE_RANGE.max}%. The soil has successfully drained to a safe level for recovery. (Penalty: 0)\n`;
        }

        // B. NPK ASSESSMENT (Post-Flood Focus)
        if (npk_n < OPTIMAL_NPK_RATIO.N * 0.5) {
            npkPenalty += SENSOR_SCORE_WEIGHTS.NPK_DEFICIENCY;
            sensorAnalysis += `* **NPK Alert (Nitrogen - POST-FLOOD):** Nitrogen (N:${npk_n} ppm) is severely deficient. This is a common and critical result of floodwater **leaching** NPK from the soil. (Penalty: -${SENSOR_SCORE_WEIGHTS.NPK_DEFICIENCY})\n`;
        } else if (npk_n < OPTIMAL_NPK_RATIO.N * 0.8) {
            npkPenalty += SENSOR_SCORE_WEIGHTS.NPK_IMBALANCE;
            sensorAnalysis += `* **NPK Warning (Nitrogen - POST-FLOOD):** Nitrogen (N:${npk_n} ppm) is suboptimal, requiring a top-dress application to compensate for flood losses. (Penalty: -${SENSOR_SCORE_WEIGHTS.NPK_IMBALANCE})\n`;
        } else {
            sensorAnalysis += `* **NPK Status (Nitrogen):** N is acceptable (N:${npk_n} ppm). (Penalty: 0)\n`;
        }
        if (npk_p < OPTIMAL_NPK_RATIO.P * 0.5 || npk_k < OPTIMAL_NPK_RATIO.K * 0.5) {
             npkPenalty += SENSOR_SCORE_WEIGHTS.NPK_DEFICIENCY / 2;
             sensorAnalysis += `* **NPK Alert (P/K - POST-FLOOD):** Phosphorus (P:${npk_p} ppm) or Potassium (K:${npk_k} ppm) is critically low, indicative of **leaching** and high recovery needs. (Penalty: -${SENSOR_SCORE_WEIGHTS.NPK_DEFICIENCY / 2})\n`;
        }

        totalHealthScore -= (moisturePenalty + npkPenalty);
        totalHealthScore = Math.max(0, totalHealthScore); 

        if (isFloodScenario) {
            sensor_rec_text = `**Soil Sensor Assessment (POST-FLOOD MITIGATION PRIORITY):** CRITICAL ACTION REQUIRED: The high moisture level is the primary post-flood threat, indicating poor drainage. The low NPK levels are secondary issues (likely leaching) that must be addressed only after drainage is confirmed. Total sensor penalty: -${moisturePenalty + npkPenalty} points.`;
        } else if (totalHealthScore < 76 && (moisturePenalty > 0 || npkPenalty > 0)) {
            sensor_rec_text = `**Soil Sensor Assessment (POST-FLOOD RECOVERY NEED):** The soil has drained but the high penalty (-${moisturePenalty + npkPenalty} points) indicates severe **nutrient deficiencies/drought stress** caused by the flood event. Immediate fertilization is necessary.`;
        } else {
            sensor_rec_text = `**Soil Sensor Assessment (POST-FLOOD STABLE):** Sensor data indicates optimal soil parameters. The recovery period is stable. Maintain current surveillance.`;
        }
        
        analysisDetail += `**SOIL DATA ANALYSIS (Rover Probe):** Post-Flood analysis registered a total penalty of **-${moisturePenalty + npkPenalty} points** due to the following conditions:\n${sensorAnalysis}\n`;
    }

    // 3. --- FUSED (FINAL) ASSESSMENT ---
    let result = HEALTH_SCORE_THRESHOLDS.OPTIMAL; 
    if (totalHealthScore <= HEALTH_SCORE_THRESHOLDS.CRITICAL.max) {
        result = HEALTH_SCORE_THRESHOLDS.CRITICAL;
    } else if (totalHealthScore <= HEALTH_SCORE_THRESHOLDS.ACTION_REQUIRED.max) {
        result = HEALTH_SCORE_THRESHOLDS.ACTION_REQUIRED;
    }
    
    healthColorCode = result.color;
    cardBorderColor = healthColorCode;
    
    let final_diagnosis_summary = `Based on the merged Post-Flood data streams, the plant is rated **${result.label}** with a final Fused Health Score of **${totalHealthScore.toFixed(0)}/100**. `;
    
    if (isFloodScenario) {
        fused_rec_text = final_diagnosis_summary + `**CRITICAL POST-FLOOD DRAINAGE FAILURE:** The immediate priority is the **Post-Flood Mitigation Protocol (Drainage)**. Waterlogging (high moisture) will prevent all recovery. Address drainage before attempting nutrient correction.`;
    } else if (photoDiagnosis && totalHealthScore < 76 && photoDiagnosis !== 'Healthy, Deep Green Foliage') {
        fused_rec_text = final_diagnosis_summary + `**POST-FLOOD DISEASE OUTBREAK:** The primary threat is the visually identified disease/deficiency (**${photoDiagnosis}**), likely exacerbated by the flood's high humidity/moisture. Targeted chemical treatment is required (as detailed in the Partial Assessment).`;
    } else if (totalHealthScore < 76) {
        fused_rec_text = final_diagnosis_summary + `**POST-FLOOD RECOVERY STAGE:** The soil has drained, but the low health score is due to severe **nutrient leaching**. Implement the nutrient correction actions detailed in the Full Assessment immediately.`;
    } else {
        fused_rec_text = final_diagnosis_summary + `**POST-FLOOD OPTIMAL RECOVERY:** Both visual and sensor data confirm successful drainage and stable health. Continue routine monitoring.`;
    }

    // 4. --- DETAILED FLOOD PROTOCOL ADDENDUM ---
    if (isFloodScenario) {
        analysisDetail += `\n**--- CRITICAL POST-FLOOD MITIGATION PROTOCOL (WATERLOGGING) ---**\n\n`;
        analysisDetail += `**The rover detects continued waterlogging, which indicates a primary failure in post-flood drainage.** This must be corrected immediately, as root hypoxia and pathogenic growth (Pythium/Phytophthora) is a near-certainty in these conditions. The detected low NPK is secondary to the lack of oxygen.\n\n`;
        analysisDetail += `**Protocol Steps:**\n1. **Diversion:** Immediately stop all irrigation and divert any external water source away from the zone.\n2. **Aeration:** Use a garden fork or soil probe to gently puncture the soil (15-20cm depth) to encourage water drainage and introduce oxygen.\n3. **Fungicide:** Apply a **preventative systemic fungicide** treatment immediately to preempt root rot.\n4. **Post-Drainage:** Once the moisture drops below 70%, then apply a mild, balanced fertilizer to correct leaching. Do NOT fertilize while waterlogged.`;
    } else {
        analysisDetail += `\n**--- POST-FLOOD RECOVERY ASSESSMENT ---**\n\n`;
        analysisDetail += `The zone has successfully drained. The focus is now on recovery. The detailed report above identifies the specific post-flood stresses: either residual **disease/pest pressure** (from CV) or **nutrient depletion** (from NPK sensor data). Target these specific issues to ensure the plant stabilizes and begins to thrive again.`;
    }


    return {
        score: totalHealthScore,
        color: healthColorCode,
        border: cardBorderColor,
        analysis: analysisDetail.trim(),
        rec_cv: cv_rec_text,
        rec_sensor: sensor_rec_text,
        rec_fused: fused_rec_text
    };
}

function getScoreClass(score) {
    if (score <= HEALTH_SCORE_THRESHOLDS.CRITICAL.max) return HEALTH_SCORE_THRESHOLDS.CRITICAL.class;
    if (score <= HEALTH_SCORE_THRESHOLDS.ACTION_REQUIRED.max) return HEALTH_SCORE_THRESHOLDS.ACTION_REQUIRED.class;
    return HEALTH_SCORE_THRESHOLDS.OPTIMAL.class;
}

function getLatestSensorDataForZone(zoneID) {
    const data = systemLoggedSensorDataArray.filter(d => d.zoneID === zoneID);
    return data.length > 0 ? data[data.length - 1] : null;
}

function triggerComprehensiveAnalysisCycle() {
    const analysisGrid = document.getElementById('plantAnalysisGrid');
    analysisGrid.innerHTML = '';
    
    FIELD_PLANT_LOCATIONS_M.forEach(zone => {
        const photoEntry = currentPhotoAssignmentData[zone.id];
        const latestSensorData = getLatestSensorDataForZone(zone.id);
        
        let photoDiagnosis = null;
        if (photoEntry) {
             const match = photoEntry.match(/diag:([^,]+)/);
             if (match) {
                 photoDiagnosis = match[1].replace(/_/g, ' ');
             }
        }
        
        let analysisResult;
        
        if (!photoEntry && !latestSensorData) {
            analysisResult = {
                score: NaN,
                color: HEALTH_SCORE_THRESHOLDS.OPTIMAL.color, 
                border: '#58a6ff',
                analysis: 'Awaiting both image and sensor data for this zone. No diagnosis possible.',
                rec_cv: '<span class="rec-no-data">N/A: No photo data available.</span>',
                rec_sensor: '<span class="rec-no-data">N/A: No sensor data available.</span>',
                rec_fused: `<span class="rec-no-data">**AWAITING DATA:** Please move the rover to this zone (X: ${zone.x}, Y: ${zone.y}) to acquire at least a soil reading and an image.</span>`
            };
            
            const index = zone.id - 1;
            field3DData[index].moisture = 50; 
            field3DData[index].healthScore = 75;
            field3DData[index].color = HEALTH_SCORE_THRESHOLDS.OPTIMAL.color;

        } else {
            analysisResult = getDiagnosisAndRecommendations({
                moisture: latestSensorData ? latestSensorData.moisture : null,
                npk_n: latestSensorData ? latestSensorData.npk_n : null,
                npk_p: latestSensorData ? latestSensorData.npk_p : null,
                npk_k: latestSensorData ? latestSensorData.npk_k : null,
                photoDiagnosis: photoDiagnosis
            });
            const index = zone.id - 1;
            field3DData[index].moisture = latestSensorData ? latestSensorData.moisture : field3DData[index].moisture;
            field3DData[index].healthScore = analysisResult.score;
            field3DData[index].color = analysisResult.color;
        }

        analysisGrid.innerHTML += generatePlantAnalysisCardHTML(zone.id, analysisResult);
    });

    updateMapVisualization(); 
    draw3DMap();
}

function generatePlantAnalysisCardHTML(zoneID, result) {
    const scoreClass = getScoreClass(result.score);
    const cardStyle = `border-color: ${result.border}; box-shadow: 0 0 30px ${result.border}33;`;

    return `
        <div class="analysis-card" style="${cardStyle}">
            <div class="plant-id-label">Zone ${zoneID} Diagnosis</div>
            
            <div style="text-align: right; margin-bottom: 20px;">
                <span class="score-badge" style="background-color: ${result.color};">
                    FUSED HEALTH SCORE: ${isNaN(result.score) ? 'N/A' : result.score.toFixed(0)}/100
                </span>
            </div>

            <div class="assessment-section">
                <div class="rec-title">FUSED POST-FLOOD ASSESSMENT (Final Protocol)</div>
                <div class="${scoreClass}">${result.rec_fused}</div>
            </div>

            <div class="assessment-section">
                <div class="rec-title">Visual Assessment (Photo-Based CV)</div>
                <div class="${scoreClass}">${result.rec_cv}</div>
            </div>

            <div class="assessment-section">
                <div class="rec-title">Soil Sensor Assessment (Rover Probe)</div>
                <div class="${scoreClass}">${result.rec_sensor}</div>
            </div>

            <h3>DATA FUSION ENGINE: Detailed Report (V39.0)</h3>
            <pre style="white-space: pre-wrap; word-wrap: break-word; background: #0f131a; padding: 15px; border-radius: 8px; border: 1px solid #30363d; font-size: 0.9em;">${result.analysis}</pre>
        </div>
    `;
}

function renderNoDataCards() {
    const analysisGrid = document.getElementById('plantAnalysisGrid');
    analysisGrid.innerHTML = '';
    FIELD_PLANT_LOCATIONS_M.forEach(zone => {
        const result = {
                score: NaN,
                color: HEALTH_SCORE_THRESHOLDS.OPTIMAL.color,
                border: '#58a6ff',
                analysis: 'System initialized. Awaiting first data acquisition (image or sensor reading) for a zone diagnosis.',
                rec_cv: '<span class="rec-no-data">Awaiting Photo.</span>',
                rec_sensor: '<span class="rec-no-data">Awaiting Sensor Data.</span>',
                rec_fused: `<span class="rec-no-data">**AWAITING DATA:** This card will populate automatically upon first data acquisition near Zone ${zone.id}.</span>`
            };
        analysisGrid.innerHTML += generatePlantAnalysisCardHTML(zone.id, result);
    });
}

// ==================================================================================
// SECTION 3.0: 2D MAP VISUALIZATION (No changes)
// ==================================================================================
function updateMapVisualization() {
    const ctx = MAP_CONTEXT;
    const size = MAP_CANVAS_PIXELS;
    const scale = size / FIELD_GRID_SIZE_M;

    ctx.clearRect(0, 0, size, size);
    ctx.fillStyle = '#0f131a'; 
    ctx.fillRect(0, 0, size, size);

    ctx.strokeStyle = '#30363d';
    ctx.lineWidth = 1;
    for (let i = 1; i < FIELD_GRID_SIZE_M; i++) {
        ctx.beginPath();
        ctx.moveTo(i * scale, 0);
        ctx.lineTo(i * scale, size);
        ctx.moveTo(0, i * scale);
        ctx.lineTo(size, i * scale);
        ctx.stroke();
    }

    FIELD_PLANT_LOCATIONS_M.forEach((plant, index) => {
        const px = plant.x * scale;
        const py = size - (plant.y * scale); 

        const healthData = field3DData[index];
        const circleColor = healthData.color || '#58a6ff'; 

        ctx.beginPath();
        ctx.arc(px, py, PLANT_CIRCLE_RADIUS * 2, 0, Math.PI * 2); 
        ctx.fillStyle = circleColor;
        ctx.fill();
        ctx.strokeStyle = '#c9d1d9';
        ctx.lineWidth = 1;
        ctx.stroke();
    });

    const roverX = currentRoverKinematicState.x_position_m * scale;
    const roverY = size - (currentRoverKinematicState.y_position_m * scale);

    ctx.fillStyle = '#58a6ff';
    ctx.beginPath();
    ctx.moveTo(roverX, roverY - 10); 
    ctx.lineTo(roverX - 10, roverY + 10); 
    ctx.lineTo(roverX + 10, roverY + 10); 
    ctx.closePath();
    ctx.fill();

    ctx.strokeStyle = '#c9d1d9';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(roverX, roverY);
    const angleRad = (90 - currentRoverKinematicState.heading) * (Math.PI / 180); 
    const lineLength = 20;
    ctx.lineTo(
        roverX + lineLength * Math.cos(angleRad),
        roverY - lineLength * Math.sin(angleRad) 
    );
    ctx.stroke();
}

function findNearestPlantZone(x_m, y_m) {
    let nearest = null;
    let minDistanceSq = Infinity;
    FIELD_PLANT_LOCATIONS_M.forEach(plant => {
        const dx = plant.x - x_m;
        const dy = plant.y - y_m;
        const distSq = dx * dx + dy * dy;
        if (distSq < minDistanceSq) {
            minDistanceSq = distSq;
            nearest = plant;
        }
    });
    return (minDistanceSq < 0.25) ? nearest : null;
}

// ==================================================================================
// SECTION 4.0: 3D VISUALIZATION CORE (No changes)
// ==================================================================================
let scene, camera, renderer, controls;
let plantCubes = []; 

const field3DData = FIELD_PLANT_LOCATIONS_M.map(() => ({ 
    moisture: 50, 
    healthScore: 75, 
    color: HEALTH_SCORE_THRESHOLDS.OPTIMAL.color 
}));

function initThreeD() {
    const container = document.getElementById('threeDContainer');
    const width = container.clientWidth;
    const height = container.clientHeight;

    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x0c1015);
    camera = new THREE.PerspectiveCamera(75, width / height, 0.1, 1000);
    camera.position.set(2, 5, 5);
    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(width, height);
    container.appendChild(renderer.domElement);
    controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;
    controls.screenSpacePanning = false;
    controls.minDistance = 2;
    controls.maxDistance = 10;

    const ambientLight = new THREE.AmbientLight(0x404040, 3.5);
    scene.add(ambientLight);
    const directionalLight = new THREE.DirectionalLight(0xffffff, 2.5);
    directionalLight.position.set(5, 5, 5);
    scene.add(directionalLight);

    drawFieldCubes();
    
    animate();
    
    window.addEventListener('resize', onWindowResize, false);
}

function drawFieldCubes() {
    const stemGeometry = new THREE.CylinderGeometry(0.05, 0.05, 1, 8); 
    const offset = FIELD_GRID_SIZE_M / 2;

    FIELD_PLANT_LOCATIONS_M.forEach((plant) => {
        const individualLeafMaterial = new THREE.MeshLambertMaterial({ color: 0x3fb950 }); 
        const stemMaterial = new THREE.MeshLambertMaterial({ color: 0x472e1e }); 
        const stem = new THREE.Mesh(stemGeometry, stemMaterial);

        const leafGroup = new THREE.Group();
        const leafBaseGeometry = new THREE.BoxGeometry(0.35, 0.05, 0.2); 
        
        const numLeaves = 6;
        for (let i = 0; i < numLeaves; i++) {
            const leaf = new THREE.Mesh(leafBaseGeometry, individualLeafMaterial); 
            const angle = (i / numLeaves) * Math.PI * 2;
            const radius = 0.15; 

            leaf.position.x = radius * Math.cos(angle);
            leaf.position.z = radius * Math.sin(angle);
            leaf.position.y = 0.0; 
            leaf.rotation.y = angle + Math.PI / 2; 
            leaf.rotation.x = Math.PI / 8; 
            
            leafGroup.add(leaf);
        }
        
        const plantGroup = new THREE.Group();
        plantGroup.add(stem);
        plantGroup.add(leafGroup); 
        
        plantGroup.position.x = plant.x - offset;
        plantGroup.position.z = plant.y - offset;
        plantGroup.position.y = 0; 

        plantCubes.push({ 
            group: plantGroup, 
            stem: stem, 
            leaves: leafGroup, 
            id: plant.id,
            material: individualLeafMaterial 
        });
        scene.add(plantGroup);
    });
    
    const planeGeometry = new THREE.PlaneGeometry(FIELD_GRID_SIZE_M + 1, FIELD_GRID_SIZE_M + 1);
    const planeMaterial = new THREE.MeshLambertMaterial({ color: 0x1f272e, side: THREE.DoubleSide });
    const plane = new THREE.Mesh(planeGeometry, planeMaterial);
    plane.rotation.x = Math.PI / 2; 
    plane.position.y = -0.05; 
    scene.add(plane);
}

function draw3DMap() {
    plantCubes.forEach((plantObj, index) => {
        const data = field3DData[index];
        
        const normalizedMoisture = data.moisture / 100;
        const stemHeight = Math.max(0.5, normalizedMoisture * 1.5 + 0.5); 
        
        plantObj.stem.scale.y = stemHeight;
        plantObj.stem.position.y = stemHeight / 2; 
        plantObj.leaves.position.y = stemHeight; 

        const newColor = new THREE.Color(data.color);
        plantObj.material.color.set(newColor);
    });
}

function updateRover3DPosition() {
    // Kinematic updates in 3D are currently not visualized in this iteration 
}

function onWindowResize() {
    const container = document.getElementById('threeDContainer');
    camera.aspect = container.clientWidth / container.clientHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(container.clientWidth, container.clientHeight);
}

function animate() {
    requestAnimationFrame(animate);
    controls.update();
    renderer.render(scene, camera);
}


// ==================================================================================
// SECTION 5.0: UTILITY & UI FUNCTIONS (Photo Grid - V39.0 FIX CORE)
// ----------------------------------------------------------------------------------

/**
 * V39.0: Populates the new Zone selector dropdown for manual data entry.
 */
function populateManualZoneSelector() {
    let options = '';
    for (let i = 1; i <= 16; i++) {
        options += `<option value="${i}">Zone ${i}</option>`;
    }
    MANUAL_TARGET_ZONE_SELECT.innerHTML = options;
}

/**
 * V39.0: Sets the currently active zone for UI highlighting and manual data entry (if from grid click).
 */
function selectZone(zoneID) {
    currentlySelectedPlantZone = zoneID;
    CURRENT_ZONE_SELECTION_DISPLAY.innerText = zoneID;
    document.getElementById('modalCurrentZoneSelection').innerText = zoneID;
    
    // Highlight the selected cell visually
    document.querySelectorAll('.grid-cell').forEach(cell => {
        cell.style.border = '1px solid #3fb950'; // Reset all
    });
    document.getElementById(`zoneCell-${zoneID}`).style.border = '3px solid #ffaa00'; // Highlight selected
    
    // V39.0: Also set the dropdown to the selected zone for consistency
    MANUAL_TARGET_ZONE_SELECT.value = zoneID;
}


/**
 * V39.0: Creates and renders the photo grid cells using the PIVO protocol.
 * Each cell contains a permanent, invisible file input that acts as the click area.
 */
function generatePhotoGrid() {
    const grid = document.getElementById('photoGrid');
    grid.innerHTML = '';
    for (let i = 1; i <= FIELD_GRID_SIZE_M * FIELD_GRID_SIZE_M; i++) {
        const cell = document.createElement('div');
        cell.className = 'grid-cell';
        cell.id = `zoneCell-${i}`;
        
        // V39.0: Click the cell to select it (for highlighting/stock photo modal). The file input handles the upload dialog.
        cell.onclick = () => selectZone(i); 

        // V38.0: PIVO Protocol - Create the permanent, invisible file input
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = 'image/*';
        fileInput.id = `fileInput-${i}`; 
        
        // V39.0 CRITICAL FIX: Set file input Z-index low to ensure image is visible over it
        fileInput.style.cssText = 'position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; z-index: 5; cursor: pointer; pointer-events: auto;'; 
        
        fileInput.onchange = (e) => handleLocalPhotoUpload(i, e, fileInput);
        cell.appendChild(fileInput);

        if (currentPhotoAssignmentData[i]) {
            // If photo exists, render the image overlay and suppress the input's pointer events
            renderPhotoInPhotoGridCell(i, currentPhotoAssignmentData[i], fileInput, false); 
        } else {
            // If no photo, render placeholder text
            const textNode = document.createElement('div');
            textNode.className = 'placeholder-text';
            textNode.innerHTML = `Zone ${i}<br>CLICK TO UPLOAD`;
            cell.appendChild(textNode);
        }
        
        grid.appendChild(cell);
    }
}

/**
 * V39.0: Handles file upload event from the *permanent* input.
 */
function handleLocalPhotoUpload(zoneID, event, inputElement) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const mockDiagnosis = (zoneID % 4 === 0) ? 'Edging Burn/Tip Necrosis (K/Salt)' : 'Healthy, Deep Green Foliage';
            const dataUrlWithMockDiagnosis = e.target.result.replace('base64,', `base64,mocked_user_upload_diag:${mockDiagnosis.replace(/\s/g, '_').replace(/[()]/g, '')},`);
            
            // V39.0 CRITICAL FIX: Ensure the state is updated and photo is rendered
            renderPhotoInPhotoGridCell(zoneID, dataUrlWithMockDiagnosis, inputElement, true); 
            
            STATUS_ELEMENT.innerText = `User photo uploaded and assigned to Zone ${zoneID}. Visibility guaranteed by Z-Stack.`;
        };
        reader.readAsDataURL(file);
    } else {
        STATUS_ELEMENT.innerText = `User cancelled file upload for Zone ${zoneID}.`;
    }
    
    // CRITICAL: Reset the input's value so the 'change' event fires again if the same file is selected later
    inputElement.value = ''; 
}

/**
 * V39.0 CRITICAL FIX: Ensures correct z-indexing and element state for image visibility.
 */
function renderPhotoInPhotoGridCell(zoneID, dataUrl, fileInput, triggerAnalysis = true) {
    const cell = document.getElementById(`zoneCell-${zoneID}`);
    if (!cell) return;
    
    // 1. Clear placeholder text / old elements, but PRESERVE the file input
    cell.querySelectorAll(':not(input[type="file"])').forEach(el => el.remove());

    // CRITICAL FIX: Disable pointer events on the input to let the image be clicked on (though cell click handles the logic)
    // The image now has a higher Z-index (10 vs 5), making it visually dominant.
    fileInput.style.pointerEvents = 'none';
    
    // 2. Create and append Image element 
    const img = document.createElement('img');
    img.src = dataUrl;
    // V39.0: Set z-index to 10 via CSS class/style to ensure it's OVER the input (z-index 5)
    img.style.cssText = 'width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; z-index: 10;'; 
    cell.appendChild(img);

    // 3. Create and append delete button (z-index 100)
    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'delete-photo-btn';
    deleteBtn.innerHTML = 'X';
    deleteBtn.onclick = (e) => {
        e.stopPropagation(); // Prevents cell click/input click
        deletePhotoAssignment(zoneID);
    };
    cell.appendChild(deleteBtn);
    
    // 4. Update the assignment data
    currentPhotoAssignmentData[zoneID] = dataUrl;
    
    if (triggerAnalysis) {
        triggerComprehensiveAnalysisCycle();
    }
}

function deletePhotoAssignment(zoneID) {
    delete currentPhotoAssignmentData[zoneID];
    const cell = document.getElementById(`zoneCell-${zoneID}`);
    const fileInput = document.getElementById(`fileInput-${zoneID}`);
    
    if (cell) {
        // Clear all elements (image, delete button) but keep the input
        cell.querySelectorAll(':not(input[type="file"])').forEach(el => el.remove());
        
        // V39.0 CRITICAL FIX: Re-enable pointer events on the hidden input to make it clickable
        if (fileInput) {
            fileInput.style.pointerEvents = 'auto';
        }
        
        // Re-append the placeholder text
        const textNode = document.createElement('div');
        textNode.className = 'placeholder-text';
        textNode.innerHTML = `Zone ${zoneID}<br>CLICK TO UPLOAD`;
        cell.appendChild(textNode);
        
        cell.style.border = '3px solid #ffaa00'; // Keep selected highlight
    }
    // Re-run analysis to update diagnosis without the photo
    triggerComprehensiveAnalysisCycle();
}

function openStockImageGalleryModal() {
    // V39.0: If a zone hasn't been clicked, use the selected zone from the dropdown
    let targetZone = currentlySelectedPlantZone;
    if (targetZone === 0) {
        targetZone = parseInt(MANUAL_TARGET_ZONE_SELECT.value);
    }
    if (isNaN(targetZone) || targetZone === 0) {
        alert("Please select a target Zone (1-16) either by clicking a grid cell or using the manual entry dropdown!");
        return;
    }
    selectZone(targetZone); // Ensure the UI and modal reflects the correct zone
    STOCK_MODAL.style.display = 'block';
}

function closeStockImageGalleryModal() {
    STOCK_MODAL.style.display = 'none';
}

function populateStockPhotos() {
    const grid = document.getElementById('stockImageGrid');
    grid.innerHTML = '';
    const diagnoses = Object.keys(TOMATO_DIAGNOSTIC_KB);

    for (let i = 1; i <= MAX_STOCK_PHOTOS; i++) {
        const diagnosisKey = diagnoses[i % diagnoses.length];
        const diagnosis = TOMATO_DIAGNOSTIC_KB[diagnosisKey];
        
        const mockDataUrl = `data:image/png;base64,mocked_stock_photo_${i}_diag:${diagnosisKey.replace(/\s/g, '_').replace(/[()]/g, '')}`;
        stockPhotoLibraryData[i] = mockDataUrl; 

        const cell = document.createElement('div');
        cell.className = 'grid-cell';
        cell.style.backgroundColor = (diagnosisKey === 'Healthy, Deep Green Foliage') ? '#3fb950' : '#f08047'; 
        cell.style.fontSize = '0.7em';
        cell.style.padding = '5px';
        cell.innerHTML = `Stock #${i}<br>(${diagnosis.type})`;
        
        cell.onclick = () => {
            const fileInput = document.getElementById(`fileInput-${currentlySelectedPlantZone}`);
            if (fileInput) {
                currentPhotoAssignmentData[currentlySelectedPlantZone] = stockPhotoLibraryData[i];
                renderPhotoInPhotoGridCell(currentlySelectedPlantZone, stockPhotoLibraryData[i], fileInput);
                closeStockImageGalleryModal();
                STATUS_ELEMENT.innerText = `Stock Photo #${i} assigned to Zone ${currentlySelectedPlantZone}.`;
            } else {
                STATUS_ELEMENT.innerText = `ERROR: Failed to assign stock photo. File input for Zone ${currentlySelectedPlantZone} not found.`;
            }
        };
        grid.appendChild(cell);
    }
}

// --- History and State Management (Retained) ---
function executeTrialSaveOperation() {
    if (trialHistoryRecords.length >= MAX_HISTORY_TRIALS) {
        trialHistoryRecords.shift(); // FIFO: Remove oldest
    }
    
    const currentState = {
        id: currentIncrementalTrialID,
        timestamp: new Date().toLocaleString(),
        kinematics: JSON.parse(JSON.stringify(currentRoverKinematicState)),
        sensorData: JSON.parse(JSON.stringify(systemLoggedSensorDataArray)),
        photoAssignments: JSON.parse(JSON.stringify(currentPhotoAssignmentData)),
        analysisResults: document.getElementById('plantAnalysisGrid').innerHTML 
    };

    trialHistoryRecords.push(currentState);
    localStorage.setItem('trialHistory', JSON.stringify(trialHistoryRecords));

    currentIncrementalTrialID++;
    HISTORY_TRIAL_COUNTER.innerText = currentIncrementalTrialID;
    STATUS_ELEMENT.innerText = `SUCCESS: Trial ${currentState.id} saved to history.`;
}

function openHistoryRetrievalModal() {
    historyIsBeingViewed = true;
    const historyList = document.getElementById('trialHistoryList');
    historyList.innerHTML = '';
    
    if (trialHistoryRecords.length === 0) {
        historyList.innerHTML = '<p style="color: #f85149; font-weight: bold;">No historical trials found in local storage.</p>';
    } else {
        trialHistoryRecords.slice().reverse().forEach(trial => { 
            const item = document.createElement('div');
            item.className = 'trial-item';
            item.innerHTML = `<strong>Trial ID: ${trial.id}</strong> | Saved: ${trial.timestamp} | Data Points: ${trial.sensorData.length} | Photos: ${Object.keys(trial.photoAssignments).length}`;
            item.onclick = () => restoreTrialFromHistory(trial);
            historyList.appendChild(item);
        });
    }

    HISTORY_MODAL.style.display = 'block';
}

function closeHistoryModal() {
    historyIsBeingViewed = false;
    HISTORY_MODAL.style.display = 'none';
}

function restoreTrialFromHistory(trial) {
    currentRoverKinematicState = trial.kinematics;
    systemLoggedSensorDataArray = trial.sensorData;
    currentPhotoAssignmentData = trial.photoAssignments;
    
    document.getElementById('plantAnalysisGrid').innerHTML = trial.analysisResults;
    
    updateMapVisualization();
    draw3DMap();
    generatePhotoGrid(); 
    
    STATUS_ELEMENT.innerText = `SUCCESS: Restored Trial ID ${trial.id} from history.`;
    closeHistoryModal();
}

function executeAllHistoryClearance() {
    if (confirm("WARNING: This will permanently delete ALL 50 saved trials. Are you sure?")) {
        localStorage.removeItem('trialHistory');
        trialHistoryRecords = [];
        currentIncrementalTrialID = 1;
        HISTORY_TRIAL_COUNTER.innerText = 1;
        STATUS_ELEMENT.innerText = "CRITICAL ACTION: All historical trials have been cleared. System reset.";
        closeHistoryModal();
    }
}

function resetSensorAndMapData(clearHistory = true) {
    systemLoggedSensorDataArray = [];
    currentPhotoAssignmentData = {}; 
    currentlySelectedPlantZone = 0;
    CURRENT_ZONE_SELECTION_DISPLAY.innerText = 'N/A';
    
    currentRoverKinematicState = { latitude: 'N/A', longitude: 'N/A', heading: 0.0, x_position_m: 2.0, y_position_m: 2.0 };

    document.getElementById('moistureData').innerText = 'N/A';
    document.getElementById('npkData').innerText = 'N/A';
    document.getElementById('headingData').innerText = 'N/A';
    document.getElementById('latitudeData').innerText = 'N/A';
    document.getElementById('longitudeData').innerText = 'N/A';
    document.getElementById('gpsFix').innerText = 'N/A';
    document.getElementById('thingspeakStatus').innerText = 'Awaiting Connection (API Key: 6OXH3SUQ4VNSOJX1)';

    updateMapVisualization();
    generatePhotoGrid(); 
    renderNoDataCards(); 
    populateManualZoneSelector(); // V39.0: Ensure selector is populated on reset

    field3DData.forEach(data => {
        data.moisture = 50;
        data.healthScore = 75;
        data.color = HEALTH_SCORE_THRESHOLDS.OPTIMAL.color;
    });
    draw3DMap();

    if (clearHistory) {
         currentIncrementalTrialID = 1;
         HISTORY_TRIAL_COUNTER.innerText = 1;
         STATUS_ELEMENT.innerText = "SYSTEM RESET: Transient data cleared. Awaiting first command.";
    } else {
         STATUS_ELEMENT.innerText = "SYSTEM BOOT: DOM Ready. Awaiting OpenCV.js initialization for full CV capability.";
    }
}

// --- Initial Load Logic (Retained for compatibility) ---
(function(D){
    D.querySelector = function(s){
        if(s.indexOf(':contains') === -1) return D.querySelector(s);
        let [selector, text] = s.split(':contains');
        text = text.replace(/[\"()]/g, '');
        return [...D.querySelectorAll(selector)].find(el => el.textContent.includes(text));
    };
    D.querySelectorAll = function(s){
        if(s.indexOf(':contains') === -1) return D.querySelectorAll(s);
        let [selector, text] = s.split(':contains');
        text = text.replace(/[\"()]/g, '');
        return [...D.querySelectorAll(selector)].filter(el => el.textContent.includes(text));
    };
})(document.constructor.prototype);

function onDocumentReady() {
    initThreeD();
    populateStockPhotos(); 
    populateManualZoneSelector(); // V39.0: Populate the new dropdown
    
    // CRITICAL: Must generate grid first so the cells/inputs exist for rendering
    generatePhotoGrid();
    
    resetSensorAndMapData(false); 
    
    if (systemLoggedSensorDataArray.length === 0 && Object.keys(currentPhotoAssignmentData).length === 0) {
        renderNoDataCards(); 
    } else {
        triggerComprehensiveAnalysisCycle(); 
    }
    
    STATUS_ELEMENT.innerText = "SYSTEM BOOT: DOM Ready. Awaiting OpenCV.js initialization for full CV capability.";
}
window.onload = onDocumentReady;

function onOpenCvReady() {
    openCvLibraryIsReady = true;
    STATUS_ELEMENT.innerText = "System Status: OpenCV.js Library Initialized. Rover Control System Fully Operational.";
}
</script>
</body>
</html>
