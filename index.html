<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>S.C.O.U.T. Rover Full-Spectrum Data Fusion & Control Console (V6 - ARCHITECTURAL OVERHAUL)</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://unpkg.com/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
<script async src="https://docs.opencv.org/4.x/opencv.js" onload="onOpenCvReady();"></script>
<style>
/* =================================================================
   SECTION 0.1: CRITICAL SYSTEM-WIDE CSS STYLES (Highly Detailed Dark Theme)
   -----------------------------------------------------------------
   This section defines the core visual identity for the command console,
   focusing on a high-contrast, low-eye-strain environment suitable for
   extended operational periods. All elements use 'monospace' for a
   traditional terminal-like display consistency.
   ================================================================= */
body { 
    font-family: 'Consolas', 'Segoe UI', monospace; 
    margin: 0; 
    padding: 25px; 
    background-color: #0c1015; /* Deeper background for the ultimate dark mode */
    color: #c9d1d9; 
    transition: background-color 0.5s;
    line-height: 1.5; 
}
.container {
    max-width: 1920px; /* Maximizing width for high-resolution displays */
    margin: auto;
    background: #161b22; 
    padding: 40px;
    border-radius: 18px;
    box-shadow: 0 15px 40px rgba(0,0,0,1.0); /* Increased shadow depth */
    display: flex;
    flex-wrap: wrap; 
    border: 3px solid #30363d; /* Thicker border for structural definition */
}

/* LAYOUT AND PANEL DEFINITION (Ensuring Robust Flex Behavior) */
.controls-panel { flex: 1; min-width: 400px; padding-right: 35px; border-right: 1px dashed #30363d; }
.map-panel { flex: 1; min-width: 480px; padding: 0 35px; }
.photo-panel { flex: 1; min-width: 480px; padding-left: 35px; border-left: 1px dashed #30363d; }
.map-3d-panel { flex-basis: 100%; min-width: 100%; margin-top: 40px; padding-top: 20px; border-top: 3px solid #30363d; }
.plant-analysis-panel {
    flex-basis: 100%; 
    margin-top: 50px;
    padding-top: 30px;
    border-top: 3px solid #30363d;
}

/* Typography and Status Indicators (Enhanced Visual Feedback) */
h1 { color: #58a6ff; border-bottom: 5px double #30363d; padding-bottom: 15px; margin-bottom: 30px; font-size: 2.6em; font-weight: 800; }
h2 { color: #79c0ff; margin-top: 35px; margin-bottom: 15px; font-size: 1.9em; border-bottom: 1px solid #30363d; padding-bottom: 5px; }
h3 { color: #4ac9b0; margin-top: 20px; font-size: 1.4em; }
#status { font-weight: 900; color: #f08047; font-size: 1.25em; display: block; margin-top: 10px; }
.data-display { 
    margin-top: 30px; 
    padding: 25px; 
    border: 2px solid #30363d; 
    border-radius: 12px; 
    background-color: #0f131a; 
    transition: box-shadow 0.3s;
}
.data-display:hover { box-shadow: 0 0 18px rgba(88, 166, 255, 0.3); }

/* Data Rows (Alignment Control) */
.data-row { margin: 12px 0; }
.data-row strong { 
    display: inline-block; 
    width: 220px; /* Increased for clean alignment */
    color: #4ac9b0; 
}

/* Control Buttons (Explicit Color Coding & Code Clean-up) */
button { 
    padding: 16px 24px; 
    margin: 8px 6px; 
    cursor: pointer; 
    border: none; 
    border-radius: 10px; 
    font-weight: bold; 
    transition: background-color 0.3s ease, transform 0.1s, box-shadow 0.3s; 
    letter-spacing: 1.2px;
    font-size: 1.08em;
    text-transform: uppercase;
    box-shadow: 0 5px 8px rgba(0,0,0,0.5);
    white-space: nowrap;
}
button:hover { transform: translateY(-3px); box-shadow: 0 8px 12px rgba(0,0,0,0.8); }
.move-controls button { background-color: #58a6ff; color: #0d1117; } 
.arm-controls button { background-color: #3fb950; color: #0d1117; } 
.history-controls button { background-color: #e3b341; color: #0d1117; } 
.photo-controls button { background-color: #f08047; color: #0d1117; }

/* MAP STYLES */
#roverMap {
    border: 4px solid #58a6ff;
    border-radius: 5px;
    background-color: #0f131a;
}

/* GRID STYLES (4x4 Zones) */
#photoGrid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    grid-template-rows: repeat(4, 1fr);
    gap: 8px;
    border: 3px solid #58a6ff;
    max-width: 480px; 
    margin: 25px auto;
    aspect-ratio: 1 / 1;
    background-color: #0f131a;
}
.grid-cell {
    background-color: #21262d;
    border: 1px solid #3fb950;
    position: relative;
    cursor: pointer;
    overflow: hidden;
    aspect-ratio: 1/1;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 0.9em;
    font-weight: bold;
    color: #4ac9b0;
    transition: border 0.2s, background-color 0.2s;
}
.grid-cell:hover { border: 3px solid #79c0ff; background-color: #2a3038; }

/* ANALYSIS CARD STYLING */
#plantAnalysisGrid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(550px, 1fr)); /* Further maximized card size */
    gap: 40px;
    margin-top: 30px;
}
.analysis-card {
    padding: 35px;
    border-radius: 20px;
    background-color: #21262d;
    box-shadow: 0 10px 25px rgba(0,0,0,0.8);
}
.plant-id-label {
    font-size: 2.2em;
    font-weight: 900;
    color: #ffd700;
    border-bottom: 5px double #30363d;
    padding-bottom: 15px;
    margin-bottom: 25px;
}
.assessment-section { margin-bottom: 30px; padding: 25px; border-radius: 12px; }

/* Recommendation Coloring */
.rec-optimal, .rec-action, .rec-critical {
    padding: 15px;
    border-radius: 10px;
    display: block;
    font-weight: bold;
    margin-top: 18px;
    font-size: 1.15em;
    line-height: 1.4;
}
.rec-optimal { background-color: #3fb950; color: #0d1117; }
.rec-action { background-color: #e3b341; color: #0d1117; }
.rec-critical { background-color: #f85149; color: #0d1117; }

/* MODAL AND HISTORY LIST STYLES */
.modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.98); }
.modal-content { background-color: #161b22; margin: 3% auto; padding: 50px; border: 3px solid #30363d; width: 95%; max-width: 1600px; border-radius: 20px; }
.close-btn { color: #aaa; float: right; font-size: 50px; font-weight: bold; }
.trial-item { 
    padding: 20px; 
    margin-bottom: 12px; 
    background-color: #0f131a; 
    border-radius: 12px; 
    cursor: pointer; 
    transition: background-color 0.3s;
    border-left: 6px solid #e3b341;
}
.trial-item:hover { background-color: #21262d; border-left: 6px solid #79c0ff; }
#stockImageGrid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); 
    gap: 18px;
    max-width: 100%;
    margin-top: 25px;
    border: 1px solid #30363d;
    padding: 20px;
    border-radius: 10px;
}
</style>
</head>
<body>
<div class="container">
<div class="controls-panel">
    <h1>S.C.O.U.T. Rover Control & Telemetry Bridge (V6)</h1>
    <p>System Diagnostic Status: <span id="status">AWAITING SYSTEM BOOT SEQUENCE COMPLETION...</span></p>

    <div class="data-display history-controls">
        <h2>Trial Preservation Console (MAX 50 Presets) 💾  </h2>
        <div class="data-row"><strong>Current System Trial ID:</strong> <span id="currentTrialNumber">1</span></div>
        <p>
            <button onclick="executeTrialSaveOperation()"> 💾  EXECUTE TRIAL SAVE OPERATION</button>
            <button onclick="openHistoryRetrievalModal()"> 📅  RETRIEVE HISTORY (MAX 50)</button>
        </p>
        <p><small>Storage Capacity: **${MAX_HISTORY_TRIALS} Historical Presets**. Oldest trial is automatically purged (FIFO) upon capacity breach.</small></p>
    </div>

    <div class="data-display move-controls">
        <h2>Rover Translational Control (X/Y Axis)</h2>
        <p>Command Structure: X-Axis (Left/Right), Y-Axis (Forward/Backward). **No code leakage in button labels.**</p>
        <button onclick="dispatchRoverMovementCommand('forward')">FORWARD (Y+)</button>
        <button onclick="dispatchRoverMovementCommand('stop')"> 🛑 EMERGENCY STOP</button>
        <button onclick="dispatchRoverMovementCommand('backward')">BACKWARD (Y-)</button><br>
        <button onclick="dispatchRoverMovementCommand('left')">LEFT (X-)</button>
        <button onclick="dispatchRoverMovementCommand('right')">RIGHT (X+)</button>
    </div>

    <div class="data-display arm-controls">
        <h2>Data Acquisition (Arduino R3 Sensor Payload)</h2>
        <p>The **ESP32** serves as the critical Wi-Fi bridge for cloud telemetry push.</p>
        <button onclick="dispatchRoverMovementCommand('probe')"> 🔬 EXTEND PROBE (SOIL READ)</button>
        <button onclick="dispatchRoverMovementCommand('read_sensors')"> 💧 READ ENVIRONMENTAL DATA</button>
        <button onclick="dispatchRoverMovementCommand('read_nav')"> 🧭 ACQUIRE GPS/IMU DATA</button>
    </div>

    <div class="data-display">
        <h2>Real-time Sensor Telemetry (Raw Feed)</h2>
        <h3>Navigation Subsystem</h3>
        <div class="data-row"><strong>Latitude (GPS):</strong> <span id="latitudeData">N/A</span></div>
        <div class="data-row"><strong>Longitude (GPS):</strong> <span id="longitudeData">N/A</span></div>
        <div class="data-row"><strong>GPS Fix Status:</strong> <span id="gpsFix">N/A</span></div>
        <div class="data-row"><strong>Heading (IMU):</strong> <span id="headingData">N/A</span></div>
        <h3>Soil/Environment Subsystem</h3>
        <div class="data-row"><strong>Soil Moisture (%):</strong> <span id="moistureData">N/A</span></div>
        <div class="data-row"><strong>NPK (N, P, K ppm):</strong> <span id="npkData">N/A</span></div>
        <div class="data-row"><strong>ThingSpeak Status:</strong> <span id="thingspeakStatus">Awaiting Connection</span></div>
    </div>
</div>

<div class="map-panel">
    <h2>2D Field Map (4m x 4m Grid - Cleaned Visualization)</h2>
    <p>Grid Key: **Thin Lines** = 1m x 1m. **Green Circles** = Plant Zones. **Blue Triangle** = Rover Position. **Zone numbers removed for clarity.**</p>
    <canvas id="roverMap" width="480" height="480"></canvas>
    <p style="margin-top: 15px;">
        <button onclick="resetSensorAndMapData()"> 🗑️ CLEAR ALL TRANSIENT MAP DATA</button>
    </p>
</div>

<div class="photo-panel">
    <div class="camera-control data-display">
        <h2>Image Capture & Stock Library</h2>
        <p>To assign a photo, click a Zone (1-16) to **upload** a file, or use the buttons below.</p>
        <button onclick="dispatchRoverMovementCommand('capture')" class="photo-controls"> 📸 TRIGGER CAMERA CAPTURE</button>
        <button onclick="openStockImageGalleryModal()" class="photo-controls"> 🖼️ VIEW STOCK PHOTOS (50 Presets)</button>
        <p>Current Target Zone: **Zone <span id="currentZoneSelection">N/A</span>**</p>
    </div>
    <hr style="border-top: 2px solid #30363d; margin: 30px 0;">
    <h2>Plant Zone Photo Assignments (16 Zones)</h2>
    <div id="photoGrid">
    </div>
    <input type="file" id="fileInput" accept="image/*" style="display:none;" onchange="handleFileSelectedByUser(event)">
</div>

<div class="map-3d-panel">
    <h2>3D Soil Metric Visualization 📊 (Height=Moisture, Color=Health)</h2>
    <div id="threeDContainer" style="height: 550px; width: 100%;"></div>
</div>

<div class="plant-analysis-panel">
    <h2>DATA FUSION ENGINE: Plant-Specific Final Diagnosis (16 Zones) 🔬 </h2>
    <p>This panel displays the **FUSED** assessment: **Leaf Visual Pre-Assessment (CV) (LOWER WEIGHT)** + **Local Soil Sensor Data (HIGHER WEIGHT)**.</p>
    <div id="plantAnalysisGrid">
        </div>
</div>
</div>

<div id="historyModal" class="modal" onclick="if(event.target.id === 'historyModal') closeHistoryModal()">
    <div class="modal-content">
        <span class="close-btn" onclick="closeHistoryModal()">&times;</span>
        <h2>Saved Trial History Retrieval Console (Maximum Capacity: 50 Presets ENFORCED)</h2>
        <p>Click a trial to restore its exact state (map, photos, and final analysis).</p>
        <div id="trialHistoryList">
        </div>
        <hr style="border-top: 2px solid #30363d; margin-top: 20px;">
        <button onclick="executeAllHistoryClearance()" style="background-color: #f85149;"> 🚨 EXECUTE ALL SAVED TRIALS CLEARANCE</button>
    </div>
</div>

<div id="stockImageModal" class="modal" onclick="if(event.target.id === 'stockImageModal') closeStockImageGalleryModal()">
    <div class="modal-content">
        <span class="close-btn" onclick="closeStockImageGalleryModal()">&times;</span>
        <h2>Stock Photo Gallery (50 Pre-Diagnosed Leaf Presets - Click to Assign)</h2>
        <p>Select a photo to assign it to your currently selected plant zone for CV analysis.</p>
        <div id="stockImageGrid">
            </div>
    </div>
</div>

<script>
// ==================================================================================
// SECTION 0.2: CORE SYSTEM CONSTANTS AND GLOBAL CONFIGURATION (MAXIMAL VERBOSITY)
// ----------------------------------------------------------------------------------
/**
 * @fileoverview S.C.O.U.T. Rover Control System JavaScript Core.
 * This script manages hardware communications, data fusion, and visualization logic.
 * Version 6.0: Enhanced stability, clean 2D map, simplified upload flow, and maximal code length.
 * The system adheres strictly to the 50-preset capacity limits for both history and stock images.
 */

// --- 0.2.1 HARDWARE AND NETWORK CONFIGURATION (CRITICAL SYSTEM IDENTIFIERS) ---
const HARDWARE_ESP32_IP_ADDRESS = '192.168.1.50';
const ESP32_BASE_URL = `http://${HARDWARE_ESP32_IP_ADDRESS}`;
const THINGSPEAK_API_KEY = '6OXH3SUQ4VNSOJX1'; // CRITICAL: ThingSpeak Write API Key placeholder
const STATUS_REPORT_INTERVAL_MS = 3000; // Reduced interval for high-frequency status check logging

// --- 0.2.2 PHYSICAL SYSTEM AND UI CONSTANTS (STRICT ADHERENCE TO SPECIFICATIONS) ---
const FIELD_GRID_SIZE_M = 4; // 4m x 4m field dimensions
const MAP_CANVAS_PIXELS = 480; // Fixed canvas size for map
const MAX_STOCK_PHOTOS = 50; // CRITICAL: Strict 50 presets for the gallery
const MAX_HISTORY_TRIALS = 50; // CRITICAL: Strict 50 presets for history storage capacity
const PLANT_CIRCLE_RADIUS = 5; // Radius for plant markers on 2D map

// --- 0.2.3 DOM ELEMENT REFERENCES (MAPPING CORE UI COMPONENTS) ---
const STATUS_ELEMENT = document.getElementById('status');
const MOISTURE_DISPLAY_ELEMENT = document.getElementById('moistureData');
const NPK_DISPLAY_ELEMENT = document.getElementById('npkData');
const HISTORY_TRIAL_COUNTER = document.getElementById('currentTrialNumber');
const THINGSPEAK_STATUS_ELEMENT = document.getElementById('thingspeakStatus');
const MAP_CONTEXT = document.getElementById('roverMap').getContext('2d');
const HISTORY_MODAL = document.getElementById('historyModal');
const STOCK_MODAL = document.getElementById('stockImageModal');
const FILE_INPUT_ELEMENT = document.getElementById('fileInput');
const CURRENT_ZONE_SELECTION_DISPLAY = document.getElementById('currentZoneSelection');

// --- 0.2.4 GLOBAL STATE VARIABLES (Clean Initial State Definition) ---
let openCvLibraryIsReady = false;
let systemLoggedSensorDataArray = []; // Array stores historical sensor logs
let currentPhotoAssignmentData = {}; // Object maps Zone ID to Base64 image
let stockPhotoLibraryData = {}; // Object stores 50 stock presets (populated on load)
let currentlySelectedPlantZone = 0; // The 4x4 zone currently clicked by the user
let historyIsBeingViewed = false;
let roverHealthStatus = 100; // Redundant system health metric

// Rover Kinematic State (Simulation - Initialized Cleanly)
let currentRoverKinematicState = {
    latitude: 'N/A',
    longitude: 'N/A',
    heading: 0.0,
    x_position_m: 2.0, // Starting center (2, 2)
    y_position_m: 2.0
};

// Persistent Storage Management (Ensure 50 preset capacity logic is used)
let trialHistoryRecords = JSON.parse(localStorage.getItem('trialHistory') || '[]');
let currentIncrementalTrialID = trialHistoryRecords.length + 1;
HISTORY_TRIAL_COUNTER.innerText = currentIncrementalTrialID;

// Pre-calculated Plant Locations (16 zones)
const FIELD_PLANT_LOCATIONS_M = [];
for(let r=0; r<FIELD_GRID_SIZE_M; r++) {
    for(let c=0; c<FIELD_GRID_SIZE_M; c++) {
        FIELD_PLANT_LOCATIONS_M.push({x: c + 0.5, y: r + 0.5, id: (r * FIELD_GRID_SIZE_M) + c + 1});
    }
}


// ==================================================================================
// SECTION 1.0: HARDWARE COMMUNICATIONS & THINGSPEAK BRIDGE LOGIC (VERBOSE CONTROL FLOW)
// ----------------------------------------------------------------------------------
/**
 * 1.1 CRITICAL FUNCTION: Simulates the ESP32 bridging the Arduino R3 sensor data
 * and pushing it to the ThingSpeak Cloud Platform using the provided API key.
 * This function also includes verbose logging of the payload before transmission.
 * @param {object} dataPacket - The NPK/Moisture data payload.
 */
function transmitSensorDataViaESP32ToThingSpeak(dataPacket) {
    const apiEndpointUrl = "https://api.thingspeak.com/update";
    THINGSPEAK_STATUS_ELEMENT.innerText = 'TRANSMITTING... (W-Fi Bridge Active, Preparing Payload)';
    
    // --- PAYLOAD CONSTRUCTION VERBOSITY ---
    const fieldMapping = { field1: dataPacket.moisture, field2: dataPacket.N, field3: dataPacket.P, field4: dataPacket.K };
    console.log("Telemetry Push Payload:", JSON.stringify(fieldMapping));

    // Construct the URL with the mandatory API Key and field values
    const urlPayload = `${apiEndpointUrl}?api_key=${THINGSPEAK_API_KEY}` +
                `&field1=${dataPacket.moisture}` +
                `&field2=${dataPacket.N}` +
                `&field3=${dataPacket.P}` +
                `&field4=${dataPacket.K}`;

    // Note: The 'no-cors' mode is necessary for ThingSpeak GET requests in client-side scripts.
    fetch(urlPayload, { method: 'GET', mode: 'no-cors' })
        .then(() => {
            THINGSPEAK_STATUS_ELEMENT.innerText = `SUCCESS: Data pushed to Cloud. Moisture=${dataPacket.moisture}%.`;
            roverHealthStatus = 100; // Reset minor error status on success
        })
        .catch(error => {
            THINGSPEAK_STATUS_ELEMENT.innerText = `ERROR: ThingSpeak Transmission Failed. Check console logs for network exception.`;
            console.error("ThingSpeak Transmission Error (Likely CORS or Network Fault):", error);
            roverHealthStatus = 80; // Set health warning for transmission failure
        });
}

/**
 * 1.2 DISPATCH: Sends a simulated command to the ESP32 bridge.
 * Includes detailed logic for rover kinematic updates and error handling simulation.
 * @param {string} commandIdentifier - The action to perform (e.g., 'forward', 'probe', 'capture').
 */
function dispatchRoverMovementCommand(commandIdentifier) {
    STATUS_ELEMENT.innerText = `DISPATCH: Sending command '${commandIdentifier}' to ESP32 Bridge... (Simulating radio link latency and command validation)`;
    
    // --- SIMULATED ASYNCHRONOUS RESPONSE (750ms latency for realism) ---
    setTimeout(() => {
        STATUS_ELEMENT.innerText = `RESPONSE: Command '${commandIdentifier}' Acknowledged by ESP32. Executing local kinematic update/data read.`;

        if (commandIdentifier.startsWith('read_') || commandIdentifier === 'probe') {
            executeDataAcquisition(commandIdentifier); // Trigger sensor read from Arduino R3
        } else if (commandIdentifier === 'capture') {
            // Check if any zone is explicitly selected for target capture (though not needed for rover capture)
            document.getElementById('currentZoneSelection').innerText = 'N/A';
            
            // Mock capture: uses a deterministic hash for consistent analysis
            const zoneID = findNearestPlantZone(currentRoverKinematicState.x_position_m, currentRoverKinematicState.y_position_m)?.id || 1;
            
            // For rover capture, we automatically assign to the nearest zone, overriding if needed.
            currentPhotoAssignmentData[zoneID] = `data:image/jpeg;base64,mocked_rover_capture_zone_${zoneID}_diag:General_Severe_Yellowing_(Chlorosis-N)`;
            renderPhotoInPhotoGridCell(zoneID, currentPhotoAssignmentData[zoneID]);
            
            STATUS_ELEMENT.innerText = `Photo captured and assigned to nearest Zone ${zoneID}. Triggering Comprehensive Analysis.`;
            triggerComprehensiveAnalysisCycle();
        } else {
             // Simulate Rover Kinematics Update (0.1m step)
             const step = 0.1;
             let newX = parseFloat(currentRoverKinematicState.x_position_m);
             let newY = parseFloat(currentRoverKinematicState.y_position_m);
             
             // --- VERBOSE KINEMATICS UPDATE LOGIC ---
             if (commandIdentifier === 'forward') newY = Math.min(FIELD_GRID_SIZE_M, newY + step).toFixed(2);
             if (commandIdentifier === 'backward') newY = Math.max(0, newY - step).toFixed(2);
             if (commandIdentifier === 'left') newX = Math.max(0, newX - step).toFixed(2);
             if (commandIdentifier === 'right') newX = Math.min(FIELD_GRID_SIZE_M, newX + step).toFixed(2);

             // Apply updates
             currentRoverKinematicState.x_position_m = newX;
             currentRoverKinematicState.y_position_m = newY;
             currentRoverKinematicState.heading = (currentRoverKinematicState.heading + (Math.random() * 5 - 2.5)).toFixed(1); // Small heading drift
             
             // Redundant check for boundary conditions
             if (newX <= 0 || newX >= FIELD_GRID_SIZE_M || newY <= 0 || newY >= FIELD_GRID_SIZE_M) {
                 STATUS_ELEMENT.innerText += " WARNING: Rover near Field Boundary! Reducing speed automatically.";
             }
             
             updateMapVisualization();
             updateRover3DPosition();
        }
    }, 750);
}

/**
 * 1.3 ACQUISITION: Executes the sensor reading process, simulating data from the Arduino R3.
 * Generates new realistic readings and logs the state.
 * @param {string} acquisitionType - Specifies the type of acquisition (e.g., 'probe').
 */
function executeDataAcquisition(acquisitionType) {
    STATUS_ELEMENT.innerText = "SENSOR READ: Acquiring raw data from Arduino R3 sensor payload... (Executing ADC and I2C protocols)";
    
    // --- Simulate Realistic Sensor Data (Based on a random distribution with slight bias) ---
    const moistureVal = (Math.random() * 70 + 20).toFixed(1); // 20% to 90%
    const npk_n = Math.floor(Math.random() * 150 + 50);
    const npk_p = Math.floor(Math.random() * 100 + 40);
    const npk_k = Math.floor(Math.random() * 180 + 60);

    // Update Live Display Elements (ENFORCING BLANK INITIALLY, then updating)
    document.getElementById('moistureData').innerText = `${moistureVal}%`;
    document.getElementById('npkData').innerText = `N:${npk_n}, P:${npk_p}, K:${npk_k}`;
    document.getElementById('headingData').innerText = (Math.random() * 360).toFixed(1) + ' deg';
    document.getElementById('latitudeData').innerText = `40.7128${(Math.random()*100).toFixed(0)}`;
    document.getElementById('longitudeData').innerText = `-74.0060${(Math.random()*100).toFixed(0)}`;
    document.getElementById('gpsFix').innerText = '3D Fix Acquired (High Precision)';

    // 1. Send data to ThingSpeak (ESP32 Bridge Action)
    transmitSensorDataViaESP32ToThingSpeak({ 
        moisture: parseFloat(moistureVal), 
        N: npk_n, 
        P: npk_p, 
        K: npk_k 
    });

    if (acquisitionType === 'probe' || acquisitionType === 'read_sensors') {
        // 2. Log data for Fused Analysis
        systemLoggedSensorDataArray.push({
            x_m: parseFloat(currentRoverKinematicState.x_position_m),
            y_m: parseFloat(currentRoverKinematicState.y_position_m),
            moisture: parseFloat(moistureVal),
            npk_n: npk_n, 
            npk_p: npk_p, 
            npk_k: npk_k,
            timestamp: Date.now() // High-resolution timestamp for log integrity
        });
        
        STATUS_ELEMENT.innerText = `SENSOR READ: Data logged (${systemLoggedSensorDataArray.length} total logs). ThingSpeak push complete. Triggering Analysis...`;
        triggerComprehensiveAnalysisCycle();
    }
    updateMapVisualization();
    draw3DMap(); 
}


// ==================================================================================
// SECTION 2.0: DIAGNOSTIC KNOWLEDGE BASE & FUSED ANALYSIS CORE
// ----------------------------------------------------------------------------------
/**
 * 2.1 TOMATO DIAGNOSTIC KNOWLEDGE BASE (EXPANDED FOR VERBOSITY AND COVERAGE)
 * This knowledge base contains the reference data for both visual (CV) and
 * chemical (NPK/Moisture) diagnostics.
 */
const TOMATO_DIAGNOSTIC_KB = {
    DISEASE_TIERS: [
        { name: "Mottling/Mosaic Pattern (Viral-TMV)", severity_score: 95, class: 'rec-critical', 
          recommendation: "CRITICAL ISOLATION REQUIRED: Strong indicator of Tobacco Mosaic Virus (TMV). **IMMEDIATELY REMOVE AND DESTROY** the plant to prevent field-wide contamination. No chemical cure exists." },
        { name: "Dark Spots & Lesions (Fungal/Bacterial)", severity_score: 85, class: 'rec-critical', 
          recommendation: "FUNGICIDE/BACTERICIDE APPLICATION: Likely Early Blight or Bacterial Spot. Apply broad-spectrum copper-based fungicide and focus on improving air circulation to reduce humidity." },
        { name: "General Severe Yellowing (Chlorosis-N)", severity_score: 50, class: 'rec-action', 
          recommendation: "NPK DEFICIENCY LIKELY: Check current NPK data for confirmation. Severe yellowing often indicates primary Nitrogen (N) deficiency. Adjust fertilizer immediately." },
        { name: "Edging Burn/Tip Necrosis (K/Salt)", severity_score: 65, class: 'rec-action', 
          recommendation: "POTASSIUM/SALINITY ALERT: Symptoms point to Potassium (K) deficiency or high salt buildup. Test K levels and consider a soil flush." },
        { name: "Healthy, Deep Green Foliage", severity_score: 0, class: 'rec-optimal', 
          recommendation: "OPTIMAL: No visual symptoms detected. Continue regular monitoring. The overall system health looks excellent based on visual inspection." }
    ],
    NPK_GUIDELINES: {
        moisture: { ideal_min: 40, ideal_max: 60, low_crit: 25, high_crit: 75, penalty_minor: 10, penalty_major: 30, low_rec: "deep supplemental irrigation", high_rec: "review soil drainage/stop all irrigation" },
        N: { ideal_min: 60, ideal_max: 100, low_crit: 30, high_crit: 150, penalty_minor: 15, penalty_major: 40, low_rec: "high-Nitrogen (N) liquid feed", high_rec: "stop all N-fertilizer, flush soil" },
        P: { ideal_min: 50, ideal_max: 80, low_crit: 20, high_crit: 120, penalty_minor: 10, penalty_major: 25, low_rec: "Phosphorus (P) booster for root development", high_rec: "check fertilizer blend for P excess" },
        K: { ideal_min: 70, ideal_max: 120, low_crit: 40, high_crit: 180, penalty_minor: 10, penalty_major: 25, low_rec: "Potassium (K) to boost resistance/fruit set", high_rec: "check for K salt toxicity" },
    }
};

/**
 * 2.2 COMPUTER VISION: LEAF PRE-ASSESSMENT LOGIC
 * Generates the descriptive summary based ONLY on the visual CV score (Pre-Assessment).
 * @param {number} visualScore - The health score from 1 to 100.
 * @param {string} diagnosedDiseaseName - The name of the disease predicted.
 * @returns {string} The descriptive assessment.
 */
function getVisualPreAssessment(visualScore, diagnosedDiseaseName) {
    const diseaseBaseName = diagnosedDiseaseName.split('(')[0].trim();
    
    // Explicitly generate the conversational pre-assessment based on health tiers
    if (visualScore >= 90) return `Leaf condition: **Greenish/Excellent**. CV Score: ${visualScore}%.`;
    if (visualScore >= 80) return `Leaf is **Healthy**, showing only minor localized discoloration. CV Score: ${visualScore}%.`;
    if (visualScore >= 60) return `Leaf shows **Notable Discoloration**. Assists health as ${diseaseBaseName} is likely. CV Score: ${visualScore}%.`;
    return `**Critical Visual Alert**. Assists health: analysis suggests ${diseaseBaseName} is imminent. CV Score: ${visualScore}%.`;
}

/**
 * 2.3 FUSED ANALYSIS: Locates the most relevant sensor data point near a plant location (within the grid cell).
 * This ensures only data logged near the plant is used for diagnosis.
 * @param {number} plantX - X coordinate of the plant zone center (m).
 * @param {number} plantY - Y coordinate of the plant zone center (m).
 * @returns {object|null} The nearest logged data point object.
 */
function findNearestSensorDataPoint(plantX, plantY) {
    let nearestDataPoint = null;
    let minimumDistanceSquared = Infinity;
    // Max search radius is 0.707m (half a diagonal in a 1m x 1m grid cell)
    const MAX_SEARCH_RADIUS_SQ = 0.5 * 0.5; 

    systemLoggedSensorDataArray.forEach(dataPoint => {
        let dx = dataPoint.x_m - plantX;
        let dy = dataPoint.y_m - plantY;
        let dist_sq = dx * dx + dy * dy;

        // CRITICAL CHECK: Must be within the grid cell boundaries AND be the closest logged data point
        if (dist_sq <= MAX_SEARCH_RADIUS_SQ && dist_sq < minimumDistanceSquared) {
            minimumDistanceSquared = dist_sq;
            nearestDataPoint = dataPoint;
        }
    });
    return nearestDataPoint;
}

/**
 * 2.4 CRITICAL FUNCTION: Performs the final, combined analysis (CV + Sensors).
 * Weighting: Soil Sensor Data (Higher Priority) + Visual Data (Lower Priority, 20% impact).
 * @param {object} plant - The plant zone object.
 * @param {object|null} sensorData - The nearest sensor data log.
 * @param {object|null} visualResult - The CV analysis result.
 * @returns {object} The final fused diagnostic report.
 */
function performFinalDataFusionAndDiagnosis(plant, sensorData, visualResult) {
    let fusedHealthScore = 100;
    let soilHealthPenalties = [];
    let sensorDataSummary = "Soil Data: Sensor Data Missing (N/A) - **HIGH PRIORITY GAP**";
    let visualPreAssessment = "Leaf Pre-Assessment: No Photo Taken.";

    // --- 1. SOIL SENSOR DATA ASSESSMENT (High Priority - Arduino R3 data) ---
    if (sensorData) {
        const { moisture, npk_n, npk_p, npk_k } = sensorData;
        const sensorReadings = { moisture, N: npk_n, P: npk_p, K: npk_k };
        sensorDataSummary = `Soil Readings: M=${moisture}%, NPK=${npk_n}/${npk_p}/${npk_k} (Logged at ${sensorData.x_m}m, ${sensorData.y_m}m)`;

        Object.keys(TOMATO_DIAGNOSTIC_KB.NPK_GUIDELINES).forEach(key => {
            const guideline = TOMATO_DIAGNOSTIC_KB.NPK_GUIDELINES[key];
            const value = sensorReadings[key];
            let penaltyMagnitude = 0;
            let problemClassification = '';

            if (value < guideline.low_crit || value > guideline.high_crit) {
                penaltyMagnitude = guideline.penalty_major;
                problemClassification = `CRITICAL DEVIATION (${key})`;
            } else if (value < guideline.ideal_min || value > guideline.ideal_max) {
                penaltyMagnitude = guideline.penalty_minor;
                problemClassification = `MILD IMBALANCE (${key})`;
            }

            if (problemClassification) {
                fusedHealthScore = Math.max(0, fusedHealthScore - penaltyMagnitude);
                const specificRec = (value < guideline.ideal_min ? guideline.low_rec : guideline.high_rec);
                soilHealthPenalties.push({ key, value, problemClassification, specificRec });
            }
        });
    }

    // --- 2. VISUAL (CV) DATA ASSESSMENT (Lower Weight) ---
    let visualPredictionTier = TOMATO_DIAGNOSTIC_KB.DISEASE_TIERS.find(d => d.name.includes("Healthy"));
    if (visualResult) {
        visualPredictionTier = visualResult.prediction;
        const visualScore = visualResult.score;
        visualPreAssessment = getVisualPreAssessment(visualScore, visualResult.diagnosis);
        
        // **KEY WEIGHTING LOGIC**: Only 20% of the visual deficit is applied to the final score.
        const visualDeficit = 100 - visualScore;
        fusedHealthScore = Math.max(0, fusedHealthScore - (visualDeficit * 0.20)); 
    }

    // --- 3. FINAL FUSED RECOMMENDATION LOGIC (Override Hierarchy) ---
    let finalActionRecommendation = 'Optimal health confirmed. Continue regular monitoring and data logging.';
    let finalHealthClassification = 'rec-optimal';
    
    const isMajorViral = visualPredictionTier.name.includes('Mottling');
    const hasCriticalSoilIssue = soilHealthPenalties.some(p => p.problemClassification.includes('CRITICAL'));
    
    // HIERARCHY 1: VIRAL OVERRIDE (Most Severe)
    if (isMajorViral) {
        finalActionRecommendation = visualPredictionTier.recommendation;
        finalHealthClassification = visualPredictionTier.class;
        fusedHealthScore = Math.min(10, fusedHealthScore); 
    }
    // HIERARCHY 2: CRITICAL SOIL STRESS (High Severity)
    else if (hasCriticalSoilIssue) {
        const criticalProblem = soilHealthPenalties.find(p => p.problemClassification.includes('CRITICAL'));
        finalActionRecommendation = `CRITICAL SOIL ALERT: ${criticalProblem.problemClassification} detected. Urgent Action: ${criticalProblem.specificRec}.`;
        finalHealthClassification = 'rec-critical';
    }
    // HIERARCHY 3: MILD/MODERATE SOIL IMBALANCES (Moderate Severity)
    else if (soilHealthPenalties.length > 0) {
        const recString = soilHealthPenalties.map(p => p.specificRec).join('; ');
        finalActionRecommendation = `CAUTION: Moderate Soil Imbalance. Recommended adjustments: ${recString}`;
        finalHealthClassification = fusedHealthScore <= 70 ? 'rec-action' : 'rec-optimal';
    }
    // HIERARCHY 4: VISUAL-ONLY OR OPTIMAL
    else {
        finalActionRecommendation = visualPredictionTier.recommendation;
        finalHealthClassification = visualPredictionTier.class;
    }

    // Redundant system logging before returning the final report
    console.log(`Zone ${plant.id} FUSION RESULT: Score ${Math.round(fusedHealthScore)}. Class: ${finalHealthClassification}.`);

    return {
        id: plant.id,
        fusedScore: Math.round(fusedHealthScore).toFixed(0),
        preAssessmentVisual: visualPreAssessment,
        preAssessmentSensor: sensorDataSummary,
        finalRecommendation: finalActionRecommendation.trim(),
        healthClassification: finalHealthClassification
    };
}


/**
 * 2.5 COMPUTER VISION ENGINE: Core Image Processing Logic (Using Mock/OpenCV)
 * @param {string} base64Image - The image data to analyze.
 * @returns {Promise<object>} A promise resolving to the CV analysis result.
 */
function executeCoreCVAnalysis(base64Image) {
    if (!openCvLibraryIsReady) {
        const fallbackPrediction = TOMATO_DIAGNOSTIC_KB.DISEASE_TIERS.find(d => d.name.includes("Mottling"));
        return Promise.resolve({ score: 5, diagnosis: "CV Library Not Ready (Delayed Init)", prediction: fallbackPrediction });
    }
    
    return new Promise((resolve) => {
        // [MAXIMALLY VERBOSE OpenCV.js IMAGE PROCESSING BLOCK]
        const imageElement = document.createElement('img');
        imageElement.onload = function() {
            let src, hsv, green_mask, yellow_mask, totalPixels; 
            try {
                src = cv.imread(imageElement);
                totalPixels = src.rows * src.cols;
                if (totalPixels === 0) throw new Error("Image read failure: zero size detected.");
                
                hsv = new cv.Mat();
                cv.cvtColor(src, hsv, cv.COLOR_RGBA2HSV, 0); // Explicitly specifying channels

                // Define Green Thresholds (Hue 30-90) - INDICATOR OF HEALTHY FOLIAGE
                const green_low = new cv.Mat(hsv.rows, hsv.cols, hsv.type(), [30, 40, 40, 0]);
                const green_high = new cv.Mat(hsv.rows, hsv.cols, hsv.type(), [90, 255, 255, 255]);
                green_mask = new cv.Mat();
                cv.inRange(hsv, green_low, green_high, green_mask);

                // Define Yellow/Chlorosis Thresholds (Hue 15-30) - INDICATOR OF DEFICIENCY
                const yellow_low = new cv.Mat(hsv.rows, hsv.cols, hsv.type(), [15, 60, 60, 0]);
                const yellow_high = new cv.Mat(hsv.rows, hsv.cols, hsv.type(), [30, 255, 255, 255]);
                yellow_mask = new cv.Mat();
                cv.inRange(hsv, yellow_low, yellow_high, yellow_mask);
                
                green_low.delete(); green_high.delete(); yellow_low.delete(); yellow_high.delete(); // Memory cleanup
                
                // Calculate Score based on pixel ratios
                const greenPixels = cv.countNonZero(green_mask);
                const unhealthyPixels = cv.countNonZero(yellow_mask);
                const totalAnalyzedPixels = greenPixels + unhealthyPixels;

                let calculatedScore = 100;
                let predictionTier = TOMATO_DIAGNOSTIC_KB.DISEASE_TIERS.find(d => d.name.includes("Healthy"));
                
                if (totalAnalyzedPixels > 1000) { // Only proceed if a substantial amount of plant matter is detected
                    const ratioOfGreen = greenPixels / totalAnalyzedPixels;
                    calculatedScore = Math.max(10, Math.min(100, Math.round(ratioOfGreen * 100)));
                    if (ratioOfGreen < 0.6) predictionTier = TOMATO_DIAGNOSTIC_KB.DISEASE_TIERS.find(d => d.name.includes("Yellowing"));
                } else {
                    calculatedScore = 85; // Default score if plant matter detection failed
                }
                
                resolve({ score: calculatedScore, diagnosis: predictionTier.name, prediction: predictionTier });
            } catch (e) {
                console.error("CRITICAL OpenCV Analysis Exception:", e);
                const errorPrediction = TOMATO_DIAGNOSTIC_KB.DISEASE_TIERS.find(d => d.name.includes("Mottling"));
                resolve({ score: 1, diagnosis: `CV Engine Failed: ${e.message}`, prediction: errorPrediction });
            } finally {
                if (src) src.delete();
                if (hsv) hsv.delete();
                if (green_mask) green_mask.delete();
                if (yellow_mask) yellow_mask.delete();
            }
        };
        imageElement.onerror = function() {
            const errorPrediction = TOMATO_DIAGNOSTIC_KB.DISEASE_TIERS.find(d => d.name.includes("Mottling"));
            resolve({ score: 1, diagnosis: "CV Image Load Error (Corrupted Data)", prediction: errorPrediction });
        }
        imageElement.src = base64Image;
    });
}

/**
 * Executes the mock or actual CV prediction based on the image source (stock or uploaded).
 * @param {string} base64Image - The image data.
 * @returns {Promise<object>} The CV prediction.
 */
function executePhotoPrediction(base64Image) {
    if (base64Image.includes('mocked_stock_photo_hash') || base64Image.includes('mocked_rover_capture_zone')) {
        // MOCK PATH: Deterministic diagnosis based on hash for consistency
        const mockMatch = base64Image.match(/diag:([a-zA-Z_()\-]+)/);
        const mockDiseaseName = mockMatch ? mockMatch[1].replace(/_/g, ' ') : "Healthy, Deep Green Foliage";

        let prediction = TOMATO_DIAGNOSTIC_KB.DISEASE_TIERS.find(d => d.name.includes(mockDiseaseName.split('(')[0].trim())) || TOMATO_DIAGNOSTIC_KB.DISEASE_TIERS[4];
        const mockScore = 100 - prediction.severity_score; 
        
        return Promise.resolve({ score: mockScore, diagnosis: prediction.name, prediction: prediction });
    } else {
        // ACTUAL CV PATH for real user uploads
        return executeCoreCVAnalysis(base64Image);
    }
}


// ==================================================================================
// SECTION 3.0: USER INTERFACE, RENDERING, AND INITIALIZATION (CLEANED FLOW)
// ----------------------------------------------------------------------------------
/**
 * 3.1 Master function to trigger the full asynchronous analysis and UI update cycle.
 * CRITICAL FIX: Ensures the analysis panel is blank if no data is present.
 */
async function triggerComprehensiveAnalysisCycle() {
    const analysisGridContainer = document.getElementById('plantAnalysisGrid');
    const hasData = systemLoggedSensorDataArray.length > 0 || Object.keys(currentPhotoAssignmentData).length > 0;
    
    // Check 1: Data Integrity Check
    if (!hasData) {
        analysisGridContainer.innerHTML = '<h2>DATA FUSION ENGINE: AWAITING GATHERED DATA. (No sensor logs or photo assignments yet.) </h2>';
        STATUS_ELEMENT.innerText = `DATA FUSION STANDBY: Awaiting initial sensor or photo data. Rover is STANDBY.`;
        draw3DMap(); 
        return; // EXIT EARLY: NO DATA TO ANALYZE
    }
    
    // Check 2: Pre-Processing Notification
    analysisGridContainer.innerHTML = '<h2>DATA FUSION ENGINE: Processing. Waiting for all Photo and Sensor data to resolve...</h2>';

    const fusionPromises = FIELD_PLANT_LOCATIONS_M.map(async plant => {
        const sensorData = findNearestSensorDataPoint(plant.x, plant.y);
        const photoBase64 = currentPhotoAssignmentData[plant.id];
        
        let visualResult = null;
        if (photoBase64) {
            visualResult = await executePhotoPrediction(photoBase64); 
        }
        
        return performFinalDataFusionAndDiagnosis(plant, sensorData, visualResult); 
    });

    // Await all diagnostic reports
    const finalAnalysesResults = await Promise.all(fusionPromises); 
    analysisGridContainer.innerHTML = ''; 

    // Render all results sequentially
    finalAnalysesResults.forEach(renderAnalysisCard);

    // Update 3D map based on new health data
    draw3DMap(); 

    STATUS_ELEMENT.innerText = `DATA FUSION COMPLETE: All ${FIELD_PLANT_LOCATIONS_M.length} zones analyzed and results rendered. Rover is STANDBY.`;
}

/**
 * 3.2 Renders a single, verbose analysis card.
 * @param {object} analysisResult - The fused diagnostic data.
 */
function renderAnalysisCard(analysisResult) {
    const analysisGridContainer = document.getElementById('plantAnalysisGrid');
    
    // Skip rendering if no data or photo exists for this zone
    if (analysisResult.preAssessmentSensor.includes('Missing') && analysisResult.preAssessmentVisual.includes('No Photo')) {
        return; 
    }

    const cardHTML = `
    <div class="analysis-card">
        <div class="plant-id-label">ZONE ${analysisResult.id} DIAGNOSTIC REPORT</div>
        
        <div class="assessment-section pre-assessment">
            <strong>1. Leaf Pre-Assessment (CV Engine - Visual Health)</strong>
            <p>${analysisResult.preAssessmentVisual}</p>
        </div>
        
        <div class="assessment-section pre-assessment">
            <strong>2. Soil Sensor Pre-Assessment (Arduino R3 Data Log)</strong>
            <p>${analysisResult.preAssessmentSensor}</p>
        </div>
        
        <hr style="border-top: 2px solid #30363d; margin: 25px 0;">
        
        <div class="assessment-section final-recommendation">
            <strong>3. FINAL COMPOSITE HEALTH SCORE (FUSED):</strong> 
            <span class="${analysisResult.healthClassification}">${analysisResult.fusedScore}/100</span>
            
            <h4 style="color: #c9d1d9; margin-top: 20px;">Final Action Recommendation (Priority Action):</h4>
            <span class="${analysisResult.healthClassification}">${analysisResult.finalRecommendation}</span>
        </div>
    </div>
    `;
    analysisGridContainer.insertAdjacentHTML('beforeend', cardHTML);
}

// 3.3 PHOTO GRID MANAGEMENT

/**
 * Generates the 4x4 interactive photo grid.
 * CRITICAL FIX: Clicking a cell now triggers the file upload dialog directly.
 */
function generatePhotoGrid() {
    const photoGrid = document.getElementById('photoGrid');
    photoGrid.innerHTML = '';
    for (let i = 1; i <= 16; i++) {
        const cell = document.createElement('div');
        cell.className = 'grid-cell';
        cell.id = `zone-cell-${i}`;
        cell.innerText = `Zone ${i} - AWAITING PHOTO`;
        
        // CRITICAL FIX: Direct file upload via grid cell click
        cell.onclick = () => {
            currentlySelectedPlantZone = i; // Store the zone ID immediately for use by the file handler
            
            // Set the visual selection state
            document.querySelectorAll('.grid-cell').forEach(c => c.style.border = '1px solid #3fb950');
            document.getElementById(`zone-cell-${i}`).style.border = '3px solid #ffd700';
            CURRENT_ZONE_SELECTION_DISPLAY.innerText = i;
            
            STATUS_ELEMENT.innerText = `Zone ${i} selected for direct upload. Opening file dialog...`;
            FILE_INPUT_ELEMENT.click(); // Trigger the file dialog
        };
        
        photoGrid.appendChild(cell);
        
        // Restore photos if they exist in the current session data
        if (currentPhotoAssignmentData[i]) {
             renderPhotoInPhotoGridCell(i, currentPhotoAssignmentData[i]);
        }
    }
}

/**
 * Handles file selection from the user's local machine.
 */
function handleFileSelectedByUser(event) {
    const file = event.target.files[0];
    const targetZoneId = currentlySelectedPlantZone;

    if (!file || targetZoneId === 0) {
        STATUS_ELEMENT.innerText = "ERROR: File selection failed or plant zone selection lost. Please re-click the zone.";
        // Reset the file input value immediately to allow the same file to be selected again
        event.target.value = ''; 
        return;
    }

    STATUS_ELEMENT.innerText = `Processing file ${file.name} for Zone ${targetZoneId}... (Converting to Base64)`;
    const reader = new FileReader();
    reader.onload = function(e) {
        const base64Image = e.target.result;
        currentPhotoAssignmentData[targetZoneId] = base64Image;
        renderPhotoInPhotoGridCell(targetZoneId, base64Image);
        
        STATUS_ELEMENT.innerText = `Photo uploaded successfully to Zone ${targetZoneId}. Triggering Fused Analysis...`;
        
        // CRITICAL CLEANUP: Reset the selection and the file input
        document.querySelectorAll('.grid-cell').forEach(c => c.style.border = '1px solid #3fb950'); // Clear highlight
        currentlySelectedPlantZone = 0; 
        CURRENT_ZONE_SELECTION_DISPLAY.innerText = 'N/A';
        event.target.value = ''; // Clear the file input for next use
        
        triggerComprehensiveAnalysisCycle(); 
    };
    
    reader.readAsDataURL(file);
}

/**
 * Renders the photo thumbnail inside the 4x4 grid cell.
 * @param {number} zoneId - The ID of the zone (1-16).
 * @param {string} base64Image - The image data.
 */
function renderPhotoInPhotoGridCell(zoneId, base64Image) {
    const cell = document.getElementById(`zone-cell-${zoneId}`);
    cell.innerHTML = ''; // Clear existing content
    const img = document.createElement('img');
    img.src = base64Image;
    img.style.width = '100%';
    img.style.height = '100%';
    img.style.objectFit = 'cover';
    cell.appendChild(img);
    
    const label = document.createElement('div');
    label.style.position = 'absolute';
    label.style.top = '0';
    label.style.left = '0';
    label.style.backgroundColor = 'rgba(0,0,0,0.7)';
    label.style.color = '#ffd700';
    label.style.padding = '5px 7px';
    label.style.fontSize = '0.7em';
    label.innerText = `ZONE ${zoneId} (ASSIGNED)`;
    cell.appendChild(label);
}

function clearPhotoGrid() {
    currentPhotoAssignmentData = {};
    generatePhotoGrid();
}

// 3.4 STOCK PHOTO GALLERY (50 PRESETS)

/**
 * Populates the 50-preset stock photo library using deterministic mock data.
 */
function populateStockPhotos() {
    if (Object.keys(stockPhotoLibraryData).length === MAX_STOCK_PHOTOS) return;
    const diseaseList = TOMATO_DIAGNOSTIC_KB.DISEASE_TIERS;
    for (let i = 1; i <= MAX_STOCK_PHOTOS; i++) {
        const diseaseIndex = i % diseaseList.length;
        const diseaseName = diseaseList[diseaseIndex].name;
        // Mock Base64 containing the diagnosis name for consistent mock analysis
        const base64 = `data:image/svg+xml;base64,mocked_stock_photo_hash_${i}_diag:${diseaseName.replace(/\s/g, '_').replace(/[()]/g, '')}`;
        stockPhotoLibraryData[i] = base64;
    }
}

function openStockImageGalleryModal() {
    populateStockPhotos();
    renderStockImageGrid();
    STOCK_MODAL.style.display = "block";
    STATUS_ELEMENT.innerText = "Stock Photo Gallery opened. Select a photo to assign to the current target zone.";
}

function closeStockImageGalleryModal() {
    STOCK_MODAL.style.display = "none";
    STATUS_ELEMENT.innerText = "Stock Photo Gallery closed. Rover Control System Online.";
}

/**
 * CRITICAL FIX: Renders the 50-preset grid within the stock image modal.
 */
function renderStockImageGrid() {
    const stockGrid = document.getElementById('stockImageGrid');
    stockGrid.innerHTML = '';
    
    for (let i = 1; i <= MAX_STOCK_PHOTOS; i++) {
        const base64 = stockPhotoLibraryData[i];
        const cell = document.createElement('div');
        cell.className = 'grid-cell';
        cell.style.border = 'none';
        cell.onclick = () => assignStockPhotoToZone(i);

        const img = document.createElement('img');
        img.src = base64; 
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.objectFit = 'cover';
        
        const label = document.createElement('div');
        label.style.position = 'absolute';
        label.style.bottom = '0';
        label.style.right = '0';
        label.style.backgroundColor = 'rgba(255,215,0,0.8)';
        label.style.color = '#000';
        label.style.padding = '3px 5px';
        label.style.fontSize = '0.7em';
        label.innerText = `ID ${i}`;

        cell.appendChild(img);
        cell.appendChild(label);
        stockGrid.appendChild(cell);
    }
}

/**
 * Assigns a selected stock photo (preset) to the currently selected zone.
 * @param {number} stockId - The ID of the stock image (1-50).
 */
function assignStockPhotoToZone(stockId) {
    if (currentlySelectedPlantZone === 0) {
        STATUS_ELEMENT.innerText = "ERROR: Please click one of the 16 Plant Zones first before selecting a stock photo.";
        return;
    }
    
    const base64Image = stockPhotoLibraryData[stockId];
    const targetZoneId = currentlySelectedPlantZone;

    currentPhotoAssignmentData[targetZoneId] = base64Image;
    renderPhotoInPhotoGridCell(targetZoneId, base64Image);
    
    STATUS_ELEMENT.innerText = `Stock Photo ID ${stockId} assigned to Zone ${targetZoneId}. Triggering Fused Analysis.`;
    
    // Reset state and trigger analysis
    document.querySelectorAll('.grid-cell').forEach(c => c.style.border = '1px solid #3fb950'); // Clear highlight
    currentlySelectedPlantZone = 0;
    CURRENT_ZONE_SELECTION_DISPLAY.innerText = 'N/A';
    closeStockImageGalleryModal();
    triggerComprehensiveAnalysisCycle();
}


// 3.5 HISTORY MANAGEMENT (50 PRESETS ENFORCED)

function executeTrialSaveOperation() {
    // Enforcement of 50 Preset Capacity (CRITICAL FIX)
    if (trialHistoryRecords.length >= MAX_HISTORY_TRIALS) {
        const removedTrial = trialHistoryRecords.shift(); 
        STATUS_ELEMENT.innerText = `WARNING: Trial history is full (${MAX_HISTORY_TRIALS} presets). Trial ${removedTrial.id} was purged (FIFO).`;
        console.warn(`PURGE: Oldest trial (ID ${removedTrial.id}) removed from local storage.`);
    }

    const trialDataRecord = {
        id: currentIncrementalTrialID,
        timestamp: new Date().toLocaleString(),
        roverState: { ...currentRoverKinematicState },
        sensorLogs: [...systemLoggedSensorDataArray],
        photoAssignments: JSON.parse(JSON.stringify(currentPhotoAssignmentData)), // Deep copy
        aiData: {
            analysisGridHTML: document.getElementById('plantAnalysisGrid').innerHTML 
        }
    };
    
    trialHistoryRecords.push(trialDataRecord);
    localStorage.setItem('trialHistory', JSON.stringify(trialHistoryRecords));
    STATUS_ELEMENT.innerText = `TRIAL SAVE COMPLETE: Trial ${currentIncrementalTrialID} saved. Starting new session...`;
    
    // Reset state for new trial
    systemLoggedSensorDataArray = [];
    currentPhotoAssignmentData = {};
    currentIncrementalTrialID++;
    HISTORY_TRIAL_COUNTER.innerText = currentIncrementalTrialID;
    resetSensorAndMapData(true);
    clearPhotoGrid();
    triggerComprehensiveAnalysisCycle();
}

function closeHistoryModal() {
    HISTORY_MODAL.style.display = "none";
    historyIsBeingViewed = false;
    // After closing history, restore current trial ID and status
    HISTORY_TRIAL_COUNTER.innerText = currentIncrementalTrialID;
    STATUS_ELEMENT.innerText = `History modal closed. Current Trial ${currentIncrementalTrialID} is now active.`;
}

function executeAllHistoryClearance() {
    if (confirm("🚨 ARE YOU ABSOLUTELY SURE? This action will permanently delete ALL saved trial history (50 presets).")) {
        localStorage.removeItem('trialHistory');
        trialHistoryRecords = [];
        currentIncrementalTrialID = 1;
        HISTORY_TRIAL_COUNTER.innerText = currentIncrementalTrialID;
        closeHistoryModal();
        STATUS_ELEMENT.innerText = "All trial history cleared. Starting fresh Trial 1.";
    }
}

/**
 * 3.6 MAP AND VISUALIZATION FUNCTIONS
 */

/**
 * Utility to find the nearest plant zone ID (helper for the capture command).
 */
function findNearestPlantZone(x_m, y_m) {
    let nearest = null;
    let min_dist_sq = Infinity;

    FIELD_PLANT_LOCATIONS_M.forEach(plant => {
        let dx = plant.x - x_m;
        let dy = plant.y - y_m;
        let dist_sq = dx * dx + dy * dy;

        if (dist_sq < min_dist_sq) {
            min_dist_sq = dist_sq;
            nearest = plant;
        }
    });
    return nearest;
}

/**
 * Resets all transient data (logs, photos, map) for a fresh trial.
 * @param {boolean} fullReset - If true, resets all sensor display values to N/A.
 */
function resetSensorAndMapData(fullReset = true) {
    if (fullReset) {
        systemLoggedSensorDataArray = [];
        currentPhotoAssignmentData = {};
        // Reset sensor displays to N/A (CRITICAL: Enforcing blank initial state)
        document.getElementById('moistureData').innerText = 'N/A';
        document.getElementById('npkData').innerText = 'N/A';
        document.getElementById('latitudeData').innerText = 'N/A';
        document.getElementById('longitudeData').innerText = 'N/A';
        document.getElementById('headingData').innerText = 'N/A';
        document.getElementById('gpsFix').innerText = 'N/A';
        document.getElementById('thingspeakStatus').innerText = 'Awaiting Connection';
    }
    currentRoverKinematicState.x_position_m = 2.0;
    currentRoverKinematicState.y_position_m = 2.0;
    currentRoverKinematicState.heading = 0.0;
    
    updateMapVisualization(); 
    draw3DMap(); 
    
    if (fullReset) {
        clearPhotoGrid();
        triggerComprehensiveAnalysisCycle(); // This will render the "AWAITING DATA" message
        historyIsBeingViewed = false;
        currentlySelectedPlantZone = 0;
        CURRENT_ZONE_SELECTION_DISPLAY.innerText = 'N/A';
    }
}

/**
 * Draws the 2D field map, rover, and logged sensor data points.
 * CRITICAL FIX: Plant Zone Numbers are removed for a cleaner visualization.
 */
function updateMapVisualization() {
    const ctx = MAP_CONTEXT;
    const size = MAP_CANVAS_PIXELS;
    const scale = size / FIELD_GRID_SIZE_M;

    // 1. Clear Canvas and Draw Background Grid (Cleaner Grid Lines)
    ctx.clearRect(0, 0, size, size);
    ctx.fillStyle = '#1e1e1e';
    ctx.fillRect(0, 0, size, size);
    ctx.strokeStyle = '#30363d'; 
    ctx.lineWidth = 0.5; 
    for (let i = 0; i <= FIELD_GRID_SIZE_M; i++) {
        ctx.beginPath();
        ctx.moveTo(i * scale, 0);
        ctx.lineTo(i * scale, size);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(0, i * scale);
        ctx.lineTo(size, i * scale);
        ctx.stroke();
    }

    // 2. Draw Plant Locations (Simple Green Circles - NO NUMBERS)
    FIELD_PLANT_LOCATIONS_M.forEach(plant => {
        const x_pix = plant.x * scale;
        const y_pix = size - (plant.y * scale);
        
        ctx.beginPath();
        ctx.arc(x_pix, y_pix, PLANT_CIRCLE_RADIUS, 0, 2 * Math.PI);
        ctx.fillStyle = '#4ec9b0'; // Bright Green for visibility
        ctx.fill();
        // REMOVED: ctx.fillText(`Z${plant.id}`, x_pix + 7, y_pix - 7);
    });
    
    // 3. Draw Logged Sensor Data Points (Small dots)
    systemLoggedSensorDataArray.forEach(data => {
        const x_pix = data.x_m * scale;
        const y_pix = size - (data.y_m * scale);
        
        let color = '#f85149'; 
        if (data.moisture > 35 && data.moisture < 65) color = '#3fb950'; 
        else if (data.moisture >= 25 && data.moisture <= 75) color = '#e3b341'; 

        ctx.beginPath();
        ctx.arc(x_pix, y_pix, 2, 0, 2 * Math.PI); 
        ctx.fillStyle = color;
        ctx.fill();
    });

    // 4. Draw Rover Position (Blue Triangle)
    const x_r = currentRoverKinematicState.x_position_m * scale;
    const y_r = size - (currentRoverKinematicState.y_position_m * scale);
    const roverSize = 12;
    
    ctx.save();
    ctx.translate(x_r, y_r);
    ctx.rotate(-currentRoverKinematicState.heading * Math.PI / 180); 
    
    ctx.beginPath();
    ctx.moveTo(0, -roverSize); 
    ctx.lineTo(-roverSize * 0.7, roverSize * 0.5); 
    ctx.lineTo(roverSize * 0.7, roverSize * 0.5); 
    ctx.closePath();
    ctx.fillStyle = '#58a6ff'; 
    ctx.fill();
    ctx.strokeStyle = '#ffffff';
    ctx.lineWidth = 1;
    ctx.stroke();
    ctx.restore();
}

/**
 * 3.7 INITIALIZATION SEQUENCING (THREE.JS)
 */
let scene, camera, renderer, controls;
const cubes = [];

function initThreeD() {
    const container = document.getElementById('threeDContainer');
    
    // SCENE SETUP
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x0f131a);

    // CAMERA AND RENDERER SETUP
    camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
    camera.position.set(2, 5, 5); 

    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(container.clientWidth, container.clientHeight);
    container.appendChild(renderer.domElement);

    // LIGHTING SETUP (Dual-Source)
    const ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
    scene.add(ambientLight);
    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.9);
    directionalLight.position.set(5, 12, 7.5);
    scene.add(directionalLight);

    // ORBIT CONTROLS (User Interaction)
    controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true; 
    controls.dampingFactor = 0.04;
    controls.screenSpacePanning = false;
    controls.minDistance = 2;
    controls.maxDistance = 15;
    
    // GROUND PLANE AND GRID
    const gridHelper = new THREE.GridHelper(FIELD_GRID_SIZE_M, FIELD_GRID_SIZE_M, 0x444444, 0x444444);
    gridHelper.position.y = -0.01;
    gridHelper.position.x = FIELD_GRID_SIZE_M / 2;
    gridHelper.position.z = FIELD_GRID_SIZE_M / 2;
    scene.add(gridHelper);
    
    // PLANT ZONE CUBES (Initialized to minimal height)
    FIELD_PLANT_LOCATIONS_M.forEach(plant => {
        const geometry = new THREE.BoxGeometry(0.8, 0.1, 0.8);
        const material = new THREE.MeshLambertMaterial({ color: 0xcccccc });
        const cube = new THREE.Mesh(geometry, material);
        cube.position.set(plant.x, 0.05, plant.y);
        cube.userData.id = plant.id;
        cube.userData.moisture = 0;
        scene.add(cube);
        cubes.push(cube);
    });

    // RENDER LOOP
    function animate() {
        requestAnimationFrame(animate);
        controls.update(); 
        renderer.render(scene, camera);
    }
    animate();

    window.addEventListener('resize', onWindowResize, false);
}
// [Additional verbose Three.js helpers]
function onWindowResize() {
    const container = document.getElementById('threeDContainer');
    camera.aspect = container.clientWidth / container.clientHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(container.clientWidth, container.clientHeight);
}

// Draw the 3D bars based on the analysis results
function draw3DMap() {
    // Only update 3D map if the rover health status is nominal or warning (not critical failure)
    if (roverHealthStatus < 50 && !historyIsBeingViewed) {
        console.warn("3D Map update aborted: System health too low.");
        return;
    }

    cubes.forEach(cube => {
        const plant = FIELD_PLANT_LOCATIONS_M.find(p => p.id === cube.userData.id);
        const sensorData = findNearestSensorDataPoint(plant.x, plant.y);
        
        let moisture = sensorData ? sensorData.moisture : 0;
        let color = 0xcccccc; 

        if (sensorData) {
            // Use the final health classification for 3D bar color (Requires DOM query)
            // Note: This relies on the DOM analysis cards being rendered for color
            const analysisCard = document.querySelector(`.analysis-card .plant-id-label:contains("ZONE ${plant.id}")`)?.parentElement;
            const healthClassElement = analysisCard?.querySelector('.final-recommendation span[class^="rec-"]');
            const healthClass = healthClassElement?.className;
            
            if (healthClass === 'rec-optimal') color = 0x3fb950;
            else if (healthClass === 'rec-action') color = 0xe3b341;
            else if (healthClass === 'rec-critical') color = 0xf85149;
            else color = 0x79c0ff; // Default if card exists but classification is not found
        }
        
        // Dynamic height based on moisture (Max height 2.5m)
        const normalizedHeight = Math.max(0.1, moisture / 100 * 2.5); 
        
        // Update cube properties
        cube.scale.y = normalizedHeight / 0.1; 
        cube.position.y = normalizedHeight / 2;
        (cube.material).color.setHex(color);

        cube.userData.moisture = moisture;
    });
}

function updateRover3DPosition() {
    let roverMesh = scene.getObjectByName('rover_model');
    if (!roverMesh) {
        const roverGeometry = new THREE.SphereGeometry(0.15, 16, 16);
        const roverMaterial = new THREE.MeshBasicMaterial({ color: 0x58a6ff });
        roverMesh = new THREE.Mesh(roverGeometry, roverMaterial);
        roverMesh.name = 'rover_model';
        roverMesh.position.y = 0.5;
        scene.add(roverMesh);
    }
    // Update position
    roverMesh.position.x = parseFloat(currentRoverKinematicState.x_position_m);
    roverMesh.position.z = parseFloat(currentRoverKinematicState.y_position_m);
}

// Final Initialization Sequence
function onDocumentReady() {
    initThreeD();
    populateStockPhotos(); 
    generatePhotoGrid();
    resetSensorAndMapData(true); // Ensures clean, N/A state and renders "AWAITING DATA"
    STATUS_ELEMENT.innerText = "SYSTEM BOOT: DOM Ready. Awaiting OpenCV.js initialization for full CV capability.";
}

// Ensure the code runs after the DOM and OpenCV are ready
window.onload = onDocumentReady;

// Small utility to allow querySelector to use :contains for the 3D map coloring logic
(function(D){
    D.querySelector = function(s){
        if(s.indexOf(':contains') === -1) return D.querySelector(s);
        let [selector, text] = s.split(':contains');
        text = text.replace(/["()]/g, '');
        return [...D.querySelectorAll(selector)].find(el => el.textContent.includes(text));
    };
    D.querySelectorAll = function(s){
        if(s.indexOf(':contains') === -1) return D.querySelectorAll(s);
        let [selector, text] = s.split(':contains');
        text = text.replace(/["()]/g, '');
        return [...D.querySelectorAll(selector)].filter(el => el.textContent.includes(text));
    };
})(document.constructor.prototype);

// OpenCV Library Readiness Check
function onOpenCvReady() {
    openCvLibraryIsReady = true;
    STATUS_ELEMENT.innerText = "System Status: OpenCV.js Library Initialized. Rover Control System Fully Operational.";
}
</script>
</body>
</html>
