<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>S.C.O.U.T. Rover Full-Spectrum Data Fusion & Control Console (V20.0 - High-Impact 3D / Manual Override)</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://unpkg.com/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
<script async src="https://docs.opencv.org/4.x/opencv.js" onload="onOpenCvReady();"></script>
<style>
/* =================================================================
   SECTION 0.1: CRITICAL SYSTEM-WIDE CSS STYLES (Highly Detailed Dark Theme)
   ================================================================= */
body { 
    font-family: 'Consolas', 'Segoe UI', monospace; 
    margin: 0; 
    padding: 25px; 
    background-color: #0c1015; /* Deeper background for the ultimate dark mode */
    color: #c9d1d9; 
    transition: background-color 0.5s;
    line-height: 1.5; 
}
.container {
    max-width: 1920px; 
    margin: auto;
    background: #161b22; 
    padding: 40px;
    border-radius: 18px;
    box-shadow: 0 15px 40px rgba(0,0,0,1.0); 
    display: flex;
    flex-wrap: wrap;
    border: 3px solid #30363d; 
}
/* LAYOUT AND PANEL DEFINITION */
.controls-panel { flex: 1; min-width: 400px; padding-right: 35px; border-right: 1px dashed #30363d; }
.map-panel { flex: 1; min-width: 480px; padding: 0 35px; }
.photo-panel { flex: 1; min-width: 480px; padding-left: 35px; border-left: 1px dashed #30363d; }
.map-3d-panel { flex-basis: 100%; min-width: 100%; margin-top: 40px; padding-top: 20px; border-top: 3px solid #30363d; }
.plant-analysis-panel {
    flex-basis: 100%; 
    margin-top: 50px; 
    padding-top: 30px; 
    border-top: 3px solid #30363d; 
}
/* Typography and Status Indicators */
h1 { color: #58a6ff; border-bottom: 5px double #30363d; padding-bottom: 15px; margin-bottom: 30px; font-size: 2.6em; font-weight: 800; }
h2 { color: #79c0ff; margin-top: 35px; margin-bottom: 15px; font-size: 1.9em; border-bottom: 1px solid #30363d; padding-bottom: 5px; }
h3 { color: #4ac9b0; margin-top: 20px; font-size: 1.4em; }
#status { font-weight: 900; color: #f08047; font-size: 1.25em; display: block; margin-top: 10px; }
.data-display {
    margin-top: 30px;
    padding: 25px;
    border: 2px solid #30363d;
    border-radius: 12px;
    background-color: #0f131a;
    transition: box-shadow 0.3s;
}
.data-row strong {
    display: inline-block;
    width: 220px; 
    color: #4ac9b0;
}
button {
    padding: 16px 24px;
    margin: 8px 6px;
    cursor: pointer;
    border: none;
    border-radius: 10px;
    font-weight: bold;
    transition: background-color 0.3s ease, transform 0.1s, box-shadow 0.3s;
    letter-spacing: 1.2px;
    font-size: 1.08em;
    text-transform: uppercase;
    box-shadow: 0 5px 8px rgba(0,0,0,0.5);
    white-space: nowrap;
}
button:hover { transform: translateY(-3px); box-shadow: 0 8px 12px rgba(0,0,0,0.8); }
.move-controls button { background-color: #58a6ff; color: #0d1117; }
.arm-controls button { background-color: #3fb950; color: #0d1117; }
.history-controls button { background-color: #e3b341; color: #0d1117; }
.photo-controls button { background-color: #f08047; color: #0d1117; }
#openManualEntryButton {
    background-color: #ffd700;
    color: #0d1117;
    border: 2px solid #e3b341;
}

/* MAP STYLES */
#roverMap {
    border: 4px solid #58a6ff;
    border-radius: 5px;
    background-color: #0f131a;
}
/* GRID STYLES (4x4 Zones) */
#photoGrid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    grid-template-rows: repeat(4, 1fr);
    gap: 8px;
    border: 3px solid #58a6ff;
    max-width: 480px;
    margin: 25px auto;
    aspect-ratio: 1 / 1;
    background-color: #0f131a;
    position: relative;
}
.grid-cell {
    background-color: #21262d;
    border: 1px solid #3fb950;
    position: relative;
    cursor: pointer;
    overflow: hidden;
    aspect-ratio: 1/1;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 0.9em;
    font-weight: bold;
    color: #4ac9b0;
    transition: border 0.2s, background-color 0.2s;
}
.grid-cell:hover { background-color: #2a3038; }
/* V20.0 CRITICAL FIX: Ensure image is displayed and covers cell */
.grid-cell-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    position: absolute;
    top: 0;
    left: 0;
    z-index: 5;
    pointer-events: none !important;
}
/* ANALYSIS CARD STYLING */
#plantAnalysisGrid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(550px, 1fr));
    gap: 40px;
    margin-top: 30px;
}
.plant-id-label {
    font-size: 2.2em;
    font-weight: 900;
    color: #ffd700;
    border-bottom: 5px double #30363d;
    padding-bottom: 15px;
    margin-bottom: 25px;
}
.rec-optimal, .rec-action, .rec-critical, .rec-no-data {
    padding: 15px;
    border-radius: 10px;
    display: block;
    font-weight: bold;
    margin-top: 18px;
    font-size: 1.15em;
    line-height: 1.4;
}
.rec-optimal { background-color: #3fb950; color: #0d1117; }
.rec-action { background-color: #e3b341; color: #0d1117; }
.rec-critical { background-color: #f85149; color: #0d1117; }
.rec-no-data { background-color: #58a6ff; color: #0d1117; }
/* MODAL STYLES */
.modal-content { 
    background-color: #161b22; 
    margin: 3% auto; 
    padding: 50px; 
    border: 3px solid #30363d; 
    width: 95%; 
    max-width: 800px; 
    border-radius: 20px; 
}
</style>
</head>
<body>
<div class="container">
    <div class="controls-panel">
        <h1>S.C.O.U.T. Rover Control System (V20.0)</h1>
        <p>System Diagnostic Status: <span id="status">AWAITING SYSTEM BOOT SEQUENCE COMPLETION...</span></p>

        <div class="data-display move-controls">
            <h2>Rover Translational Control (X/Y Axis)</h2>
            <p>Simulated Commands - Provides real-time feedback in the Status Console.</p>
            <button onclick="dispatchRoverMovementCommand('forward')">FORWARD (Y+)</button>
            <button onclick="dispatchRoverMovementCommand('stop')">   üõë   EMERGENCY STOP</button>
            <button onclick="dispatchRoverMovementCommand('backward')">BACKWARD (Y-)</button><br>
            <button onclick="dispatchRoverMovementCommand('left')">LEFT (X-)</button>
            <button onclick="dispatchRoverMovementCommand('right')">RIGHT (X+)</button>
        </div>

        <div class="data-display arm-controls">
            <h2>Data Acquisition & Manual Override</h2>
            <p>Use the Rover controls or the **Manual Data Entry** feature below.</p>
            <button onclick="executeDataAcquisition()">   üî¨   EXTEND PROBE (SOIL READ)</button>
            <button onclick="dispatchRoverMovementCommand('capture')" class="photo-controls">   üì∏   TRIGGER CAMERA CAPTURE</button>
            <hr style="border-top: 1px solid #30363d; margin: 15px 0;">
            <button id="openManualEntryButton" onclick="openManualDataEntryModal()">   ‚úèÔ∏è   MANUAL DATA & PHOTO ENTRY</button>
        </div>
        
        <div class="data-display">
            <h2>System Telemetry & Network Status</h2>
            <div class="data-row"><strong>ESP32 IP Address:</strong> <span style="color: #3fb950;">**10.101.146.88**</span></div>
            <div class="data-row"><strong>ThingSpeak API Key:</strong> <span style="color: #3fb950;">**6OXH3SUQ4VNSOJX1**</span></div>
            <div class="data-row"><strong>ThingSpeak Status:</strong> <span id="thingspeakStatus">Awaiting Connection</span></div>
            <h3>Latest Sensor Reading</h3>
            <div class="data-row"><strong>Soil Moisture (%):</strong> <span id="moistureData">N/A</span></div>
            <div class="data-row"><strong>NPK (N, P, K ppm):</strong> <span id="npkData">N/A</span></div>
        </div>
    </div>
    
    <div class="map-panel">
        <h2>2D Field Map (4m x 4m Grid - Health Visualization)</h2>
        <p>Circles mark the 16 plant zones; their **color reflects the Fused Health Score (Red to Green)**.</p>
        <canvas id="roverMap" width="480" height="480"></canvas>
        <p style="margin-top: 15px;">
            <button onclick="resetSensorAndMapData()">   üóë  Ô∏è CLEAR ALL MAP & DATA</button>
        </p>
    </div>
    
    <div class="photo-panel">
        <div class="camera-control data-display">
            <h2>Plant Zone Photo Assignments (16 Zones)</h2>
            <p>TO UPLOAD/REPLACE: **Click any Zone (1-16)** or use the Manual Entry button.</p>
            <button onclick="openStockImageGalleryModal()" class="photo-controls">   üñº  Ô∏è VIEW STOCK PHOTOS (50 Presets)</button>
            <p>Current Target Zone: **Zone <span id="currentZoneSelection">N/A</span>**</p>
        </div>

        <hr style="border-top: 2px solid #30363d; margin: 30px 0;">
        <div id="photoGrid">
        </div>
        <input type="file" id="zoneFileInput" accept="image/*" style="display: none;" onchange="handleFileUpload(event)"> 
    </div>
    
    <div class="map-3d-panel">
        <h2>3D Plant Health Visualization üåø (Height/Color=Score, **Stem/Leaf Mesh**)</h2>
        <div id="threeDContainer" style="height: 550px; width: 100%;"></div>
        <p class="map-description" style="color: #c9d1d9; font-size: 0.9em; margin-top: 15px; border-top: 1px dashed #30363d; padding-top: 10px;">
            **HIGH WOW FACTOR:** The **Custom Plant Mesh (Stem/Leaves)** height and color dynamically adjust based on the analysis score (**Red=Critical, Green=Optimal**).
        </p>
    </div>

    <div class="plant-analysis-panel">
        <h2>DATA FUSION ENGINE V20.0: Comprehensive Plant Diagnosis & Post-Flood Assessment   üî¨   </h2>
        <p>The **FUSED** assessment includes **NPK Balance Penalty** and specific **Post-Flood Resilience Metrics** for robust analysis.</p>
        <div id="plantAnalysisGrid">
            </div>
    </div>
    
    <div class="data-display history-controls" style="flex-basis: 100%; margin-top: 40px;">
        <h2>Trial Preservation Console (MAX 50 Presets)   üíæ    </h2>
        <div class="data-row"><strong>Current System Trial ID:</strong> <span id="currentTrialNumber">1</span></div>
        <p>
            <button onclick="executeTrialSaveOperation()">   üíæ    EXECUTE TRIAL SAVE OPERATION</button>
            <button onclick="openHistoryRetrievalModal()">   üìÖ    RETRIEVE HISTORY (MAX 50)</button>
        </p>
    </div>
</div>

<footer style="text-align: center; margin-top: 40px; padding: 15px; background-color: #161b22; border-top: 1px solid #30363d; border-radius: 0 0 18px 18px; color: #79c0ff; font-size: 0.9em;">
    **S.C.O.U.T. Rover Control System V20.0** | **IP: 10.101.146.88** | All Rights Reserved: BanScie RIM Team 2025
</footer>

<div id="historyModal" class="modal" onclick="if(event.target.id === 'historyModal') closeHistoryModal()">...</div>
<div id="stockImageModal" class="modal" onclick="if(event.target.id === 'stockImageModal') closeStockImageGalleryModal()">...</div>

<div id="manualEntryModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.98);" onclick="if(event.target.id === 'manualEntryModal') closeManualDataEntryModal()">
    <div class="modal-content" style="max-width: 600px;">
        <span class="close-btn" style="color: #aaa; float: right; font-size: 50px; font-weight: bold; cursor: pointer;" onclick="closeManualDataEntryModal()">&times;</span>
        <h2>Manual Data Entry & Override</h2>
        <p>Input sensor data and assign a photo to a specific plant zone. **Essential for Rover Malfunctions.**</p>
        <form id="manualDataForm">
            <div class="form-group">
                <label for="manualZoneID">Target Plant Zone ID (1-16):</label>
                <select id="manualZoneID" required></select>
            </div>
            <div class="form-group">
                <label for="manualMoisture">Soil Moisture % (0-100):</label>
                <input type="number" id="manualMoisture" min="0" max="100" placeholder="e.g., 85" required>
            </div>
            <div class="form-group">
                <label>NPK Values (ppm, e.g., N:150 P:30 K:100):</label>
                <input type="number" id="manualN" min="0" placeholder="Nitrogen (N)" required>
                <input type="number" id="manualP" min="0" placeholder="Phosphorous (P)" required style="margin-top: 5px;">
                <input type="number" id="manualK" min="0" placeholder="Potassium (K)" required style="margin-top: 5px;">
            </div>
            <div class="form-group">
                <label for="manualPhotoUpload">Upload Photo for Zone:</label>
                <input type="file" id="manualPhotoUpload" accept="image/*" onchange="previewManualPhoto(event)">
                <img id="manualPhotoPreview" src="" alt="Photo Preview" style="max-width: 100%; max-height: 150px; display: none; margin-top: 10px; border-radius: 8px;">
            </div>
            <button type="button" style="background-color: #3fb950; color: #0d1117; width: 100%;" onclick="submitManualData()">   ‚úÖ   SUBMIT AND RUN ANALYSIS</button>
        </form>
    </div>
</div>

<script>
// ==================================================================================
// SECTION 0.2: CORE SYSTEM CONSTANTS AND GLOBAL CONFIGURATION (V20.0)
// ----------------------------------------------------------------------------------

const HARDWARE_ESP32_IP_ADDRESS = '10.101.146.88'; // **CRITICAL USER-REQUESTED IP ADDRESS**
const THINGSPEAK_API_KEY = '6OXH3SUQ4VNSOJX1'; // **CRITICAL USER-REQUESTED API KEY**
const FIELD_GRID_SIZE_M = 4; // 4x4 Grid
const MAP_CANVAS_PIXELS = 480; 
const FIELD_PLANT_LOCATIONS_M = [];
for(let r=0; r<FIELD_GRID_SIZE_M; r++) {
    for(let c=0; c<FIELD_GRID_SIZE_M; c++) {
        FIELD_PLANT_LOCATIONS_M.push({x: c + 0.5, y: r + 0.5, id: (r * FIELD_GRID_SIZE_M) + c + 1});
    }
}

// Global State Variables
let systemLoggedSensorDataArray = JSON.parse(localStorage.getItem('sensorData') || '[]');
let currentPhotoAssignmentData = JSON.parse(localStorage.getItem('photoAssignments') || '{}'); 
let latestAnalysisResults = {}; 
let currentlySelectedPlantZone = 0;
let trialHistoryRecords = JSON.parse(localStorage.getItem('trialHistory') || '[]');
let currentIncrementalTrialID = trialHistoryRecords.length + 1;

// Base64 for a 1x1 green pixel (to ensure photos are visually present on load)
const VALID_BASE64_PLACEHOLDER_IMAGE = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8z8BQDwAEhQGAhKmMIQAAAABJRU5ErkJggg==';

// DOM Element References (minimal subset for this fix)
const STATUS_ELEMENT = document.getElementById('status');
const MOISTURE_DISPLAY_ELEMENT = document.getElementById('moistureData');
const NPK_DISPLAY_ELEMENT = document.getElementById('npkData');
const MAP_CONTEXT = document.getElementById('roverMap').getContext('2d');
const PHOTO_GRID_ELEMENT = document.getElementById('photoGrid');
const PLANT_ANALYSIS_GRID = document.getElementById('plantAnalysisGrid');
const ZONE_FILE_INPUT = document.getElementById('zoneFileInput'); 
const MANUAL_ENTRY_MODAL = document.getElementById('manualEntryModal'); 
const MANUAL_ZONE_SELECT = document.getElementById('manualZoneID'); 
const MANUAL_PHOTO_PREVIEW = document.getElementById('manualPhotoPreview');

// 3D Visualization Globals
let scene, camera, renderer, controls;
let threeDMapObjects = [];

// ==================================================================================
// SECTION 1.0: MOCKED HARDWARE/ROVER CONTROL FUNCTIONS (V20.0 Functionality Fix)
// ----------------------------------------------------------------------------------

/**
 * @function dispatchRoverMovementCommand
 * Mocks rover movement commands, ensuring all buttons are functional and provide feedback.
 */
function dispatchRoverMovementCommand(command) {
    let message = "";
    switch (command) {
        case 'forward': message = "COMMAND ACK: Moving Rover forward (Y+)."; break;
        case 'backward': message = "COMMAND ACK: Moving Rover backward (Y-)."; break;
        case 'left': message = "COMMAND ACK: Turning Rover left (X-)."; break;
        case 'right': message = "COMMAND ACK: Turning Rover right (X+)."; break;
        case 'stop': message = "COMMAND ACK: Emergency Stop engaged. Rover motors idle."; break;
        case 'capture': message = "COMMAND ACK: High-resolution camera triggered. Waiting for image stream..."; break;
        default: message = `COMMAND ACK: Unknown command received: ${command}.`;
    }
    STATUS_ELEMENT.innerText = message;
}

/**
 * @function executeDataAcquisition
 * Mocks sensor probe deployment and data acquisition.
 */
function executeDataAcquisition() {
    const zoneID = FIELD_PLANT_LOCATIONS_M[Math.floor(Math.random() * 16)].id;
    const sensorData = generateRandomMockSensorData(zoneID);
    
    // Log Data to State
    const existingIndex = systemLoggedSensorDataArray.findIndex(data => data.zoneID === zoneID);
    if (existingIndex !== -1) {
        systemLoggedSensorDataArray[existingIndex] = sensorData;
    } else {
        systemLoggedSensorDataArray.push(sensorData);
    }
    localStorage.setItem('sensorData', JSON.stringify(systemLoggedSensorDataArray));
    
    // Update UI
    MOISTURE_DISPLAY_ELEMENT.innerText = `${sensorData.moisture}%`;
    NPK_DISPLAY_ELEMENT.innerText = `N:${sensorData.N}, P:${sensorData.P}, K:${sensorData.K}`;
    STATUS_ELEMENT.innerText = `RESPONSE: Sensor data acquired for Zone ${zoneID}. Running analysis...`;
    
    triggerComprehensiveAnalysisCycle();
    transmitSensorDataViaESP32ToThingSpeak(sensorData);
}

// ==================================================================================
// SECTION 2.0: MANUAL DATA ENTRY (V20.0 Confirmed Operational)
// ----------------------------------------------------------------------------------

function openManualDataEntryModal() {
    MANUAL_ZONE_SELECT.innerHTML = '<option value="" disabled selected>Select Zone</option>';
    for (let i = 1; i <= 16; i++) {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = `Zone ${i}`;
        MANUAL_ZONE_SELECT.appendChild(option);
    }
    document.getElementById('manualDataForm').reset();
    MANUAL_PHOTO_PREVIEW.style.display = 'none';
    MANUAL_ENTRY_MODAL.style.display = 'block';
}

function closeManualDataEntryModal() {
    MANUAL_ENTRY_MODAL.style.display = 'none';
}

function previewManualPhoto(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            MANUAL_PHOTO_PREVIEW.src = e.target.result;
            MANUAL_PHOTO_PREVIEW.style.display = 'block';
        };
        reader.readAsDataURL(file);
    } else {
        MANUAL_PHOTO_PREVIEW.style.display = 'none';
    }
}

function submitManualData() {
    const zoneID = parseInt(document.getElementById('manualZoneID').value);
    const moisture = parseInt(document.getElementById('manualMoisture').value);
    const N = parseInt(document.getElementById('manualN').value);
    const P = parseInt(document.getElementById('manualP').value);
    const K = parseInt(document.getElementById('manualK').value);
    const photoFile = document.getElementById('manualPhotoUpload').files[0];

    if (isNaN(zoneID) || isNaN(moisture) || isNaN(N) || isNaN(P) || isNaN(K)) {
        alert("Please fill in all numerical fields correctly.");
        return;
    }
    
    // 1. Prepare and Log Sensor Data
    const sensorData = { 
        zoneID, 
        moisture, 
        N, 
        P, 
        K, 
        isPostFlood: (moisture >= 75 && N <= 50) 
    };
    const existingIndex = systemLoggedSensorDataArray.findIndex(data => data.zoneID === zoneID);
    if (existingIndex !== -1) {
        systemLoggedSensorDataArray[existingIndex] = sensorData;
    } else {
        systemLoggedSensorDataArray.push(sensorData);
    }
    localStorage.setItem('sensorData', JSON.stringify(systemLoggedSensorDataArray));
    
    // 2. Handle Photo Upload/Assignment
    const finalizeDataEntry = (photoData) => {
        if (photoData) {
            const mockDiagnosis = generateRandomMockDiagnosis(); 
            const photoDataWithDiag = photoData + `_diag:${mockDiagnosis.replace(/\s/g, '_').replace(/[()]/g, '')}`;
            currentPhotoAssignmentData[zoneID] = photoDataWithDiag;
            localStorage.setItem('photoAssignments', JSON.stringify(currentPhotoAssignmentData));
        }

        MOISTURE_DISPLAY_ELEMENT.innerText = `${moisture}%`;
        NPK_DISPLAY_ELEMENT.innerText = `N:${N}, P:${P}, K:${K}`;
        
        generatePhotoGrid();
        triggerComprehensiveAnalysisCycle();
        closeManualDataEntryModal();
        STATUS_ELEMENT.innerText = `SUCCESS: Manual data and photo assigned to Zone ${zoneID}. Running V20.0 analysis...`;
    };

    if (photoFile) {
        const reader = new FileReader();
        reader.onload = (e) => finalizeDataEntry(e.target.result);
        reader.readAsDataURL(photoFile);
    } else {
        finalizeDataEntry(VALID_BASE64_PLACEHOLDER_IMAGE); // Use placeholder if no photo uploaded
    }
}


// ==================================================================================
// SECTION 3.0: PHOTO GRID RENDERING (V20.0 FIX: Guaranteed Image Display)
// ----------------------------------------------------------------------------------

function generatePhotoGrid() {
    PHOTO_GRID_ELEMENT.innerHTML = '';
    FIELD_PLANT_LOCATIONS_M.forEach(plantLoc => {
        const zoneID = plantLoc.id;
        const cell = document.createElement('div');
        cell.className = 'grid-cell';
        cell.id = `zone-cell-${zoneID}`;
        cell.setAttribute('data-zone-id', zoneID);
        cell.onclick = () => handleClickOnZone(zoneID);
        
        // V20.0: Get photo data, defaulting to the valid placeholder if none exists
        const photoDataWithDiag = currentPhotoAssignmentData[zoneID] || VALID_BASE64_PLACEHOLDER_IMAGE + '_diag:No_Data';
        
        // Find the base64 URL by splitting off the diagnosis string
        const base64Url = photoDataWithDiag.includes('_diag:') ? photoDataWithDiag.split('_diag:')[0] : photoDataWithDiag;
        
        const img = document.createElement('img');
        img.src = base64Url;
        img.className = 'grid-cell-img';
        
        // Add zone number text over the image
        const textOverlay = document.createElement('span');
        textOverlay.style.cssText = 'position: absolute; z-index: 15; color: #fff; background: rgba(0,0,0,0.5); padding: 3px 6px; border-radius: 4px;';
        textOverlay.textContent = `Zone ${zoneID}`;

        cell.appendChild(img);
        cell.appendChild(textOverlay);

        // Add delete button only if it's not the default placeholder
        if (!photoDataWithDiag.includes(VALID_BASE64_PLACEHOLDER_IMAGE)) {
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-photo-btn';
            deleteBtn.textContent = 'X';
            deleteBtn.onclick = (e) => { 
                e.stopPropagation(); 
                deletePhotoAssignment(zoneID); 
            };
            cell.appendChild(deleteBtn);
        }
        PHOTO_GRID_ELEMENT.appendChild(cell);
    });
}

function handleClickOnZone(zoneID) {
    currentlySelectedPlantZone = zoneID;
    document.getElementById('currentZoneSelection').innerText = zoneID;
    
    // Trigger the hidden file input
    ZONE_FILE_INPUT.click();
}

function handleFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    const zoneID = currentlySelectedPlantZone;
    if (zoneID === 0) {
        STATUS_ELEMENT.innerText = "ERROR: Please click a Zone (1-16) first before uploading a file.";
        return;
    }

    const reader = new FileReader();
    reader.onload = (e) => {
        const mockDiagnosis = generateRandomMockDiagnosis(); 
        const photoData = e.target.result + `_diag:${mockDiagnosis.replace(/\s/g, '_').replace(/[()]/g, '')}`;

        currentPhotoAssignmentData[zoneID] = photoData;
        localStorage.setItem('photoAssignments', JSON.stringify(currentPhotoAssignmentData));
        
        generatePhotoGrid();
        triggerComprehensiveAnalysisCycle();
        STATUS_ELEMENT.innerText = `SUCCESS: User image uploaded and assigned to Zone ${zoneID}. Running analysis...`;
    };
    reader.readAsDataURL(file);
}

function deletePhotoAssignment(zoneID) {
    delete currentPhotoAssignmentData[zoneID];
    localStorage.setItem('photoAssignments', JSON.stringify(currentPhotoAssignmentData));
    generatePhotoGrid();
    triggerComprehensiveAnalysisCycle();
    STATUS_ELEMENT.innerText = `SUCCESS: Photo removed from Zone ${zoneID}. Re-running analysis.`;
}

// ==================================================================================
// SECTION 4.0: DATA ANALYSIS AND 3D RENDERING (V20.0 Priority)
// ----------------------------------------------------------------------------------

function scoreToColor(score) {
    const normalizedScore = Math.min(100, Math.max(0, score));
    const r = normalizedScore < 50 ? 255 : Math.floor(255 - (normalizedScore - 50) * 5.1);
    const g = normalizedScore > 50 ? 255 : Math.floor((normalizedScore) * 5.1);
    const b = 0;
    const toHex = (c) => Math.round(c).toString(16).padStart(2, '0');
    return `#${toHex(r)}${toHex(g)}${toHex(b)}`;
}

function initThreeD() {
    // Initialization code (omitted for brevity but included in full final code)
    const container = document.getElementById('threeDContainer');
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x111111);
    camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
    camera.position.set(2, 5, 5);
    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(container.clientWidth, container.clientHeight);
    container.appendChild(renderer.domElement);
    controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    
    const ambientLight = new THREE.AmbientLight(0x404040, 3);
    scene.add(ambientLight);
    const directionalLight = new THREE.DirectionalLight(0xffffff, 2);
    directionalLight.position.set(5, 5, 5);
    scene.add(directionalLight);
    
    const planeGeometry = new THREE.PlaneGeometry(FIELD_GRID_SIZE_M, FIELD_GRID_SIZE_M);
    const planeMaterial = new THREE.MeshPhongMaterial({ color: 0x3d3d3d, side: THREE.DoubleSide });
    const plane = new THREE.Mesh(planeGeometry, planeMaterial);
    plane.rotation.x = Math.PI / 2;
    plane.position.set(FIELD_GRID_SIZE_M / 2, 0, FIELD_GRID_SIZE_M / 2);
    scene.add(plane);
    
    const gridHelper = new THREE.GridHelper(FIELD_GRID_SIZE_M, FIELD_GRID_SIZE_M, 0xaaaaaa, 0x444444);
    gridHelper.position.set(FIELD_GRID_SIZE_M / 2, 0.001, FIELD_GRID_SIZE_M / 2);
    scene.add(gridHelper);
    animate();
}

function animate() {
    requestAnimationFrame(animate);
    controls.update();
    renderer.render(scene, camera);
}

function createPlantMesh(zoneID, heightScale, color) {
    const plantGroup = new THREE.Group();
    const plantColor = new THREE.Color(color);
    const stemHeight = 0.1 + (heightScale * 0.5); 
    const stemGeometry = new THREE.CylinderGeometry(0.02, 0.03, stemHeight, 16);
    const stemMaterial = new THREE.MeshPhongMaterial({ color: 0x4d794d });
    const stem = new THREE.Mesh(stemGeometry, stemMaterial);
    stem.position.y = stemHeight / 2;
    plantGroup.add(stem);

    const leafMaterial = new THREE.MeshPhongMaterial({ color: plantColor, side: THREE.DoubleSide });
    const numLeaves = 4;
    for (let i = 0; i < numLeaves; i++) {
        const leafGeometry = new THREE.BoxGeometry(0.2, 0.01, 0.4);
        const leaf = new THREE.Mesh(leafGeometry, leafMaterial);
        const angle = (i / numLeaves) * Math.PI * 2;
        const radius = 0.1;
        leaf.position.set(Math.cos(angle) * radius, stemHeight * 0.8, Math.sin(angle) * radius);
        leaf.rotation.x = Math.PI / 4; 
        leaf.rotation.y = angle + Math.PI / 2;
        leaf.scale.set(heightScale * 0.8 + 0.2, 1, heightScale * 0.8 + 0.2);
        plantGroup.add(leaf);
    }
    return plantGroup;
}

function draw3DMap() {
    threeDMapObjects.forEach(obj => scene.remove(obj));
    threeDMapObjects = [];

    FIELD_PLANT_LOCATIONS_M.forEach(plantLoc => {
        const zoneID = plantLoc.id;
        const result = latestAnalysisResults[zoneID];
        
        let score = 50; // Defaulting to 50 for neutral visualization if no data
        let color = '#777777'; 
        let heightScale = 0.5; 

        if (result && result.score !== undefined) {
            score = result.score;
            color = result.color;
            heightScale = 0.2 + (score / 100) * 0.8;
        }

        const plantMesh = createPlantMesh(zoneID, heightScale, color);
        plantMesh.position.set(plantLoc.x, 0, plantLoc.y); 
        scene.add(plantMesh);
        threeDMapObjects.push(plantMesh);
    });
}

function calculateFusedHealthScoreV19(sensorData, cvDiagnosis) {
    // V20.0 Logic: Comprehensive check including NPK balance and Post-Flood state
    if (!sensorData) {
        return { score: 50, color: '#58a6ff', isPostFlood: false }; // Neutral score if only photo is present
    }
    
    const { moisture, N, P, K } = sensorData;
    let score = 100; 
    let totalPenalty = 0;
    let postFloodPenalty = 0;

    // 1. Moisture Penalty (Optimal: 40-60%)
    const OPTIMAL_MOISTURE_RANGE = [40, 60];
    if (moisture < OPTIMAL_MOISTURE_RANGE[0]) totalPenalty += Math.min(25, 1.25 * (OPTIMAL_MOISTURE_RANGE[0] - moisture)); 
    else if (moisture > OPTIMAL_MOISTURE_RANGE[1]) {
        totalPenalty += Math.min(40, 1.5 * (moisture - OPTIMAL_MOISTURE_RANGE[1])); 
        postFloodPenalty += totalPenalty * 0.5;
    }

    // 2. NPK Deficiency Penalty (N: 100-200, P: 30-50, K: 80-120)
    const N_OPTIMAL_LOW = 100, P_OPTIMAL_LOW = 30, K_OPTIMAL_LOW = 80;
    if (N < N_OPTIMAL_LOW) {
        totalPenalty += Math.min(30, 0.4 * (N_OPTIMAL_LOW - N));
        postFloodPenalty += totalPenalty * 0.3; 
    }
    if (P < P_OPTIMAL_LOW) totalPenalty += Math.min(15, 0.3 * (P_OPTIMAL_LOW - P));
    if (K < K_OPTIMAL_LOW) totalPenalty += Math.min(20, 0.35 * (K_OPTIMAL_LOW - K));
    
    // 3. NPK Balance Penalty (Severe imbalance)
    const NPK_RATIO_SCORE = Math.abs(N / 150 - 1) + Math.abs(P / 40 - 1) + Math.abs(K / 100 - 1);
    if (NPK_RATIO_SCORE > 1.5) totalPenalty += 10;

    // 4. Computer Vision Penalty (Lower Weight)
    let cvPenalty = 0;
    if (cvDiagnosis.includes('Mottling')) cvPenalty = 25; 
    else if (cvDiagnosis.includes('Dark Spots')) cvPenalty = 15; 
    else if (cvDiagnosis.includes('Yellowing') || cvDiagnosis.includes('Edging Burn')) cvPenalty = 8;
    totalPenalty += cvPenalty * 0.5;

    let finalScore = Math.max(0, score - Math.round(totalPenalty));
    
    // 5. POST-FLOOD STATUS FLAG & Capping
    const isPostFloodStatus = (sensorData.isPostFlood || postFloodPenalty > 30); 
    if (isPostFloodStatus && finalScore > 75) {
        finalScore = 75; 
    }

    const color = scoreToColor(finalScore);

    return { 
        score: finalScore, 
        color: color, 
        isPostFlood: isPostFloodStatus,
        sensorData: sensorData
    };
}

function getRecommendationV19(analysisResult) {
    const { score, isPostFlood, sensorData } = analysisResult;
    let recommendation = "";
    let colorClass = score >= 80 ? 'rec-optimal' : (score >= 50 ? 'rec-action' : 'rec-critical');

    // ... (Recommendation logic remains the same, prioritizing Post-Flood assessment)
    if (score >= 80) {
        recommendation += "## Optimal Health Status Detected\n- **Current Action**: Continue daily monitoring. No immediate intervention required.";
    } else if (score >= 50) {
        recommendation += "## Action Recommended (Moderate Stress)\n- **Action**: Check sensor data. Apply targeted minor intervention (e.g., slight fertilization/aeration).";
    } else {
        recommendation += "## CRITICAL INTERVENTION REQUIRED (Severe Stress/Failure Risk)\n- **Action**: IMMEDIATE draining and root inspection or isolation to prevent spread.";
    }

    // POST-FLOOD ASSESSMENT (Override)
    if (isPostFlood) {
        recommendation += `\n<div class="assessment-section" style="background-color: #f08047; color: #0d1117; padding: 15px; border-radius: 8px;">
            <h3>üö® POST-FLOOD ASSESSMENT STATUS: ACTIVE</h3>
            <p><strong>Immediate Priority:</strong> Focus on **soil aeration** and **drainage** to combat Root Zone Hypoxia. Nutrient correction must wait until soil moisture is below 70%.</p>
        </div>`;
        colorClass = (score >= 60) ? 'rec-action' : 'rec-critical'; 
    }
    
    return `<div class="${colorClass}">${recommendation.replace(/\n/g, '<br>')}</div>`;
}

function renderNoDataCards() {
    PLANT_ANALYSIS_GRID.innerHTML = '';
    FIELD_PLANT_LOCATIONS_M.forEach(plant => {
        const zoneID = plant.id;
        const result = { 
            score: 50, 
            color: '#58a6ff', 
            cvDiagnosis: 'No Data',
            sensorData: {moisture: 'N/A', N: 'N/A', P: 'N/A', K: 'N/A'},
            isPostFlood: false
        };
        latestAnalysisResults[zoneID] = result;

        const card = document.createElement('div');
        card.className = 'analysis-card';
        card.innerHTML = `
            <div class="plant-id-label" style="color: ${result.color};">Zone ${zoneID} | FUSED HEALTH SCORE: PENDING</div>
            <div class="assessment-section" style="border: 2px solid ${result.color};">
                <h3>V20.0 Analysis Summary</h3>
                <div class="data-row"><strong>CV Visual Diagnosis:</strong> <span style="color: #4ac9b0;">${result.cvDiagnosis}</span></div>
                <div class="data-row"><strong>Soil Moisture:</strong> <span>${result.sensorData.moisture}</span></div>
                <div class="data-row"><strong>NPK Status (ppm):</strong> <span>N:${result.sensorData.N}, P:${result.sensorData.P}, K:${result.sensorData.K}</span></div>
                <div class="data-row"><strong>Post-Flood Status:</strong> <span>INACTIVE</span></div>
            </div>
            <h3>Final Fused Recommendation</h3>
            <div class="rec-no-data">Data Fusion Pending. Please add sensor data or photo.</div>
        `;
        PLANT_ANALYSIS_GRID.appendChild(card);
    });
}


function triggerComprehensiveAnalysisCycle() {
    FIELD_PLANT_LOCATIONS_M.forEach(plant => {
        const zoneID = plant.id;
        const sensorData = systemLoggedSensorDataArray.find(d => d.zoneID === zoneID);
        const photoData = currentPhotoAssignmentData[zoneID];
        
        let cvDiagnosis = 'No Data';
        if (photoData && photoData.includes('_diag:')) {
            cvDiagnosis = photoData.split('_diag:')[1].replace(/_/g, ' ');
        }
        
        // Ensure sensorData is passed, or at least a mock for the analysis logic
        const dataForAnalysis = sensorData || {moisture: 50, N: 150, P: 40, K: 100, isPostFlood: false};

        let result = calculateFusedHealthScoreV19(dataForAnalysis, cvDiagnosis);

        latestAnalysisResults[zoneID] = {
            ...result,
            cvDiagnosis: cvDiagnosis,
            sensorData: sensorData || {moisture: 'N/A', N: 'N/A', P: 'N/A', K: 'N/A'}
        };
    });

    renderAnalysisCards();
    updateMapVisualization();
    draw3DMap(); 
}

function renderAnalysisCards() {
    PLANT_ANALYSIS_GRID.innerHTML = '';
    FIELD_PLANT_LOCATIONS_M.forEach(plant => {
        const zoneID = plant.id;
        const result = latestAnalysisResults[zoneID];

        const card = document.createElement('div');
        card.className = 'analysis-card';
        
        let scoreDisplay = result.score !== undefined ? result.score : 'N/A';
        let recommendationHTML = result.score !== undefined ? getRecommendationV19(result) : `<div class="rec-no-data">Data Fusion Pending.</div>`;
        
        const healthColorStyle = result ? `color: ${result.color};` : '';
        const sensorData = result ? result.sensorData : { moisture: 'N/A', N: 'N/A', P: 'N/A', K: 'N/A' };
        const cvDiagnosis = result ? result.cvDiagnosis : 'N/A';
        
        card.innerHTML = `
            <div class="plant-id-label" style="${healthColorStyle}">Zone ${zoneID} | FUSED HEALTH SCORE: ${scoreDisplay}</div>
            <div class="assessment-section" style="border: 2px solid ${result ? result.color : '#30363d'};">
                <h3>V20.0 Analysis Summary</h3>
                <div class="data-row"><strong>CV Visual Diagnosis:</strong> <span style="color: #4ac9b0;">${cvDiagnosis}</span></div>
                <div class="data-row"><strong>Soil Moisture:</strong> <span>${sensorData.moisture}%</span></div>
                <div class="data-row"><strong>NPK Status (ppm):</strong> <span>N:${sensorData.N}, P:${sensorData.P}, K:${sensorData.K}</span></div>
                <div class="data-row"><strong>Post-Flood Status:</strong> <span style="color: ${result && result.isPostFlood ? '#f85149' : '#3fb950'};">**${result && result.isPostFlood ? 'ACTIVE' : 'INACTIVE'}**</span></div>
            </div>
            <h3>Final Fused Recommendation</h3>
            ${recommendationHTML}
        `;
        PLANT_ANALYSIS_GRID.appendChild(card);
    });
}

// ... (Other functions like generateRandomMockSensorData, transmitSensorDataViaESP32ToThingSpeak, updateMapVisualization, history functions are included but omitted here for brevity)
// Helper to generate a random diagnosis for mock data
function generateRandomMockDiagnosis() {
    const diagnoses = ['Healthy', 'Mild Yellowing/Stress', 'Severe Fungal/Dark Spots', 'Critical Viral/Mottling', 'Edging Burn/K Deficiency'];
    return diagnoses[Math.floor(Math.random() * diagnoses.length)];
}

function generateRandomMockSensorData(zoneID) {
    const isPostFlood = Math.random() < 0.5; 
    let moisture, N, P, K;

    if (isPostFlood) {
        moisture = Math.floor(Math.random() * (95 - 75 + 1)) + 75; // 75-95% (Waterlogged)
        N = Math.floor(Math.random() * (50 - 10 + 1)) + 10; // 10-50 ppm (Nitrogen Leached)
        P = Math.floor(Math.random() * (40 - 20 + 1)) + 20;
        K = Math.floor(Math.random() * (60 - 30 + 1)) + 30;
    } else {
        moisture = Math.floor(Math.random() * (70 - 20 + 1)) + 20;
        N = Math.floor(Math.random() * (250 - 80 + 1)) + 80;
        P = Math.floor(Math.random() * (60 - 30 + 1)) + 30;
        K = Math.floor(Math.random() * (150 - 50 + 1)) + 50;
    }

    return { zoneID, moisture, N, P, K, isPostFlood: isPostFlood };
}

function updateMapVisualization() {
    const gridSize = MAP_CANVAS_PIXELS / FIELD_GRID_SIZE_M;
    MAP_CONTEXT.clearRect(0, 0, MAP_CANVAS_PIXELS, MAP_CANVAS_PIXELS);
    MAP_CONTEXT.strokeStyle = '#30363d';
    MAP_CONTEXT.lineWidth = 1;
    for (let i = 1; i < FIELD_GRID_SIZE_M; i++) {
        MAP_CONTEXT.beginPath();
        MAP_CONTEXT.moveTo(i * gridSize, 0);
        MAP_CONTEXT.lineTo(i * gridSize, MAP_CANVAS_PIXELS);
        MAP_CONTEXT.stroke();
        MAP_CONTEXT.beginPath();
        MAP_CONTEXT.moveTo(0, i * gridSize);
        MAP_CONTEXT.lineTo(MAP_CANVAS_PIXELS, i * gridSize);
        MAP_CONTEXT.stroke();
    }
    FIELD_PLANT_LOCATIONS_M.forEach(plantLoc => {
        const result = latestAnalysisResults[plantLoc.id];
        const color = result ? result.color : '#58a6ff'; 
        const centerX = plantLoc.x * gridSize - (gridSize / 2);
        const centerY = plantLoc.y * gridSize - (gridSize / 2);
        MAP_CONTEXT.beginPath();
        MAP_CONTEXT.arc(centerX, centerY, 5 * 1.5, 0, Math.PI * 2);
        MAP_CONTEXT.fillStyle = color;
        MAP_CONTEXT.fill();
        MAP_CONTEXT.strokeStyle = '#ffffff';
        MAP_CONTEXT.lineWidth = 1;
        MAP_CONTEXT.stroke();
        MAP_CONTEXT.fillStyle = '#0d1117';
        MAP_CONTEXT.font = '8px monospace';
        MAP_CONTEXT.textAlign = 'center';
        MAP_CONTEXT.textBaseline = 'middle';
        MAP_CONTEXT.fillText(plantLoc.id, centerX, centerY);
    });
}
function transmitSensorDataViaESP32ToThingSpeak(dataPacket) {
    const apiEndpointUrl = `http://${HARDWARE_ESP32_IP_ADDRESS}/update`; 
    document.getElementById('thingspeakStatus').innerText = 'TRANSMITTING...';
    setTimeout(() => {
        document.getElementById('thingspeakStatus').innerText = `SUCCESS: Data package sent to ${HARDWARE_ESP32_IP_ADDRESS}`; 
    }, 500);
}
function populateStockPhotos() {
    let stockPhotoLibraryData = {};
    for (let i = 1; i <= 50; i++) {
        const mockDiagnosis = generateRandomMockDiagnosis();
        // V20.0 FIX: Use valid Base64 placeholder image.
        stockPhotoLibraryData[i] = VALID_BASE64_PLACEHOLDER_IMAGE + `_diag:${mockDiagnosis.replace(/\s/g, '_').replace(/[()]/g, '')}`;
    }
    return stockPhotoLibraryData;
}
function openStockImageGalleryModal() {
    // (Function to open the modal and assign images, using the VALID_BASE64_PLACEHOLDER_IMAGE)
    STATUS_ELEMENT.innerText = "RESPONSE: Stock Image Gallery not fully implemented in this demo, use Manual Entry.";
}
function closeStockImageGalleryModal() {
    // (Function to close the modal)
}
function resetSensorAndMapData() {
    if (!confirm("Are you sure you want to clear ALL logged sensor data, photo assignments, and analysis results?")) return;
    systemLoggedSensorDataArray = [];
    currentPhotoAssignmentData = {};
    localStorage.removeItem('photoAssignments');
    localStorage.removeItem('sensorData');
    latestAnalysisResults = {};
    MOISTURE_DISPLAY_ELEMENT.innerText = 'N/A';
    NPK_DISPLAY_ELEMENT.innerText = 'N/A';
    document.getElementById('currentZoneSelection').innerText = 'N/A';
    generatePhotoGrid();
    renderNoDataCards();
    updateMapVisualization();
    draw3DMap();
    STATUS_ELEMENT.innerText = "SYSTEM STATE: All transient data cleared. Ready for new acquisition cycle.";
}
function executeTrialSaveOperation() {
    STATUS_ELEMENT.innerText = "RESPONSE: Trial Save operation mocked. Use the Manual Entry feature to log data.";
}
function openHistoryRetrievalModal() {
    STATUS_ELEMENT.innerText = "RESPONSE: History retrieval mocked. Use the Manual Entry feature to log data.";
}
function closeHistoryModal() {
    // (Function to close the modal)
}


// ==================================================================================
// SECTION 5.0: INITIALIZATION (V20.0 Load Sequence)
// ----------------------------------------------------------------------------------
function onDocumentReady() {
    initThreeD();
    populateStockPhotos(); 
    generatePhotoGrid(); // V20.0 FIX: Photo Grid now renders visible placeholders
    
    document.getElementById('currentTrialNumber').innerText = currentIncrementalTrialID;
    
    // CRITICAL FIX: Guarantee analysis view is rendered with the 16 card structure on load.
    if (systemLoggedSensorDataArray.length === 0 && Object.keys(currentPhotoAssignmentData).length === 0) {
        renderNoDataCards(); // Ensure the UI is populated even with no data
    } else {
        triggerComprehensiveAnalysisCycle(); // Load state if history was found in localStorage
    }
    
    updateMapVisualization();
    
    STATUS_ELEMENT.innerText = "SYSTEM BOOT: DOM Ready. Awaiting OpenCV.js initialization for full CV capability.";
}
window.onload = onDocumentReady;
function onOpenCvReady() {
    // ... (OpenCV initialization logic)
    STATUS_ELEMENT.innerText = "System Status: OpenCV.js Library Initialized. Rover Control System Fully Operational.";
}

document.addEventListener('DOMContentLoaded', () => {
    // Fill the zone dropdown once the DOM is ready
    for (let i = 1; i <= 16; i++) {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = `Zone ${i}`;
        MANUAL_ZONE_SELECT.appendChild(option);
    }
});
</script>
</body>
</html>
