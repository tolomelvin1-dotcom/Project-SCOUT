<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PROJECT SCOUT — Full Post-Flood Tomato Assessment (Corrected)</title>

<!-- Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://unpkg.com/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.18.0/dist/tf.min.js"></script>

<style>
:root{--bg:#071018;--card:#0d1418;--muted:#c9d1d9;--accent:#58a6ff;--good:#3fb950;--warn:#e3b341;--bad:#f85149;}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--muted);font-family:Arial}
.container{max-width:1300px;margin:18px auto;padding:18px}
.header{display:flex;justify-content:space-between;align-items:center;padding-bottom:8px;border-bottom:1px solid #123}
.title{font-size:1.4rem;font-weight:800;color:var(--accent)}
#status{font-weight:700;color:#79c0ff}
.panel{background:var(--card);margin-top:12px;padding:12px;border-radius:8px}
#threeDContainer{height:420px;border-radius:8px}
.photo-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:6px}
.grid-cell{position:relative;aspect-ratio:1/1;background:#071014;border:1px dashed #333;border-radius:6px;overflow:hidden;display:flex;align-items:center;justify-content:center}
.grid-cell img{width:100%;height:100%;object-fit:cover}
.delete-button{position:absolute;top:4px;right:4px;background:#f85149;color:#fff;border:none;padding:4px 6px;font-size:0.7rem;cursor:pointer}
.zone-label{position:absolute;bottom:4px;left:4px;background:rgba(0,0,0,0.5);padding:2px 4px;font-size:0.75rem;border-radius:4px}
.log{background:#0002;padding:6px;height:120px;overflow:auto;font-size:0.85rem}
.footer{margin-top:20px;text-align:center;color:#79c0ff;padding:12px;border-top:1px solid #123}
.analysis-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.analysis-card{background:#0b1319;padding:8px;border-radius:6px;min-height:140px;cursor:pointer}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="title">PROJECT SCOUT — Post-Flood Tomato Assessment</div>
    <div>Status: <span id="status">Initializing...</span></div>
  </div>

  <!-- Rover Controls -->
  <div class="panel">
    <h3>Rover & Sensor Controls</h3>
    <button onclick="sendCommandToESP32('forward')">Forward</button>
    <button onclick="sendCommandToESP32('backward')">Backward</button>
    <button onclick="sendCommandToESP32('left')">Left</button>
    <button onclick="sendCommandToESP32('right')">Right</button>
    <button onclick="sendCommandToESP32('stop')">Stop</button>
    <button onclick="sendCommandToESP32('probe')">Probe Arm</button>
    <button onclick="sendCommandToESP32('read_sensors')">Read Sensors</button>
  </div>

  <!-- Photo Grid -->
  <div class="panel">
    <h3>Photo Grid (Upload by Zone)</h3>
    <div id="photoGrid" class="photo-grid"></div>
  </div>
  <!-- Stock Gallery -->
  <div class="panel">
    <h3>Stock Gallery</h3>
    <input type="file" accept="image/*" multiple onchange="handleStockUpload(event)" />
    <div id="stockGrid" style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-top:6px"></div>
  </div>

  <!-- Manual Entry -->
  <div class="panel">
    <h3>Manual Data Entry</h3>
    <label>Zone: <input id="manual_zone" type="number" min="1" max="16" value="1"></label><br>
    <label>Moisture: <input id="manual_moisture" type="number"></label><br>
    <label>N: <input id="manual_n" type="number"></label><br>
    <label>P: <input id="manual_p" type="number"></label><br>
    <label>K: <input id="manual_k" type="number"></label><br>
    <label>Photo: <input id="manual_photo" type="file" accept="image/*"></label><br>
    <button onclick="submitManualEntry()">Submit</button>
  </div>

  <!-- Visualization -->
  <div class="panel">
    <h3>2D & 3D Field Visualization</h3>
    <canvas id="mapCanvas" width="640" height="640" style="border:1px solid #333"></canvas>
    <div id="threeDContainer"></div>
  </div>

  <!-- Analysis -->
  <div class="panel">
    <h3>Analysis Results</h3>
    <div id="analysisGrid" class="analysis-grid"></div>
    <h3>Detailed AI Analysis</h3>
    <div id="aiAnalysis" style="white-space:pre-wrap;font-size:0.9rem;background:#071018;padding:6px;border-radius:6px;max-height:200px;overflow:auto"></div>
  </div>

  <!-- Logs -->
  <div class="panel">
    <h3>Log</h3>
    <div id="log" class="log"></div>
  </div>

  <!-- Footer -->
  <div class="footer">BanScie RIM Team • ESP32: 10.101.146.88 • ThingSpeak Key: 6OXH3SUQ4VNSOJX1</div>
</div>
<script>
const ESP32_IP="10.101.146.88";
const THINGSPEAK_KEY="6OXH3SUQ4VNSOJX1";

// === Logging ===
function log(msg){
  const d=document.createElement('div');
  d.innerText=`[${new Date().toLocaleTimeString()}] ${msg}`;
  document.getElementById('log').prepend(d);
  console.log(msg);
}

// === Globals ===
const ZONES=16;
let photos={}, stock={}, sensorLogs=[], latestAnalysis={}, plants=[];

// === Helper ===
function readFileAsDataURL(file){
  return new Promise((res,rej)=>{
    const r=new FileReader();
    r.onload=()=>res(r.result);
    r.onerror=rej;
    r.readAsDataURL(file);
  });
}

// === Photo Grid ===
function generatePhotoGrid(){
  const grid=document.getElementById('photoGrid');
  grid.innerHTML='';
  for(let z=1;z<=ZONES;z++){
    const cell=document.createElement('div');
    cell.className='grid-cell';cell.dataset.zone=z;
    const label=document.createElement('div');
    label.className='zone-label';
    label.innerText='Zone '+z;
    cell.appendChild(label);

    const input=document.createElement('input');
    input.type='file';input.accept='image/*';
    input.style.position='absolute';input.style.opacity='0';
    input.style.width='100%';input.style.height='100%';
    input.onchange=async e=>{
      const f=e.target.files[0];if(!f)return;
      const b64=await readFileAsDataURL(f);
      photos[z]=b64;
      log('Photo uploaded zone '+z);
      generatePhotoGrid();
      triggerAnalysis();
    };
    cell.appendChild(input);

    if(photos[z]){
      const img=document.createElement('img');
      img.src=photos[z];
      cell.appendChild(img);
      const btn=document.createElement('button');
      btn.className='delete-button';
      btn.innerText='X';
      btn.onclick=(ev)=>{
        ev.stopPropagation();
        delete photos[z];
        generatePhotoGrid();
      };
      cell.appendChild(btn);
    }
    grid.appendChild(cell);
  }
}
// === Stock Gallery ===
function handleStockUpload(e){
  for(const f of e.target.files){
    readFileAsDataURL(f).then(b64=>{
      const id=Object.keys(stock).length+1;
      stock[id]={id,url:b64,name:f.name};
      renderStockGrid();
    });
  }
}
function renderStockGrid(){
  const g=document.getElementById('stockGrid');
  g.innerHTML='';
  for(const id in stock){
    const it=stock[id];
    const img=document.createElement('img');
    img.src=it.url;
    img.style.width='100%';
    img.title=it.name;
    g.appendChild(img);
  }
}

// === Manual Entry ===
function submitManualEntry(){
  const z=Number(document.getElementById('manual_zone').value)||1;
  const m=Number(document.getElementById('manual_moisture').value);
  const N=Number(document.getElementById('manual_n').value);
  const P=Number(document.getElementById('manual_p').value);
  const K=Number(document.getElementById('manual_k').value);

  sensorLogs.push({zone:z,moisture:m,npk_n:N,npk_p:P,npk_k:K,ts:Date.now()});

  const f=document.getElementById('manual_photo').files[0];
  if(f){
    readFileAsDataURL(f).then(b64=>{
      photos[z]=b64;
      generatePhotoGrid();
      triggerAnalysis();
    });
  } else {
    triggerAnalysis();
  }
  log('Manual entry zone '+z);
}

// === Map (2D) ===
const map=document.getElementById('mapCanvas');
const ctx=map.getContext('2d');
function updateMap(){
  ctx.clearRect(0,0,map.width,map.height);
  const scale=map.width/4;
  for(let z=1;z<=ZONES;z++){
    const a=latestAnalysis[z]||{health:100};
    const row=Math.floor((z-1)/4),col=(z-1)%4;
    const x=col*scale+scale/2,y=row*scale+scale/2;
    ctx.beginPath();ctx.arc(x,y,20,0,Math.PI*2);
    ctx.fillStyle=hexFromHealth(a.health);
    ctx.fill();
  }
}

// === 3D Setup ===
let scene,camera,renderer,controls;
function init3D(){
  const c=document.getElementById('threeDContainer');
  scene=new THREE.Scene();
  scene.background=new THREE.Color(0x071018);

  camera=new THREE.PerspectiveCamera(60,c.clientWidth/c.clientHeight,0.1,1000);
  camera.position.set(3,5,6);

  renderer=new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(c.clientWidth,c.clientHeight);
  c.appendChild(renderer.domElement);

  controls=new THREE.OrbitControls(camera,renderer.domElement);
  scene.add(new THREE.AmbientLight(0xffffff,0.7));
  const light=new THREE.DirectionalLight(0xffffff,0.5);
  light.position.set(5,10,7);
  scene.add(light);

  plants=[];
  const grid=4,spacing=2.5;
  for(let z=1;z<=ZONES;z++){
    const group=new THREE.Group();
    const stem=new THREE.Mesh(
      new THREE.CylinderGeometry(0.05,0.05,1.5,8),
      new THREE.MeshStandardMaterial({color:0x3fb950})
    );
    group.add(stem);

    for(let i=0;i<5;i++){
      const leaf=new THREE.Mesh(
        new THREE.BoxGeometry(0.6,0.1,0.2),
        new THREE.MeshStandardMaterial({color:0x3fb950})
      );
      leaf.position.set(Math.random()*0.6-0.3,Math.random()*1.2,Math.random()*0.6-0.3);
      group.add(leaf);
    }

    const row=Math.floor((z-1)/grid),col=(z-1)%grid;
    group.position.set((col-grid/2)*spacing,0,(row-grid/2)*spacing);
    scene.add(group);
    plants.push({id:z,group});
  }

  function animate(){
    requestAnimationFrame(animate);
    controls.update();
    renderer.render(scene,camera);
  }
  animate();
}
// === TF.js Placeholder ===
let tfModel=null,tfReady=false;
async function loadTFModel(){
  try{
    log("Loading TF.js model...");
    tfModel=await tf.loadLayersModel("/models/tomato-leaf/model.json");
    tfReady=true;
    log("TF.js model loaded.");
  }catch(e){
    log("TF model not found — using color-only analysis.");
  }
}

// === Photo Analysis (color-based, fallback if no TF.js model) ===
async function analyzePhoto(zone){
  const data=photos[zone];
  if(!data) return null;

  return new Promise(res=>{
    const img=new Image();
    img.onload=async()=>{
      const c=document.createElement('canvas');
      c.width=200;c.height=200;
      const cx=c.getContext('2d');
      cx.drawImage(img,0,0,200,200);
      const d=cx.getImageData(0,0,200,200).data;

      let g=0,y=0,b=0,t=0;
      for(let i=0;i<d.length;i+=16){
        const r=d[i],gr=d[i+1],bl=d[i+2];
        t++;
        if(gr>r&&gr>bl&&gr>80) g++;
        else if(r>150&&gr>120&&bl<100) y++;
        else if(r>100&&gr<90&&bl<80) b++;
      }
      const gp=Math.round(g/t*100);
      const yp=Math.round(y/t*100);
      const bp=Math.round(b/t*100);
      let visScore=gp-(yp*0.5)-(bp*0.8);
      visScore=Math.max(0,Math.min(100,visScore));

      let pred={label:'color-only',score:visScore};
      if(tfReady&&tfModel){
        try{
          const tensor=tf.browser.fromPixels(img)
            .resizeBilinear([224,224])
            .toFloat()
            .expandDims(0)
            .div(255);
          const preds=tfModel.predict(tensor);
          const arr=await preds.data();
          const maxIdx=arr.indexOf(Math.max(...arr));
          pred={label:'class_'+maxIdx,score:arr[maxIdx]};
        }catch(e){ log("TF inference error: "+e.message); }
      }

      res({
        green:gp,yellow:yp,brown:bp,
        visualScore:visScore,
        label:pred.label,score:pred.score
      });
    };
    img.src=data;
  });
}

// === Analysis Fusion ===
function fuseZone(z,vis,sens){
  let health=100;
  if(sens){
    if(sens.moisture<25) health-=30;
    if(sens.moisture>85) health-=25;
    if(sens.npk_n<30) health-=10;
  }
  if(vis){
    health-=Math.round((100-vis.visualScore)*0.3);
  }
  health=Math.max(0,Math.min(100,health));

  const flood=vis&&vis.brown>15 ? (sens&&sens.moisture>70?60:30):0;
  const txt=generateAIText(z,vis,sens,flood,health);
  latestAnalysis[z]={health,flood,visual:vis,sensor:sens,aiText:txt};
}

function generateAIText(z,vis,sens,flood,health){
  let t=`Zone ${z} Analysis\n`;
  if(sens) t+=`Moisture:${sens.moisture}% NPK:${sens.npk_n}/${sens.npk_p}/${sens.npk_k}\n`;
  if(vis) t+=`Leaf colors G:${vis.green}% Y:${vis.yellow}% B:${vis.brown}% Visual:${vis.visualScore}% Label:${vis.label}\n`;
  t+=`Flood severity:${flood}% Health:${health}%\n`;

  if(flood>=60) t+="Severe flood stress — drainage and root inspection required.\n";
  else if(flood>=30) t+="Moderate flood stress — monitor and improve drainage.\n";
  else t+="No flood stress detected.\n";

  if(health<40) t+="Crop highly stressed — consider replanting.\n";
  else if(health<70) t+="Moderate stress — apply nutrients and improve soil.\n";
  else t+="Crop in good condition.\n";

  t+="Post-flood context: Flooding can wash away nutrients, suffocate roots, and promote disease. Prompt action ensures crop survival.\n";
  return t;
}

// === Trigger Analysis ===
async function triggerAnalysis(){
  for(let z=1;z<=ZONES;z++){
    if(photos[z]){
      const vis=await analyzePhoto(z);
      const sens=sensorLogs.find(s=>s.zone===z)||null;
      fuseZone(z,vis,sens);
    }
  }
  renderAnalysis();
  updateMap();
  update3D();
}

// === Render Analysis ===
function renderAnalysis(){
  const g=document.getElementById('analysisGrid');
  g.innerHTML='';
  for(let z=1;z<=ZONES;z++){
    const a=latestAnalysis[z]||{health:0,flood:0};
    const c=document.createElement('div');
    c.className='analysis-card';
    c.innerText=`Zone ${z}\nHealth:${a.health}%\nFlood:${a.flood}%`;
    c.onclick=()=>{document.getElementById('aiAnalysis').innerText=a.aiText||'No data'};
    g.appendChild(c);
  }
}

// === 3D Update ===
function update3D(){
  for(const p of plants){
    const a=latestAnalysis[p.id]||{health:100};
    const hex=hexFromHealth(a.health);
    p.group.children.forEach(ch=>{
      if(ch.material){ ch.material.color.set(hex); }
    });
    p.group.scale.set(
      0.8+0.7*(a.health/100),
      0.8+0.7*(a.health/100),
      0.8+0.7*(a.health/100)
    );
  }
}
function hexFromHealth(h){
  const s=Math.max(0,Math.min(100,h));
  if(s>=50){
    const t=(s-50)/50;
    const r=Math.round(241+(46-241)*t),
          g=Math.round(196+(204-196)*t),
          b=Math.round(15+(113-15)*t);
    return `rgb(${r},${g},${b})`;
  } else {
    const t=s/50;
    const r=Math.round(231+(241-231)*t),
          g=Math.round(76+(196-76)*t),
          b=Math.round(60+(15-60)*t);
    return `rgb(${r},${g},${b})`;
  }
}

// === ESP32 ===
function sendCommandToESP32(cmd){
  const url=`http://${ESP32_IP}/${cmd}`;
  fetch(url,{mode:'no-cors'}).then(()=>log("ESP32 cmd:"+cmd));
}
// === Init ===
window.onload=async()=>{
  log("Init...");
  generatePhotoGrid();
  init3D();
  await loadTFModel();
  document.getElementById('status').innerText="Ready";
  log("System Ready.");
}
</script>
</body>
</html>
