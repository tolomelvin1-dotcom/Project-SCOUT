<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PROJECT SCOUT</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://unpkg.com/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
<style>
/* --- 1. MODERNIZED STYLING & VARIABLE DEFINITIONS --- */
:root {
    --color-primary: #0078D4; /* Modern Blue for actions/highlights */
    --color-secondary: #4EC9B0; /* Teal/Cyan for headers */
    --color-background: #1F1F1F; /* Darkest Background */
    --color-card: #2D2D30; /* Card/Panel Background */
    --color-text: #E0E0E0;
    --color-border: #3C3C3C;
    --color-status-good: #6AA84F;
    --color-status-caution: #FFC000;
    --color-status-bad: #C55050;
    --color-text-highlight: #9CDCFE;
    --color-focus-ring: #0099FF;
}

/* BASE STYLING */
body { 
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
    margin: 0; 
    background-color: var(--color-background); 
    color: var(--color-text); 
    padding: 0;
    line-height: 1.6;
}

/* HEADER & FOOTER */
.header-bar {
    background-color: #1E1E1E;
    color: var(--color-text);
    padding: 15px 40px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.5);
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: sticky;
    top: 0;
    z-index: 1000;
}
.header-bar h1 {
    margin: 0;
    color: var(--color-primary);
    font-size: 1.8em;
    font-weight: 300;
}
.footer-bar {
    text-align: center;
    padding: 20px;
    margin-top: 50px;
    border-top: 1px solid var(--color-border);
    background-color: #1E1E1E;
    color: #888;
    font-size: 0.9em;
}

/* MAIN CONTAINER (CSS Grid Layout) */
.container {
    max-width: 1800px;
    margin: 30px auto;
    padding: 25px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.7);
    border-radius: 12px;
    background-color: var(--color-background);
    
    /* Grid Definition for 3-column layout */
    display: grid;
    grid-template-columns: minmax(380px, 1.2fr) 1.5fr 1.5fr; 
    grid-template-rows: auto auto 1fr; /* Rows: Status, Top, Bottom */
    gap: 20px;
}
/* Grid Area Assignments */
.system-status-panel { grid-column: 1 / 4; grid-row: 1 / 2; background: var(--color-card); padding: 15px; border-radius: 8px;}
.controls-panel { grid-column: 1 / 2; grid-row: 2 / 4; background: var(--color-card); padding: 20px; border-radius: 8px; overflow-y: auto;}
.map-panel { grid-column: 2 / 3; grid-row: 2 / 3; background: var(--color-card); padding: 20px; border-radius: 8px;}
.photo-panel { grid-column: 3 / 4; grid-row: 2 / 3; background: var(--color-card); padding: 20px; border-radius: 8px;}
.map-3d-panel { grid-column: 2 / 3; grid-row: 3 / 4; background: var(--color-card); padding: 20px; border-radius: 8px;}
.plant-analysis-panel { grid-column: 3 / 4; grid-row: 3 / 4; background: var(--color-card); padding: 20px; border-radius: 8px;}

/* TYPOGRAPHY & HEADERS */
h2 { color: var(--color-secondary); margin-top: 5px; font-weight: 400; border-bottom: 1px solid var(--color-border); padding-bottom: 5px; }
h3 { color: var(--color-text-highlight); margin-top: 15px; font-size: 1.1em; }
#status { font-weight: bold; color: var(--color-status-caution); transition: color 0.5s; }
.section-divider { border-top: 1px solid var(--color-border); margin: 20px 0; }

/* BUTTONS */
button { 
    padding: 10px 15px; 
    margin: 8px 5px 8px 0; 
    cursor: pointer; 
    border: none; 
    border-radius: 6px; 
    font-weight: bold; 
    transition: background-color 0.2s, box-shadow 0.2s, transform 0.1s; 
    box-shadow: 0 2px 4px rgba(0,0,0,0.4);
}
button:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.6);
    transform: translateY(-1px);
}
button:active {
    transform: translateY(0);
}
.move-controls button { background-color: var(--color-primary); color: white; }
.arm-controls button { background-color: var(--color-status-good); color: white; }
.camera-control button { background-color: var(--color-status-bad); color: white; }
.history-controls button { background-color: var(--color-status-caution); color: black; }
.export-button { background-color: #569cd6; color: white; }

/* DATA DISPLAY */
.data-display { margin-top: 15px; padding: 15px; border: 1px solid var(--color-border); border-radius: 6px; background-color: #252526; }
.data-row { margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;}
.data-row strong { color: var(--color-text-highlight); font-weight: 500;}
.data-value { font-family: 'Consolas', monospace; color: var(--color-text); }

/* SYSTEM STATUS BAR */
.status-bar-grid { display: flex; justify-content: space-around; gap: 10px; margin-top: 10px; }
.status-item { text-align: center; flex-grow: 1; padding: 8px; border-radius: 6px; background-color: #252526; }
.status-item strong { display: block; font-size: 0.8em; color: #888; }
.status-value { font-size: 1.2em; font-weight: bold; }
.status-good { color: var(--color-status-good); }
.status-caution { color: var(--color-status-caution); }
.status-bad { color: var(--color-status-bad); }

/* NPK Configuration Panel */
.config-input-group { display: flex; gap: 10px; margin-bottom: 10px; }
.config-input-group label { flex: 1; }
.config-input-group input { 
    width: 100%; padding: 5px; border: 1px solid var(--color-border); 
    border-radius: 4px; background-color: #1E1E1E; color: var(--color-text);
}

/* CANVAS MAP (2D & 3D) */
#roverMap { border: 3px solid var(--color-status-good); background-color: #3d3d3d; display: block; margin: 10px auto 0; }
#threeDContainer {
    width: 100%;
    height: 480px;
    border: 3px solid var(--color-primary);
    background-color: #1a1a1a;
    margin: 10px auto 0;
    display: block;
}

/* PHOTO GRID STYLES */
#photoGrid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    grid-template-rows: repeat(4, 1fr);
    gap: 5px;
    border: 2px solid var(--color-secondary);
    max-width: 400px; /* Reduced slightly for better fit */
    margin: 15px auto;
    aspect-ratio: 1 / 1;
    background-color: #252526;
}
.grid-cell {
    border: 1px solid var(--color-border);
    background-color: #444;
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 0.9em;
    font-weight: bold;
    color: #bbb;
    position: relative;
    overflow: hidden;
}
.grid-cell img { width: 100%; height: 100%; object-fit: cover; }

/* Plant Analysis Grid Styles */
#plantAnalysisGrid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 15px;
    margin-top: 15px;
}
.analysis-card {
    padding: 15px;
    border-radius: 8px;
    background-color: #3e3e42;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    border-left: 5px solid;
}
.analysis-card.rec-critical { border-left-color: var(--color-status-bad); }
.analysis-card.rec-action { border-left-color: var(--color-status-caution); }
.analysis-card.rec-optimal { border-left-color: var(--color-status-good); }

.plant-id-label {
    font-size: 1.2em;
    font-weight: bold;
    color: var(--color-secondary);
    border-bottom: 1px dashed var(--color-border);
    padding-bottom: 5px;
    margin-bottom: 10px;
}
.rec-optimal, .rec-action, .rec-critical {
    padding: 8px;
    border-radius: 4px;
    display: block;
    font-weight: bold;
    white-space: normal;
    word-break: break-word;
    margin-top: 10px;
    text-align: center;
}
.rec-optimal { background-color: var(--color-status-good); color: white; }
.rec-action { background-color: var(--color-status-caution); color: black; }
.rec-critical { background-color: var(--color-status-bad); color: white; }

/* --- MODAL STYLES (Fully Written) --- */
.modal {
    display: none;
    position: fixed;
    z-index: 2000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.7);
}
.modal-content {
    background-color: var(--color-card);
    margin: 10% auto;
    padding: 25px;
    border: 1px solid var(--color-border);
    width: 80%;
    max-width: 900px;
    border-radius: 10px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.5);
    color: var(--color-text);
    max-height: 80vh;
    overflow-y: auto;
}
.close {
    color: var(--color-text-highlight);
    float: right;
    font-size: 28px;
    font-weight: bold;
}
.close:hover,
.close:focus {
    color: var(--color-primary);
    text-decoration: none;
    cursor: pointer;
}
#historyList, #stockImageContainer {
    list-style: none;
    padding: 0;
}
#historyList li, .stock-image-item {
    padding: 10px;
    margin-bottom: 8px;
    background-color: #252526;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.2s;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
#historyList li:hover { background-color: #3C3C3C; }

.stock-image-item {
    display: inline-block;
    width: 180px;
    height: 180px;
    margin: 5px;
    overflow: hidden;
    position: relative;
    border: 3px solid transparent;
    transition: border-color 0.2s;
}
.stock-image-item:hover { border-color: var(--color-primary); }
.stock-image-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}
.stock-image-item span {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background-color: rgba(0,0,0,0.6);
    color: white;
    padding: 5px;
    font-size: 0.8em;
    text-align: center;
}
</style>
</head>
<body>
<div class="header-bar">
    <h1>PROJECT SCOUT: Rover Mapping & AI</h1>
    <div>
        <span id="status">Connecting...</span>
        <span style="margin-left: 20px; font-size: 0.9em; color: #aaa;">Rover: <span id="rover-ip">192.168.1.50</span></span>
    </div>
</div>

<div class="container">

    <div class="system-status-panel">
        <h2>System Health Dashboard 📡 </h2>
        <div class="status-bar-grid">
            <div class="status-item">
                <strong>Battery Level</strong>
                <span id="batteryStatus" class="status-value status-good">98%</span>
            </div>
            <div class="status-item">
                <strong>Motor Temp</strong>
                <span id="motorTemp" class="status-value status-good">35°C</span>
            </div>
            <div class="status-item">
                <strong>Signal Strength</strong>
                <span id="signalStrength" class="status-value status-good">-60 dBm</span>
            </div>
            <div class="status-item">
                <strong>Data Buffer</strong>
                <span id="dataBuffer" class="status-value status-good">0.05 GB</span>
            </div>
            <div class="status-item">
                <strong>Uptime</strong>
                <span id="uptime" class="status-value status-good">4h 21m</span>
            </div>
        </div>
    </div>

    <div class="controls-panel">
        <h2>Rover Control & Configuration</h2>
        
        <div class="data-display history-controls">
            <h3>Trial Management 💾 </h3>
            <div class="data-row">
                <strong>Current Trial:</strong> <span class="data-value" id="currentTrialNumber">1</span>
            </div>
            <p>
                <button onclick="saveCurrentTrial()"> 💾 Save Trial Data</button>
                <button onclick="openHistoryModal()"> 📅 View History</button>
                <button class="export-button" onclick="exportData()"> 📤 Export to JSON</button>
            </p>
        </div>

        <div class="section-divider"></div>

        <div class="move-controls">
            <h3>Rover Movement</h3>
            <p>
                <button onclick="sendCommand('forward')">Forward (↑)</button>
                <button onclick="sendCommand('stop')"> 🛑 STOP</button>
                <button onclick="sendCommand('backward')">Backward (↓)</button><br>
                <button onclick="sendCommand('left')">Left (←)</button>
                <button onclick="sendCommand('right')">Right (→)</button>
            </p>
            <p><small>Rover coordinates: (X: <span id="rover-x">2.0</span>m, Y: <span id="rover-y">2.0</span>m)</small></p>
        </div>

        <div class="section-divider"></div>

        <div class="arm-controls">
            <h3>Data Acquisition</h3>
            <button onclick="sendCommand('probe')"> 🔬 Probe Soil (Arm Down)</button>
            <button onclick="sendCommand('read_sensors')"> 💧 Read Soil Data</button>
            <button onclick="sendCommand('read_nav')"> 🧭 Get GPS/Heading</button>
        </div>

        <div class="data-display">
            <h3>Live Sensor Data</h3>
            <div class="data-row"><strong>Latitude:</strong> <span id="latitudeData" class="data-value">N/A</span></div>
            <div class="data-row"><strong>Longitude:</strong> <span id="longitudeData" class="data-value">N/A</span></div>
            <div class="data-row"><strong>GPS Fix:</strong> <span id="gpsFix" class="data-value status-bad">No Fix</span></div>
            <div class="data-row"><strong>Heading:</strong> <span id="headingData" class="data-value">N/A</span></div>
            <div class="data-row"><strong>Moisture:</strong> <span id="moistureData" class="data-value">N/A</span></div>
            <div class="data-row"><strong>NPK (N, P, K):</strong> <span id="npkData" class="data-value">N/A</span></div>
        </div>

        <div class="section-divider"></div>

        <div class="config-panel">
            <h3>NPK Sensor Calibration Settings (PPM)</h3>
            <p><small>Define the ideal range for the AI's "Optimal" classification.</small></p>
            <div class="config-input-group">
                <label>N (Min): <input type="number" id="config-n-min" value="60"></label>
                <label>N (Max): <input type="number" id="config-n-max" value="100"></label>
            </div>
            <div class="config-input-group">
                <label>P (Min): <input type="number" id="config-p-min" value="50"></label>
                <label>P (Max): <input type="number" id="config-p-max" value="80"></label>
            </div>
            <div class="config-input-group">
                <label>K (Min): <input type="number" id="config-k-min" value="70"></label>
                <label>K (Max): <input type="number" id="config-k-max" value="120"></label>
            </div>
            <button onclick="applyCalibration()">Apply New Calibration</button>
        </div>
    </div>

    <div class="map-panel">
        <h2>2D Field Map ($\mathbf{4\text{m} \times 4\text{m}}$ Grid)</h2>
        <canvas id="roverMap" width="450" height="450"></canvas>
        <p><small>Map Key: $\text{Grid} = 1 \text{m} \times 1 \text{m}$. $\text{Circles} = \text{Health}$. $\text{Triangle} = \text{Rover}$.</small></p>
        <button onclick="clearMapData()"> 🗑 Clear Map Data</button>
    </div>

    <div class="photo-panel">
        <div class="camera-control">
            <h2>Image Capture & Gallery</h2>
            <button onclick="sendCommand('capture')"> 📸 Take Photo (to Dell Wyse)</button>
            <button onclick="openStockImageModal()"> 🖼 ️ Load AI Simulation Photos</button>
            <p><small>Last photo status: <span id="lastPhotoStatus">N/A</span>. Server IP: <span id="server-ip">192.168.X.X:5000</span>.</small></p>
        </div>
        
        <div class="section-divider"></div>

        <h2>Plant Zone Photo Assignments (Zones 1-16)</h2>
        <p><small>Click a zone to assign a photo. Photos assigned here are used for the Fused AI analysis.</small></p>
        <div id="photoGrid">
        </div>
        <input type="file" id="fileInput" accept="image/*" style="display:none;" onchange="handleFileSelect(event)">
    </div>
    
    <div class="map-3d-panel">
        <h2>3D Soil Metric Visualization 📊 </h2>
        <div id="threeDContainer"></div>
        <div class="three-d-controls">
            <p><small>Bar Height = Soil Moisture %. Bar Color = Plant Health (Green/Yellow/Red).</small></p>
        </div>
    </div>
    
    <div class="plant-analysis-panel">
        <h2>Plant-Specific Fused AI Analysis (16 Zones) 🔬 </h2>
        <p><small>This grid shows the fused analysis of **Leaf Photo (AI)** + **Local Soil Data (NPK/Moisture)**, with **Dark Spots** prioritized.</small></p>
        <div id="plantAnalysisGrid">
        </div>
    </div>

</div>

<div id="historyModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeHistoryModal()">&times;</span>
        <h2>Trial History Log 📅 </h2>
        <p>Select a past trial to review its data (Map, Photos, AI Analysis).</p>
        <ul id="historyList">
            </ul>
        <button class="camera-control" onclick="clearAllHistory()" style="margin-top: 20px;"> ⚠️ Permanently Delete All History</button>
    </div>
</div>

<div id="stockImageModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeStockImageModal()">&times;</span>
        <h2>AI Simulation Photo Gallery 🖼️</h2>
        <p>Select a simulated plant image below, then click a zone (1-16) on the main photo grid to assign it for analysis.</p>
        <p><small>Current Action: Assigning photo to Zone <span id="selectedZoneDisplay">N/A</span>.</small></p>
        <div id="stockImageContainer">
            </div>
    </div>
</div>

<div class="footer-bar">
    All Rights Reserved: BanScie RIM Team 2025
</div>

<script>
// JAVASCRIPT LOGIC
// !!! CONFIGURATION CONSTANTS !!!
const ESP32_IP = '192.168.1.50';
const DELL_WYSE_IP = 'http://192.168.X.X:5000';
const ESP32_URL_BASE = `http://${ESP32_IP}`;
const STATUS_ELEMENT = document.getElementById('status');
const LAST_PHOTO_STATUS = document.getElementById('lastPhotoStatus');

document.getElementById('server-ip').innerText = DELL_WYSE_IP.replace('http://', '');
document.getElementById('rover-ip').innerText = ESP32_IP;

// --- GLOBAL CONSTANTS & ELEMENTS ---
const FIELD_SIZE = 4;
const MAP_CANVAS = document.getElementById('roverMap');
const CTX = MAP_CANVAS.getContext('2d');
const MAP_SIZE = 450;
const PIXELS_PER_METER = MAP_SIZE / FIELD_SIZE;
const MAX_MOISTURE = 100;
const PLANT_LOCATIONS_M = [];
for(let r=0; r<FIELD_SIZE; r++) for(let c=0; c<FIELD_SIZE; c++) PLANT_LOCATIONS_M.push({x: c + 0.5, y: r + 0.5, id: (r * FIELD_SIZE) + c + 1});

// Global Data Structures
let loggedData = [];
let photoData = {}; // Stores {zoneId: base64Image} - ASSIGNED PHOTOS
let stockPhotoData = {}; // Stores {stockId: base64Image} - GALLERY OF STOCK PHOTOS
let selectedZone = 0;
let trialHistory = JSON.parse(localStorage.getItem('trialHistory') || '[]');
let currentTrialNumber = trialHistory.length + 1;
document.getElementById('currentTrialNumber').innerText = currentTrialNumber;
let currentRoverData = {
    latitude: 'N/A', longitude: 'N/A', heading: 0, x_m: 2.0, y_m: 2.0, lastCommand: 'init'
};

// --- SIMULATED LIBRARY: TOMATO DIAGNOSTIC RULES (SCIENTIFICALLY PRIORITIZED) ---
const TOMATO_DIAGNOSTIC_LIBRARY = {
    // Disease Tiers (Prioritized by Severity)
    DISEASE_TIERS: [
        { name: "Mottling/Mosaic Pattern (Viral)", severity: 95, probability: 0.10, class: 'rec-critical', recommendation: "***ISOLATION REQUIRED***: Strong indicator of Tobacco Mosaic Virus (TMV) or similar. Incurable. Remove plant immediately to prevent field-wide contamination."
        },
        // CRITICAL UPDATE: Explicitly defining "Dark Spots" as the determinant feature
        { name: "Dark Spots & Lesions (Fungal/Bact)", severity: 85, probability: 0.15, class: 'rec-critical', recommendation: "***DARK SPOT DETECTION (AI DETERMINANT)***: High probability of Early Blight or Bacterial Spot. Apply broad-spectrum fungicide and improve air circulation/reduce leaf wetness."
        },
        { name: "Leaf Curl & Wilting (Stress/Viral)", severity: 75, probability: 0.10, class: 'rec-critical', recommendation: "WILTING: Could be severe water stress, root rot, or Tomato Yellow Leaf Curl Virus (TYLCV). Check moisture urgently. If moisture is good, isolate for potential virus."
        },
        { name: "General Yellowing (Chlorosis)", severity: 50, probability: 0.25, class: 'rec-action', recommendation: "GENERAL YELLOWING: A common sign of nutrient deficiency (N, Mg, Fe) or pH imbalance. Check NPK data for confirmation."
        },
        { name: "Healthy, Deep Green", severity: 0, probability: 0.40, class: 'rec-optimal', recommendation: "OPTIMAL: No visual symptoms detected. Continue regular monitoring."
        }
    ],
    // NPK Guidelines for Scoring (Dynamically updated by applyCalibration)
    NPK_GUIDELINES: { 
        moisture: { ideal_min: 40, ideal_max: 60, low_crit: 25, high_crit: 75, penalty_minor: 10, penalty_major: 30, low_rec: "deep watering", high_rec: "review soil drainage/stop irrigation" },
        N: { ideal_min: 60, ideal_max: 100, low_crit: 30, high_crit: 150, penalty_minor: 15, penalty_major: 40, low_rec: "high-Nitrogen (N) liquid feed", high_rec: "stop all N-fertilizer, flush soil" },
        P: { ideal_min: 50, ideal_max: 80, low_crit: 20, high_crit: 120, penalty_minor: 10, penalty_major: 25, low_rec: "Phosphorus (P) booster for root development", high_crit: "check fertilizer blend for P excess" },
        K: { ideal_min: 70, ideal_max: 120, low_crit: 40, high_crit: 180, penalty_minor: 10, penalty_major: 25, low_rec: "Potassium (K) to boost resistance/fruit set", high_rec: "check for K salt toxicity" },
    }
};

// --- HASHING AND PRNG FOR ACCURACY/CONSISTENCY ---
function simpleStringHash(str) { 
    let hash = 0;
    for (let i = 0; i < Math.min(str.length, 1000); i++) {
        const char = str.charCodeAt(i);
        hash = (hash << 5) - hash + char;
        hash |= 0;
    }
    return Math.abs(hash);
}
function deterministicPseudoRandom(seed) { 
    const a = 1664525;
    const c = 1013904223;
    const m = 4294967296;
    let state = (Math.abs(Math.floor(seed)) * 101) % m;
    state = (a * state + c) % m;
    return state / m;
}

// --- NPK CONFIGURATION FUNCTION (NEW) ---
function applyCalibration() {
    const nMin = parseInt(document.getElementById('config-n-min').value);
    const nMax = parseInt(document.getElementById('config-n-max').value);
    const pMin = parseInt(document.getElementById('config-p-min').value);
    const pMax = parseInt(document.getElementById('config-p-max').value);
    const kMin = parseInt(document.getElementById('config-k-min').value);
    const kMax = parseInt(document.getElementById('config-k-max').value);

    // Basic validation
    if (nMin >= nMax || pMin >= pMax || kMin >= kMax) {
        STATUS_ELEMENT.innerText = "Error: Min must be less than Max for all NPK values.";
        STATUS_ELEMENT.style.color = 'var(--color-status-bad)';
        return;
    }

    // Update global guidelines
    TOMATO_DIAGNOSTIC_LIBRARY.NPK_GUIDELINES.N.ideal_min = nMin;
    TOMATO_DIAGNOSTIC_LIBRARY.NPK_GUIDELINES.N.ideal_max = nMax;
    TOMATO_DIAGNOSTIC_LIBRARY.NPK_GUIDELINES.P.ideal_min = pMin;
    TOMATO_DIAGNOSTIC_LIBRARY.NPK_GUIDELINES.P.ideal_max = pMax;
    TOMATO_DIAGNOSTIC_LIBRARY.NPK_GUIDELINES.K.ideal_min = kMin;
    TOMATO_DIAGNOSTIC_LIBRARY.NPK_GUIDELINES.K.ideal_max = kMax;

    // Recalculate critical points based on new ideal range (e.g., crit_low = ideal_min / 2)
    TOMATO_DIAGNOSTIC_LIBRARY.NPK_GUIDELINES.N.low_crit = Math.floor(nMin * 0.5);
    TOMATO_DIAGNOSTIC_LIBRARY.NPK_GUIDELINES.P.low_crit = Math.floor(pMin * 0.5);
    TOMATO_DIAGNOSTIC_LIBRARY.NPK_GUIDELINES.K.low_crit = Math.floor(kMin * 0.5);

    STATUS_ELEMENT.innerText = "NPK Calibration applied successfully. Rerunning AI analysis...";
    STATUS_ELEMENT.style.color = 'var(--color-status-good)';
    fetchAIResults();
}

// --- 3D RENDERING SETUP (THREE.JS) ---
let scene, camera, renderer, rover3D, controls;
let dataCubes = {};
function initThreeD() {
    const container = document.getElementById('threeDContainer');
    const width = container.clientWidth;
    const height = container.clientHeight;
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x1a1a1a);
    camera = new THREE.PerspectiveCamera(75, width / height, 0.1, 100);
    camera.position.set(2, 6, 2);
    camera.lookAt(2, 0, 2);
    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(width, height);
    container.innerHTML = ''; // Clear existing canvas if any
    container.appendChild(renderer.domElement);
    controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;
    controls.screenSpacePanning = false;
    controls.minDistance = 1;
    controls.maxDistance = 10;
    controls.maxPolarAngle = Math.PI / 2.2;
    const gridHelper = new THREE.GridHelper(FIELD_SIZE, FIELD_SIZE, 0x444444, 0x444444);
    gridHelper.position.set(FIELD_SIZE / 2, 0, FIELD_SIZE / 2);
    scene.add(gridHelper);
    const roverGeometry = new THREE.BoxGeometry(0.2, 0.1, 0.2);
    const roverMaterial = new THREE.MeshPhongMaterial({ color: 0x569cd6 });
    rover3D = new THREE.Mesh(roverGeometry, roverMaterial);
    rover3D.position.set(currentRoverData.x_m, 0.05, currentRoverData.y_m);
    scene.add(rover3D);
    const ambientLight = new THREE.AmbientLight(0x404040, 2);
    scene.add(ambientLight);
    const directionalLight = new THREE.DirectionalLight(0xffffff, 1.5);
    directionalLight.position.set(5, 10, 5);
    scene.add(directionalLight);
    animate();
}
function animate() {
    requestAnimationFrame(animate);
    if(controls) controls.update();
    renderer.render(scene, camera);
}
function updateRover3DPosition() {
    if (rover3D) {
        rover3D.position.set(
            parseFloat(currentRoverData.x_m), 0.05, parseFloat(currentRoverData.y_m)
        );
        rover3D.rotation.y = -(currentRoverData.heading - 90) * (Math.PI / 180);
    }
}
function getHealthColorHex(status) {
    if (status === 'Good') return 0x28a745;
    if (status === 'Caution') return 0xffc107;
    if (status === 'Bad') return 0xdc3545;
    return 0x5a5a5a;
}
function draw3DMap() {
    // Clear old data cubes
    Object.values(dataCubes).forEach(cube => {
        scene.remove(cube);
        cube.geometry.dispose();
        cube.material.dispose();
    });
    dataCubes = {};

    loggedData.forEach((data, index) => {
        const { x_m, y_m, moisture, healthStatus } = data;
        const cubeWidth = 0.5;
        const cubeDepth = 0.5;
        const cubeHeight = Math.max(0.01, moisture / MAX_MOISTURE * 3); // Scale height up for visibility
        const colorHex = getHealthColorHex(healthStatus);
        const geometry = new THREE.BoxGeometry(cubeWidth, cubeHeight, cubeDepth);
        const material = new THREE.MeshPhongMaterial({
            color: colorHex, opacity: 0.8, transparent: true
        });
        const cube = new THREE.Mesh(geometry, material);
        cube.position.set(x_m, cubeHeight / 2, y_m);
        dataCubes[index] = cube;
        scene.add(cube);
    });
    updateRover3DPosition();
}

// --- PHOTO GRID & MODAL FUNCTIONS ---
function populateStockPhotos() {
    if (Object.keys(stockPhotoData).length === 16) return;
    const diseaseList = TOMATO_DIAGNOSTIC_LIBRARY.DISEASE_TIERS;
    for (let i = 1; i <= 16; i++) {
        // Deterministically assign a symptom based on index
        const diseaseIndex = i % diseaseList.length;
        // The base64 includes the diagnostic tag for deterministic simulation
        const diagTag = diseaseList[diseaseIndex].name.replace(/\s/g, '_').replace(/\//g, '-');
        const base64 = `data:image/svg+xml;base64,mocked_stock_photo_hash_${i}_diag:${diagTag}`;
        stockPhotoData[i] = {
            base64: base64,
            name: diseaseList[diseaseIndex].name
        };
    }
}

function openStockImageModal() {
    populateStockPhotos();
    renderStockImageGrid();
    document.getElementById('stockImageModal').style.display = "block";
    
    if (selectedZone === 0) {
        STATUS_ELEMENT.innerText = "Select a stock photo, then click a zone (1-16) in the main photo grid to assign it.";
        document.getElementById('selectedZoneDisplay').innerText = "N/A";
    } else {
        document.getElementById('selectedZoneDisplay').innerText = selectedZone;
    }
}
function closeStockImageModal() { document.getElementById('stockImageModal').style.display = "none"; }

function getPhotoPrediction(base64Image) {
    const photoHash = simpleStringHash(base64Image);
    const randomRoll = deterministicPseudoRandom(photoHash);
    let cumulativeProb = 0;
    let prediction = TOMATO_DIAGNOSTIC_LIBRARY.DISEASE_TIERS[4]; // Default to Healthy

    // AI SIMULATION: **PRIORITIZE DARK SPOT DETECTION**
    // Check if the image is tagged with "Dark Spots" (simulating AI feature)
    const isDarkSpotDetected = base64Image.includes('diag:Dark_Spots');
    
    if (isDarkSpotDetected) {
        // Return the specific, critical disease tier for dark spots
        return TOMATO_DIAGNOSTIC_LIBRARY.DISEASE_TIERS.find(d => d.name.includes("Dark Spots"));
    }

    // Standard Probabilistic Roll for other symptoms
    for (const disease of TOMATO_DIAGNOSTIC_LIBRARY.DISEASE_TIERS) {
        if (disease.name.includes("Dark Spots")) continue; // Skip Dark Spots tier in random roll
        
        cumulativeProb += disease.probability;
        if (randomRoll <= cumulativeProb) {
            prediction = disease;
            break;
        }
    }
    return prediction;
}
function renderStockImageGrid() {
    const container = document.getElementById('stockImageContainer');
    container.innerHTML = '';
    
    for (let id = 1; id <= 16; id++) {
        const item = stockPhotoData[id];
        const div = document.createElement('div');
        div.className = 'stock-image-item';
        div.setAttribute('onclick', `assignStockPhotoToZone(${id})`);
        div.innerHTML = `
            <img src="${item.base64}" alt="Stock Image ${id}" />
            <span>ID ${id}: ${item.name}</span>
        `;
        container.appendChild(div);
    }
}
function assignStockPhotoToZone(stockId) {
    if (selectedZone === 0) {
        STATUS_ELEMENT.innerText = "Error: Please click a Zone (1-16) on the main Photo Grid first.";
        STATUS_ELEMENT.style.color = 'var(--color-status-bad)';
        return;
    }
    
    const photo = stockPhotoData[stockId];
    photoData[selectedZone] = photo.base64;
    renderPhotoInCell(selectedZone, photo.base64);
    STATUS_ELEMENT.innerText = `Assigned Photo ID ${stockId} (${photo.name}) to Zone ${selectedZone}.`;
    closeStockImageModal();
    selectedZone = 0; // Reset selected zone
    fetchAIResults(); // Re-run analysis automatically
}
function deletePhoto(zoneId) {
    delete photoData[zoneId];
    const cell = document.getElementById(`photo-zone-${zoneId}`);
    cell.innerHTML = `Zone ${zoneId}`;
    STATUS_ELEMENT.innerText = `Photo deleted from Zone ${zoneId}.`;
    fetchAIResults();
}
function generatePhotoGrid() {
    const grid = document.getElementById('photoGrid');
    grid.innerHTML = '';
    for (let i = 1; i <= 16; i++) {
        const cell = document.createElement('div');
        cell.className = 'grid-cell';
        cell.id = `photo-zone-${i}`;
        cell.innerText = `Zone ${i}`;
        cell.setAttribute('onclick', `preparePhotoUpload(${i})`);
        grid.appendChild(cell);
    }
    loadCurrentPhotoData();
}
function preparePhotoUpload(zoneId) {
    selectedZone = zoneId;
    document.getElementById('selectedZoneDisplay').innerText = zoneId;
    STATUS_ELEMENT.innerText = `Zone ${zoneId} selected. Choose an option: Upload File or Load Simulation Photo.`;
    
    // Prompt user to choose between file upload or simulation gallery
    const choice = confirm(`Zone ${zoneId} selected. Do you want to: \n\nOK: Upload a photo file from your device \nCANCEL: Use a simulation photo from the gallery`);
    
    if (choice) {
        document.getElementById('fileInput').click();
    } else {
        openStockImageModal();
    }
}
function handleFileSelect(event) {
    const file = event.target.files[0];
    if (file && selectedZone !== 0) {
        const reader = new FileReader();
        reader.onload = function(e) {
            photoData[selectedZone] = e.target.result;
            renderPhotoInCell(selectedZone, e.target.result);
            STATUS_ELEMENT.innerText = `Custom photo uploaded and assigned to Zone ${selectedZone}.`;
            selectedZone = 0;
            fetchAIResults();
        };
        reader.readAsDataURL(file);
    }
}
function renderPhotoInCell(zoneId, base64Image) {
    const cell = document.getElementById(`photo-zone-${zoneId}`);
    cell.innerHTML = `
        <img src="${base64Image}" alt="Photo for Zone ${zoneId}" title="Zone ${zoneId}: Click to replace or delete">
        <span style="position:absolute; top:2px; right:2px; background:rgba(0,0,0,0.7); color:white; padding: 2px 5px; border-radius:3px; font-size: 0.7em;">${zoneId}</span>
        <button onclick="event.stopPropagation(); deletePhoto(${zoneId})" style="position:absolute; bottom:5px; right:5px; padding: 5px; margin:0; font-size: 0.7em; background: var(--color-status-bad);">X</button>
    `;
    cell.setAttribute('onclick', `preparePhotoUpload(${zoneId})`); // Re-enable click for replacement
}
function loadCurrentPhotoData() {
    Object.keys(photoData).forEach(zoneId => {
        renderPhotoInCell(parseInt(zoneId), photoData[zoneId]);
    });
}

// --- FUSED AI ANALYSIS LOGIC ---
function getNearestSensorData(plantX, plantY) {
    let nearestData = null;
    let min_dist_sq = Infinity;
    // Check within a 1-meter radius (0.707m is diagonal of a 1x1 grid square, so 1m is safe)
    loggedData.forEach(data => {
        let dx = data.x_m - plantX;
        let dy = data.y_m - plantY;
        let dist_sq = dx * dx + dy * dy;
        if (dist_sq < 1 * 1 && dist_sq < min_dist_sq) {
            min_dist_sq = dist_sq;
            nearestData = data;
        }
    });
    return nearestData;
}

function analyzePlant(plant, sensorData, photoExists) {
    let soilScore = 100;
    let soilProblems = [];
    let sensorDiagnosis = "Soil: Data Missing or Out of Range";
    let visualDiagnosis = "Visual: No Photo Taken";
    let prediction = TOMATO_DIAGNOSTIC_LIBRARY.DISEASE_TIERS[4]; // Default to Healthy

    // 1. Sensor Data Analysis
    if (sensorData) {
        const { moisture, npk_n, npk_p, npk_k } = sensorData;
        const data = { moisture, N: npk_n, P: npk_p, K: npk_k };
        const keys = ['moisture', 'N', 'P', 'K'];
        keys.forEach(key => {
            const guideline = TOMATO_DIAGNOSTIC_LIBRARY.NPK_GUIDELINES[key];
            const value = data[key];
            let problem = '';

            if (value < guideline.low_crit) {
                soilScore -= guideline.penalty_major; problem = `CRITICAL LOW ${key}`;
            } else if (value < guideline.ideal_min) {
                soilScore -= guideline.penalty_minor; problem = `LOW ${key}`;
            } else if (value > guideline.high_crit) {
                soilScore -= guideline.penalty_major; problem = `CRITICAL HIGH ${key}`;
            } else if (value > guideline.ideal_max) {
                soilScore -= guideline.penalty_minor; problem = `HIGH ${key}`;
            }

            if (problem) {
                let rec = (problem.includes('CRITICAL') ? "Urgent " : "") +
                (value < guideline.low_crit ? guideline.low_rec : guideline.high_rec);
                soilProblems.push({ key, value, problem, rec });
            }
        });
        sensorDiagnosis = `Soil: M=${moisture}%, NPK=${npk_n}/${npk_p}/${npk_k}`;
    } else {
        // Data Missing scenario
        return {
            id: plant.id, score: 20, visualDiagnosis: "Visual: N/A (Data Missing)",
            sensorDiagnosis: "Soil: Sensor Data Missing (Cannot Analyze)",
            recommendation: "***CRITICAL ERROR: DATA GAP***. Conduct soil probe at Zone " + plant.id + " immediately to enable fused analysis.",
            healthClass: 'rec-critical'
        };
    }

    // 2. Photo Analysis (Visual Diagnosis)
    if (photoExists) {
        prediction = getPhotoPrediction(photoData[plant.id]);
        visualDiagnosis = `Visual: ${prediction.name}`;
    }
    
    // 3. Fused Diagnosis (Disease + Soil)
    const isYellow = prediction.name.includes('Yellowing');
    const isDarkSpots = prediction.name.includes('Dark Spots'); // CRITICAL DETERMINANT
    const isMottling = prediction.name.includes('Mottling');
    const isWilting = prediction.name.includes('Leaf Curl');
    const isLowN = soilProblems.some(p => p.problem.includes('CRITICAL LOW N'));
    const isLowK = soilProblems.some(p => p.problem.includes('CRITICAL LOW K'));
    const isCritMoisture = soilProblems.some(p => p.problem.includes('CRITICAL LOW moisture') || p.problem.includes('CRITICAL HIGH moisture'));


    // TIER 1: INCURABLE PATHOGEN OVERRIDE
    if (isMottling || isWilting) {
        finalRecommendation = prediction.recommendation;
        healthClass = prediction.class;
        soilScore = 5; 
    }
    // TIER 2: FUNGUS/BACTERIA OVERRIDE (PRIORITIZED DARK SPOT DETECTION)
    else if (isDarkSpots) {
        finalRecommendation = prediction.recommendation; // Use the fixed fungal recommendation
        healthClass = prediction.class;
        soilScore = Math.min(25, soilScore); // Penalize severely due to disease presence
    }
    // TIER 3: CRITICAL MOISTURE STRESS
    else if (isCritMoisture) {
        const critMoisture = soilProblems.find(p => p.problem.includes('CRITICAL'));
        finalRecommendation = `***CRITICAL WATER STRESS***: ${critMoisture.problem} (${critMoisture.value}%). ${critMoisture.rec}.`;
        healthClass = 'rec-critical';
        soilScore = Math.min(35, soilScore);
    }
    // TIER 4: N-DEFICIENCY CONFIRMATION (Visual + Soil)
    else if (isYellow && isLowN) {
        const critN = soilProblems.find(p => p.key === 'N');
        finalRecommendation = `CONFIRMED N-DEFICIENCY: Yellowing is caused by ${critN.problem} (${critN.value} ppm). Apply ${critN.rec}.`;
        healthClass = 'rec-action'; 
    }
    // TIER 5: SECONDARY DEFICIENCY INFERENCE
    else if (isYellow && isLowK) {
        const critK = soilProblems.find(p => p.key === 'K');
        finalRecommendation = `INFERENCE: Yellowing present. Low Potassium (${critK.value} ppm) suggests K-deficiency. Supplement Potassium to boost immunity/fruit health.`;
        healthClass = 'rec-action';
    }
    // TIER 6: SOIL PROBLEMS ONLY (No Major Visual)
    else if (soilProblems.length > 0) {
        const problemString = soilProblems.map(p => `${p.problem.replace('CRITICAL ', '')} (${p.value})`).join('; ');
        const recString = soilProblems.map(p => p.rec).join('; ');

        finalRecommendation = `CAUTION: Soil Imbalance Detected: ${problemString}. Recommended action: ${recString}`;
        healthClass = soilScore <= 60 ? 'rec-action' : 'rec-optimal';
    }
    // TIER 7: OPTIMAL
    else {
        finalRecommendation = prediction.recommendation;
        healthClass = prediction.class;
    }
    
    // Final Score Calculation: Max score is 100. Lower is worse.
    const finalScore = Math.max(0, Math.round(soilScore - prediction.severity * 0.3));
    return {
        id: plant.id,
        score: finalScore.toFixed(0),
        visualDiagnosis: visualDiagnosis,
        sensorDiagnosis: sensorDiagnosis,
        recommendation: finalRecommendation.trim(),
        healthClass: healthClass
    };
}
function fetchAIResults() {
    const analysisGrid = document.getElementById('plantAnalysisGrid');
    analysisGrid.innerHTML = '';
    let aiDataList = [];

    PLANT_LOCATIONS_M.forEach(plant => {
        const sensorData = getNearestSensorData(plant.x, plant.y);
        const photoExists = !!photoData[plant.id];
        const analysis = analyzePlant(plant, sensorData, photoExists);
        aiDataList.push(analysis);

        const recLabel = analysis.recommendation;
        const card = `
        <div class="analysis-card ${analysis.healthClass}">
        <div class="plant-id-label">Zone ${analysis.id}</div>
        <div class="data-row">
            <strong>Composite Score:</strong> <span class="data-value">${analysis.score}/100</span>
        </div>
        <div class="data-row">
            <strong>Leaf Analysis:</strong> <span class="data-value">${analysis.visualDiagnosis}</span>
        </div>
        <div class="data-row">
            <strong>Soil Analysis:</strong> <span class="data-value">${analysis.sensorDiagnosis}</span>
        </div>
        <div style="margin-top: 10px;">
            <strong>Recommendation:</strong> <span class="${analysis.healthClass}">${recLabel}</span>
        </div>
        </div>
        `;
        analysisGrid.insertAdjacentHTML('beforeend', card);
    });
    // Store the raw analysis list with the current trial data
    currentRoverData.aiData = aiDataList; 
    STATUS_ELEMENT.innerText = `AI Analysis Complete: ${PLANT_LOCATIONS_M.length} plants analyzed.`;
    // Update 3D map based on new health data
    draw3DMap();
}

// --- COMMUNICATION & SIMULATION ---
let simInterval;
function startSimulatedTelemetry() {
    if (simInterval) clearInterval(simInterval);
    simInterval = setInterval(() => {
        // Simulate System Health Updates (NEW)
        updateSystemHealth();
    }, 5000);
}

function updateSystemHealth() {
    // Simulated values changing slightly over time
    const battery = Math.max(10, 98 - (currentTrialNumber * 0.5));
    const temp = Math.min(55, 35 + (currentTrialNumber * 0.5));
    const signal = -60 + Math.floor(Math.random() * 10 - 5);
    const buffer = (Math.random() * 0.2).toFixed(2);
    const uptimeHours = Math.floor(currentTrialNumber / 4) + 4;
    const uptimeMins = (currentTrialNumber * 15) % 60;

    const batteryEl = document.getElementById('batteryStatus');
    const tempEl = document.getElementById('motorTemp');
    const signalEl = document.getElementById('signalStrength');
    const bufferEl = document.getElementById('dataBuffer');
    const uptimeEl = document.getElementById('uptime');

    batteryEl.innerText = `${battery.toFixed(0)}%`;
    batteryEl.className = battery < 20 ? 'status-value status-bad' : (battery < 50 ? 'status-value status-caution' : 'status-value status-good');
    
    tempEl.innerText = `${temp.toFixed(1)}°C`;
    tempEl.className = temp > 50 ? 'status-value status-bad' : (temp > 40 ? 'status-value status-caution' : 'status-value status-good');

    signalEl.innerText = `${signal} dBm`;
    signalEl.className = signal < -75 ? 'status-value status-bad' : (signal < -65 ? 'status-value status-caution' : 'status-value status-good');

    bufferEl.innerText = `${buffer} GB`;
    bufferEl.className = buffer > 0.1 ? 'status-value status-caution' : 'status-value status-good';

    uptimeEl.innerText = `${uptimeHours}h ${uptimeMins}m`;

    if (battery < 15 || temp > 55) {
        STATUS_ELEMENT.innerText = "CRITICAL WARNING: System health alert. Check status dashboard.";
        STATUS_ELEMENT.style.color = 'var(--color-status-bad)';
    } else if (STATUS_ELEMENT.innerText.includes("CRITICAL")) {
        STATUS_ELEMENT.innerText = "System health restored. Normal operation.";
        STATUS_ELEMENT.style.color = 'var(--color-status-good)';
    }
}

function sendCommand(command) {
    STATUS_ELEMENT.innerText = `Sending command: ${command} to ${ESP32_IP}...`;
    // Simulate API call delay
    setTimeout(() => {
        const lastCommand = command;
        let newX = currentRoverData.x_m;
        let newY = currentRoverData.y_m;
        let newHeading = currentRoverData.heading;
        const step = 0.5;

        // Simple movement simulation based on current heading
        const rad = newHeading * Math.PI / 180;
        if (command === 'forward') {
            newX += step * Math.cos(rad);
            newY += step * Math.sin(rad);
        } else if (command === 'backward') {
            newX -= step * Math.cos(rad);
            newY -= step * Math.sin(rad);
        } else if (command === 'left') {
            newHeading = (newHeading - 45 + 360) % 360;
        } else if (command === 'right') {
            newHeading = (newHeading + 45) % 360;
        }

        // Clamp coordinates within field boundaries (0 to FIELD_SIZE)
        currentRoverData.x_m = Math.min(FIELD_SIZE - 0.05, Math.max(0.05, newX)).toFixed(2);
        currentRoverData.y_m = Math.min(FIELD_SIZE - 0.05, Math.max(0.05, newY)).toFixed(2);
        currentRoverData.heading = newHeading;

        // Update UI
        document.getElementById('rover-x').innerText = currentRoverData.x_m;
        document.getElementById('rover-y').innerText = currentRoverData.y_m;
        
        fetchData(lastCommand);
    }, 500);
}

function fetchData(lastCommand = null) {
    let message = 'Rover data refreshed.';
    let healthStatus = 'Good';

    // Simulate new data acquisition if relevant command was sent
    let npk_n = Math.round(50 + Math.random() * 60); // 50 to 110
    let npk_p = Math.round(40 + Math.random() * 50); // 40 to 90
    let npk_k = Math.round(60 + Math.random() * 80); // 60 to 140
    let moisture = Math.round(30 + Math.random() * 50); // 30 to 80

    if (lastCommand === 'read_nav') {
        currentRoverData.latitude = (14.5 + Math.random() * 0.01).toFixed(6);
        currentRoverData.longitude = (121.0 + Math.random() * 0.01).toFixed(6);
        document.getElementById('gpsFix').innerText = '3D Fix';
        document.getElementById('gpsFix').className = 'data-value status-good';
    } else if (lastCommand === 'read_sensors' || lastCommand === 'probe') {
        // Health analysis based on NPK
        healthStatus = analyzeHealth(moisture, npk_n, npk_p, npk_k);

        // Log the new data point
        const newLogEntry = {
            timestamp: new Date().toLocaleTimeString(),
            x_m: currentRoverData.x_m,
            y_m: currentRoverData.y_m,
            moisture: moisture,
            npk_n: npk_n,
            npk_p: npk_p,
            npk_k: npk_k,
            healthStatus: healthStatus
        };
        loggedData.push(newLogEntry);
        
        // Update UI with latest soil readings
        document.getElementById('moistureData').innerText = `${moisture}%`;
        document.getElementById('npkData').innerText = `${npk_n}/${npk_p}/${npk_k}`;
        message = `New soil data logged at (${currentRoverData.x_m}, ${currentRoverData.y_m}). Health: ${healthStatus}.`;
        
        // After logging new data, refresh AI results/maps
        fetchAIResults();
    } else if (lastCommand === 'capture') {
        LAST_PHOTO_STATUS.innerText = 'Success. Image file transferred to Dell Wyse server.';
    }

    // Update Live Nav Data
    document.getElementById('latitudeData').innerText = currentRoverData.latitude;
    document.getElementById('longitudeData').innerText = currentRoverData.longitude;
    document.getElementById('headingData').innerText = currentRoverData.heading + ' deg';

    // Update Maps
    drawMap();
    updateRover3DPosition();
    STATUS_ELEMENT.innerText = message;
    STATUS_ELEMENT.style.color = 'var(--color-status-good)';
}

function analyzeHealth(moisture, npk_n, npk_p, npk_k) {
    const guid = TOMATO_DIAGNOSTIC_LIBRARY.NPK_GUIDELINES;
    let issues = 0;

    // Check critical lows/highs for moisture
    if (moisture < guid.moisture.low_crit || moisture > guid.moisture.high_crit) issues += 3;
    
    // Check critical lows/highs for NPK
    if (npk_n < guid.N.low_crit || npk_n > guid.N.high_crit) issues += 2;
    if (npk_p < guid.P.low_crit || npk_p > guid.P.high_crit) issues += 1;
    if (npk_k < guid.K.low_crit || npk_k > guid.K.high_crit) issues += 1;

    if (issues >= 4) return 'Bad';
    if (issues > 0) return 'Caution';
    return 'Good';
}

function clearMapData(resetRover = true) {
    loggedData = [];
    if (resetRover) {
        currentRoverData.x_m = 2.0;
        currentRoverData.y_m = 2.0;
        currentRoverData.heading = 0;
        document.getElementById('rover-x').innerText = '2.00';
        document.getElementById('rover-y').innerText = '2.00';
    }
    drawMap();
    draw3DMap();
    fetchAIResults(); // Re-run AI analysis (which will now show 'Data Missing')
    STATUS_ELEMENT.innerText = 'Map data cleared.';
}

function drawMap() {
    CTX.clearRect(0, 0, MAP_SIZE, MAP_SIZE);
    CTX.strokeStyle = '#3C3C3C';
    CTX.lineWidth = 1;

    // Draw 1m grid lines
    for (let i = 0; i <= FIELD_SIZE; i++) {
        const p = i * PIXELS_PER_METER;
        CTX.beginPath();
        CTX.moveTo(p, 0);
        CTX.lineTo(p, MAP_SIZE);
        CTX.stroke();
        CTX.beginPath();
        CTX.moveTo(0, p);
        CTX.lineTo(MAP_SIZE, p);
        CTX.stroke();
    }

    // Draw logged data points (Plant zones)
    loggedData.forEach(data => {
        const x_px = data.x_m * PIXELS_PER_METER;
        const y_px = MAP_SIZE - (data.y_m * PIXELS_PER_METER); // Convert Y to canvas coords
        
        CTX.beginPath();
        CTX.arc(x_px, y_px, 12, 0, 2 * Math.PI);
        CTX.fillStyle = getHealthColor(data.healthStatus);
        CTX.fill();
        CTX.strokeStyle = 'white';
        CTX.lineWidth = 2;
        CTX.stroke();
    });

    // Draw Rover (Triangle)
    const rx_px = currentRoverData.x_m * PIXELS_PER_METER;
    const ry_px = MAP_SIZE - (currentRoverData.y_m * PIXELS_PER_METER);
    const angle = currentRoverData.heading * Math.PI / 180;
    const size = 15;

    CTX.save();
    CTX.translate(rx_px, ry_px);
    CTX.rotate(-angle); // Canvas Y is inverted, so use -angle

    CTX.beginPath();
    CTX.moveTo(size, 0);
    CTX.lineTo(-size * 0.5, size * 0.7);
    CTX.lineTo(-size * 0.5, -size * 0.7);
    CTX.closePath();
    
    CTX.fillStyle = '#0078D4'; // Rover color
    CTX.fill();
    CTX.strokeStyle = '#9CDCFE';
    CTX.lineWidth = 2;
    CTX.stroke();
    CTX.restore();
}

function getHealthColor(status) {
    if (status === 'Good') return 'var(--color-status-good)';
    if (status === 'Caution') return 'var(--color-status-caution)';
    if (status === 'Bad') return 'var(--color-status-bad)';
    return '#888888';
}

// --- HISTORY & EXPORT FUNCTIONS (Fully Written) ---
function saveCurrentTrial() {
    const trialId = trialHistory.length + 1;
    const trialName = `Trial ${trialId} - ${new Date().toLocaleString()}`;

    // Get the current NPK calibration settings
    const currentCalibration = {
        N_min: document.getElementById('config-n-min').value,
        N_max: document.getElementById('config-n-max').value,
        P_min: document.getElementById('config-p-min').value,
        P_max: document.getElementById('config-p-max').value,
        K_min: document.getElementById('config-k-min').value,
        K_max: document.getElementById('config-k-max').value,
    };

    const trialData = {
        id: trialId,
        name: trialName,
        timestamp: new Date().toISOString(),
        roverData: { ...currentRoverData },
        loggedData: [...loggedData],
        photoData: { ...photoData },
        aiData: { analysisList: currentRoverData.aiData },
        calibration: currentCalibration
    };

    trialHistory.push(trialData);
    localStorage.setItem('trialHistory', JSON.stringify(trialHistory));
    currentTrialNumber = trialId + 1;
    document.getElementById('currentTrialNumber').innerText = currentTrialNumber;
    STATUS_ELEMENT.innerText = `Trial ${trialId} saved successfully!`;
    STATUS_ELEMENT.style.color = 'var(--color-status-good)';
}

function openHistoryModal() {
    const list = document.getElementById('historyList');
    list.innerHTML = '';
    
    if (trialHistory.length === 0) {
        list.innerHTML = '<li>No trial data saved yet.</li>';
    } else {
        trialHistory.slice().reverse().forEach(trial => { // Display newest first
            const li = document.createElement('li');
            li.innerHTML = `
                <span>${trial.name}</span>
                <button class="move-controls" onclick="loadPastTrial(${trial.id})">Load</button>
            `;
            list.appendChild(li);
        });
    }

    document.getElementById('historyModal').style.display = "block";
}
function closeHistoryModal() { document.getElementById('historyModal').style.display = "none"; }

function loadPastTrial(trialId) {
    const trial = trialHistory.find(t => t.id === trialId);
    if (!trial) return;
    
    // Load Rover Data
    currentRoverData = trial.roverData;
    document.getElementById('latitudeData').innerText = trial.roverData.latitude;
    document.getElementById('longitudeData').innerText = trial.roverData.longitude;
    document.getElementById('headingData').innerText = trial.roverData.heading + ' deg';
    document.getElementById('gpsFix').innerText = 'Historical';
    document.getElementById('gpsFix').className = 'data-value status-caution';
    document.getElementById('rover-x').innerText = trial.roverData.x_m;
    document.getElementById('rover-y').innerText = trial.roverData.y_m;

    // Load NPK Calibration
    document.getElementById('config-n-min').value = trial.calibration.N_min;
    document.getElementById('config-n-max').value = trial.calibration.N_max;
    document.getElementById('config-p-min').value = trial.calibration.P_min;
    document.getElementById('config-p-max').value = trial.calibration.P_max;
    document.getElementById('config-k-min').value = trial.calibration.K_min;
    document.getElementById('config-k-max').value = trial.calibration.K_max;
    applyCalibration(); // Ensure AI logic uses historical calibration

    // Load Logged Data, Maps, and Photos
    loggedData = trial.loggedData;
    drawMap();
    draw3DMap();
    photoData = trial.photoData;
    loadCurrentPhotoData(); // Redraw photo grid

    // Re-render AI Analysis from historical list
    const analysisGrid = document.getElementById('plantAnalysisGrid');
    analysisGrid.innerHTML = '';
    trial.aiData.analysisList.forEach(analysis => {
        const card = `
        <div class="analysis-card ${analysis.healthClass}">
        <div class="plant-id-label">Zone ${analysis.id}</div>
        <div class="data-row">
            <strong>Composite Score:</strong> <span class="data-value">${analysis.score}/100</span>
        </div>
        <div class="data-row">
            <strong>Leaf Analysis:</strong> <span class="data-value">${analysis.visualDiagnosis}</span>
        </div>
        <div class="data-row">
            <strong>Soil Analysis:</strong> <span class="data-value">${analysis.sensorDiagnosis}</span>
        </div>
        <div style="margin-top: 10px;">
            <strong>Recommendation:</strong> <span class="${analysis.healthClass}">${analysis.recommendation}</span>
        </div>
        </div>
        `;
        analysisGrid.insertAdjacentHTML('beforeend', card);
    });

    STATUS_ELEMENT.innerText = `Loaded data for Trial ${trialId}. CURRENT VIEWING HISTORICAL DATA.`;
    STATUS_ELEMENT.style.color = 'var(--color-status-caution)';
    document.getElementById('currentTrialNumber').innerText = `${currentTrialNumber} (Viewing Trial ${trialId})`;
    closeHistoryModal();
}

function clearAllHistory() {
    if (confirm("Are you sure you want to clear ALL saved trial history? This cannot be undone. You will return to Trial 1.")) {
        localStorage.removeItem('trialHistory');
        trialHistory = [];
        currentTrialNumber = 1;
        document.getElementById('currentTrialNumber').innerText = currentTrialNumber;
        closeHistoryModal();
        STATUS_ELEMENT.innerText = "All trial history cleared. Restarting live mode.";
        STATUS_ELEMENT.style.color = 'var(--color-status-good)';
        clearMapData(true); // Also clear current map data
        fetchAIResults();
    }
}

function exportData() {
    if (trialHistory.length === 0) {
        STATUS_ELEMENT.innerText = "Error: No data to export. Save a trial first.";
        STATUS_ELEMENT.style.color = 'var(--color-status-bad)';
        return;
    }

    const dataStr = JSON.stringify(trialHistory, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);

    const exportFileDefaultName = 'PROJECT_SCOUT_History_Export.json';

    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();
    
    STATUS_ELEMENT.innerText = "Data export initiated: PROJECT_SCOUT_History_Export.json";
    STATUS_ELEMENT.style.color = 'var(--color-status-good)';
}

// --- Initialization ---
window.onload = function() {
    initThreeD();
    drawMap();
    generatePhotoGrid();
    populateStockPhotos();
    // Initialize NPK guidelines from the HTML inputs
    applyCalibration(); 
    fetchAIResults();
    startSimulatedTelemetry();
};
</script>
</body>
</html>
