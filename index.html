<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PROJECT SCOUT ‚Äì Post-Flood Crop Assessment Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- =========================
       STYLES (Self-contained)
       ========================= -->
  <style>
    * { box-sizing: border-box; margin:0; padding:0; font-family: Arial, Helvetica, sans-serif; }
    body { background: #0a111a; color: #e4e4e4; display:flex; flex-direction:column; min-height:100vh; }
    h1,h2,h3,h4 { font-weight:600; margin-bottom:10px; }
    p { margin-bottom:10px; line-height:1.5; }
    button { cursor:pointer; }

    /* Layout */
    .layout { display:grid; grid-template-columns:260px 1fr; flex:1; min-height:calc(100vh - 60px); }

    header { background:#112131; color:#fff; padding:15px 25px; display:flex; align-items:center; justify-content:space-between; height:60px; box-shadow:0 2px 4px rgba(0,0,0,0.5); position:sticky; top:0; z-index:100; }
    header h1 { font-size:1.2rem; letter-spacing:1px; }
    header .status { font-size:0.9rem; color:#9fdf9f; font-weight:bold; }

    .sidebar { background:#131c29; padding:20px; border-right:2px solid #1d2c3c; display:flex; flex-direction:column; gap:20px; }
    .sidebar h2 { font-size:1rem; text-transform:uppercase; color:#7fb4ff; }
    .sidebar button { background:#1c2f47; border:none; padding:10px; margin:4px 0; color:#fff; font-size:0.9rem; border-radius:6px; text-align:left; transition:background 0.2s; }
    .sidebar button:hover { background:#2c4f77; }

    .main { padding:20px; overflow-y:auto; display:grid; grid-template-columns:1fr 1fr; grid-gap:20px; }
    .panel { background:#162233; padding:15px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.6); }
    .panel h3 { color:#7fb4ff; margin-bottom:12px; }

    footer { background:#112131; padding:12px 20px; font-size:0.85rem; text-align:center; border-top:2px solid #1d2c3c; }

    /* Photo Grid */
    #photoGridContainer div { cursor:pointer; transition:0.2s; }
    #photoGridContainer div:hover { border-color:#7fb4ff; }
  </style>
</head>
<body>

  <!-- =========================
       HEADER
       ========================= -->
  <header>
    <h1>PROJECT SCOUT ‚Äì Post-Flood Crop Assessment</h1>
    <div class="status" id="status">Initializing...</div>
  </header>

  <!-- =========================
       LAYOUT
       ========================= -->
  <div class="layout">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <h2>Navigation</h2>
      <button onclick="scrollToSection('roverControls')">Rover Controls</button>
      <button onclick="scrollToSection('photoGrid')">Photo Grid</button>
      <button onclick="scrollToSection('stockGallery')">Stock Gallery</button>
      <button onclick="scrollToSection('manualEntry')">Manual Entry</button>
      <button onclick="scrollToSection('mapSection')">2D Map</button>
      <button onclick="scrollToSection('threeDSection')">3D Plants</button>
      <button onclick="scrollToSection('analysisSection')">Analysis</button>
      <button onclick="scrollToSection('logs')">Logs</button>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <!-- =========================
           ROVER CONTROLS
           ========================= -->
      <section class="panel" id="roverControls">
        <h3>Rover Controls</h3>
        <p>Use these buttons to move the rover and operate the probe arm.</p>
        <div style="display:flex;flex-wrap:wrap;gap:10px">
          <button onclick="sendCommandToESP32('forward')">‚¨Ü Forward</button>
          <button onclick="sendCommandToESP32('backward')">‚¨á Backward</button>
          <button onclick="sendCommandToESP32('left')">‚¨Ö Left</button>
          <button onclick="sendCommandToESP32('right')">‚û° Right</button>
          <button onclick="sendCommandToESP32('stop')">‚èπ Stop</button>
          <button onclick="sendCommandToESP32('probe_up')">üîº Probe Up</button>
          <button onclick="sendCommandToESP32('probe_down')">üîΩ Probe Down</button>
          <button onclick="fetchSensorData()">üì° Read Sensors</button>
        </div>
      </section>

      <!-- =========================
           PHOTO GRID
           ========================= -->
      <section class="panel" id="photoGrid">
        <h3>Zone Photo Grid (16 zones)</h3>
        <p>Upload field images per zone for analysis. Each square represents a zone.</p>
        <div id="photoGridContainer" style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;"></div>
      </section>

      <!-- =========================
           STOCK GALLERY
           ========================= -->
      <section class="panel" id="stockGallery">
        <h3>Stock Gallery</h3>
        <p>Upload and manage stock images separately.</p>
        <input type="file" accept="image/*" multiple onchange="handleStockUpload(event)" />
        <div id="stockGrid" style="display:grid;grid-template-columns:repeat(5,1fr);gap:6px;margin-top:10px"></div>
      </section>

      <!-- =========================
           MANUAL ENTRY
           ========================= -->
      <section class="panel" id="manualEntry">
        <h3>Manual Data Entry</h3>
        <form onsubmit="submitManualEntry();return false;" style="display:flex;flex-direction:column;gap:8px;max-width:300px">
          <label>Zone: <input id="manual_zone" type="number" min="1" max="16" value="1" required></label>
          <label>Soil Moisture (%): <input id="manual_moisture" type="number" min="0" max="100"></label>
          <label>Nitrogen (N): <input id="manual_n" type="number" min="0" max="200"></label>
          <label>Phosphorus (P): <input id="manual_p" type="number" min="0" max="200"></label>
          <label>Potassium (K): <input id="manual_k" type="number" min="0" max="200"></label>
          <label>Upload Photo: <input id="manual_photo" type="file" accept="image/*"></label>
          <button type="submit" style="background:#2c4f77;color:#fff;padding:10px;border:none;border-radius:6px">
            ‚ûï Submit Manual Entry
          </button>
        </form>
      </section>

      <!-- =========================
           2D MAP
           ========================= -->
      <section class="panel" id="mapSection">
        <h3>2D Field Map</h3>
        <canvas id="mapCanvas" width="600" height="600" style="border:1px solid #333;border-radius:10px;background:#0f1722"></canvas>
        <p style="font-size:0.8rem;color:#aaa;margin-top:6px">Hover over a circle to view zone details.</p>
      </section>

      <!-- =========================
           3D PLANTS
           ========================= -->
      <section class="panel" id="threeDSection">
        <h3>3D Tomato Plant Visualization</h3>
        <div id="threeDContainer" style="width:100%;height:500px;border:1px solid #333;border-radius:10px"></div>
      </section>

      <!-- =========================
           ANALYSIS
           ========================= -->
      <section class="panel" id="analysisSection">
        <h3>AI-Based Analysis Results</h3>
        <div id="analysisGrid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px;margin-bottom:15px"></div>
        <div id="aiAnalysis" style="background:#0f1722;padding:12px;border-radius:8px;font-size:0.9rem;line-height:1.4;white-space:pre-wrap;min-height:150px">
          No zone selected. Click on a zone card above to see detailed analysis.
        </div>
      </section>

      <!-- =========================
           LOGS
           ========================= -->
      <section class="panel" id="logs">
        <h3>System Logs</h3>
        <div id="log" style="background:#0f1722;padding:10px;border-radius:8px;max-height:200px;overflow-y:auto;font-size:0.85rem;line-height:1.3"></div>
      </section>
    </main>
  </div>

  <footer>
    PROJECT SCOUT ‚Ä¢ ESP32: 10.101.146.88 ‚Ä¢ ThingSpeak Key: 6OXH3SUQ4VNSOJX1
  </footer>

  <!-- =========================
       SCRIPTS
       ========================= -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.12.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.155.0/build/three.min.js"></script>

  <script>
  /* ============================================================
     GLOBAL VARIABLES
     ============================================================ */
  const ESP32_IP = "10.101.146.88";
  const THINGSPEAK_KEY = "6OXH3SUQ4VNSOJX1";
  const ZONES = 16;
  let photos = {};
  let stockGallery = {};
  let sensorLogs = [];
  let latestAnalysis = {};

  /* ============================================================
     LOGGING
     ============================================================ */
  function log(msg) {
    const d = document.createElement("div");
    d.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
    document.getElementById("log").prepend(d);
    console.log(msg);
  }

  /* ============================================================
     FILE READING
     ============================================================ */
  function readFileAsDataURL(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  /* ============================================================
     PHOTO GRID
     ============================================================ */
  function generatePhotoGrid() {
    const grid = document.getElementById("photoGridContainer");
    grid.innerHTML = "";
    for(let zone=1; zone<=ZONES; zone++){
      const cell = document.createElement("div");
      cell.style.position="relative";
      cell.style.border="1px solid #2c3e50";
      cell.style.borderRadius="6px";
      cell.style.overflow="hidden";
      cell.style.height="100px";
      cell.style.background="#0f1722";
      cell.style.display="flex"; cell.style.alignItems="center"; cell.style.justifyContent="center";
      cell.dataset.zone=zone;

      const label = document.createElement("div");
      label.innerText = "Zone "+zone;
      label.style.position="absolute"; label.style.top="2px"; label.style.left="4px";
      label.style.fontSize="0.8rem"; label.style.background="rgba(0,0,0,0.5)"; label.style.padding="1px 3px"; label.style.borderRadius="4px";
      cell.appendChild(label);

      const input = document.createElement("input");
      input.type="file"; input.accept="image/*";
      input.style.position="absolute"; input.style.opacity="0"; input.style.width="100%"; input.style.height="100%";
      input.onchange = async (e)=>{
        const f = e.target.files[0]; if(!f) return;
        const b64 = await readFileAsDataURL(f); photos[zone]=b64; log("Photo uploaded for Zone "+zone); generatePhotoGrid(); triggerAnalysis();
      };
      cell.appendChild(input);

      if(photos[zone]){
        const img=document.createElement("img");
        img.src=photos[zone]; img.style.width="100%"; img.style.height="100%"; img.style.objectFit="cover";
        cell.appendChild(img);

        const del=document.createElement("button");
        del.innerText="√ó"; del.style.position="absolute"; del.style.top="2px"; del.style.right="2px";
        del.style.background="rgba(255,0,0,0.7)"; del.style.border="none"; del.style.borderRadius="4px"; del.style.color="#fff"; del.style.padding="2px 6px";
        del.onclick=(ev)=>{ ev.stopPropagation(); delete photos[zone]; log("Deleted photo for Zone "+zone); generatePhotoGrid(); };
        cell.appendChild(del);
      }
      grid.appendChild(cell);
    }
  }

  /* ============================================================
     STOCK GALLERY
     ============================================================ */
  function handleStockUpload(event){
    for(const f of event.target.files){
      readFileAsDataURL(f).then((b64)=>{
        const id=Object.keys(stockGallery).length+1;
        stockGallery[id]={id,url:b64,name:f.name};
        log("Added stock image: "+f.name);
        renderStockGrid();
      });
    }
  }
  function renderStockGrid(){
    const g=document.getElementById("stockGrid"); g.innerHTML="";
    for(const id in stockGallery){
      const it=stockGallery[id];
      const img=document.createElement("img");
      img.src=it.url; img.title=it.name; img.style.width="100%"; img.style.borderRadius="6px";
      g.appendChild(img);
    }
  }

  /* ============================================================
     MANUAL ENTRY
     ============================================================ */
  function submitManualEntry(){
    const zone=parseInt(document.getElementById("manual_zone").value);
    const moisture=parseFloat(document.getElementById("manual_moisture").value);
    const n=parseFloat(document.getElementById("manual_n").value);
    const p=parseFloat(document.getElementById("manual_p").value);
    const k=parseFloat(document.getElementById("manual_k").value);
    const photoInput=document.getElementById("manual_photo");
    const photoFile=photoInput.files[0];

    let photoPromise=Promise.resolve(null);
    if(photoFile) photoPromise=readFileAsDataURL(photoFile);

    photoPromise.then((b64)=>{
      sensorLogs.push({zone,moisture,n,p,k,photo:b64,timestamp:new Date()});
      if(b64) photos[zone]=b64;
      log(`Manual entry submitted for Zone ${zone}`);
      generatePhotoGrid(); photoInput.value=""; triggerAnalysis();
    });
  }

  /* ============================================================
     ROVER COMMANDS
     ============================================================ */
  async function sendCommandToESP32(cmd){
    try{
      const res=await fetch(`http://${ESP32_IP}/${cmd}`);
      if(res.ok){ log(`Command sent: ${cmd}`); document.getElementById("status").innerText=`Last command: ${cmd}`; }
      else log(`Failed command: ${cmd}`);
    }catch(err){ log(`Error sending command: ${cmd} (${err})`); }
  }
  async function fetchSensorData(){
    try{
      const res=await fetch(`http://${ESP32_IP}/sensors`);
      const data=await res.json(); log(`Sensor data: ${JSON.stringify(data)}`);
    }catch(err){ log("Error fetching sensor data: "+err); }
  }

  /* ============================================================
     2D MAP
     ============================================================ */
  function renderMap(){
    const canvas=document.getElementById("mapCanvas"); const ctx=canvas.getContext("2d");
    ctx.clearRect(0,0,canvas.width,canvas.height);
    const radius=25, padding=40, cols=4;
    for(let i=0;i<ZONES;i++){
      const col=i%cols, row=Math.floor(i/cols);
      const x=padding+col*(radius*3), y=padding+row*(radius*3);
      let color="#4caf50";
      if(sensorLogs[i]&&sensorLogs[i].moisture<40) color="#ffc107";
      if(sensorLogs[i]&&sensorLogs[i].moisture<20) color="#f44336";
      ctx.beginPath(); ctx.arc(x,y,radius,0,Math.PI*2); ctx.fillStyle=color; ctx.fill(); ctx.strokeStyle="#222"; ctx.stroke();
      canvas._zones=canvas._zones||[]; canvas._zones[i]={x,y,radius,zone:i+1};
    }
  }

  const tooltip=document.createElement("div");
  tooltip.style.position="absolute"; tooltip.style.padding="4px 8px"; tooltip.style.background="rgba(0,0,0,0.8)";
  tooltip.style.color="#fff"; tooltip.style.borderRadius="4px"; tooltip.style.pointerEvents="none"; tooltip.style.fontSize="0.8rem"; tooltip.style.display="none";
  document.body.appendChild(tooltip);
  document.getElementById("mapCanvas").addEventListener("mousemove",(e)=>{
    const rect=e.target.getBoundingClientRect(); const x=e.clientX-rect.left; const y=e.clientY-rect.top; let found=false;
    if(e.target._zones) for(const z of e.target._zones){
      const dx=x-z.x,dy=y-z.y; if(Math.sqrt(dx*dx+dy*dy)<z.radius){ tooltip.innerText="Zone "+z.zone; tooltip.style.left=e.clientX+8+"px"; tooltip.style.top=e.clientY+8+"px"; tooltip.style.display="block"; found=true; break; }
    }
    if(!found) tooltip.style.display="none";
  });

  /* ============================================================
     3D PLANTS
     ============================================================ */
  let scene,camera,renderer,plantGroup;
  function init3DPlants(){
    const container=document.getElementById("threeDContainer");
    scene=new THREE.Scene(); scene.background=new THREE.Color(0x0f1722);
    camera=new THREE.PerspectiveCamera(45,container.clientWidth/container.clientHeight,0.1,1000); camera.position.set(0,50,100);
    renderer=new THREE.WebGLRenderer({antialias:true}); renderer.setSize(container.clientWidth,container.clientHeight); container.appendChild(renderer.domElement);
    const light=new THREE.DirectionalLight(0xffffff,1); light.position.set(50,100,50); scene.add(light);
    scene.add(new THREE.AmbientLight(0x888888));
    plantGroup=new THREE.Group(); scene.add(plantGroup);
    for(let z=1;z<=ZONES;z++){
      const stemGeo=new THREE.CylinderGeometry(0.5,0.5,6,6); const stemMat=new THREE.MeshStandardMaterial({color:0x228B22});
      const stem=new THREE.Mesh(stemGeo,stemMat);
      stem.position.set((z-1)%4*10,3,Math.floor((z-1)/4)*10);
      const leafGeo=new THREE.SphereGeometry(1.5,6,6); const leafMat=new THREE.MeshStandardMaterial({color:0x32CD32});
      const leaf=new THREE.Mesh(leafGeo,leafMat); leaf.position.set(stem.position.x,5,stem.position.z);
      plantGroup.add(stem); plantGroup.add(leaf);
    }
    animate3D();
  }
  function animate3D(){ requestAnimationFrame(animate3D); renderer.render(scene,camera); }

  /* ============================================================
     ANALYSIS ENGINE
     ============================================================ */
  function analyzePlantHealthFromPhoto(base64Img){
    return new Promise((resolve)=>{
      if(!base64Img) return resolve({health:"Unknown",greenRatio:0});
      const img=new Image(); img.src=base64Img; img.onload=()=>{
        const c=document.createElement("canvas"); c.width=img.width; c.height=img.height;
        const ctx=c.getContext("2d"); ctx.drawImage(img,0,0);
        const data=ctx.getImageData(0,0,img.width,img.height).data;
        let greenSum=0,pixelCount=0;
        for(let i=0;i<data.length;i+=4){
          const r=data[i],g=data[i+1],b=data[i+2];
          if(g>r+b) greenSum++; pixelCount++;
        }
        const greenRatio=greenSum/pixelCount; let health="Severe";
        if(greenRatio>0.4) health="Healthy"; else if(greenRatio>0.2) health="Moderate";
        resolve({health,greenRatio:Math.round(greenRatio*100)});
      }; img.onerror=()=>resolve({health:"Unknown",greenRatio:0});
    });
  }
  function calculateFloodSeverity(moisture){
    if(moisture===null||moisture===undefined) return "Unknown";
    if(moisture>60) return "Low"; if(moisture>40) return "Moderate"; return "High";
  }
  async function analyzeZone(zone){
    const photo=photos[zone]; const sensor=sensorLogs[zone-1]||{};
    const moisture=sensor.moisture??Math.floor(Math.random()*100);
    const photoAnalysis=await analyzePlantHealthFromPhoto(photo);
    const floodSeverity=calculateFloodSeverity(moisture);
    latestAnalysis[zone]={zone,moisture,health:photoAnalysis.health,greenRatio:photoAnalysis.greenRatio,floodSeverity,recommendation:photoAnalysis.health==="Healthy"?"No immediate action required":"Inspect plants, consider irrigation or drainage"};
    return latestAnalysis[zone];
  }

  async function triggerAnalysis(){
    const grid=document.getElementById("analysisGrid"); grid.innerHTML="";
    for(let zone=1;zone<=ZONES;zone++){
      const card=document.createElement("div"); card.style.background="#1b2a3c"; card.style.padding="8px"; card.style.borderRadius="6px"; card.style.cursor="pointer"; card.style.textAlign="center"; card.innerText=`Zone ${zone}`;
      card.onclick=async()=>{
        const result=await analyzeZone(zone);
        document.getElementById("aiAnalysis").innerText=
          `Zone ${zone} Analysis:\n- Moisture: ${result.moisture}%\n- Plant Health: ${result.health}\n- Green Coverage: ${result.greenRatio || "N/A"}%\n- Flood Severity: ${result.floodSeverity}\n- Recommendation: ${result.recommendation}\n\nObservations:\nThe system indicates ${result.health.toLowerCase()} plant conditions in this zone.`+
          (result.floodSeverity==="High"?" Likely affected by post-flood stress.":" Minimal flood impact detected.");
      };
      grid.appendChild(card);
    }
    renderMap();
  }

  /* ============================================================
     ThingSpeak Upload
     ============================================================ */
  async function pushToThingSpeak(zone){
    const data=latestAnalysis[zone]; if(!data) return;
    const url=`https://api.thingspeak.com/update.json?api_key=${THINGSPEAK_KEY}&field1=${data.zone}&field2=${data.moisture}&field3=${data.health}&field4=${data.floodSeverity}`;
    try{ const res=await fetch(url,{method:"POST"}); if(res.ok) log(`ThingSpeak updated for Zone ${zone}`); else log(`ThingSpeak failed for Zone ${zone}`); }catch(err){ log(`Error pushing to ThingSpeak: ${err}`); }
  }

  function scrollToSection(id){ document.getElementById(id).scrollIntoView({behavior:"smooth"}); }

  /* ============================================================
     INITIALIZATION
     ============================================================ */
  window.onload=()=>{
    log("PROJECT SCOUT Dashboard Initialized");
    generatePhotoGrid(); triggerAnalysis(); renderMap(); init3DPlants();
    document.getElementById("status").innerText="Dashboard Ready";
  };
  </script>
</body>
</html>
