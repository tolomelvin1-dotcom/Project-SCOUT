<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PROJECT SCOUT ‚Äì Crop Assessment Dashboard</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r152/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.152.0/examples/js/controls/OrbitControls.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:Arial,sans-serif;}
body{background:#0a111a;color:#e4e4e4;display:flex;flex-direction:column;min-height:100vh;}
header{background:#112131;padding:15px 25px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:100;box-shadow:0 2px 4px rgba(0,0,0,0.5);}
header h1{font-size:1.2rem;}
header .status{font-size:0.9rem;color:#9fdf9f;font-weight:bold;}
.layout{display:grid;grid-template-columns:260px 1fr;flex:1;min-height:calc(100vh - 60px);}
.sidebar{background:#131c29;padding:20px;border-right:2px solid #1d2c3c;display:flex;flex-direction:column;gap:15px;}
.sidebar h2{font-size:1rem;text-transform:uppercase;color:#7fb4ff;margin-bottom:8px;}
.sidebar button{background:#1c2f47;border:none;padding:10px;color:#fff;border-radius:6px;text-align:left;transition:0.2s;}
.sidebar button:hover{background:#2c4f77;}
main{padding:20px;overflow-y:auto;display:grid;grid-template-columns:1fr;grid-gap:20px;}
.panel{background:#162233;padding:15px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,0.6);}
.panel h3{color:#7fb4ff;margin-bottom:10px;}
button.btn{background:#2c4f77;color:#fff;padding:8px 12px;border:none;border-radius:6px;margin:2px;}
button.btn:hover{background:#3e68a1;}
input,select{padding:6px;border-radius:4px;border:none;background:#1c2f47;color:#fff;width:100%;}
.photo-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;}
.photo-cell{position:relative;border:1px solid #2c3e50;border-radius:6px;height:100px;overflow:hidden;display:flex;align-items:center;justify-content:center;background:#0f1722;}
.photo-cell img{width:100%;height:100%;object-fit:cover;}
#stockGrid{display:grid;grid-template-columns:repeat(5,1fr);gap:6px;margin-top:10px;}
#stockGrid img{width:100%;border-radius:6px;}
#mapCanvas{border:1px solid #333;border-radius:10px;background:#0f1722;width:100%;height:400px;}
#threeDContainer{width:100%;height:500px;border:1px solid #333;border-radius:10px;}
#analysisGrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px;margin-bottom:15px;}
#aiAnalysis{background:#0f1722;padding:12px;border-radius:8px;font-size:0.9rem;line-height:1.4;white-space:pre-wrap;min-height:120px;}
#log{background:#0f1722;padding:10px;border-radius:8px;max-height:200px;overflow-y:auto;font-size:0.85rem;line-height:1.3;}
footer{background:#112131;padding:12px 20px;font-size:0.85rem;text-align:center;border-top:2px solid #1d2c3c;}
@media(max-width:900px){.layout{grid-template-columns:1fr;}.sidebar{flex-direction:row;overflow-x:auto;}.sidebar button{flex:1;}}
</style>
</head>
<body>
<header>
  <h1>PROJECT SCOUT ‚Äì Crop Assessment</h1>
  <div class="status" id="status">Initializing...</div>
</header>

<div class="layout">
<aside class="sidebar">
<h2>Navigation</h2>
<button onclick="scrollToSection('roverControls')">Rover Controls</button>
<button onclick="scrollToSection('photoGrid')">Photo Grid</button>
<button onclick="scrollToSection('stockGallery')">Stock Gallery</button>
<button onclick="scrollToSection('manualEntry')">Manual Entry</button>
<button onclick="scrollToSection('mapSection')">2D Map</button>
<button onclick="scrollToSection('threeDSection')">3D Plants</button>
<button onclick="scrollToSection('analysisSection')">Analysis</button>
<button onclick="scrollToSection('logs')">Logs</button>
</aside>

<main>
<section class="panel" id="roverControls">
<h3>Rover Controls</h3>
<p>Move the rover and operate the probe.</p>
<div>
<button class="btn" onclick="sendCommand('forward')">‚¨Ü Forward</button>
<button class="btn" onclick="sendCommand('backward')">‚¨á Backward</button>
<button class="btn" onclick="sendCommand('left')">‚¨Ö Left</button>
<button class="btn" onclick="sendCommand('right')">‚û° Right</button>
<button class="btn" onclick="sendCommand('stop')">‚èπ Stop</button>
<button class="btn" onclick="sendCommand('probe_up')">üîº Probe Up</button>
<button class="btn" onclick="sendCommand('probe_down')">üîΩ Probe Down</button>
<button class="btn" onclick="fetchSensorData()">üì° Read Sensors</button>
</div>
</section>

<section class="panel" id="photoGrid">
<h3>Zone Photo Grid (16 zones)</h3>
<p>Upload images per zone.</p>
<div id="photoGridContainer" class="photo-grid"></div>
</section>

<section class="panel" id="stockGallery">
<h3>Stock Gallery</h3>
<input type="file" accept="image/*" multiple onchange="handleStockUpload(event)">
<div id="stockGrid"></div>
</section>

<section class="panel" id="manualEntry">
<h3>Manual Data Entry</h3>
<form onsubmit="submitManualEntry();return false;" style="display:grid; gap:10px; max-width:300px;">
<label>Zone: <input type="number" id="manual_zone" min="1" max="16" required></label>
<label>Soil Moisture (%): <input type="number" id="manual_moisture" min="0" max="100"></label>
<label>Nitrogen (N): <input type="number" id="manual_n" min="0" max="200"></label>
<label>Phosphorus (P): <input type="number" id="manual_p" min="0" max="200"></label>
<label>Potassium (K): <input type="number" id="manual_k" min="0" max="200"></label>
<label>Upload Photo: <input type="file" id="manual_photo" accept="image/*"></label>
<button class="btn" type="submit">‚ûï Submit Manual Entry</button>
</form>
</section>

<section class="panel" id="mapSection">
<h3>2D Field Map</h3>
<p>Each circle represents soil condition: size & color reflect moisture/NPK.</p>
<canvas id="mapCanvas"></canvas>
</section>

<section class="panel" id="threeDSection">
<h3>3D Tomato Plant Visualization</h3>
<p>16 plants: stem + leaves, color reflects health.</p>
<div id="threeDContainer"></div>
</section>

<section class="panel" id="analysisSection">
<h3>AI-Based Analysis</h3>
<div id="analysisGrid"></div>
<div id="aiAnalysis">No zone selected.</div>
</section>

<section class="panel" id="logs">
<h3>System Logs</h3>
<div id="log"></div>
</section>
</main>
</div>

<footer>
PROJECT SCOUT ‚Ä¢ ESP32: 10.101.146.88 ‚Ä¢ ThingSpeak Key: 6OXH3SUQ4VNSOJX1
</footer>

<script>
const ESP32_IP="10.101.146.88";
const THINGSPEAK_KEY="6OXH3SUQ4VNSOJX1";
const ZONES=16;
let photos={}, stockGallery={}, sensorLogs=[], latestAnalysis={};

function log(msg){const d=document.createElement("div"); d.innerText=`[${new Date().toLocaleTimeString()}] ${msg}`; document.getElementById("log").prepend(d); console.log(msg);}
function readFileAsDataURL(file){return new Promise((res,reject)=>{const r=new FileReader();r.onload=()=>res(r.result);r.onerror=reject;r.readAsDataURL(file);});}

function generatePhotoGrid(){
  const grid=document.getElementById("photoGridContainer"); grid.innerHTML="";
  for(let z=1;z<=ZONES;z++){
    const cell=document.createElement("div"); cell.className="photo-cell"; cell.dataset.zone=z;
    const label=document.createElement("div"); label.innerText="Zone "+z; label.style.position="absolute"; label.style.top="2px"; label.style.left="4px"; label.style.fontSize="0.8rem"; label.style.background="rgba(0,0,0,0.5)"; label.style.padding="1px 3px"; label.style.borderRadius="4px"; cell.appendChild(label);
    const input=document.createElement("input"); input.type="file"; input.accept="image/*"; input.style.position="absolute"; input.style.width="100%"; input.style.height="100%"; input.style.opacity="0";
    input.onchange=async(e)=>{const f=e.target.files[0]; if(!f) return; const b64=await readFileAsDataURL(f); photos[z]=b64; log("Photo uploaded for Zone "+z); generatePhotoGrid(); triggerAnalysis();};
    cell.appendChild(input);
    if(photos[z]){const img=document.createElement("img"); img.src=photos[z]; cell.appendChild(img);
      const del=document.createElement("button"); del.innerText="√ó"; del.style.position="absolute"; del.style.top="2px"; del.style.right="2px"; del.style.background="rgba(255,0,0,0.7)"; del.style.border="none"; del.style.borderRadius="4px"; del.style.color="#fff"; del.style.padding="2px 6px"; del.onclick=(ev)=>{ev.stopPropagation(); delete photos[z]; log("Deleted photo for Zone "+z); generatePhotoGrid();}; cell.appendChild(del);}
    grid.appendChild(cell);
  }
}

function handleStockUpload(event){for(const f of event.target.files){readFileAsDataURL(f).then(b64=>{const id=Object.keys(stockGallery).length+1; stockGallery[id]={id,url:b64,name:f.name}; log("Added stock image: "+f.name); renderStockGrid();});}}
function renderStockGrid(){const g=document.getElementById("stockGrid"); g.innerHTML=""; for(const id in stockGallery){const it=stockGallery[id]; const img=document.createElement("img"); img.src=it.url; img.title=it.name; g.appendChild(img);}}

function submitManualEntry(){const zone=parseInt(document.getElementById("manual_zone").value); const moisture=parseFloat(document.getElementById("manual_moisture").value)||0; const n=parseFloat(document.getElementById("manual_n").value)||0; const p=parseFloat(document.getElementById("manual_p").value)||0; const k=parseFloat(document.getElementById("manual_k").value)||0; const photoInput=document.getElementById("manual_photo"); const photoFile=photoInput.files[0]; let photoPromise=Promise.resolve(null); if(photoFile) photoPromise=readFileAsDataURL(photoFile); photoPromise.then(b64=>{sensorLogs[zone-1]={zone,moisture,n,p,k,photo:b64,timestamp:new Date()}; if(b64) photos[zone]=b64; log(`Manual entry submitted for Zone ${zone}`); generatePhotoGrid(); photoInput.value=""; triggerAnalysis();});}

async function sendCommand(cmd){try{const res=await fetch(`http://${ESP32_IP}/${cmd}`); if(res.ok){log("Command sent: "+cmd); document.getElementById("status").innerText=`Last command: ${cmd}`;} else log("Failed command: "+cmd);} catch(err){log(`Error sending command: ${cmd} (${err})`);}}

async function fetchSensorData(){try{const res=await fetch(`http://${ESP32_IP}/sensors`); const data=await res.json(); log("Sensor data: "+JSON.stringify(data));}catch(err){log("Error fetching sensor data: "+err);}}

const canvas=document.getElementById("mapCanvas"); const ctx=canvas.getContext("2d"); canvas.width=canvas.clientWidth; canvas.height=canvas.clientHeight;
function renderMap(){ctx.clearRect(0,0,canvas.width,canvas.height); const radius=20; const paddingX=50; const paddingY=50; const cols=4; const rows=4; canvas._zones=[]; for(let i=0;i<ZONES;i++){const col=i%cols; const row=Math.floor(i/cols); const x=paddingX+col*100; const y=paddingY+row*100; ctx.beginPath(); ctx.arc(x,y,radius,0,Math.PI*2); ctx.fillStyle="#555"; ctx.fill(); ctx.strokeStyle="#222"; ctx.stroke(); canvas._zones[i]={x,y,radius,zone:i+1};}}

function scrollToSection(id){document.getElementById(id).scrollIntoView({behavior:"smooth"});}

/* ================== 3D ================== */
let scene,camera,renderer,controls,plantGroup=[];
function init3D(){
  const container=document.getElementById("threeDContainer"); scene=new THREE.Scene(); scene.background=new THREE.Color(0x0a111a);
  camera=new THREE.PerspectiveCamera(45,container.clientWidth/container.clientHeight,0.1,200); camera.position.set(20,30,40);
  renderer=new THREE.WebGLRenderer({antialias:true}); renderer.setSize(container.clientWidth,container.clientHeight); container.appendChild(renderer.domElement);
  controls=new THREE.OrbitControls(camera,renderer.domElement); controls.enableDamping=true;
  const light=new THREE.DirectionalLight(0xffffff,1); light.position.set(50,50,50); scene.add(light); scene.add(new THREE.AmbientLight(0xaaaaaa,0.5));
  for(let z=0; z<ZONES; z++){
    const stemGeom=new THREE.CylinderGeometry(0.2,0.2,3,8);
    const stemMat=new THREE.MeshStandardMaterial({color:0x228833});
    const stem=new THREE.Mesh(stemGeom,stemMat);
    stem.position.set((z%4)*3,1.5,Math.floor(z/4)*3);
    const leafGeom=new THREE.SphereGeometry(0.5,8,6);
    const leafMat=new THREE.MeshStandardMaterial({color:0x228833});
    const leaf=new THREE.Mesh(leafGeom,leafMat); leaf.position.set(0,2.2,0); stem.add(leaf);
    scene.add(stem); plantGroup[z]=stem;
  }
  animate3D();
}
function animate3D(){requestAnimationFrame(animate3D); controls.update(); renderer.render(scene,camera);}
function update3DColor(zone,score){const plant=plantGroup[zone-1]; if(!plant) return; let color=0x228833; if(score<40) color=0xff2222; else if(score<70) color=0xffaa22; plant.material.color.setHex(color); plant.children[0].material.color.setHex(color);}

/* ================== ANALYSIS ================== */
function triggerAnalysis(){
  const grid=document.getElementById("analysisGrid"); grid.innerHTML="";
  for(let z=1; z<=ZONES; z++){
    const card=document.createElement("div"); card.style.background="#1b2a3c"; card.style.padding="8px"; card.style.borderRadius="6px"; card.style.cursor="pointer"; card.style.textAlign="center"; card.innerText=`Zone ${z}`;
    card.onclick=()=>{
      const entry=sensorLogs[z-1]||{moisture:0,n:0,p:0,k:0}; const {moisture,n,p,k}=entry;
      const healthScore=Math.round((moisture*0.4 + n*0.2 + p*0.2 + k*0.2));
      let rec="Keep monitoring."; if(healthScore<40) rec="Severe flood damage. Consider replant & fertilizer."; else if(healthScore<70) rec="Moderate stress. Apply nutrients & check drainage."; else rec="Healthy. Maintain regular care.";
      document.getElementById("aiAnalysis").innerText=`Zone ${z} Analysis:\nMoisture: ${moisture}%\nN: ${n} P: ${p} K: ${k}\nHealth Score: ${healthScore}\nRecommendation: ${rec}`;
      latestAnalysis[z]={moisture,n,p,k,healthScore,recommendation:rec};
      update3DColor(z,healthScore); updateMapColors();
    };
    grid.appendChild(card);
  }
}

function updateMapColors(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const radiusBase=15; const cols=4; const rows=4;
  for(let i=0;i<ZONES;i++){
    const col=i%cols; const row=Math.floor(i/cols);
    const x=50+col*100; const y=50+row*100;
    ctx.beginPath(); ctx.arc(x,y,radiusBase,0,Math.PI*2);
    const entry=latestAnalysis[i+1]||{healthScore:0,moisture:0}; const score=entry.healthScore; const moisture=entry.moisture;
    ctx.fillStyle=score<40?"#ff2222":score<70?"#ffaa22":"#22ff33";
    ctx.globalAlpha=0.5+0.5*(moisture/100); ctx.fill(); ctx.globalAlpha=1;
    ctx.strokeStyle="#222"; ctx.stroke();
  }
}

/* ================== INIT ================== */
window.onload=()=>{
  document.getElementById("status").innerText="Dashboard Ready";
  generatePhotoGrid(); renderStockGrid(); renderMap(); init3D(); triggerAnalysis(); log("Dashboard initialized.");
};
</script>
</body>
</html>
