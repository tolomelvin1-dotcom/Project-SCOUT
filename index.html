<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S.C.O.U.T. Rover Mapping & Control (Enhanced 3D View)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/controls/OrbitControls.js"></script> 
    <style>
        /* BASE STYLING (Dark Theme) */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background-color: #1e1e1e; color: #d4d4d4; }
        .container { max-width: 1700px; margin: auto; background: #2d2d30; padding: 25px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.5); display: flex; flex-wrap: wrap; }
        
        /* LAYOUT PANELS */
        .controls-panel { flex: 1; min-width: 350px; padding-right: 20px; }
        .map-panel { flex: 1; min-width: 450px; }
        .photo-panel { flex: 1; min-width: 450px; padding-left: 20px; border-left: 1px solid #3c3c3c; } 
        .map-3d-panel { flex: 1; min-width: 450px; margin-top: 20px; }
        
        /* TYPOGRAPHY & HEADERS */
        h1 { color: #569cd6; border-bottom: 3px solid #3c3c3c; padding-bottom: 10px; }
        h2 { color: #4ec9b0; margin-top: 20px; }
        h3 { color: #c8c8c8; margin-top: 10px; }
        #status { font-weight: bold; color: #ffcc00; }

        /* BUTTONS */
        button { padding: 10px 15px; margin: 8px 5px; cursor: pointer; border: none; border-radius: 6px; font-weight: bold; transition: background-color 0.2s; }
        .move-controls button { background-color: #569cd6; color: white; }
        .arm-controls button { background-color: #6a9955; color: white; }
        .camera-control button { background-color: #ce4257; color: white; }
        .history-controls button { background-color: #ff9900; color: white; }
        
        /* DATA DISPLAY */
        .data-display { margin-top: 20px; padding: 15px; border: 1px solid #3c3c3c; border-radius: 6px; background-color: #252526; }
        .data-row strong { display: inline-block; width: 140px; color: #9cdcfe; }
        
        /* CANVAS MAP (2D) */
        #roverMap { border: 3px solid #6a9955; background-color: #3d3d3d; display: block; margin: 20px auto 0; }

        /* 3D MAP CANVAS */
        #threeDContainer { 
            width: 450px; 
            height: 450px; 
            border: 3px solid #569cd6; 
            background-color: #1a1a1a; 
            margin: 20px auto 0;
            display: block;
        }
        .three-d-controls { 
            margin-top: 10px; 
            display: flex; 
            align-items: center; 
            justify-content: center;
        }

        /* 4x4 PHOTO GRID STYLES (No changes needed here) */
        #photoGrid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(4, 1fr);
            gap: 5px;
            border: 2px solid #569cd6;
            max-width: 450px;
            margin: 20px auto;
            aspect-ratio: 1 / 1; 
            background-color: #252526;
        }
        .grid-cell {
            background-color: #3d3d3d;
            border: 1px solid #4ec9b0;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            overflow: hidden;
            transition: background-color 0.1s;
        }
        .cell-label {
            position: absolute;
            top: 5px;
            left: 5px;
            font-weight: bold;
            color: #4ec9b0;
            font-size: 16px;
            z-index: 10;
            background: rgba(45, 45, 48, 0.7);
            padding: 2px 5px;
            border-radius: 3px;
        }
        .cell-photo {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
        }
        .delete-photo-btn {
            position: absolute;
            bottom: 2px;
            right: 2px;
            background-color: rgba(220, 53, 69, 0.8);
            color: white;
            border: none;
            border-radius: 3px;
            padding: 2px 5px;
            font-size: 10px;
            cursor: pointer;
            z-index: 20;
            line-height: 1;
            display: none; 
        }
        .grid-cell:has(.cell-photo) .delete-photo-btn {
            display: block; 
        }
        
        /* MODAL (History Viewer) STYLES */
        .modal {
            display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7);
        }
        .modal-content {
            background-color: #2d2d30; margin: 10% auto; padding: 20px; border: 1px solid #3c3c3c; width: 80%; border-radius: 10px;
        }
        .close-btn {
            color: #aaa; float: right; font-size: 28px; font-weight: bold;
        }
        .close-btn:hover, .close-btn:focus {
            color: #fff; text-decoration: none; cursor: pointer;
        }
        .trial-item {
            padding: 10px; margin-bottom: 5px; background-color: #252526; border-radius: 5px; cursor: pointer; transition: background-color 0.2s;
        }
        .trial-item:hover { background-color: #404040; }
    </style>
</head>
<body>

<div class="container">
    <div class="controls-panel">
        <h1>S.C.O.U.T. Rover Control</h1>
        <p>System Status: <span id="status">Connecting...</span></p>

        <div class="data-display history-controls">
            <h2>Trial Management üíæ</h2>
            <div class="data-row"><strong>Current Trial:</strong> <span id="currentTrialNumber">1</span></div>
            <p>
                <button onclick="saveCurrentTrial()">üíæ Save Trial Data</button>
                <button onclick="openHistoryModal()">üìÖ View History</button>
            </p>
            <p><small>Saved trials are stored in your browser's local storage.</small></p>
        </div>
        
        <div id="ai-analysis" class="data-display">
            <h2>Comprehensive Analysis üß†</h2>
            <div class="data-row"><strong>Last Update Time:</strong> <span id="ai-time">N/A</span></div>
            <div class="data-row"><strong>Crop Health Score:</strong> <span id="ai-health">N/A</span></div>
            <h3 style="border-bottom: none; margin-top: 5px;">Overall Recommendation</h3>
            <p><strong>Action Required:</strong> <span id="ai-recommendation">N/A</span></p>
        </div>

        <div class="move-controls">
            <h2>Rover Movement</h2>
            <button onclick="sendCommand('forward')">Forward (‚Üë)</button>
            <button onclick="sendCommand('stop')">üõë STOP</button>
            <button onclick="sendCommand('backward')">Backward (‚Üì)</button><br>
            <button onclick="sendCommand('left')">Left (‚Üê)</button>
            <button onclick="sendCommand('right')">Right (‚Üí)</button>
        </div>

        <hr style="border-top: 1px solid #3c3c3c;">

        <div class="arm-controls">
            <h2>Data Acquisition</h2>
            <button onclick="sendCommand('probe')">üî¨ Probe Soil (Arm Down)</button>
            <button onclick="sendCommand('read_sensors')">üíß Read Soil Data</button>
            <button onclick="sendCommand('read_nav')">üß≠ Get GPS/Heading</button>
        </div>

        <hr style="border-top: 1px solid #3c3c3c;">

        <div class="data-display">
            <h2>Live Sensor Data</h2>
            
            <h3>Navigation Data</h3>
            <div class="data-row"><strong>Latitude:</strong> <span id="latitudeData">N/A</span></div>
            <div class="data-row"><strong>Longitude:</strong> <span id="longitudeData">N/A</span></div>
            <div class="data-row"><strong>GPS Fix:</strong> <span id="gpsFix">No Fix</span></div>
            <div class="data-row"><strong>Heading:</strong> <span id="headingData">N/A</span></div>

            <h3>Soil Data</h3>
            <div class="data-row"><strong>Moisture:</strong> <span id="moistureData">N/A</span></div>
            <div class="data-row"><strong>NPK (N, P, K):</strong> <span id="npkData">N/A</span></div>
        </div>
    </div>

    <div class="map-panel">
        <h2>2D Field Map ($\mathbf{4\text{m} \times 4\text{m}}$ Grid)</h2>
        <canvas id="roverMap" width="450" height="450"></canvas>
        <p>Map Key: $\text{Grid} = 1 \text{m} \times 1 \text{m}$. $\text{Circles} = \text{Health}$. $\text{Triangle} = \text{Rover}$.</p>
        <button onclick="clearMapData()">üóëÔ∏è Clear Map Data</button>
    </div>

    <div class="map-3d-panel">
        <h2>3D Photo Map Viewer (Enhanced View)</h2>
        <div id="threeDContainer"></div>
        <div class="three-d-controls">
            <label>
                <input type="checkbox" id="planeToggle" checked onchange="togglePhotoPlanes()">
                Show Photo Planes
            </label>
            <span style="margin-left: 20px;">| Drag mouse to rotate. Scroll to zoom.</span>
        </div>
    </div>

    <div class="photo-panel">
        <div class="camera-control">
            <h2>Image Capture & Gallery</h2>
            <button onclick="sendCommand('capture')">üì∏ Take Photo (to Dell Wyse)</button>
            <button onclick="loadStockPhotos()">üñºÔ∏è Load Stock Photos</button>
            <p>Last photo status: <span id="lastPhotoStatus">N/A</span>. Sent to Dell Wyse server at <span id="server-ip">192.168.X.X:5000</span>.</p>
        </div>

        <hr style="border-top: 1px solid #3c3c3c;">

        <h2>Manual Photo Upload Map (Zones 1-16)</h2>
        <p>Click a zone below to upload/replace the photo. Click the **X** to delete it.</p>
        <div id="photoGrid">
            </div>
        <input type="file" id="fileInput" accept="image/*" style="display:none;" onchange="handleFileSelect(event)">
    </div>
</div>

<div id="historyModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeHistoryModal()">&times;</span>
        <h2>Saved Trial History</h2>
        <div id="trialHistoryList">
            </div>
        <hr style="border-top: 1px solid #3c3c3c; margin-top: 15px;">
        <button onclick="clearAllHistory()" style="background-color: #dc3545;">üö® Clear All Saved Trials</button>
    </div>
</div>

<script>
    // JAVASCRIPT LOGIC
    
    // !!! CONFIGURE YOUR IPs HERE !!!
    const ESP32_IP = '192.168.1.50'; 
    const DELL_WYSE_IP = 'http://192.168.X.X:5000'; 
    
    const ESP32_URL_BASE = `http://${ESP32_IP}`;
    const STATUS_ELEMENT = document.getElementById('status');
    const LAST_PHOTO_STATUS = document.getElementById('lastPhotoStatus');
    
    document.getElementById('server-ip').innerText = DELL_WYSE_IP.replace('http://', ''); 

    // --- MAP CONSTANTS (4m x 4m) ---
    const FIELD_SIZE = 4;
    const MAP_CANVAS = document.getElementById('roverMap');
    const CTX = MAP_CANVAS.getContext('2d');
    const MAP_SIZE = 450; 
    const PIXELS_PER_METER = MAP_SIZE / FIELD_SIZE;
    
    // Plant locations in meters
    const PLANT_LOCATIONS_M = [];
    for(let r=0; r<FIELD_SIZE; r++) for(let c=0; c<FIELD_SIZE; c++) PLANT_LOCATIONS_M.push({x: c + 0.5, y: r + 0.5});

    // Global Data Structures
    let loggedData = []; 
    let selectedZone = 0; 
    let photoData = {}; 
    let trialHistory = JSON.parse(localStorage.getItem('trialHistory') || '[]');
    let currentTrialNumber = trialHistory.length + 1;

    document.getElementById('currentTrialNumber').innerText = currentTrialNumber;


    // Coordinate mapping for 3D
    const ZONE_COORDS = {}; 
    for(let i=1; i<=16; i++) {
        let row = Math.floor((i - 1) / FIELD_SIZE);
        let col = (i - 1) % FIELD_SIZE;
        // The center coordinate of a 1x1m square
        ZONE_COORDS[i] = { x: col + 0.5, z: row + 0.5 }; 
    }

    let currentRoverData = {
        latitude: 'N/A', 
        longitude: 'N/A', 
        heading: 0, 
        x_m: 2.0, 
        y_m: 2.0 
    };

    // --- 3D RENDERING SETUP (THREE.JS) ---
    let scene, camera, renderer, rover3D, controls;
    let photoPlanes = {}; 
    const PHOTO_PLANE_HEIGHT = 0.5; // NEW: Elevate planes 0.5m above the ground (z=0)

    function initThreeD() {
        const container = document.getElementById('threeDContainer');
        const width = container.clientWidth;
        const height = container.clientHeight;

        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x1a1a1a);

        camera = new THREE.PerspectiveCamera(75, width / height, 0.1, 100);
        camera.position.set(2, 6, 2); 
        camera.lookAt(2, 0, 2);

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(width, height);
        container.appendChild(renderer.domElement);
        
        // FIX: Initialize OrbitControls correctly
        controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true; 
        controls.dampingFactor = 0.05;
        controls.screenSpacePanning = false;
        controls.minDistance = 1;
        controls.maxDistance = 10;
        controls.maxPolarAngle = Math.PI / 2.2; 
        

        // Field Grid (Ground Plane)
        const gridHelper = new THREE.GridHelper(FIELD_SIZE, FIELD_SIZE, 0x444444, 0x444444);
        gridHelper.position.set(FIELD_SIZE / 2, 0, FIELD_SIZE / 2);
        scene.add(gridHelper);

        // Rover Model (Simple Cube)
        const roverGeometry = new THREE.BoxGeometry(0.2, 0.1, 0.2);
        const roverMaterial = new THREE.MeshPhongMaterial({ color: 0x569cd6 });
        rover3D = new THREE.Mesh(roverGeometry, roverMaterial);
        rover3D.position.set(currentRoverData.x_m, 0.05, currentRoverData.y_m); 
        scene.add(rover3D);

        // Lighting
        const ambientLight = new THREE.AmbientLight(0x404040, 2);
        scene.add(ambientLight);
        const directionalLight = new THREE.DirectionalLight(0xffffff, 1.5);
        directionalLight.position.set(5, 10, 5);
        scene.add(directionalLight);

        animate();
    }

    function animate() {
        requestAnimationFrame(animate);
        if(controls) controls.update(); 
        renderer.render(scene, camera);
    }
    
    function updateRover3DPosition() {
        if (rover3D) {
            rover3D.position.set(
                parseFloat(currentRoverData.x_m), 
                0.05, 
                parseFloat(currentRoverData.y_m) 
            ); 
            rover3D.rotation.y = -(currentRoverData.heading - 90) * (Math.PI / 180);
        }
    }

    function clear3DPhotos() {
        Object.values(photoPlanes).forEach(plane => {
            scene.remove(plane);
            plane.geometry.dispose();
            plane.material.dispose();
        });
        photoPlanes = {};
    }

    // NEW: Toggle Photo Plane Visibility
    function togglePhotoPlanes() {
        const isVisible = document.getElementById('planeToggle').checked;
        Object.values(photoPlanes).forEach(plane => {
            plane.visible = isVisible;
        });
        STATUS_ELEMENT.innerText = `3D Photo Planes are now ${isVisible ? 'visible' : 'hidden'}.`;
    }
    
    function addPhotoTo3DMap(zoneId, base64Image) {
        if (!scene || !base64Image) return;

        const { x, z } = ZONE_COORDS[zoneId];
        
        // Remove old plane
        if (photoPlanes[zoneId]) {
            scene.remove(photoPlanes[zoneId]);
            photoPlanes[zoneId].geometry.dispose();
            photoPlanes[zoneId].material.dispose();
        }

        // Create a new texture from the base64 image
        const img = new Image();
        img.crossOrigin = "anonymous"; 
        img.onload = () => {
            const texture = new THREE.Texture(img);
            texture.needsUpdate = true;

            const material = new THREE.MeshBasicMaterial({ map: texture, side: THREE.DoubleSide });
            // Plane geometry dimensions (1m wide, 0.5m high) 
            // We use a standing plane to give the illusion of a clearer 3D view
            const geometry = new THREE.PlaneGeometry(1, 0.5); 
            const plane = new THREE.Mesh(geometry, material);

            // Rotation is 0 on X and Y, making it stand upright.
            // Position: x and z define the center of the zone. Y (up) is half the height of the plane, plus the desired elevation.
            plane.position.set(
                x, 
                PHOTO_PLANE_HEIGHT / 2, // Half the height of the plane for the pivot point
                z
            );
            plane.visible = document.getElementById('planeToggle').checked; // Respect current toggle state

            photoPlanes[zoneId] = plane;
            scene.add(plane);
        };
        img.src = base64Image;
    }


    // ------------------------------------
    // --- PHOTO GRID & STOCK PHOTO FUNCTIONS ---
    // ------------------------------------
    
    function loadStockPhotos() {
        for (let i = 1; i <= 16; i++) {
            const color = '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0');
            const stockImage = `<svg width="100%" height="100%" xmlns="http://www.w3.org/2000/svg"><rect width="100%" height="100%" fill="${color}"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-size="20" fill="#fff">Zone ${i}</text></svg>`;
            const base64StockImage = 'data:image/svg+xml;base64,' + btoa(stockImage);
            
            photoData[i] = base64StockImage;
            renderPhotoInCell(i, base64StockImage);
            addPhotoTo3DMap(i, base64StockImage);
        }
        LAST_PHOTO_STATUS.innerText = '16 stock photos loaded.';
    }

    function deletePhoto(zoneId) {
        if (!photoData[zoneId]) return;

        // 1. Remove from data structure
        delete photoData[zoneId];

        // 2. Remove from 2D grid
        renderPhotoInCell(zoneId, null); // Render with null clears the image

        // 3. Remove from 3D map
        if (photoPlanes[zoneId]) {
            scene.remove(photoPlanes[zoneId]);
            photoPlanes[zoneId].geometry.dispose();
            photoPlanes[zoneId].material.dispose();
            delete photoPlanes[zoneId];
        }
        STATUS_ELEMENT.innerText = `Photo deleted from Zone ${zoneId}.`;
    }

    function generatePhotoGrid() {
        const grid = document.getElementById('photoGrid');
        for (let i = 1; i <= 16; i++) {
            const cell = document.createElement('div');
            cell.className = 'grid-cell';
            cell.id = 'zone-' + i;
            cell.innerHTML = `
                <span class="cell-label">${i}</span>
                <button class="delete-photo-btn" onclick="deletePhoto(${i})">X</button>
            `;
            
            // Only trigger upload on clicking the cell area, not the delete button
            cell.addEventListener('click', function(e) {
                if (e.target.className !== 'delete-photo-btn') {
                    selectedZone = i;
                    document.getElementById('fileInput').click(); 
                }
            });
            
            grid.appendChild(cell);
        }
        loadCurrentPhotoData();
    }

    function handleFileSelect(event) {
        const file = event.target.files[0];
        if (!file || selectedZone === 0) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            const base64Image = e.target.result;
            photoData[selectedZone] = base64Image; 
            renderPhotoInCell(selectedZone, base64Image);
            addPhotoTo3DMap(selectedZone, base64Image); 
            selectedZone = 0; 
        };
        reader.readAsDataURL(file); 
    }

    function renderPhotoInCell(zoneId, base64Image) {
        const cell = document.getElementById('zone-' + zoneId);
        if (!cell) return;
        
        const existingPhoto = cell.querySelector('.cell-photo');
        if (existingPhoto) existingPhoto.remove();

        if (base64Image) {
            const img = document.createElement('img');
            img.src = base64Image;
            img.className = 'cell-photo';
            cell.appendChild(img);
        }
    }

    function clearPhotoGrid() {
        for (let i = 1; i <= 16; i++) {
            renderPhotoInCell(i, null);
        }
    }
    
    function loadCurrentPhotoData() {
        clearPhotoGrid();
        clear3DPhotos();
        for (const [zoneId, base64Image] of Object.entries(photoData)) {
            renderPhotoInCell(parseInt(zoneId), base64Image);
            addPhotoTo3DMap(parseInt(zoneId), base64Image);
        }
    }

    // ------------------------------------
    // --- HISTORY & DATA SAVING FUNCTIONS ---
    // ------------------------------------

    function saveCurrentTrial() {
        const trialData = {
            id: currentTrialNumber,
            date: new Date().toLocaleString(),
            roverData: { ...currentRoverData },
            loggedData: [...loggedData],
            photoData: { ...photoData },
            aiData: { 
                time: document.getElementById('ai-time').innerText,
                health: document.getElementById('ai-health').innerText,
                recommendation: document.getElementById('ai-recommendation').innerText,
            }
        };

        trialHistory.push(trialData);
        localStorage.setItem('trialHistory', JSON.stringify(trialHistory));
        
        STATUS_ELEMENT.innerText = `Trial ${currentTrialNumber} saved successfully! Starting new trial...`;
        
        // Reset for new trial
        loggedData = [];
        photoData = {};
        currentTrialNumber++;
        document.getElementById('currentTrialNumber').innerText = currentTrialNumber;
        clearMapData(false); 
        clearPhotoGrid(); 
        clear3DPhotos(); 
        updateRover3DPosition(); 
    }

    function openHistoryModal() {
        const modal = document.getElementById('historyModal');
        const list = document.getElementById('trialHistoryList');
        list.innerHTML = ''; 

        if (trialHistory.length === 0) {
            list.innerHTML = '<p>No trials saved yet.</p>';
        } else {
            trialHistory.forEach(trial => {
                const item = document.createElement('div');
                item.className = 'trial-item';
                item.innerHTML = `<strong>Trial ${trial.id}:</strong> ${trial.date} (${trial.loggedData.length} readings)`;
                item.onclick = () => loadPastTrial(trial.id);
                list.appendChild(item);
            });
        }
        modal.style.display = "block";
    }

    function closeHistoryModal() {
        document.getElementById('historyModal').style.display = "none";
    }

    function loadPastTrial(trialId) {
        const trial = trialHistory.find(t => t.id === trialId);
        if (!trial) return;

        // 1. Load Rover Data
        currentRoverData = trial.roverData;
        document.getElementById('latitudeData').innerText = trial.roverData.latitude;
        document.getElementById('longitudeData').innerText = trial.roverData.longitude;
        document.getElementById('headingData').innerText = trial.roverData.heading + ' deg';
        document.getElementById('gpsFix').innerText = 'Historical';

        // 2. Load Logged Data & Map
        loggedData = trial.loggedData;
        drawMap();
        updateRover3DPosition();
        
        // 3. Load Photo Data
        photoData = trial.photoData;
        loadCurrentPhotoData(); 

        // 4. Load AI Data (from saved data)
        document.getElementById('ai-time').innerText = trial.aiData.time;
        document.getElementById('ai-health').innerText = trial.aiData.health;
        document.getElementById('ai-recommendation').innerText = trial.aiData.recommendation;

        STATUS_ELEMENT.innerText = `Loaded data for Trial ${trialId}.`;
        document.getElementById('currentTrialNumber').innerText = `${currentTrialNumber} (Viewing Trial ${trialId})`;
        closeHistoryModal();
    }
    
    function clearAllHistory() {
        if (confirm("Are you sure you want to clear ALL saved trial history? This cannot be undone.")) {
            localStorage.removeItem('trialHistory');
            trialHistory = [];
            currentTrialNumber = 1;
            document.getElementById('currentTrialNumber').innerText = currentTrialNumber;
            closeHistoryModal();
            STATUS_ELEMENT.innerText = "All trial history cleared.";
        }
    }


    // ------------------------------------
    // --- AI and COMMUNICATION FUNCTIONS (Mock) ---
    // ------------------------------------
    
    function fetchAIResults() {
        document.getElementById('ai-time').innerText = 'N/A';
        document.getElementById('ai-health').innerText = 'N/A';
        document.getElementById('ai-recommendation').innerText = 'Awaiting data from Dell Wyse.';
    }

    function sendCommand(command) {
        let url = (command === 'capture') ? `${ESP32_URL_BASE}/capture` : `${ESP32_URL_BASE}/move?dir=${command}`;
        
        STATUS_ELEMENT.innerText = `Sending command: ${command}...`;

        fetch(url)
            .then(response => {
                if (!response.ok) { throw new Error(`HTTP Error: ${response.status}`); }
                return response.text();
            })
            .then(data => {
                STATUS_ELEMENT.innerText = `Command '${command}' Success.`;
                if (command.startsWith('read_') || command === 'probe') {
                    setTimeout(() => fetchData(command), 500); 
                    setTimeout(() => fetchAIResults(), 1000); 
                }
            })
            .catch(error => {
                STATUS_ELEMENT.innerText = `ERROR: Command ${command} failed. Is ESP32 at ${ESP32_IP} online?`;
                console.error('Error sending command:', error);
            });
    }
    
    // --- MOCK/SIMULATED DATA FETCH (Called manually by 'read' buttons) ---
    function fetchData(lastCommand = null) {
        
        STATUS_ELEMENT.innerText = "Fetching latest data...";
        
        setTimeout(() => {
            // --- Simulate GPS/Nav Data ---
             let headingStr = (Math.random() * 360).toFixed(1) + ' deg';
             currentRoverData.heading = parseFloat(headingStr.split(' ')[0]) || 0; 
             currentRoverData.latitude = "40.7128";
             currentRoverData.longitude = "-74.0060";
             
             document.getElementById('latitudeData').innerText = currentRoverData.latitude; 
             document.getElementById('longitudeData').innerText = currentRoverData.longitude;
             document.getElementById('gpsFix').innerText = "3D Fix";
             document.getElementById('headingData').innerText = headingStr;

             // Simulate Rover Movement (random walk)
             if (lastCommand !== 'read_nav' && lastCommand !== 'stop') {
                 currentRoverData.x_m = Math.min(FIELD_SIZE, Math.max(0, parseFloat(currentRoverData.x_m) + (Math.random() - 0.5) * 0.1)).toFixed(2);
                 currentRoverData.y_m = Math.min(FIELD_SIZE, Math.max(0, parseFloat(currentRoverData.y_m) + (Math.random() - 0.5) * 0.1)).toFixed(2);
             }

             // --- Simulate Soil Data ---
             let moistureStr = (Math.random() * 80 + 10).toFixed(1) + '%';
             let npkStr = `N:${Math.floor(Math.random() * 100)}, P:${Math.floor(Math.random() * 100)}, K:${Math.floor(Math.random() * 100)}`;
             document.getElementById('moistureData').innerText = moistureStr;
             document.getElementById('npkData').innerText = npkStr;
            
             if (lastCommand === 'probe' || lastCommand === 'read_sensors') {
                
                 let moisture = parseFloat(moistureStr.split('%')[0]) || 0;
                 let npk_values = npkStr.match(/N:(\d+), P:(\d+), K:(\d+)/);
                 let npk_n = npk_values ? parseInt(npk_values[1]) : 0;
                 let npk_p = npk_values ? parseInt(npk_values[2]) : 0;
                 let npk_k = npk_values ? parseInt(npk_values[3]) : 0;
                
                 let healthStatus = analyzeHealth(moisture, npk_n, npk_p, npk_k);

                 loggedData.push({
                     x_m: parseFloat(currentRoverData.x_m),
                     y_m: parseFloat(currentRoverData.y_m),
                     healthStatus: healthStatus,
                     moisture: moisture,
                     npk_n: npk_n, npk_p: npk_p, npk_k: npk_k
                 });
                 STATUS_ELEMENT.innerText = `Data logged! Status: ${healthStatus}`;
             }

             drawMap();
             updateRover3DPosition();
             STATUS_ELEMENT.innerText = "Data update complete.";

        }, 500); 
    }
    
    // ------------------------------------
    // --- 2D MAP LOGIC ---
    // ------------------------------------

    function analyzeHealth(moisture, npk_n, npk_p, npk_k) {
        let issues = 0;
        const MIN_MOISTURE = 30;
        const IDEAL_NPK_SUM = 150; 
        const NPK_TOLERANCE = 50;

        if (moisture < MIN_MOISTURE || moisture > 80) { issues++; } 
        
        let npk_sum = npk_n + npk_p + npk_k;
        if (Math.abs(npk_sum - IDEAL_NPK_SUM) > NPK_TOLERANCE) { issues++; } 

        if (issues >= 2) return 'Bad';
        if (issues === 1) return 'Caution';
        return 'Good';
    }
    
    function clearMapData(resetRover = true) {
        loggedData = [];
        if (resetRover) {
            currentRoverData.x_m = 2.0;
            currentRoverData.y_m = 2.0;
            currentRoverData.heading = 0;
        }
        drawMap();
        updateRover3DPosition();
        STATUS_ELEMENT.innerText = "Map data cleared.";
    }

    function drawMap() {
        CTX.clearRect(0, 0, MAP_SIZE, MAP_SIZE);
        
        // 1. Draw the 4x4 Grid
        CTX.strokeStyle = '#5a5a5a'; 
        CTX.lineWidth = 1;
        for (let i = 1; i < FIELD_SIZE; i++) { 
            let px = i * PIXELS_PER_METER;
            CTX.beginPath(); CTX.moveTo(px, 0); CTX.lineTo(px, MAP_SIZE); CTX.stroke();
            CTX.beginPath(); CTX.moveTo(0, px); CTX.lineTo(MAP_SIZE, px); CTX.stroke();
        }

        // 2. Map Soil Condition (Background Squares)
        const GRID_SIZE_M = 1.0;
        for (let row = 0; row < FIELD_SIZE; row++) { 
            for (let col = 0; col < FIELD_SIZE; col++) { 
                let center_x_m = col * GRID_SIZE_M + 0.5;
                let center_y_m = row * GRID_SIZE_M + 0.5;

                let nearestData = null;
                let min_dist_sq = Infinity;

                loggedData.forEach(data => {
                    let dx = data.x_m - center_x_m;
                    let dy = data.y_m - center_y_m;
                    let dist_sq = dx * dx + dy * dy;

                    if (dist_sq < min_dist_sq) {
                        min_dist_sq = dist_sq;
                        nearestData = data;
                    }
                });

                if (nearestData && min_dist_sq < 0.5 * 0.5) { 
                    let moistureColor;
                    if (nearestData.moisture < 20) { moistureColor = '#0070e040'; } 
                    else if (nearestData.moisture > 70) { moistureColor = '#80008040'; } 
                    else { moistureColor = '#6a995540'; } 
                    
                    CTX.fillStyle = moistureColor;
                    CTX.fillRect(
                        col * PIXELS_PER_METER, 
                        MAP_SIZE - ((row + 1) * PIXELS_PER_METER), 
                        PIXELS_PER_METER, 
                        PIXELS_PER_METER
                    );
                }
            }
        }

        // 3. Draw Plant Health Circles
        PLANT_LOCATIONS_M.forEach((plant, index) => {
            let px = plant.x * PIXELS_PER_METER;
            let py = MAP_SIZE - (plant.y * PIXELS_PER_METER);

            let nearestData = null;
            let min_dist_sq = Infinity;

            loggedData.forEach(data => {
                let dx = data.x_m - plant.x;
                let dy = data.y_m - plant.y;
                let dist_sq = dx * dx + dy * dy;

                if (dist_sq < min_dist_sq) {
                    min_dist_sq = dist_sq;
                    nearestData = data;
                }
            });

            let plantColor = nearestData ? (nearestData.healthStatus ? getHealthColor(nearestData.healthStatus) : '#5a5a5a') : '#5a5a5a'; 
            
            CTX.fillStyle = plantColor;
            CTX.beginPath();
            CTX.arc(px, py, 6, 0, 2 * Math.PI); 
            CTX.fill();
            
            if (nearestData && nearestData.healthStatus) {
                CTX.fillStyle = 'white';
                CTX.font = '10px Arial';
                CTX.fillText(nearestData.healthStatus.charAt(0), px - 3, py + 3);
            }
        });

        // 4. Draw Rover Position and Heading (Triangle)
        let rover_x_px = currentRoverData.x_m * PIXELS_PER_METER;
        let rover_y_px = MAP_SIZE - (currentRoverData.y_m * PIXELS_PER_METER); 
        let heading_rad = (currentRoverData.heading - 90) * (Math.PI / 180);

        CTX.fillStyle = '#9cdcfe';
        CTX.save();
        CTX.translate(rover_x_px, rover_y_px);
        CTX.rotate(heading_rad); 

        CTX.beginPath();
        CTX.moveTo(10, 0);  
        CTX.lineTo(-10, -8); 
        CTX.lineTo(-10, 8);  
        CTX.closePath();
        CTX.fill();

        CTX.restore();

        CTX.fillStyle = 'white';
        CTX.beginPath();
        CTX.arc(rover_x_px, rover_y_px, 3, 0, 2 * Math.PI);
        CTX.fill();
    }
    
    function getHealthColor(status) {
        switch (status) {
            case 'Good': return '#28a745'; 
            case 'Caution': return '#ffc107'; 
            case 'Bad': return '#dc3545'; 
            default: return '#5a5a5a'; 
        }
    }

    // --- Initialization ---
    window.onload = function() {
        initThreeD();       
        drawMap();          
        generatePhotoGrid();
        fetchAIResults();   
        setInterval(fetchAIResults, 5000); 
        LAST_PHOTO_STATUS.innerText = 'No photos taken yet.';
    };

</script>

</body>
</html>
