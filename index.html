<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>PROJECT SCOUT ‚Äì Post-Flood Crop Assessment Dashboard</title>

<!-- =========================
     GLOBAL STYLES
     ========================= -->
<style>
* { box-sizing:border-box; margin:0; padding:0; font-family: Arial, Helvetica, sans-serif;}
body { background:#0a111a; color:#e4e4e4; display:flex; flex-direction:column; min-height:100vh; }
h1,h2,h3,h4 { font-weight:600; margin-bottom:10px; }
p { margin-bottom:10px; line-height:1.5; }
button { cursor:pointer; }

/* HEADER */
header { background:#112131; color:#fff; padding:15px 25px; display:flex; align-items:center; justify-content:space-between; height:60px; box-shadow:0 2px 4px rgba(0,0,0,0.5); position:sticky; top:0; z-index:100;}
header h1 { font-size:1.2rem; letter-spacing:1px; }
header .status { font-size:0.9rem; color:#9fdf9f; font-weight:bold; }

/* FOOTER */
footer { background:#112131; padding:12px 20px; font-size:0.85rem; text-align:center; border-top:2px solid #1d2c3c; }

/* LAYOUT */
.layout { display:grid; grid-template-columns:260px 1fr; flex:1; min-height:calc(100vh - 60px); gap:10px; }
.sidebar { background:#131c29; padding:20px; border-right:2px solid #1d2c3c; display:flex; flex-direction:column; gap:15px; }
.sidebar h2 { font-size:1rem; text-transform:uppercase; margin-bottom:10px; color:#7fb4ff; }
.sidebar button { background:#1c2f47; border:none; padding:10px; color:#fff; font-size:0.9rem; border-radius:6px; text-align:left; transition:0.2s; }
.sidebar button:hover { background:#2c4f77; }

/* MAIN PANELS */
.main { padding:20px; overflow-y:auto; display:grid; grid-template-columns: 1fr 1fr; grid-gap:20px; }

/* PANEL */
.panel { background:#162233; padding:15px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.6); }
.panel h3 { color:#7fb4ff; margin-bottom:12px; }

/* FORM & INPUTS */
input, select { padding:6px 8px; border-radius:4px; border:1px solid #444; background:#0f1722; color:#fff; width:100%; }
input[type=file] { padding:2px; }
form label { display:flex; flex-direction:column; margin-bottom:6px; font-size:0.9rem; }
form button { background:#2c4f77; color:#fff; padding:10px; border:none; border-radius:6px; }

/* PHOTO GRID */
#photoGridContainer { display:grid; grid-template-columns:repeat(4,1fr); gap:10px; }
#stockGrid { display:grid; grid-template-columns:repeat(5,1fr); gap:6px; margin-top:10px; }

/* ANALYSIS GRID */
#analysisGrid { display:grid; grid-template-columns:repeat(auto-fit,minmax(120px,1fr)); gap:10px; margin-bottom:15px; }

/* AI TEXT */
#aiAnalysis { background:#0f1722; padding:12px; border-radius:8px; font-size:0.9rem; line-height:1.4; white-space:pre-wrap; min-height:150px; }

/* LOGS */
#log { background:#0f1722; padding:10px; border-radius:8px; max-height:200px; overflow-y:auto; font-size:0.85rem; line-height:1.3; }

/* 3D Container */
#threeDContainer { width:100%; height:500px; border:1px solid #333; border-radius:10px; }

/* RESPONSIVE */
@media(max-width:1000px){.layout{grid-template-columns:1fr;} .main{grid-template-columns:1fr;}}
</style>
</head>
<body>

<header>
  <h1>PROJECT SCOUT ‚Äì Post-Flood Crop Assessment</h1>
  <div class="status" id="status">Initializing...</div>
</header>

<div class="layout">
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <h2>Navigation</h2>
    <button onclick="scrollToSection('roverControls')">Rover Controls</button>
    <button onclick="scrollToSection('photoGrid')">Photo Grid</button>
    <button onclick="scrollToSection('stockGallery')">Stock Gallery</button>
    <button onclick="scrollToSection('manualEntry')">Manual Entry</button>
    <button onclick="scrollToSection('mapSection')">2D Map</button>
    <button onclick="scrollToSection('threeDSection')">3D Plants</button>
    <button onclick="scrollToSection('analysisSection')">Analysis</button>
    <button onclick="scrollToSection('logs')">Logs</button>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <!-- Rover Controls -->
    <section class="panel" id="roverControls">
      <h3>Rover Controls</h3>
      <p>Use these buttons to move the rover and operate the probe arm.</p>
      <div style="display:flex;flex-wrap:wrap;gap:10px">
        <button onclick="sendCommandToESP32('forward')">‚¨Ü Forward</button>
        <button onclick="sendCommandToESP32('backward')">‚¨á Backward</button>
        <button onclick="sendCommandToESP32('left')">‚¨Ö Left</button>
        <button onclick="sendCommandToESP32('right')">‚û° Right</button>
        <button onclick="sendCommandToESP32('stop')">‚èπ Stop</button>
        <button onclick="sendCommandToESP32('probe_up')">üîº Probe Up</button>
        <button onclick="sendCommandToESP32('probe_down')">üîΩ Probe Down</button>
        <button onclick="fetchSensorData()">üì° Read Sensors</button>
      </div>
    </section>

    <!-- Photo Grid -->
    <section class="panel" id="photoGrid">
      <h3>Zone Photo Grid (16 zones)</h3>
      <p>Upload field images per zone for analysis. Each square represents a zone.</p>
      <div id="photoGridContainer"></div>
    </section>

    <!-- Stock Gallery -->
    <section class="panel" id="stockGallery">
      <h3>Stock Gallery</h3>
      <p>Upload and manage stock images here.</p>
      <input type="file" accept="image/*" multiple onchange="handleStockUpload(event)" />
      <div id="stockGrid"></div>
    </section>

    <!-- Manual Entry -->
    <section class="panel" id="manualEntry">
      <h3>Manual Data Entry</h3>
      <p>If rover or sensors fail, manually input values and photos for each zone.</p>
      <form onsubmit="submitManualEntry();return false;" style="display:flex;flex-direction:column;gap:8px;max-width:300px">
        <label>Zone: <input id="manual_zone" type="number" min="1" max="16" value="1" required></label>
        <label>Soil Moisture (%): <input id="manual_moisture" type="number" min="0" max="100" step="1"></label>
        <label>Nitrogen (N): <input id="manual_n" type="number" min="0" max="200"></label>
        <label>Phosphorus (P): <input id="manual_p" type="number" min="0" max="200"></label>
        <label>Potassium (K): <input id="manual_k" type="number" min="0" max="200"></label>
        <label>Upload Photo: <input id="manual_photo" type="file" accept="image/*"></label>
        <button type="submit">‚ûï Submit Manual Entry</button>
      </form>
    </section>

    <!-- 2D Map -->
    <section class="panel" id="mapSection">
      <h3>2D Field Map</h3>
      <p>The field is divided into 16 zones. Each circle represents the zone‚Äôs health. Hover to view details.</p>
      <canvas id="mapCanvas" width="600" height="600" style="border:1px solid #333; border-radius:10px; background:#0f1722;"></canvas>
    </section>

    <!-- 3D Plants -->
    <section class="panel" id="threeDSection">
      <h3>3D Tomato Plant Visualization</h3>
      <p>Each 3D model represents a tomato plant in its zone. Plants colored by health.</p>
      <div id="threeDContainer"></div>
    </section>

    <!-- Analysis -->
    <section class="panel" id="analysisSection">
      <h3>AI-Based Analysis Results</h3>
      <p>Select a zone to view post-flood crop health analysis.</p>
      <div id="analysisGrid"></div>
      <div id="aiAnalysis">No zone selected. Click on a zone card above to see detailed analysis.</div>
    </section>

    <!-- Logs -->
    <section class="panel" id="logs">
      <h3>System Logs</h3>
      <p>All rover actions, uploads, and analysis updates are logged here.</p>
      <div id="log"></div>
    </section>
  </main>
</div>

<footer>
PROJECT SCOUT ‚Ä¢ ESP32: 10.101.146.88 ‚Ä¢ ThingSpeak Key: 6OXH3SUQ4VNSOJX1
</footer>

<!-- =========================
     THREE.JS LIB
     ========================= -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r152/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.152.0/examples/js/controls/OrbitControls.js"></script>

<script>
/* =============================
   GLOBAL VARIABLES
============================= */
const ESP32_IP = "10.101.146.88";
const THINGSPEAK_KEY = "6OXH3SUQ4VNSOJX1";
const ZONES = 16;

let photos = {};         
let stockGallery = {};   
let sensorLogs = [];     
let latestAnalysis = {}; 

/* =============================
   LOGGER
============================= */
function log(msg){
  const d = document.createElement("div");
  d.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
  document.getElementById("log").prepend(d);
  console.log(msg);
}

/* =============================
   FILE READER
============================= */
function readFileAsDataURL(file){
  return new Promise((resolve,reject)=>{
    const reader = new FileReader();
    reader.onload = ()=>resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

/* =============================
   PHOTO GRID
============================= */
function generatePhotoGrid(){
  const grid = document.getElementById("photoGridContainer");
  grid.innerHTML="";
  for(let zone=1;zone<=ZONES;zone++){
    const cell=document.createElement("div");
    cell.style.position="relative";
    cell.style.border="1px solid #2c3e50";
    cell.style.borderRadius="6px";
    cell.style.overflow="hidden";
    cell.style.height="100px";
    cell.style.background="#0f1722";
    cell.style.display="flex";
    cell.style.alignItems="center";
    cell.style.justifyContent="center";
    cell.dataset.zone=zone;

    const label=document.createElement("div");
    label.innerText="Zone "+zone;
    label.style.position="absolute";
    label.style.top="2px";
    label.style.left="4px";
    label.style.fontSize="0.8rem";
    label.style.background="rgba(0,0,0,0.5)";
    label.style.padding="1px 3px";
    label.style.borderRadius="4px";
    cell.appendChild(label);

    const input=document.createElement("input");
    input.type="file";
    input.accept="image/*";
    input.style.position="absolute";
    input.style.opacity="0";
    input.style.width="100%";
    input.style.height="100%";
    input.onchange=async (e)=>{
      const f=e.target.files[0];
      if(!f) return;
      const b64=await readFileAsDataURL(f);
      photos[zone]=b64;
      log("Photo uploaded for Zone "+zone);
      generatePhotoGrid();
      triggerAnalysis();
      update3DPlants();
    };
    cell.appendChild(input);

    if(photos[zone]){
      const img=document.createElement("img");
      img.src=photos[zone];
      img.style.width="100%";
      img.style.height="100%";
      img.style.objectFit="cover";
      cell.appendChild(img);

      const del=document.createElement("button");
      del.innerText="√ó";
      del.style.position="absolute";
      del.style.top="2px";
      del.style.right="2px";
      del.style.background="rgba(255,0,0,0.7)";
      del.style.border="none";
      del.style.borderRadius="4px";
      del.style.color="#fff";
      del.style.padding="2px 6px";
      del.onclick=(ev)=>{
        ev.stopPropagation();
        delete photos[zone];
        log("Deleted photo for Zone "+zone);
        generatePhotoGrid();
        update3DPlants();
      };
      cell.appendChild(del);
    }
    grid.appendChild(cell);
  }
}

/* =============================
   STOCK GALLERY
============================= */
function handleStockUpload(event){
  for(const f of event.target.files){
    readFileAsDataURL(f).then((b64)=>{
      const id=Object.keys(stockGallery).length+1;
      stockGallery[id]={id,url:b64,name:f.name};
      log("Added stock image: "+f.name);
      renderStockGrid();
    });
  }
}
function renderStockGrid(){
  const g=document.getElementById("stockGrid");
  g.innerHTML="";
  for(const id in stockGallery){
    const it=stockGallery[id];
    const img=document.createElement("img");
    img.src=it.url;
    img.title=it.name;
    img.style.width="100%";
    img.style.borderRadius="6px";
    g.appendChild(img);
  }
}

/* =============================
   MANUAL ENTRY
============================= */
function submitManualEntry(){
  const zone=parseInt(document.getElementById("manual_zone").value);
  const moisture=parseFloat(document.getElementById("manual_moisture").value);
  const n=parseFloat(document.getElementById("manual_n").value);
  const p=parseFloat(document.getElementById("manual_p").value);
  const k=parseFloat(document.getElementById("manual_k").value);
  const photoInput=document.getElementById("manual_photo");
  const photoFile=photoInput.files[0];

  let photoPromise=Promise.resolve(null);
  if(photoFile) photoPromise=readFileAsDataURL(photoFile);

  photoPromise.then((b64)=>{
    sensorLogs.push({zone,moisture,n,p,k,photo:b64,timestamp:new Date()});
    if(b64) photos[zone]=b64;
    log(`Manual entry submitted for Zone ${zone}`);
    generatePhotoGrid();
    photoInput.value="";
    triggerAnalysis();
    update3DPlants();
  });
}

/* =============================
   ROVER COMMANDS
============================= */
async function sendCommandToESP32(cmd){
  try{
    const res=await fetch(`http://${ESP32_IP}/${cmd}`);
    if(res.ok){
      log(`Command sent: ${cmd}`);
      document.getElementById("status").innerText=`Last command: ${cmd}`;
    } else log(`Failed command: ${cmd}`);
  }catch(err){ log(`Error sending command: ${cmd} (${err})`); }
}
async function fetchSensorData(){
  try{
    const res=await fetch(`http://${ESP32_IP}/sensors`);
    const data=await res.json();
    log(`Sensor data: ${JSON.stringify(data)}`);
  }catch(err){ log("Error fetching sensor data: "+err);}
}

/* =============================
   2D MAP
============================= */
function renderMap(){
  const canvas=document.getElementById("mapCanvas");
  const ctx=canvas.getContext("2d");
  ctx.clearRect(0,0,canvas.width,canvas.height);

  const radius=25;
  const padding=40;
  const cols=4;

  for(let i=0;i<ZONES;i++){
    const col=i%cols;
    const row=Math.floor(i/cols);
    const x=padding+col*(radius*3);
    const y=padding+row*(radius*3);

    let color="#4caf50";
    if(sensorLogs[i] && sensorLogs[i].moisture<40) color="#ffc107";
    if(sensorLogs[i] && sensorLogs[i].moisture<20) color="#f44336";

    ctx.beginPath();
    ctx.arc(x,y,radius,0,Math.PI*2);
    ctx.fillStyle=color;
    ctx.fill();
    ctx.strokeStyle="#222";
    ctx.stroke();

    canvas._zones=canvas._zones||[];
    canvas._zones[i]={x,y,radius,zone:i+1};
  }
}

/* =============================
   ANALYSIS
============================= */
function triggerAnalysis(){
  const grid=document.getElementById("analysisGrid");
  grid.innerHTML="";
  for(let z=1; z<=ZONES; z++){
    const div=document.createElement("div");
    div.style.padding="6px";
    div.style.border="1px solid #2c3e50";
    div.style.borderRadius="6px";
    div.style.cursor="pointer";
    div.innerText="Zone "+z;
    div.onclick=()=>showAnalysis(z);
    grid.appendChild(div);
  }
}
function showAnalysis(zone){
  const aiDiv=document.getElementById("aiAnalysis");
  const photo=photos[zone]? "‚úÖ Photo" : "‚ùå No Photo";
  const logEntry=sensorLogs.find(e=>e.zone===zone);
  let moisture="N/A", n="N/A", p="N/A", k="N/A";
  if(logEntry){ moisture=logEntry.moisture; n=logEntry.n; p=logEntry.p; k=logEntry.k; }

  aiDiv.innerText=`Zone ${zone} Analysis:
Photo: ${photo}
Soil Moisture: ${moisture}
N: ${n}, P: ${p}, K: ${k}

Health Observation:
${moisture>50?"Good":"Moderate/Low"} moisture.
${n>50 && p>30 && k>30?"Nutrients sufficient":"Nutrient deficiency detected"}.

Recommendation:
${moisture<40?"Irrigate zone immediately.":""}
${n<50 || p<30 || k<30?"Apply fertilizer mix.":""}
`;
}

/* =============================
   SCROLL
============================= */
function scrollToSection(id){
  document.getElementById(id).scrollIntoView({behavior:'smooth'});
}

/* =============================
   3D TOMATO PLANTS
============================= */
let scene, camera, renderer, controls, plantGroup;
function init3D(){
  const container=document.getElementById("threeDContainer");
  scene=new THREE.Scene();
  scene.background=new THREE.Color(0x0f1722);

  camera=new THREE.PerspectiveCamera(45,container.clientWidth/container.clientHeight,0.1,1000);
  camera.position.set(8,10,15);

  renderer=new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(container.clientWidth,container.clientHeight);
  container.appendChild(renderer.domElement);

  controls=new THREE.OrbitControls(camera,renderer.domElement);
  controls.enableDamping=true;

  const ambient=new THREE.AmbientLight(0xffffff,0.5);
  scene.add(ambient);
  const dir=new THREE.DirectionalLight(0xffffff,1);
  dir.position.set(10,15,10);
  scene.add(dir);

  plantGroup=new THREE.Group();
  scene.add(plantGroup);

  window.addEventListener('resize',()=>{
    camera.aspect=container.clientWidth/container.clientHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(container.clientWidth,container.clientHeight);
  });

  animate3D();
  update3DPlants();
}

function animate3D(){
  requestAnimationFrame(animate3D);
  controls.update();
  renderer.render(scene,camera);
}

function update3DPlants(){
  plantGroup.clear();
  const spacing=3;
  for(let i=0;i<ZONES;i++){
    const zone=i+1;
    const group=new THREE.Group();
    group.position.set((i%4)*spacing,0,Math.floor(i/4)*spacing);

    // Stem
    const stemGeo=new THREE.CylinderGeometry(0.05,0.05,1.2);
    const stemMat=new THREE.MeshStandardMaterial({color:0x228B22});
    const stem=new THREE.Mesh(stemGeo,stemMat);
    stem.position.y=0.6;
    group.add(stem);

    // Leaves
    for(let l=0;l<3;l++){
      const leafGeo=new THREE.BoxGeometry(0.3,0.05,0.8);
      const leafMat=new THREE.MeshStandardMaterial({color:0x32CD32});
      const leaf=new THREE.Mesh(leafGeo,leafMat);
      leaf.rotation.y=(l/3)*Math.PI*2;
      leaf.position.y=0.8 + l*0.1;
      group.add(leaf);
    }

    // Tomato fruit
    const fruitGeo=new THREE.SphereGeometry(0.15,16,16);
    let fruitColor=0xff0000;
    if(sensorLogs[i] && sensorLogs[i].moisture<40) fruitColor=0xffff00;
    const fruitMat=new THREE.MeshStandardMaterial({color:fruitColor});
    const fruit=new THREE.Mesh(fruitGeo,fruitMat);
    fruit.position.y=1.2;
    group.add(fruit);

    plantGroup.add(group);
  }
}

/* =============================
   INIT
============================= */
window.onload=()=>{
  generatePhotoGrid();
  renderStockGrid();
  triggerAnalysis();
  renderMap();
  init3D();
  document.getElementById("status").innerText="Ready";
};
</script>

</body>
</html>
